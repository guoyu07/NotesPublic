http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718013
# Data Representation
Integer data values are 16 bits in big-endian order: the high order byte precedes the lower order byte. This means that a 16-bit word is presented on the network as Most Significant Byte (MSB), followed by Least Significant Byte (LSB).

```
0xB4（10110100）

Big Endian
   MSB                            LSB
   --------------------------------->
   +---+---+---+---+---+---+---+---+
   | 1 | 0 | 1 | 1 | 0 | 1 | 0 | 0 |
   +---+---+---+---+---+---+---+---+

Little Endian
   LSB                             MSB
   --------------------------------->
   +---+---+---+---+---+---+---+---+
   | 0 | 0 | 1 | 0 | 1 | 1 | 0 | 1 |
   +---+---+---+---+---+---+---+---+
```

In signed binary numbers, it indicates a negative number when MSB=1, and positive number when MSB=0.
In unsigned binary numbers, MSB=1 is the largest number (2^n - 1).

### When Will The Server May Disconnect the Client?
*   A Client can only send the CONNECT Packet once over a Network Connection. The Server MUST process a second CONNECT Packet sent from a Client as a protocol violation and disconnect the Client 
*   If the protocol name is incorrect the Server MAY disconnect the Client, or it MAY continue processing the CONNECT packet in accordance with some other specification. In the latter case, the Server MUST NOT continue to process the CONNECT packet in line with this specification.
*   The Server MUST validate that the reserved flag in the CONNECT Control Packet is set to zero and disconnect the Client if it is not zero.
*   If the Keep Alive value is non-zero and the Server does not receive a Control Packet from the Client within one and a half times the Keep Alive time period, it MUST disconnect the Network Connection to the Client as if the network had failed.
*   If the Client supplies a zero-byte ClientId with CleanSession set to 0, the Server MUST respond to the CONNECT Packet with a CONNACK return code 0x02 (Identifier rejected) and then close the Network Connection
*   If the Server rejects the ClientId it MUST respond to the CONNECT Packet with a CONNACK return code 0x02 (Identifier rejected) and then close the Network Connection.
*    If the Server does not receive a CONNECT Packet within a reasonable amount of time after the Network Connection is established, the Server SHOULD close the connection.
*   The Server MUST validate the CONNECT Packet  and close the Network Connection without sending a CONNACK if it does not conform.
*   The Server MAY check that the contents of the CONNECT Packet meet any further restrictions and MAY perform authentication and authorization checks. If any of these checks fail, it SHOULD send an appropriate CONNACK response with a non-zero return code and it MUST close the Network Connection.
*   If a server sends a CONNACK packet containing a non-zero return code it MUST then close the Network Connection
*   If a Server or Client receives a PUBLISH Packet which has both QoS bits set to 1 (0x11) it MUST close the Network Connection.
*   If a Server implementation does not authorize a PUBLISH to be performed by a Client; it has no way of informing that Client. It MUST either make a positive acknowledgement, according to the normal QoS rules, or close the Network Connection
*   Bits 3,2,1 and 0 (Flags of the Control Packet) of the fixed header in the PUBREL Control Packet are reserved and MUST be set to 0,0,1 and 0 respectively. The Server MUST treat any other value as malformed and close the Network Connection.
*   Bits 3,2,1 and 0 (Flags of the Control Packet) of the fixed header of the SUBSCRIBE Control Packet are reserved and MUST be set to 0,0,1 and 0 respectively. The Server MUST treat any other value as malformed and close the Network Connection.
*   The Server MUST treat a SUBSCRIBE packet as malformed and close the Network Connection if any of Reserved bits in the payload are non-zero, or QoS is not 0,1 or 2

# MQTT Control Packet Format
```
+------------------------------------------
|                   |          | 
+-------------------+----------+-----------
|                   | CP  Flags|   
| Fixed header      +----------+   2 Bytes
|                   |  Remaing |   
+-------------------+----------+------------
|                   | PI MSB   |
~ Variable header   +----------+  Some
|                   | PI LSB   |   
+-------------------+----------+-------------
~ Payload           ~          ~  Some
+-----------------------+--------------------
```

## Fixed Header
```
+--------------------------------------+
| bit  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| Byte |    Control    |     Flags     |
|   1  |    Packet     |               |
+--------------------------------------+
|   2  |  Remaining Length             |
+--------------------------------------+
```
### Control Packet

1 byte = 4 bit = [0, 2^4 - 1]

```
Bit   7    6   5  4
+---------------------------------------------------------------
|CP|V|P|
+-----------------------------------------------------
| 0| | | Reseved    |         |
| 1| |Y| CONNECT    | C2S     |  
| 2| | | CONNACK    | S2C     | Connect ACK
| 3|?|?| PUBLISH    | C2S/S2C | Publish message
| 4|Y| | PUBACK     | C2S/S2C | Publish ACK
| 5|Y| | PUBREC     | C2S/S2C | Publish Received
| 6|Y| | PUBREL     | C2S/S2C | Publish Release
| 7|Y| | PUBCOMP    | C2S/S2C | Publish Complete
| 8|Y|Y| SUBSCRIBE  | C2S     |
| 9|Y|Y| SUBACK     | S2C     | Subscribe ACK
|10|Y|Y| UNSUBSCRIBE| C2S     |
|11|Y| | UNSUBACK   | S2C     | Unsubscribe ACK
|12| | | PINGREQ    | C2S     | Ping Request
|13| | | PINGRESP   | S2C     | Ping Response
|14| | | DISCONNECT | C2S     | Client is disconnecting
|15| | | Reserved   |         |
+----------------------------------------------------
```
* CP      : The value of conrol pakcet bit
* V       : Contains packet identifier filed (variable header), [? PUBLISH, if QoS > 0]
* P       : Requires payload, [? optional] [Y required]
* C2S     : Client to Server
* S2C     : Server to Client

### Flags
```
+----------------------------------------------------------------------+
|CP|Control Packet   |                    | bit3 | bit2 | bit1 |  bit0 |
+----------------------------------------------------------------------+
|
|           
| 3|  PUBLISH      |  Used in MQTT 3.1.1  | DUP  |      Qos    | RETAIN|
``` 
* CP      : The value of conrol pakcet bit
* DUP     : Duplicate delivery of a PUBLISH Control Packet
* QoS     : PUBLISH Quality of Service
         -  0: at most once delivery, [0, 1]
         -  1: at least once delivery, [1,]
         -  2: exactly once delivery, [1]
         -  3: reserved
* RETAIN  : PUBLISH Retain flag

### Remaining Length
Starts at byte 2

The Remaining Length is the number of bytes remaining within the current packet, including data in the variable header and the payload. The Remaining Length does not include the bytes used to encode the Remaining Length.
 
The Remaining Length is encoded using a variable length encoding scheme which uses a single byte for values up to 127. Larger values are handled as follows. The least significant seven bits of each byte encode the data, and the most significant bit is used to indicate that there are following bytes in the representation. Thus each byte encodes 128 values and a "continuation bit". The maximum number of bytes in the Remaining Length field is four.

## Variable Header
The variable header component of many of the Control Packet types includes a 2 byte Packet Identifier field. These Control Packets are PUBLISH (where QoS > 0), PUBACK, PUBREC, PUBREL, PUBCOMP, SUBSCRIBE, SUBACK, UNSUBSCRIBE, UNSUBACK.

> A PUBACK, PUBREC or PUBREL Packet MUST contain the same Packet Identifier as the PUBLISH Packet that was originally sent
> SUBSCRIBE, UNSUBSCRIBE, and PUBLISH (in cases where QoS > 0) Control Packets MUST contain a non-zero 16-bit Packet Identifier [MQTT-2.3.1-1]. Each time a Client sends a new packet of one of these types it MUST assign it a currently unused Packet Identifier [MQTT-2.3.1-2]. If a Client re-sends a particular Control Packet, then it MUST use the same Packet Identifier in subsequent re-sends of that packet. The Packet Identifier becomes available for reuse after the Client has processed the corresponding acknowledgement packet. In the case of a QoS 1 PUBLISH this is the corresponding PUBACK; in the case of QoS 2 it is PUBCOMP. For SUBSCRIBE or UNSUBSCRIBE it is the corresponding SUBACK or UNSUBACK [MQTT-2.3.1-3]. The same conditions apply to a Server when it sends a PUBLISH with QoS > 0 [MQTT-2.3.1-4].

> The Client and Server assign Packet Identifiers independently of each other. As a result, Client Server pairs can participate in concurrent message exchanges using the same Packet Identifiers.
 
```
[Client]                                                                                  [Server]
   PUBLISH Packet Identifier=0x1234--->
                                                    <--PUBLISH Packet Identifier=0x1234
   PUBACK Packet Identifier=0x1234--->
                                                    <--PUBACK Packet Identifier=0x1234
```

# MQTT Control Packets
## CONNECT - C2S
> After a Network Connection is established by a Client to a Server, the first Packet sent from the Client to the Server MUST be a CONNECT Packet.

> A Client can only send the CONNECT Packet once over a Network Connection. The Server MUST process a second CONNECT Packet sent from a Client as a protocol violation and disconnect the Client 

> The payload contains one or more encoded fields. They specify a unique Client identifier for the Client, a Will topic, Will Message, User Name and Password. All but the Client identifier are optional and their presence is determined based on flags in the variable header.

### Fixed Header For The CONNECT Packet
```
+--------------------------------------+
| bit  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
|      | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 |    Controp Packet Type: 1(CONNECT), Flags: 0 (Reserved)
+--------------------------------------+
|      |                               |
|  ... |      Remaining Length         |    Remaining Len = Var-Header Len + Payload Len
|      |                               |
+--------------------------------------+
```
> The value of Remaining Length = Variable Header Length + Payload Length

### Variable Header For The CONNECT Packet

```
+---+--------------------------------------
|B\b| 
+---+----------------------------------
| 1 |0|0|0|0|0|0|0|0|       Length MSB = 0
| 2 |0|0|0|0|0|1|0|0|       Length LSB = 4
| 3 |0|1|0|0|1|1|0|1|       77 = 'M'
| 4 |0|1|0|1|0|0|0|1|       81 = 'Q'
| 5 |0|1|0|1|0|1|0|0|       84 = 'T'
| 6 |0|1|0|1|0|1|0|0|       84 = 'T'
+---+---------------------------------------
| 7 |0|0|0|0|0|1|0|0|       Protocol Level = 4
+-------------------------------------------
| 8 |x|x|x| x |x|x|0|       Connect Flags
+--------------------------------------------
| 9 |0|0|0|0|0|0|0|0|        Keep Alive MSB = 0        
|10 |0|0|0|0|1|0|1|0|        Keep Alive LSB = 10
+-------------------------------------------
```

#### Protocol Name Of For The CONNECT Packet

The Protocol Name is a UTF-8 encoded string that represents the protocol name “MQTT”. The string, its offset and length will not be changed by future versions of the MQTT specification.

> If the protocol name is incorrect the Server MAY disconnect the Client, or it MAY continue processing the CONNECT packet in accordance with some other specification. In the latter case, the Server MUST NOT continue to process the CONNECT packet in line with this specification

#### Protocol Level For The CONNECT Packet
The Server MUST respond to the CONNECT Packet with a CONNACK return code 0x01 (unacceptable protocol level) and then disconnect the Client if the Protocol Level is not supported by the Server

#### Connect Flags For The CONNECT Packet
```
+----------+----------+--------+-------------+------+---------+----------+
|     7    |     6    |   5    |  4      3   |  2   |    1    |    0     |     
+----------+----------+--------+-------------+------+---------+----------+
| User Name| Password |  Will  |     Will    | Will |  Clean  | Reserved |
|   Flag   |    Flag  | Retain |     QoS     | Flag | Session |          |
+----------+----------+--------+-------------+------+---------+----------+
|    x     |     x    |   x    |      x      |   x  |    x    |     0    |
+----------+----------+--------+-------------+------+---------+----------+
```
The Server MUST validate that the reserved flag in the CONNECT Control Packet is set to zero and disconnect the Client if it is not zero.

##### Clean Session
The Client and Server can store Session state to enable reliable messaging to continue across a sequence of Network Connections. This bit is used to control the lifetime of the Session state. 

> If CleanSession is set to 0, the Server MUST resume communications with the Client based on state from the current Session (as identified by the Client identifier). If there is no Session associated with the Client identifier the Server MUST create a new Session. The Client and Server MUST store the Session after the Client and Server are disconnected.

> After the disconnection of a Session that had CleanSession set to 0, the Server MUST store further QoS 1 and QoS 2 messages that match any subscriptions that the client had at the time of disconnection as part of the Session state. It MAY also store QoS 0 messages that meet the same criteria.

> If CleanSession is set to 1, the Client and Server MUST discard any previous Session and start a new one. This Session lasts as long as the Network Connection. State data associated with this Session MUST NOT be reused in any subsequent Session

The Session state in the Client consists of:
- QoS 1 and QoS 2 messages which have been sent to the Server, but have not been completely acknowledged.
- QoS 2 messages which have been received from the Server, but have not been completely acknowledged. 

The Session state in the Server consists of:
- The existence of a Session, even if the rest of the Session state is empty.
- The Client’s subscriptions.
- QoS 1 and QoS 2 messages which have been sent to the Client, but have not been completely acknowledged.
- QoS 1 and QoS 2 messages pending transmission to the Client.
- QoS 2 messages which have been received from the Client, but have not been completely acknowledged.
- Optionally, QoS 0 messages pending transmission to the Client. 

> Retained messages do not form part of the Session state in the Server, they MUST NOT be deleted when the Session ends.

> Hence, to ensure that you do not lose messages while disconnected, use QoS 1 or QoS 2 with CleanSession set to 0.
 
 
##### Will Flag
The Server SHOULD publish Will Messages promptly. In the case of a Server shutdown or failure the server MAY defer publication of Will Messages until a subsequent restart. If this happens there might be a delay between the time the server experienced failure and a Will Message being published.

> If the Will Flag is set to 1 this indicates that, if the Connect request is accepted, a Will Message MUST be stored on the Server and associated with the Network Connection. The Will Message MUST be published when the Network Connection is subsequently closed unless the Will Message has been deleted by the Server on receipt of a DISCONNECT Packet.

Situations in which the Will Message is published include, but are not limited to:
*   An I/O error or network failure detected by the Server.
*   The Client fails to communicate within the Keep Alive time.
*   The Client closes the Network Connection without first sending a DISCONNECT Packet.
*   The Server closes the Network Connection because of a protocol error.

If the Will Flag is set to 1, the Will QoS and Will Retain fields in the Connect Flags will be used by the Server, and the Will Topic and Will Message fields MUST be present in the payload.

The Will Message MUST be removed from the stored Session state in the Server once it has been published or the Server has received a DISCONNECT packet from the Client.

If the Will Flag is set to 0 the Will QoS and Will Retain fields in the Connect Flags MUST be set to zero and the Will Topic and Will Message fields MUST NOT be present in the payload.

If the Will Flag is set to 0, a Will Message MUST NOT be published when this Network Connection ends.

##### Will QoS
If the Will Flag is set to 0, then the Will QoS MUST be set to 0 (0x00)

##### Will Retain
This bit specifies if the Will Message is to be Retained when it is published.
*   If the Will Flag is set to 0, then the Will Retain Flag MUST be set to 0.
*   If the Will Flag is set to 1:
        - If Will Retain is set to 0, the Server MUST publish the Will Message as a non-retained message
        - If Will Retain is set to 1, the Server MUST publish the Will Message as a retained message.
        
##### User Name Flag and Password Flag
*   If the User Name Flag is set to 0, a user name MUST NOT be present in the payload.
*   If the User Name Flag is set to 1, a user name MUST be present in the payload
*   If the Password Flag is set to 0, a password MUST NOT be present in the payload
*   If the Password Flag is set to 1, a password MUST be present in the payload
*   If the User Name Flag is set to 0, the Password Flag MUST be set to 0

#### Keep Alive
The Keep Alive is a time interval measured in seconds. The maximum value is 18 hours 12 minutes and 15 seconds. Expressed as a 16-bit word, it is the maximum time interval that is permitted to elapse between the point at which the Client finishes transmitting one Control Packet and the point it starts sending the next.

In the absence of sending any other Control Packets, the Client MUST send a PINGREQ Packet to keep alive.

If the Keep Alive value is non-zero and the Server does not receive a Control Packet from the Client within one and a half times the Keep Alive time period, it MUST disconnect the Network Connection to the Client as if the network had failed.

A Keep Alive value of zero (0) has the effect of turning off the keep alive mechanism. This means that, in this case, the Server is not required to disconnect the Client on the grounds of inactivity.

> Note that a Server is permitted to disconnect a Client that it determines to be inactive or non-responsive at any time, regardless of the Keep Alive value provided by that Client.

### Payload For The CONNECT Packet
The payload of the CONNECT Packet contains one or more length-prefixed fields, whose presence is determined by the flags in the variable header. These fields, if present, MUST appear in the order Client Identifier, Will Topic, Will Message, User Name, Password.

#### Client Identifier
The Client Identifier (ClientId) identifies the Client to the Server. Each Client connecting to the Server has a unique ClientId. The ClientId MUST be used by Clients and by Servers to identify state that they hold relating to this MQTT Session between the Client and the Server.

The Client Identifier (ClientId) MUST be present and MUST be the first field in the CONNECT packet payload.

The ClientId MUST be a UTF-8 encoded string.

The Server MUST allow ClientIds which are between 1 and 23 UTF-8 encoded bytes in length, and that contain only the characters `[\da-zA-Z]`

The Server MAY allow ClientId’s that contain more than 23 encoded bytes. The Server MAY allow ClientId’s that contain characters not included in the list given above. 

A Server MAY allow a Client to supply a ClientId that has a length of zero bytes, however if it does so the Server MUST treat this as a special case and assign a unique ClientId to that Client. It MUST then process the CONNECT packet as if the Client had provided that unique ClientId.

If the Client supplies a zero-byte ClientId, the Client MUST also set CleanSession to 1.

If the Client supplies a zero-byte ClientId with CleanSession set to 0, the Server MUST respond to the CONNECT Packet with a CONNACK return code 0x02 (Identifier rejected) and then close the Network Connection.

If the Server rejects the ClientId it MUST respond to the CONNECT Packet with a CONNACK return code 0x02 (Identifier rejected) and then close the Network Connection.

#### Will Topic And Will Message
If the Will Flag is set to 1, the Will Topic is the next field in the payload. The Will Topic MUST be a UTF-8 encoded string.

The Will Message field consists of a two byte length followed by the payload for the Will Message expressed as a sequence of zero or more bytes. The length gives the number of bytes in the data that follows and does not include the 2 bytes taken up by the length itself.

#### User Name And Password
 The Password field contains 0 to 65535 bytes of binary data prefixed with a two byte length field which indicates the number of bytes used by the binary data (it does not include the two bytes taken up by the length field itself).
```
Password Bytes
+---+---------------------------------
|B\b|
+---+---------------------------------
| 1 | Data Length MSB     
+---+---------------------------------    
| 2 | Data Length LSB
+---+---------------------------------
| 3 |  
~...~    Data, if length > 0
+---+---------------------------------
+-------------------------------------------
```

### Response
Note that a Server MAY support multiple protocols (including earlier versions of this protocol) on the same TCP port or other network endpoint. If the Server determines that the protocol is MQTT 3.1.1 then it validates the connection attempt as follows.
*    If the Server does not receive a CONNECT Packet within a reasonable amount of time after the Network Connection is established, the Server SHOULD close the connection.
*   The Server MUST validate the CONNECT Packet  and close the Network Connection without sending a CONNACK if it does not conform.
*   The Server MAY check that the contents of the CONNECT Packet meet any further restrictions and MAY perform authentication and authorization checks. If any of these checks fail, it SHOULD send an appropriate CONNACK response with a non-zero return code as described in section 3.2 and it MUST close the Network Connection.

If validation is successful the Server performs the following steps:
*   If the ClientId represents a Client already connected to the Server then the Server MUST disconnect the existing Client.
*   The Server MUST perform the processing of CleanSession.
*   The Server MUST acknowledge the CONNECT Packet with a CONNACK Packet containing a zero return code.
*   Start message delivery and keep alive monitoring.

Clients are allowed to send further Control Packets immediately after sending a CONNECT Packet; Clients need not wait for a CONNACK Packet to arrive from the Server. If the Server rejects the CONNECT, it MUST NOT process any data sent by the Client after the CONNECT Packet.

## CONNACT - S2C
> The first packet sent from the Server to the Client MUST be a CONNACK Packet.

### Fixed Header For the CONNACT packet
```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 |        Control Packet Type: 2(CONNECT), Flags: 0 (Reserved)
+--------------------------------------+
| 2 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |        Remaining Length = 2 = the length of the variable header
+--------------------------------------+                      
```


### Variable Header For the CONNACT Packet
```
+-------------------+
|B\b|7|6|5|4|3|2|1|0|
+-------------------+
| 1 |   Reserved  |#|        #: Session Present Flag
|   |0|0|0|0|0|0|0|X|        CONNACK Flags, 
+-------------------+
| 2 |X|X|X|X|X|X|X|X|        Connect Return Code
+-------------------+
```

#### CONNACK Flags
Bits 7 to 1 are reserved and MUST be set to 0. Bit 0(#) is the Session Present Flag.

If the Server accepts a connection with CleanSession set to 1, the Server MUST set Session Present to 0 in the CONNACK packet in addition to setting a zero return code in the CONNACK packet.

If the Server accepts a connection with CleanSession set to 0, the value set in Session Present depends on whether the Server already has stored Session state for the supplied client ID. If the Server has stored Session state, it MUST set Session Present to 1 in the CONNACK packet. If the Server does not have stored Session state, it MUST set Session Present to 0 in the CONNACK packet. This is in addition to setting a zero return code in the CONNACK packet.

The Client can discard the Session state on both Client and Server by disconnecting, connecting with Clean Session set to 1 and then disconnecting again. 

If a server sends a CONNACK packet containing a non-zero return code it MUST set Session Present to 0.

#### Connect Return Code For CONNACT Packet
If a well formed CONNECT Packet is received by the Server, but the Server is unable to process it for some reason, then the Server SHOULD attempt to send a CONNACK packet containing the appropriate non-zero Connect return code from this table. If a server sends a CONNACK packet containing a non-zero return code it MUST then close the Network Connection.

```
+-------------------------------------------------------
|0| 0x00 Connection Accepted
|1| 0x01 Connection Refused, unacceptable protocol version
|2| 0x02 Connection Refused, identifier rejected. Correct UTF-8 but not allowed by the Server
|3| 0x03 Connection Refused, Server unavailable.
|4| 0x04 Connection Refused, bad user name or password
|5| 0x05 Connection Refused, not authorized
|6-255  | Reserved
+---------------------------------------------------
```

If none of the return codes listed above, Connect Return code values are deemed applicable, then the Server MUST close the Network Connection without sending a CONNACK.

## PUBLISH Packet - C2S/S2C
### Fixed Header For the PUBLISH Packet
```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 | 0 | 0 | 1 | 1 |DUP|  Qos  |RET|        Control Packet Type: 3(PUBLISH), Flags: 
+--------------------------------------+
| 2 |                                        Remaining Length
+---------------------------------------
```

#### DUP Flag For The PUBLISH Packet
If the DUP(Destination User Prompter) flag is set to 0, it indicates that this is the first occasion that the Client or Server has attempted to send this MQTT PUBLISH Packet. If the DUP flag is set to 1, it indicates that this might be re-delivery of an earlier attempt to send the Packet.

The DUP flag MUST be set to 1 by the Client or Server when it attempts to re-deliver a PUBLISH Packet.

The DUP flag MUST be set to 0 for all QoS 0 messages.

The value of the DUP flag from an incoming PUBLISH packet is not propagated when the PUBLISH Packet is sent to subscribers by the Server. The DUP flag in the outgoing PUBLISH packet is set independently to the incoming PUBLISH packet, its value MUST be determined solely by whether the outgoing PUBLISH packet is a retransmission.

The recipient of a Control Packet that contains the DUP flag set to 1 cannot assume that it has seen an earlier copy of this packet.

#### RETAIN For The PUBLISH Packet
If the RETAIN flag is set to 1, in a PUBLISH Packet sent by a Client to a Server, the Server MUST store the Application Message and its QoS, so that it can be delivered to future subscribers whose subscriptions match its topic name.

When a new subscription is established, the last retained message, if any, on each matching topic name MUST be sent to the subscriber.
```php
<?php
    $c->onConnect(function() use ($c) {
        /**
         * publish($topic, $message, $Qos, $isRetain)
         */
        $c->publish('aa/test', 'Retain Message: Hello, Aario! '. uniqid() , 2, true);
        $c->publish('aa/test', 'Not Retain Message: Hello, Aario! '. uniqid() , 2);
    });
?>

a new subscription:
sh$ ./mosquitto_sub -v -t aa/test
    Retain Message: Hello, Aario! sdfasfsa                  <---- the last retained message

```


If the Server receives a QoS 0 message with the RETAIN flag set to 1 it MUST discard any message previously retained for that topic. It SHOULD store the new QoS 0 message as the new retained message for that topic, but MAY choose to discard it at any time - if this happens there will be no retained message for that topic.

When sending a PUBLISH Packet to a Client the Server MUST set the RETAIN flag to 1 if a message is sent as a result of a new subscription being made by a Client. It MUST set the RETAIN flag to 0 when a PUBLISH Packet is sent to a Client because it matches an established subscription regardless of how the flag was set in the message it received.

> A PUBLISH Packet with a RETAIN flag set to 1 and a payload containing zero bytes will be processed as normal by the Server and sent to Clients with a subscription matching the topic name. Additionally any existing retained message with the same topic name MUST be removed and any future subscribers for the topic will not receive a retained message. “As normal” means that the RETAIN flag is not set in the message received by existing Clients. A zero byte retained message MUST NOT be stored as a retained message on the Server.
```php
<?php
    $c->onConnect(function() use ($c) {
        /**
         * publish($topic, $message, $Qos, $isRetain)
         */
        $c->publish('aa/test', 'Retain Message: Hello, Aario! '. uniqid() , 2, true);
        $c->publish('aa/test', 'Not Retain Message: Hello, Aario! '. uniqid() , 2);
        $c->publish('aa/test', '' , 2, true);     // RETAIN = 1, and payload length = 0
    });
?>

a new subscriber will receive nothing.
sh$ ./mosquitto_sub -v -t aa/test

```

If the RETAIN flag is 0, in a PUBLISH Packet sent by a Client to a Server, the Server MUST NOT store the message and MUST NOT remove or replace any existing retained message.

Retained messages are useful where publishers send state messages on an irregular basis. A new subscriber will receive the most recent state.

### Variable Header For The PUBLISH Packet
```
sh$ mosquitto_pub -t Aario/Ai -m ...

+---+--------------------------------------
|B\b| 
+---+----------------------------------
| 1 |0|0|0|0|0|0|0|0|       Length MSB = 0
| 2 |0|0|0|0|0|1|0|0|       Length LSB = 5
| 3 |0|1|0|0|0|0|0|1|        65 = 'A'
| 4 |0|1|1|0|0|0|0|1|        97 = 'a'
| 5 |0|1|1|1|0|0|1|0|       114 = 'r'
| 6 |0|1|1|0|1|0|0|1|       105 = 'i'
| 7 |0|1|1|0|1|1|1|1|       111 = 'o'
| 8 |0|0|1|0|1|1|1|1|        47 = '/'
| 9 |0|1|0|0|0|0|0|1|       65  = 'A'
|10 |0|1|1|0|1|0|0|1|       105 = 'i'
+---+---------------------------------------
|11 |0|0|0|0|0|0|0|0|        Packet Identifier MSB = 0        
|12 |0|0|0|0|1|0|1|0|        Packet Identifier LSB = 10
+-------------------------------------------
```
#### Topic Name
The Topic Name in the PUBLISH Packet MUST NOT contain wildcard characters.

#### Packet Identifier
The Packet Identifier field is only present in PUBLISH Packets where the QoS level is 1 or 2.

### Payload For The PUBLISH Packet
The Payload contains the Application Message that is being published. The content and format of the data is application specific. The length of the payload can be calculated by subtracting the length of the variable header from the Remaining Length field that is in the Fixed Header. It is valid for a PUBLISH Packet to contain a zero length payload.

### Reponse For The PUBLISH Packet
*   QoS 0 : None
*   QoS 1 : PUBACK Packet
*   Qos 2 : PUBREC Packet

When Clients make subscriptions with Topic Filters that include wildcards, it is possible for a Client’s subscriptions to overlap so that a published message might match multiple filters. In this case the Server MUST deliver the message to the Client respecting the maximum QoS of all the matching subscription.

## PUBACK Packet - Response to PUBULISH QoS 1
A PUBACK Packet is the response to a PUBLISH Packet with QoS level 1.

### Fixed Header For The PUBACK Packet
```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 |        Control Packet Type: 4(PUBACK), Flags: 0 (Reserved)
+--------------------------------------+
| 2 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |        Remaining Length = 2 = the length of the variable header
+--------------------------------------+   
```
### Variable Header For The PUBACK Packet

```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 |  Packet Identifier MSB
+--------------------------------------+
| 2 |  Packet Identifier LSB
+--------------------------------------+   
```

## PUBREC - The 2nd Packet of the QoS 2
A PUBREC Packet is the response to a PUBLISH Packet with QoS 2.  It is the 2nd packet of the QoS 2 protocol exchange.
### Fixed Header For The PUBACK Packet
```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 | 0 | 1 | 0 | 1 | 0 | 0 | 0 | 0 |        Control Packet Type: 5(PUBREC), Flags: 0 (Reserved)
+--------------------------------------+
| 2 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |        Remaining Length = 2 = the length of the variable header
+--------------------------------------+   
```
### Variable Header For The PUBACK Packet

```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 |  Packet Identifier MSB
+--------------------------------------+
| 2 |  Packet Identifier LSB
+--------------------------------------+   
```

## PUBREL - The 3rd Packet of the QoS 2
A PUBREL Packet is the response to a PUBREC Packet. It is the 3rd packet of the QoS 2 protocol exchange.

### Fixed Header For The PUBREL Packet
```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 | 0 | 1 | 1 | 1 | 0 | 0 | 1 | 0 |        Control Packet Type: 6(PUBREL), Flags: 2 (Reserved)
+--------------------------------------+
| 2 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |        Remaining Length = 2 = the length of the variable header(Packet Identifier)
+--------------------------------------+   
```
Bits 3,2,1 and 0 (Flags of Control Packet) of the fixed header in the PUBREL Control Packet are reserved and MUST be set to 0,0,1 and 0 respectively. The Server MUST treat any other value as malformed and close the Network Connection.


## PUBCOMP - The 4th Packet of the QoS 2
The PUBCOMP Packet is the response to a PUBREL Packet. It is the fourth and final packet of the QoS 2 protocol exchange.
### Fixed Header For The PUBCOMP Packet
```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 | 0 | 1 | 1 | 0 | 0 | 0 | 0 | 0 |        Control Packet Type: 7(PUBCOMP), Flags: 0 (Reserved)
+--------------------------------------+
| 2 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |        Remaining Length = 2 = the length of the variable header (Packet Identifier)
+--------------------------------------+   
```

## SUBSCRIBE

### Fixed Header For The SUBSCRIBE Packet
```
+--------------------------------------+
|B\b| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| 1 | 1 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |        Control Packet Type: 8(SUBSCRIBE), Flags: 2 (Reserved)
+--------------------------------------+
| 2 |  Remaining Length = the length of the variable header(2 Bytes Packet Identifier) + Payload Length
+--------------------------------------+   
```
Bits 3,2,1 and 0 of the fixed header of the SUBSCRIBE Control Packet are reserved and MUST be set to 0,0,1 and 0 respectively. The Server MUST treat any other value as malformed and close the Network Connection.

### Payload For The SUBSCRIBE Packet
The payload of a SUBSCRIBE packet MUST contain at least one Topic Filter / QoS pair. A SUBSCRIBE packet with no payload is a protocol violation.

```
sh$ mosquitto_sub -t Aario/Ai -q 1 -t a/b -q 2

+---+--------------------------------------
|B\b| 
+---+----------------------------------
| 1 |0|0|0|0|0|0|0|0|       Length MSB = 0
| 2 |0|0|0|0|0|1|0|0|       Length LSB = 5
| 3 |0|1|0|0|0|0|0|1|        65 = 'A'
| 4 |0|1|1|0|0|0|0|1|        97 = 'a'
| 5 |0|1|1|1|0|0|1|0|       114 = 'r'
| 6 |0|1|1|0|1|0|0|1|       105 = 'i'
| 7 |0|1|1|0|1|1|1|1|       111 = 'o'
| 8 |0|0|1|0|1|1|1|1|        47 = '/'
| 9 |0|1|0|0|0|0|0|1|       65  = 'A'
|10 |0|1|1|0|1|0|0|1|       105 = 'i'
+---+---------------------------------------
|   |  Reserved |QoS|
|11 |0|0|0|0|0|0|0|1|         
+-------------------------------------------
|12 |0|0|0|0|0|0|0|0|       Length MSB = 0
|13 |0|0|0|0|0|1|0|0|       Length LSB = 3
|14 |0|1|1|0|0|0|0|1|        97 = 'a'
|15 |0|0|1|0|1|1|1|1|        47 = '/'
|16 |0|1|1|0|0|0|1|0|        98 = 'b'
+---+---------------------------------------
|   |  Reserved |QoS|
|17 |0|0|0|0|0|0|1|0|         
+-------------------------------------------
```

The Server MUST treat a SUBSCRIBE packet as malformed and close the Network Connection if any of Reserved bits in the payload are non-zero, or QoS is not 0,1 or 2.

### Response To The SUBSCRIBE Packet
When the Server receives a SUBSCRIBE Packet from a Client, the Server MUST respond with a SUBACK Packet that has the same Packet Identifier.

The Server is permitted to start sending PUBLISH packets matching the Subscription before the Server sends the SUBACK Packet.
