[MQTT](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718013)
# Data Representation
Integer data values are 16 bits in big-endian order: the high order byte precedes the lower order byte. This means that a 16-bit word is presented on the network as Most Significant Byte (MSB), followed by Least Significant Byte (LSB).

# MQTT Control Packet Format
```
+------------------------------------------
|                   |          | 
+-------------------+----------+-----------
|                   | CP  Flags|   
| Fixed header      +----------+   2 Bytes
|                   |  Remaing |   
+-------------------+----------+------------
|                   | PI MSB   |
~ Variable header   +----------+  Some
|                   | PI LSB   |   
+-------------------+----------+-------------
~ Payload           ~          ~  Some
+-----------------------+--------------------
```

## Fixed Header
```
+--------------------------------------+
| bit  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| Byte |    Control    |     Flags     |
|   1  |    Packet     |               |
+--------------------------------------+
|   2  |  Remaining Length             |
+--------------------------------------+
```
### Control Packet

1 byte = 4 bit = [0, 2^4 - 1]

```
Bit   7    6   5  4
+---------------------------------------------------------------
|CP|V|P|
+-----------------------------------------------------
| 0| | | Reseved    |         |
| 1| |*| CONNECT    | C2S     |  
| 2| | | CONNACK    | S2C     | Connect ACK
| 3|?|?| PUBLISH    | C2S/S2C |  Publish message
| 4|Y| | PUBACK     | C2S/S2C | Publish ACK
| 5|Y| | PUBREC     | C2S/S2C | Publish Received
| 6|Y| | PUBREL     | C2S/S2C | Publish Release
| 7|Y| | PUBCOMP    | C2S/S2C | Publish Complete
| 8|Y|*| SUBSCRIBE  | C2S     |
| 9|Y|*| SUBACK     | S2C     | Subscribe ACK
|10|Y|*| UNSUBSCRIBE| C2S     |
|11|Y| | UNSUBACK   | S2C     | Unsubscribe ACK
|12| | | PINGREQ    | C2S     | Ping Request
|13| | | PINGRESP   | S2C     | Ping Response
|14| | | DISCONNECT | C2S     | Client is disconnecting
|15| | | Reserved   |         |
+----------------------------------------------------
```
* CP      : The value of conrol pakcet bit
* V       : Contains packet identifier filed (variable header), [? PUBLISH, if QoS > 0]
* P       : Requires payload, [? optional] [* required]
* C2S     : Client to Server
* S2C     : Server to Client
### Flags
```
+----------------------------------------------------------------------+
|CP|Control Packet   |                    | bit3 | bit2 | bit1 |  bit0  |
+----------------------------------------------------------------------+
|
|           
| 3|  PUBLISH      |  Used in MQTT 3.1.1  | DUP  | QoS  | Qos  | RETAIN |
``` 
* CP       : The value of conrol pakcet bit
* DUP     : Duplicate delivery of a PUBLISH Control Packet
* QoS     : PUBLISH Quality of Service
         -  0: at most once, [0, 1]
         -  1: at least once, [1,]
         -  2: only once, [1]
         -  3: reserved
* RETAIN  : PUBLISH Retain flag

### Remaining Length
Starts at byte 2

The Remaining Length is the number of bytes remaining within the current packet, including data in the variable header and the payload. The Remaining Length does not include the bytes used to encode the Remaining Length.
 
The Remaining Length is encoded using a variable length encoding scheme which uses a single byte for values up to 127. Larger values are handled as follows. The least significant seven bits of each byte encode the data, and the most significant bit is used to indicate that there are following bytes in the representation. Thus each byte encodes 128 values and a "continuation bit". The maximum number of bytes in the Remaining Length field is four.

## Variable Header
The variable header component of many of the Control Packet types includes a 2 byte Packet Identifier field. These Control Packets are PUBLISH (where QoS > 0), PUBACK, PUBREC, PUBREL, PUBCOMP, SUBSCRIBE, SUBACK, UNSUBSCRIBE, UNSUBACK.

> A PUBACK, PUBREC or PUBREL Packet MUST contain the same Packet Identifier as the PUBLISH Packet that was originally sent
> SUBSCRIBE, UNSUBSCRIBE, and PUBLISH (in cases where QoS > 0) Control Packets MUST contain a non-zero 16-bit Packet Identifier [MQTT-2.3.1-1]. Each time a Client sends a new packet of one of these types it MUST assign it a currently unused Packet Identifier [MQTT-2.3.1-2]. If a Client re-sends a particular Control Packet, then it MUST use the same Packet Identifier in subsequent re-sends of that packet. The Packet Identifier becomes available for reuse after the Client has processed the corresponding acknowledgement packet. In the case of a QoS 1 PUBLISH this is the corresponding PUBACK; in the case of QoS 2 it is PUBCOMP. For SUBSCRIBE or UNSUBSCRIBE it is the corresponding SUBACK or UNSUBACK [MQTT-2.3.1-3]. The same conditions apply to a Server when it sends a PUBLISH with QoS > 0 [MQTT-2.3.1-4].

> The Client and Server assign Packet Identifiers independently of each other. As a result, Client Server pairs can participate in concurrent message exchanges using the same Packet Identifiers.
 
```
[Client]                                                                                  [Server]
   PUBLISH Packet Identifier=0x1234--->
                                                    <--PUBLISH Packet Identifier=0x1234
   PUBACK Packet Identifier=0x1234--->
                                                    <--PUBACK Packet Identifier=0x1234
```

# MQTT Control Packets
## CONNECT - C2S
> After a Network Connection is established by a Client to a Server, the first Packet sent from the Client to the Server MUST be a CONNECT Packet.

> A Client can only send the CONNECT Packet once over a Network Connection. The Server MUST process a second CONNECT Packet sent from a Client as a protocol violation and disconnect the Client 

> The payload contains one or more encoded fields. They specify a unique Client identifier for the Client, a Will topic, Will Message, User Name and Password. All but the Client identifier are optional and their presence is determined based on flags in the variable header.

### Fixed Header For The CONNECT Packet
```
+--------------------------------------+
| bit  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
|      | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 |        Controp Packet Type: 1(CONNECT), Flags: 0
+--------------------------------------+
|      |                               |
|  ... |      Remaining Length         |
|      |                               |
+--------------------------------------+
```
> The value of Remaining Length = Variable Header Length + Payload Length

### Variable Header For The CONNECT Packet's 
#### Protocol Name Of For The CONNECT Packet

The Protocol Name is a UTF-8 encoded string that represents the protocol name “MQTT”. The string, its offset and length will not be changed by future versions of the MQTT specification.

```
+----+--------------------------------------
     | 
+----+----------------------------------
|  1 |0|0|0|0|0|0|0|0|       Length MSB  = 0
|  2 |0|0|0|0|0|1|0|0|       Length LSB  = 4
|  3 |0|1|0|0|1|1|0|1|       77 = 'M'
|  4 |0|1|0|1|0|0|0|1|       81 = 'Q'
|  5 |0|1|0|1|0|1|0|0|       84 = 'T'
|  6 |0|1|0|1|0|1|0|0|       84 = 'T'
+----+---------------------------------------
|  7 |0|0|0|0|0|1|0|0|       Protocol Level = 4
+--------------------------------------------
|  8 |x|x|x| x |x|x|0|       Connect Flags
+---------------------------------------------
```

> If the protocol name is incorrect the Server MAY disconnect the Client, or it MAY continue processing the CONNECT packet in accordance with some other specification. In the latter case, the Server MUST NOT continue to process the CONNECT packet in line with this specification

#### Protocol Level For The CONNECT Packet
The Server MUST respond to the CONNECT Packet with a CONNACK return code 0x01 (unacceptable protocol level) and then disconnect the Client if the Protocol Level is not supported by the Server

#### Connect Flags For The CONNECT Packet
```
+----------+----------+--------+-------------+------+---------+----------+
|     7    |     6    |   5    |  4      3   |  2   |    1    |    0     |     
+----------+----------+--------+-------------+------+---------+----------+
| Username | Password |  Will  |     Will    | Will |  Clean  | Reserved |
|   Flag   |    Flag  | Retain |     QoS     | Flag | Session |          |
+----------+----------+--------+-------------+------+---------+----------+
|    x     |     x    |   x    |      x      |   x  |    x    |     0    |
+----------+----------+--------+-------------+------+---------+----------+
```
The Server MUST validate that the reserved flag in the CONNECT Control Packet is set to zero and disconnect the Client if it is not zero.

#### Clean Session
The Client and Server can store Session state to enable reliable messaging to continue across a sequence of Network Connections. This bit is used to control the lifetime of the Session state. 

> If CleanSession is set to 0, the Server MUST resume communications with the Client based on state from the current Session (as identified by the Client identifier). If there is no Session associated with the Client identifier the Server MUST create a new Session. The Client and Server MUST store the Session after the Client and Server are disconnected.

> After the disconnection of a Session that had CleanSession set to 0, the Server MUST store further QoS 1 and QoS 2 messages that match any subscriptions that the client had at the time of disconnection as part of the Session state. It MAY also store QoS 0 messages that meet the same criteria.

> If CleanSession is set to 1, the Client and Server MUST discard any previous Session and start a new one. This Session lasts as long as the Network Connection. State data associated with this Session MUST NOT be reused in any subsequent Session

The Session state in the Client consists of:
- QoS 1 and QoS 2 messages which have been sent to the Server, but have not been completely acknowledged.
- QoS 2 messages which have been received from the Server, but have not been completely acknowledged. 

The Session state in the Server consists of:
- The existence of a Session, even if the rest of the Session state is empty.
- The Client’s subscriptions.
- QoS 1 and QoS 2 messages which have been sent to the Client, but have not been completely acknowledged.
- QoS 1 and QoS 2 messages pending transmission to the Client.
- QoS 2 messages which have been received from the Client, but have not been completely acknowledged.
- Optionally, QoS 0 messages pending transmission to the Client. 

> Retained messages do not form part of the Session state in the Server, they MUST NOT be deleted when the Session ends.

> Hence, to ensure that you do not lose messages while disconnected, use QoS 1 or QoS 2 with CleanSession set to 0.
 