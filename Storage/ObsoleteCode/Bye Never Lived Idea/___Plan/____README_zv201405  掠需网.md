君子掠需，万邦之屏。
================================================================================   
上掠需，抢需求！
================================================================================

# 技术难点

为了练习技术，就构思出一个项目（和公司的业务不冲突）。如何在一台服务器上做好代码分离以及合并，要保证代码以后分离方便。  

考虑到前期资金短缺，就需要将网页端和API都放在一台服务器上。这时候技术瓶颈就是既要
分开API（方便手机端调用），又要糅合网页端与API，为了减少TCP/IP再次连接性能损耗，
我架构的方案是将API放在网页端内部（之前构思过再次通过HTTP调用，后来到TCP/IP 方案调用API，
最后才设计到直接内部调用函数）。

由于以前积累的经验，以及一直坚持的HTML/CSS/JS/PHP/MySQL分离的理念，以及以前写的模板
代码。我就在这里进行了优化。翻阅了大量的架构资料，后来选择了类似MVP的设计风格，最开始
是类似MVC的，但是后来发现在设计API的时候，很容易造成局部混乱。下面会对这个架构详细说明。

 
# 技术方面

以前有用过Yii框架，而且当初在写一个网站的时候（考虑用API的方式写网站，来匹配移动互联网时代的发展），当时在写那个网站的时候，其实也算是在练习技术，所以我就没有用框架。其实当初想要用Yii框架开发的，后来考虑了一下，无论是从学习架构技术、让代码更简洁、同时提供数据给网页、手机网页以及iOS/Android应用，当时就决定自己写架构。  

当然在此之前，我是一点架构基础都没有的，而且技术水平不是很好。于是我就从网上找了大量关于网站架构相关的书籍资料，但是没有发现系统的网站架构的书籍。只能找到一些资料，于是看完资料之后，以及结合以前一直用原生态 PHP/JS 写网站时候遇到的坑（前期代码如果没有合理的规划，html php mysql如果过度交叉在一起，会导致网站开发到后期越来越难以修改、维护），所以我粗略的按照MVC模式，以及由于Yii框架基础，我就大量参考Yii框架设计，并采用了我写的正则匹配的模版开发语法独立了 View（没有选用Smarty，是因为当时看了Smarty，但是smarty太过于繁琐了，包括把各种缓存都已经写好了，当时时间紧迫，而且又不忍放弃以前一直坚持又不断想要放弃的模版语法。）然后采用json写接口，提供了controller / Module 来分开功能。  

这样解除了大量的代码耦合。但是写完之后，包括利用模版语言都运行正常、网页也写好了一部分demon。但是发现大量的SQL语句在Module里面太过于耦合，乱七八糟（获取链接字段，为了安全又不能和数据库字段相同，然后从数据库传出的字段又要不相同），而且我不是一个专业的DBA，当时就再考虑为什么不让专业的DBA去设计数据库，然后让DBA去写数据库语句，我只要把这个数据库语句独立出来，那么就可以做到了。  

于是我又从百度、谷歌翻阅了大量中英文架构方面的资料，然后就推翻了那一个版本查到了一个MVP的架构思想，貌似和我的这个独立数据库写法的思路有相似的点，于是我就查阅了很多MVP的架构思路。当然由于没有基础，所以任何阅览都是一知半解。于是就开始用一知半解的MVP思路以及我以前遇到的那些坑，又开始写了起来。在独立数据库语句的时候，我用了很多方法，但是都是特别不成功。因为又要保证传进去的字段名不乱、而且又要保证传进去的字段名和数据库的字段名不一样，还有传出来也一样，我就用了很多办法。包括用 define() 的方式来存储字段名。当然这个阶段，我已经放弃了我以前自己写的JS函数包，开始使用jQuery了。  

后来这个版本就这样写好了，然后又修复了一些我写的模版语句的一些bug。但是新的瓶颈又出现了，就是和手机APP交互过程中的安全问题、以及不用http请求，直接用tcp/ip的方式请求，而且涉及到 sos.luexu.com 的单点登陆跨域问题，第一方案是允许所有  *.luexu.com 都共享sso.luexu.com 下面的一个登陆成功信息cookie。当然也考虑到了独立session服务器的方案（但是我当时设计的所有架构思路是：前期只能用一台服务器，但是要求方便很快速的拆分，独立静态文件到其他域名，避免cookie损耗，以及要求以后把界面和API数据调取快速拆分，所以我决定开始把 API放在界面目录下面，当同一台服务器的时候，直接从API目录获取数据，来节省tcp/ip 的请求损耗；而且利用虚拟主机技术，让手机端调用直接调用  api.luexu.com （其实是界面目录下的 /_api 文件)，这样实现性能优化以及分工。  

于是频繁的API请求，我就考虑到http的损耗，以及json格式的性能劣势。于是查阅了大量资料，确定了Facebook的Thrift以及谷歌的Protobuf，虽然总体而言Protobuf更有优势。但是Thrift提供了对Tcp/Ip 的简单封装（好像是这样），于是当时就选择了Thrift来做API数据。  

然后经过不断的改变、修复bug，包括把模版标签在主流编辑器上更友好的显示（之前设计过几种模版界定符，由于我正则很好，所以用起来都很好，但是后来在实际写的时候，发现写多了的话，编辑器并不能对这些模版界定符友好显示，于是不断修正）。当时翻阅很多资料的时候，又看到一些DAL等相关的知识点，于是就不断修整思路，而且后来对APi进行性能测试的时候，发现在define()上面性能耗费最大，于是删除了所有define()模式，采用类来封装URL传递来的参数名以及数据库字段名，然后彻底实现独立MySQL语句，后来形成了那个半成品的技术。  


2014年5月的这个其实是个半成品，业余时间用来练技术的，但是其实之前有两个版本，用了很长时间才不断的
除Bug、推陈出新、整体改版，才到现在这个阶段的一个半成品。  

由于考虑到要跨手机端、网页端，为了优化代码管理，我采用的API式的数据获取。当时就
在查找一些基础架构的书籍，但是没有PHP这方面系统的书籍，只能不停的找资料。最开始
设计的两个方案，代码写到一定时期就会出现技术瓶颈、或者思路阻塞，然后就会去翻阅
架构类的资料。  

当前这个版本是基于Thrift的API，其实前两个版本的一个是基于纯自定义格式的，第二个是
基于jSON格式的。  

## 模板目录 

/___/ 这个目录里面就是模板文件，而 /sso/ 就是模板文件生成的测试文件，里面即使有bug，
也可能是我故意留的，因为当时一直在测模板文件。  

模板文件夹下， /lang/ 目录就是对文字、URL参数变量以及URL等的语言类包，理解起来并不难。
/tpl/ 是网站文件结构，写整个网站都在这里面。任何以 .tpl 结尾的，都是模板文件。  

具体可以看看 /___/tpl/sso/index.php.tpl 和 sign_in.html.tpl 模板文件
与 上述 /sso/ 生成的文件。再重写我的模板代码的时候，我一定程度上参考了smarty，
不过后来发现有些编辑器对这些界定符不太友善，所以改过很多次模板界定符的写法。也就是
上面所说的可能会有bug，可能是出自修改了模板界定符，却没有及时修改模板文件。  
  
/tpl_inc/ 就是对模板文件重复、或者使代码更独立、清晰的去写的目录，这里面的文件也
可以用模板语言写，然后引入到模板文件中。  

## API 整个架构思想

架构思路不好讲述，毕竟技术很菜，就公开一些  /_api/__Plan/ 下面的一些资料吧：

### 公开大部分架构图（很菜勿喷）

技术架构图：https://raw.githubusercontent.com/vince-well/Obsolete_To-my-lost-youth/master/____README_zv201405%20%E6%8E%A0%E9%9C%80%E7%BD%91%20%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg

架构简图：https://raw.githubusercontent.com/vince-well/Obsolete_To-my-lost-youth/master/____README_zv201405%20%E6%8E%A0%E9%9C%80%E7%BD%91%20API%20%E6%9E%B6%E6%9E%84%E7%AE%80%E5%9B%BE.jpeg

架构简图2：https://raw.githubusercontent.com/vince-well/Obsolete_To-my-lost-youth/master/____README_zv201405%20%E6%8E%A0%E9%9C%80%E7%BD%91%20API%20%E6%9E%B6%E6%9E%84%E7%AE%80%E5%9B%BE2.jpeg

一部分的URL规划设计：https://raw.githubusercontent.com/vince-well/Obsolete_To-my-lost-youth/master/____README_zv201405%20%E6%8E%A0%E9%9C%80%E7%BD%91%20%E4%B8%80%E9%83%A8%E5%88%86URL%E8%A7%84%E5%88%92.jpeg


手机版产品设计：https://raw.githubusercontent.com/vince-well/Obsolete_To-my-lost-youth/master/____README_zv201405%20%E6%8E%A0%E9%9C%80%E7%BD%91%20%E7%AE%80%E5%8D%95%E8%AE%BE%E8%AE%A1.jpeg

### 简单介绍一下结构

由于最近搬家，今天请假一天。本想今天收拾东西的，但是还是准备先写完这个吧。
/C/ 就是公用类，原本准备在 https://github.com/vince-well/PHP_CoreClass  里面重写。
但是后来学了C++扩展PHP，所以一定时间内决定就没有先重写这个部分，看看以后能不能
直接用C++写公用类部分。  

/Conf/ 就是配置文件  

/Ctrl/  负责接收用户传递来的信息，然后转发到 /Mdl/ 数据传递 或者 /Flt/ 过滤等操作，
这里仅仅是接收信息、过滤接收的信息、封装从/Mdl/接收来的信息、反馈信息的地方。  

/Mdl/ 数据操作部分，包括 Session、缓存、以及数据库的读写。  

/Mdl/Dal/  里面是数据库语句，为了实现DBA写数据库语句，我设计了彻底独立数据库语句
的方式。这个其实耗费我很多时间去架构这个，因为和其他部分耦合太严重了，特别是字段名
和输出的key名的映射关系，非常耦合，当然后来找到了方法绕了很多圈解决了这个问题。

/View/ 就是API的模板部分，比如发邮件的模板  

/cig-bin/ 里面是一些独立的文件格式，比如验证码图片、其他生成的格式文件

/e/ 就是第三方扩展  

/tpl/ 就是模板文件  

/1/ 就是 API 第一版



















