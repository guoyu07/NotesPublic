<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>交叉制表--列头和行头数据类型(5)</B><BR>--get&nbsp;standard&nbsp;data&nbsp;type&nbsp;of&nbsp;@chrcolhead&nbsp;column<BR>select&nbsp;@chvtemp=t2.name<BR>from&nbsp;sysobjects&nbsp;o<BR>&nbsp;&nbsp;&nbsp;&nbsp;join&nbsp;syscolumns&nbsp;c&nbsp;on&nbsp;(o.id=c.id)<BR>&nbsp;&nbsp;&nbsp;&nbsp;join&nbsp;systypes&nbsp;t1&nbsp;on&nbsp;(t1.usertype=c.usertype)<BR>&nbsp;&nbsp;&nbsp;&nbsp;join&nbsp;systypes&nbsp;t2&nbsp;on(t1.type=t2.type)<BR>&nbsp;&nbsp;where&nbsp;t2.usertype&lt;100&nbsp;and&nbsp;t2.usertype&lt;&gt;18&nbsp;and&nbsp;t2.usertype&lt;&gt;80&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;and&nbsp;o.type&nbsp;in(''''u'''',''''v'''')<BR>&nbsp;&nbsp;&nbsp;and&nbsp;o.name=@chrsource&nbsp;and&nbsp;c.name=@chrcolhead
<P></P>
<P>if&nbsp;upper(@chvtemp)&nbsp;not&nbsp;in(''''char'''',''''varchar'''')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@intcoltype=1<BR>&nbsp;&nbsp;else&nbsp;select&nbsp;@intcoltype=0<BR>--get&nbsp;standard&nbsp;data&nbsp;type&nbsp;of&nbsp;@chrrowhead<BR>&nbsp;&nbsp;select&nbsp;@chvrowtype=t2.name<BR>&nbsp;&nbsp;from&nbsp;sysobjects&nbsp;o<BR>&nbsp;&nbsp;join&nbsp;syscolumns&nbsp;c&nbsp;on&nbsp;(o.id=c.id)<BR>&nbsp;&nbsp;join&nbsp;systypes&nbsp;t1&nbsp;on&nbsp;(t1.usertype&nbsp;=c.usertype)<BR>&nbsp;&nbsp;join&nbsp;systypes&nbsp;t2&nbsp;on(t1.type=t2.type)<BR>&nbsp;&nbsp;where&nbsp;t2.usertype&lt;100&nbsp;and&nbsp;t2.usertype&lt;&gt;18&nbsp;and&nbsp;t2.usertype&lt;&gt;80&nbsp;&nbsp;<BR>&nbsp;&nbsp;and&nbsp;o.type&nbsp;in(''''u'''',''''v'''')&nbsp;and&nbsp;o.name=@chrsource&nbsp;and&nbsp;c.name=@chrrowhead<BR>&nbsp;if&nbsp;upper(@chvrowtype)not&nbsp;in&nbsp;(''''char'''',''''varchar'''')<BR>&nbsp;&nbsp;select&nbsp;@introwtype=1&nbsp;<BR>&nbsp;else&nbsp;select&nbsp;@introwtype=0<BR>--categorize&nbsp;types&nbsp;for&nbsp;grouping&nbsp;check<BR>&nbsp;select&nbsp;@inttemp=case<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;@chvtemp&nbsp;in(''''int'''',''''smallint'''',''''tinyint'''',''''float'''',''''real'''',''''decimal'''',''''numeric'''',''''money'''',''''smallmoney'''')&nbsp;then&nbsp;1<BR>&nbsp;when&nbsp;@chvtemp&nbsp;in&nbsp;(''''datetime'''',''''smalldatetime''''&nbsp;)then&nbsp;3<BR>&nbsp;when&nbsp;@chvtemp&nbsp;in&nbsp;(''''bit'''',''''char'''',''''varchar'''')&nbsp;then&nbsp;5<BR>&nbsp;else&nbsp;100&nbsp;end<BR>--validate&nbsp;existing&nbsp;data&nbsp;type&nbsp;is&nbsp;consistant&nbsp;with&nbsp;selected&nbsp;grouping<BR>&nbsp;if&nbsp;(@inttemp=5&nbsp;and&nbsp;@ingrouping&gt;0)&nbsp;or&nbsp;(@inttemp=1&nbsp;and&nbsp;@inygrouping&gt;0)&nbsp;or<BR>&nbsp;&nbsp;&nbsp;&nbsp;(@inttemp=3&nbsp;and&nbsp;@inygrouping=0)<BR>begin<BR>&nbsp;&nbsp;&nbsp;raiserror&nbsp;51030&nbsp;''''crosstab&nbsp;grouping&nbsp;not&nbsp;valid&nbsp;with&nbsp;@chrcolhead&nbsp;definition.''''<BR>&nbsp;&nbsp;&nbsp;return&nbsp;-1<BR>end&nbsp;&nbsp;<BR>最后的代码验证列数据类型与日期分组参数的一致性.如果列数据是一个日期,日期分组必须在1和5之间,否则日期分组必须为0.</P></FONT>