<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Data&nbsp;Retrieval</B><BR>Data&nbsp;Retrieval&nbsp;Script
<P></P>
<P></P>
<P><BR>This&nbsp;stored&nbsp;procedure&nbsp;is&nbsp;a&nbsp;refinement&nbsp;of&nbsp;work&nbsp;previously&nbsp;done&nbsp;by&nbsp;Sumit&nbsp;Dhingra.&nbsp;It&nbsp;takes&nbsp;a&nbsp;string&nbsp;argument&nbsp;of&nbsp;fields&nbsp;delimited&nbsp;by&nbsp;the&nbsp;3rd&nbsp;argument&nbsp;character,&nbsp;or&nbsp;a&nbsp;comma&nbsp;if&nbsp;the&nbsp;3rd&nbsp;argument&nbsp;is&nbsp;missing,&nbsp;and&nbsp;applies&nbsp;each&nbsp;field&nbsp;to&nbsp;the&nbsp;second&nbsp;argument&nbsp;which&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;SQL&nbsp;statement&nbsp;or,&nbsp;more&nbsp;usually,&nbsp;a&nbsp;stored&nbsp;procedure.&nbsp;</P>
<P>Example:&nbsp;</P>
<P>sp_ForEach&nbsp;"table1,table2,table3","sp_spaceused"</P>
<P>Author:&nbsp;Tony&nbsp;Zackin&nbsp;</P>
<P><BR>if&nbsp;exists&nbsp;(select&nbsp;name&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;name&nbsp;=&nbsp;"sp_ForEach"&nbsp;and&nbsp;type&nbsp;=<BR>"P")&nbsp;<BR>drop&nbsp;proc&nbsp;sp_ForEach<BR>go</P>
<P>/*--------------------------------------------------------------------------<BR>------------------------------------<BR>Based&nbsp;on&nbsp;code&nbsp;created&nbsp;by&nbsp;Sumit&nbsp;Dhingra</P>
<P>This&nbsp;proc&nbsp;takes&nbsp;a&nbsp;string&nbsp;argument&nbsp;of&nbsp;fields&nbsp;delimited&nbsp;by&nbsp;the&nbsp;3rd&nbsp;argument<BR>character,<BR>or&nbsp;a&nbsp;comma&nbsp;if&nbsp;the&nbsp;3rd&nbsp;argument&nbsp;is&nbsp;missing,&nbsp;and&nbsp;applies&nbsp;each&nbsp;field&nbsp;to&nbsp;the<BR>second<BR>argument&nbsp;which&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;SQL&nbsp;statement&nbsp;or,&nbsp;more&nbsp;usually,&nbsp;a&nbsp;stored<BR>procedure.</P>
<P>Example:&nbsp;sp_ForEach&nbsp;"table1,table2,table3","sp_spaceused"</P>
<P>----------------------------------------------------------------------------<BR>----------------------------------*/</P>
<P>CREATE&nbsp;PROCEDURE&nbsp;sp_ForEach<BR>@ParamStr&nbsp;Varchar(1000),&nbsp;--&nbsp;delimited&nbsp;string<BR>@cmd&nbsp;Varchar(500),&nbsp;--&nbsp;command&nbsp;to&nbsp;issue&nbsp;for&nbsp;each<BR>substring<BR>@delim&nbsp;Char(1)&nbsp;=&nbsp;","&nbsp;--&nbsp;default&nbsp;delimiter<BR>AS</P>
<P><BR>SET&nbsp;NOCOUNT&nbsp;ON</P>
<P>/*&nbsp;Declare&nbsp;Variables&nbsp;*/<BR>DECLARE&nbsp;@Field&nbsp;Varchar(100)&nbsp;<BR>DECLARE&nbsp;@ctr&nbsp;Int<BR>DECLARE&nbsp;@posctr&nbsp;Int<BR>DECLARE&nbsp;@commaPos&nbsp;Int<BR>DECLARE&nbsp;@paramLen&nbsp;Int<BR>DECLARE&nbsp;@findposinparamstr&nbsp;Varchar(200)</P>
<P><BR>/*&nbsp;Initialize&nbsp;the&nbsp;Variables&nbsp;*/<BR>SET&nbsp;@paramLen&nbsp;=&nbsp;len(@ParamStr)<BR>SET&nbsp;@findposinparamstr&nbsp;=&nbsp;@ParamStr<BR>SET&nbsp;@posctr&nbsp;=&nbsp;1<BR>SET&nbsp;@ctr&nbsp;=&nbsp;0</P>
<P><BR>/*&nbsp;Loop&nbsp;through&nbsp;the&nbsp;Comma&nbsp;Delimited&nbsp;String&nbsp;and&nbsp;pick&nbsp;up&nbsp;the&nbsp;individual&nbsp;values<BR>(Fields)&nbsp;*/<BR>WHILE&nbsp;@posctr&nbsp;&lt;&nbsp;@paramLen<BR>BEGIN<BR>SET&nbsp;@commaPos&nbsp;=&nbsp;patindex('%'+@delim+'%',@findposinparamstr)</P>
<P>IF&nbsp;(@commaPos&nbsp;&lt;&gt;&nbsp;0)<BR>BEGIN<BR>SET&nbsp;@Field&nbsp;=&nbsp;ltrim(substring(@ParamStr,@posctr,@commaPos-1))<BR>exec&nbsp;(@cmd+"&nbsp;"+@Field)<BR>END<BR>ELSE&nbsp;/*&nbsp;@commaPos&nbsp;&lt;&gt;&nbsp;0&nbsp;*/<BR>Break</P>
<P>SET&nbsp;@posctr&nbsp;=&nbsp;@posctr&nbsp;+&nbsp;@commaPos&nbsp;--&nbsp;Set&nbsp;this<BR>to&nbsp;starting&nbsp;position&nbsp;for&nbsp;next&nbsp;element.<BR>SET&nbsp;@findposinparamstr&nbsp;=&nbsp;substring(@findposinparamstr,(@commapos&nbsp;+<BR>1),(len(@findposinparamstr)-@commapos))<BR>SET&nbsp;@ctr&nbsp;=&nbsp;@ctr&nbsp;+&nbsp;1<BR>END&nbsp;/*&nbsp;End&nbsp;of&nbsp;While....&nbsp;*/</P>
<P><BR>/*&nbsp;Get&nbsp;the&nbsp;last&nbsp;item&nbsp;from&nbsp;the&nbsp;string&nbsp;*/<BR>SET&nbsp;@Field&nbsp;=&nbsp;ltrim(@findposinparamstr)<BR>exec&nbsp;(@cmd+"&nbsp;"+@Field)</P>
<P>SET&nbsp;NOCOUNT&nbsp;OFF<BR>Return(0)<BR>GO</P>
<P>/*--------------------------------------------------------------------------<BR>------------------------------------<BR>The&nbsp;following&nbsp;is&nbsp;a&nbsp;somewhat&nbsp;contrived&nbsp;example&nbsp;showing&nbsp;how&nbsp;this&nbsp;could&nbsp;be&nbsp;used<BR>using&nbsp;a&nbsp;non-comma&nbsp;delimiter:</P>
<P>if&nbsp;exists&nbsp;(select&nbsp;name&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;name&nbsp;=<BR>"sp_ExpensesForNameAndDeptByDate"&nbsp;and&nbsp;type&nbsp;=&nbsp;"P")&nbsp;<BR>drop&nbsp;proc&nbsp;sp_ExpensesForNameAndDeptByDate<BR>go</P>
<P>create&nbsp;proc&nbsp;sp_ExpensesForNameAndDeptByDate&nbsp;@parms&nbsp;varchar(500)<BR>as<BR>/*&nbsp;<BR>This&nbsp;proc&nbsp;retrieves&nbsp;expense&nbsp;data&nbsp;for&nbsp;a&nbsp;name&nbsp;in&nbsp;a&nbsp;specific&nbsp;department&nbsp;for<BR>a&nbsp;date&nbsp;range.&nbsp;&nbsp;It&nbsp;enables&nbsp;the&nbsp;user&nbsp;to&nbsp;specify&nbsp;all&nbsp;arguments&nbsp;as&nbsp;a&nbsp;single<BR>string&nbsp;delimited&nbsp;by&nbsp;embedded&nbsp;commas.&nbsp;&nbsp;Multiple&nbsp;queries&nbsp;may&nbsp;be&nbsp;issued&nbsp;with<BR>one&nbsp;call&nbsp;by&nbsp;separating&nbsp;separate&nbsp;argument&nbsp;strings&nbsp;by&nbsp;a&nbsp;semi-colon.</P>
<P>Example&nbsp;(whitespace&nbsp;is&nbsp;provided&nbsp;for&nbsp;readability&nbsp;only):<BR>sp_ExpensesForNameAndDeptByDate&nbsp;<BR>"'Joe','466','20020101','20020131';<BR>'Joe','591','20020201','20020228';<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sam','972','20020101','20020131'"<BR>*//*</P>
<P>exec&nbsp;sp_ForEach&nbsp;@parms,"sp_ExpensesForNameAndDeptByDate2",";"</P>
<P><BR>----------------------------------------------------------------------------<BR>----------------------------------</P>
<P>if&nbsp;exists&nbsp;(select&nbsp;name&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;name&nbsp;=<BR>"sp_ExpensesForNameAndDeptByDate2"&nbsp;and&nbsp;type&nbsp;=&nbsp;"P")&nbsp;<BR>drop&nbsp;proc&nbsp;sp_ExpensesForNameAndDeptByDate2<BR>go</P>
<P>create&nbsp;proc&nbsp;sp_ExpensesForNameAndDeptByDate2&nbsp;@name&nbsp;varchar(20),&nbsp;@dept<BR>varchar(20),&nbsp;@d1&nbsp;char(8),&nbsp;@d2&nbsp;char(8)<BR>as<BR>declare&nbsp;@statement&nbsp;nvarchar(1000)<BR>select&nbsp;@statement=<BR>"select&nbsp;d.name,&nbsp;d.mgr,&nbsp;p.name,&nbsp;p.date,&nbsp;p.expenses"+<BR>"from&nbsp;Departments&nbsp;d&nbsp;"+<BR>"join&nbsp;Personnel&nbsp;p&nbsp;on&nbsp;d.name&nbsp;=&nbsp;p.dept&nbsp;"+<BR>"where&nbsp;p.date&nbsp;between&nbsp;@lowdate&nbsp;and&nbsp;@highdate&nbsp;"+<BR>"and&nbsp;p.name&nbsp;=&nbsp;@name&nbsp;"+<BR>"and&nbsp;d.dept&nbsp;=&nbsp;@dept"</P>
<P>exec&nbsp;sp_executesql&nbsp;@statement,<BR>N'@lowdate&nbsp;char(8),@highdate&nbsp;char(8),@name&nbsp;varchar(20),@dept<BR>varchar(20)',<BR>@d1,@d2,@name,@dept<BR>*/</P></FONT>