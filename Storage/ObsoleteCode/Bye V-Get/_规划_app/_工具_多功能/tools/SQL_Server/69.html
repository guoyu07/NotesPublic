<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>用加密函数加密</B><BR>A&nbsp;common&nbsp;question&nbsp;I'm&nbsp;asked&nbsp;by&nbsp;clients&nbsp;is&nbsp;how&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;and&nbsp;store&nbsp;it&nbsp;in&nbsp;SQL&nbsp;Server.&nbsp;One&nbsp;of&nbsp;the&nbsp;major&nbsp;problems&nbsp;I&nbsp;see&nbsp;in&nbsp;the&nbsp;field&nbsp;is&nbsp;when&nbsp;people&nbsp;store&nbsp;sensitive&nbsp;data&nbsp;unencrypted&nbsp;into&nbsp;SQL&nbsp;Server.&nbsp;For&nbsp;example,&nbsp;if&nbsp;a&nbsp;password&nbsp;is&nbsp;stored&nbsp;unencrypted&nbsp;into&nbsp;SQL&nbsp;Server,&nbsp;a&nbsp;malitious&nbsp;user&nbsp;could&nbsp;easily&nbsp;read&nbsp;all&nbsp;of&nbsp;the&nbsp;passwords&nbsp;with&nbsp;a&nbsp;simple&nbsp;select&nbsp;statement.&nbsp;You&nbsp;can&nbsp;develop&nbsp;your&nbsp;own&nbsp;COM&nbsp;mechanisms&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;password&nbsp;but&nbsp;in&nbsp;this&nbsp;article,&nbsp;we'll&nbsp;discuss&nbsp;a&nbsp;method&nbsp;that&nbsp;is&nbsp;build&nbsp;into&nbsp;SQL&nbsp;Server.&nbsp;<BR>Since&nbsp;SQL&nbsp;Server&nbsp;6.x,&nbsp;you&nbsp;can&nbsp;use&nbsp;the&nbsp;ENCRYPT&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;with&nbsp;the&nbsp;same&nbsp;method&nbsp;used&nbsp;by&nbsp;the&nbsp;WITH&nbsp;ENCRYPTION&nbsp;keyword.&nbsp;There's&nbsp;a&nbsp;rather&nbsp;large&nbsp;problem&nbsp;that&nbsp;I&nbsp;will&nbsp;discuss&nbsp;after&nbsp;the&nbsp;example.&nbsp;To&nbsp;use&nbsp;the&nbsp;ENCRYPT&nbsp;function,&nbsp;use&nbsp;it&nbsp;before&nbsp;the&nbsp;string&nbsp;value&nbsp;as&nbsp;shown&nbsp;below:&nbsp; 

<P></P>
<P>SELECT&nbsp;ENCRYPT('TestPW1')</P>
<P>Will&nbsp;output&nbsp;the&nbsp;following&nbsp;result:&nbsp;</P>
<P><BR>------------------------------&nbsp;<BR>0x5400650073007400500057003100</P>
<P>(1&nbsp;row(s)&nbsp;affected)</P>
<P>Let's&nbsp;go&nbsp;ahead&nbsp;and&nbsp;create&nbsp;a&nbsp;sample&nbsp;table&nbsp;and&nbsp;try&nbsp;out&nbsp;this&nbsp;function.&nbsp;Create&nbsp;the&nbsp;following&nbsp;user&nbsp;table&nbsp;and&nbsp;load&nbsp;the&nbsp;sample&nbsp;data&nbsp;below:&nbsp;<BR>CREATE&nbsp;TABLE&nbsp;Users&nbsp;(&nbsp;<BR>UserID&nbsp;Varchar(10),<BR>UserPW&nbsp;Varchar&nbsp;(20))</P>
<P>INSERT&nbsp;INTO&nbsp;USERS&nbsp;values('TestUser1',ENCRYPT('TestPW1'))<BR>INSERT&nbsp;INTO&nbsp;USERS&nbsp;values('TestUser2',ENCRYPT('TestPW2'))<BR>INSERT&nbsp;INTO&nbsp;USERS&nbsp;values('TestUser3',ENCRYPT('TestPW3'))<BR>INSERT&nbsp;INTO&nbsp;USERS&nbsp;values('TestUser4',ENCRYPT('TestPW4'))</P>
<P>If&nbsp;you&nbsp;now&nbsp;select&nbsp;the&nbsp;data&nbsp;it&nbsp;will&nbsp;appear&nbsp;encrypted.&nbsp;Notice&nbsp;if&nbsp;you&nbsp;run&nbsp;a&nbsp;SELECT&nbsp;ENCRYPT('TestPW1')&nbsp;that&nbsp;the&nbsp;data&nbsp;that&nbsp;you&nbsp;see&nbsp;different&nbsp;that&nbsp;what&nbsp;appears&nbsp;when&nbsp;you&nbsp;select&nbsp;out&nbsp;of&nbsp;the&nbsp;Users&nbsp;table&nbsp;after&nbsp;you&nbsp;insert&nbsp;the&nbsp;value.&nbsp;The&nbsp;algorithm&nbsp;that&nbsp;SQL&nbsp;Server&nbsp;uses&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data&nbsp;is&nbsp;relativily&nbsp;easy&nbsp;and&nbsp;is&nbsp;case&nbsp;sensitive&nbsp;until&nbsp;it's&nbsp;stored&nbsp;into&nbsp;a&nbsp;table.&nbsp;At&nbsp;that&nbsp;point&nbsp;it&nbsp;becomes&nbsp;very&nbsp;difficult&nbsp;to&nbsp;read.&nbsp;<BR>Data&nbsp;stored&nbsp;in&nbsp;an&nbsp;encrypted&nbsp;column&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;store&nbsp;passwords.&nbsp;Once&nbsp;encrypted,&nbsp;you&nbsp;can't&nbsp;directly&nbsp;unencrypt&nbsp;the&nbsp;data.&nbsp;You&nbsp;could&nbsp;only&nbsp;perform&nbsp;checks&nbsp;against&nbsp;it&nbsp;as&nbsp;shown&nbsp;below:&nbsp;</P>
<P><BR>SELECT&nbsp;*&nbsp;from&nbsp;Users&nbsp;where&nbsp;UserID&nbsp;=&nbsp;'TestUser2'&nbsp;<BR>&nbsp;and&nbsp;UserPW&nbsp;=&nbsp;ENCRYPT('TestPW2')</P>
<P>Keep&nbsp;in&nbsp;mind&nbsp;that&nbsp;the&nbsp;above&nbsp;command&nbsp;is&nbsp;case&nbsp;sensitive.&nbsp;If&nbsp;you&nbsp;want&nbsp;this&nbsp;to&nbsp;be&nbsp;case-insensitive,&nbsp;it&nbsp;is&nbsp;best&nbsp;to&nbsp;store&nbsp;all&nbsp;the&nbsp;data&nbsp;in&nbsp;uppercase&nbsp;by&nbsp;using&nbsp;the&nbsp;UPPER&nbsp;function.&nbsp;The&nbsp;UPPER&nbsp;function&nbsp;will&nbsp;have&nbsp;to&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;insert&nbsp;statement&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;select&nbsp;statement&nbsp;that&nbsp;we've&nbsp;mentioned.&nbsp;For&nbsp;example,&nbsp;the&nbsp;insert&nbsp;statement&nbsp;would&nbsp;look&nbsp;like&nbsp;this:&nbsp;</P>
<P><BR>INSERT&nbsp;INTO&nbsp;USERS&nbsp;values('TestUser1',ENCRYPT(UPPER('TestPW1')))</P>
<P>SELECT&nbsp;*&nbsp;from&nbsp;Users&nbsp;where&nbsp;UserID&nbsp;=&nbsp;'TestUser2'&nbsp;<BR>&nbsp;and&nbsp;UserPW&nbsp;=&nbsp;ENCRYPT(UPPER('TestPW2'))</P>
<P>Another&nbsp;note&nbsp;to&nbsp;mention&nbsp;is&nbsp;that&nbsp;like&nbsp;any&nbsp;nicely&nbsp;encrypted&nbsp;data,&nbsp;the&nbsp;data&nbsp;may&nbsp;appear&nbsp;one&nbsp;length&nbsp;when&nbsp;viewing&nbsp;it,&nbsp;but&nbsp;is&nbsp;actually&nbsp;stored&nbsp;at&nbsp;a&nbsp;different&nbsp;length.&nbsp;</P>
<P><BR>UserID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserPW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>----------&nbsp;--------------------&nbsp;<BR>TestUser1&nbsp;&nbsp;T<BR>TestUser2&nbsp;&nbsp;T<BR>TestUser3&nbsp;&nbsp;T<BR>TestUser4&nbsp;&nbsp;T</P>
<P>(4&nbsp;row(s)&nbsp;affected)</P>
<P>But&nbsp;in&nbsp;actuality&nbsp;if&nbsp;we&nbsp;select&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;field&nbsp;by&nbsp;using&nbsp;the&nbsp;LEN&nbsp;function,&nbsp;we&nbsp;can&nbsp;see&nbsp;the&nbsp;true&nbsp;length.&nbsp;</P>
<P></P>
<P>userid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>----------&nbsp;-----------&nbsp;<BR>TestUser1&nbsp;&nbsp;14<BR>TestUser2&nbsp;&nbsp;14<BR>TestUser3&nbsp;&nbsp;14<BR>TestUser4&nbsp;&nbsp;14</P>
<P>(4&nbsp;row(s)&nbsp;affected)</P>
<P>With&nbsp;that&nbsp;point&nbsp;made,&nbsp;make&nbsp;sure&nbsp;that&nbsp;the&nbsp;length&nbsp;of&nbsp;your&nbsp;column&nbsp;represents&nbsp;the&nbsp;encrypted&nbsp;length,&nbsp;not&nbsp;the&nbsp;unencrypted&nbsp;lenth.&nbsp;Now,&nbsp;for&nbsp;the&nbsp;large&nbsp;caveat&nbsp;that&nbsp;I&nbsp;mentioned&nbsp;earlier.&nbsp;This&nbsp;stored&nbsp;procedure&nbsp;is&nbsp;unsupported&nbsp;by&nbsp;Micrososft&nbsp;and&nbsp;they&nbsp;could&nbsp;easily&nbsp;change&nbsp;it&nbsp;or&nbsp;rip&nbsp;it&nbsp;out.&nbsp;A&nbsp;good&nbsp;example&nbsp;of&nbsp;this&nbsp;function&nbsp;changing&nbsp;was&nbsp;between&nbsp;SQL&nbsp;Server&nbsp;6.5&nbsp;and&nbsp;7.0.&nbsp;Another&nbsp;common&nbsp;question&nbsp;is&nbsp;decryption.&nbsp;Obiously,&nbsp;Microsoft&nbsp;does&nbsp;not&nbsp;make&nbsp;this&nbsp;easy&nbsp;and&nbsp;strings&nbsp;can&nbsp;only&nbsp;be&nbsp;easily&nbsp;decrypted&nbsp;using&nbsp;the&nbsp;comparison&nbsp;technique&nbsp;I&nbsp;showed&nbsp;earlier.&nbsp;If&nbsp;you&nbsp;don't&nbsp;use&nbsp;this&nbsp;method&nbsp;to&nbsp;encrypt&nbsp;your&nbsp;passwords,&nbsp;there&nbsp;are&nbsp;other&nbsp;methods&nbsp;that&nbsp;are&nbsp;much&nbsp;better.&nbsp;These&nbsp;methods&nbsp;are&nbsp;much&nbsp;more&nbsp;robust&nbsp;and&nbsp;secure&nbsp;than&nbsp;what&nbsp;we&nbsp;discussed.&nbsp;For&nbsp;example,&nbsp;Les&nbsp;Smith&nbsp;has&nbsp;2&nbsp;articles&nbsp;that&nbsp;show&nbsp;you&nbsp;how&nbsp;to&nbsp;use&nbsp;Java&nbsp;or&nbsp;COM&nbsp;to&nbsp;encrypt&nbsp;passwords&nbsp;at&nbsp;:&nbsp;<IMG 
src="http://netcollector://Article/用加密函数加密_files/url.gif" align=absMiddle border=0><A 
href="http://www.sqlservercentral.com/columnists/lsmith/usingjavatoencryptpasswords.asp." 
target=_blank>http://www.sqlservercentral.com/columnists/lsmith/usingjavatoencryptpasswords.asp.</A>&nbsp;If&nbsp;you're&nbsp;serious&nbsp;</P></FONT>