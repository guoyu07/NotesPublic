<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>×Ö·û´®-Quoting</B><BR>Introduction&nbsp;<BR>More&nbsp;and&nbsp;more&nbsp;I&nbsp;see&nbsp;people&nbsp;using&nbsp;dynamic&nbsp;sql&nbsp;to&nbsp;solve&nbsp;their&nbsp;problems.&nbsp;While&nbsp;I&nbsp;am&nbsp;not&nbsp;a&nbsp;fan&nbsp;of&nbsp;dynamic&nbsp;sql&nbsp;and&nbsp;think&nbsp;it&nbsp;should&nbsp;be&nbsp;avoided&nbsp;where&nbsp;possible,&nbsp;I&nbsp;understand&nbsp;it&nbsp;can&nbsp;be&nbsp;helpful&nbsp;and&nbsp;solve&nbsp;some&nbsp;problems.&nbsp;Recently&nbsp;I&nbsp;ran&nbsp;across&nbsp;an&nbsp;interesting&nbsp;problem&nbsp;where&nbsp;someone&nbsp;was&nbsp;creating&nbsp;a&nbsp;string&nbsp;of&nbsp;dynamic&nbsp;sql&nbsp;that&nbsp;appeared&nbsp;to&nbsp;work&nbsp;fine,&nbsp;but&nbsp;cause&nbsp;problems&nbsp;when&nbsp;executed.&nbsp;
<P></P>
<P>The&nbsp;Problem&nbsp;<BR>Suppose&nbsp;you&nbsp;wanted&nbsp;to&nbsp;build&nbsp;a&nbsp;dynamic&nbsp;string&nbsp;to&nbsp;select&nbsp;names&nbsp;from&nbsp;a&nbsp;table.&nbsp;For&nbsp;example,&nbsp;let's&nbsp;assume&nbsp;you&nbsp;have&nbsp;the&nbsp;following&nbsp;table:&nbsp;</P>
<P>create&nbsp;table&nbsp;Users<BR>(&nbsp;UserName&nbsp;varchar(&nbsp;100)<BR>&nbsp;,&nbsp;Password&nbsp;varchar(&nbsp;100)<BR>)</P>
<P>A&nbsp;simple&nbsp;table,&nbsp;however&nbsp;let's&nbsp;now&nbsp;add&nbsp;some&nbsp;data&nbsp;to&nbsp;this&nbsp;table:&nbsp;<BR>insert&nbsp;Users&nbsp;select&nbsp;'sjones',&nbsp;'mypassword'<BR>insert&nbsp;Users&nbsp;select&nbsp;'bgates',&nbsp;'richguy'<BR>insert&nbsp;Users&nbsp;select&nbsp;'to''reilly',&nbsp;'writer'<BR>insert&nbsp;Users&nbsp;select&nbsp;'lellison',&nbsp;'karatechop'</P>
<P>Now,&nbsp;suppose&nbsp;that&nbsp;we&nbsp;have&nbsp;a&nbsp;stored&nbsp;procedure&nbsp;that&nbsp;will&nbsp;verify&nbsp;the&nbsp;password&nbsp;for&nbsp;a&nbsp;given&nbsp;username&nbsp;using&nbsp;dynamic&nbsp;sql.&nbsp;Why&nbsp;use&nbsp;dyanmic&nbsp;sql?&nbsp;No&nbsp;real&nbsp;reason&nbsp;in&nbsp;this&nbsp;case,&nbsp;but&nbsp;I&nbsp;tried&nbsp;to&nbsp;make&nbsp;a&nbsp;simple&nbsp;example&nbsp;to&nbsp;show&nbsp;the&nbsp;problem.&nbsp;</P>
<P>So&nbsp;what&nbsp;is&nbsp;the&nbsp;problem?&nbsp;Take&nbsp;a&nbsp;look&nbsp;at&nbsp;this&nbsp;procedure&nbsp;</P>
<P>alter&nbsp;procedure&nbsp;spValidateUser<BR>&nbsp;@user&nbsp;varchar(&nbsp;100)<BR>&nbsp;,&nbsp;@pwd&nbsp;varchar(&nbsp;100)<BR>as</P>
<P>declare&nbsp;@sql&nbsp;nvarchar(&nbsp;1000)</P>
<P>select&nbsp;@sql&nbsp;=&nbsp;'select&nbsp;1&nbsp;from&nbsp;Users&nbsp;where&nbsp;[username]&nbsp;=&nbsp;'''&nbsp;+&nbsp;@user&nbsp;+&nbsp;'''&nbsp;and&nbsp;password&nbsp;=&nbsp;'''&nbsp;+&nbsp;@pwd&nbsp;+&nbsp;'''&nbsp;'</P>
<P>exec&nbsp;sp_executesql&nbsp;@sql</P>
<P>return</P>
<P>If&nbsp;I&nbsp;execute&nbsp;this&nbsp;with&nbsp;my&nbsp;own&nbsp;information,&nbsp;I&nbsp;get:&nbsp;<BR>exec&nbsp;spValidateUser&nbsp;'sjones',&nbsp;'mypassword'</P>
<P>(no&nbsp;column&nbsp;name)<BR>----------------<BR>1</P>
<P>which&nbsp;my&nbsp;client&nbsp;application&nbsp;can&nbsp;use&nbsp;to&nbsp;process&nbsp;the&nbsp;validation.&nbsp;However,&nbsp;what&nbsp;if&nbsp;I&nbsp;look&nbsp;for&nbsp;Tim&nbsp;O'Reilly.&nbsp;<BR>exec&nbsp;spValidateUser&nbsp;'to''reilly',&nbsp;'mypassword'</P>
<P>Server:&nbsp;Msg&nbsp;170,&nbsp;Level&nbsp;15,&nbsp;State&nbsp;1,&nbsp;Line&nbsp;1<BR>Line&nbsp;1:&nbsp;Incorrect&nbsp;syntax&nbsp;near&nbsp;'reilly'.<BR>Server:&nbsp;Msg&nbsp;105,&nbsp;Level&nbsp;15,&nbsp;State&nbsp;1,&nbsp;Line&nbsp;1<BR>Unclosed&nbsp;quotation&nbsp;mark&nbsp;before&nbsp;the&nbsp;character&nbsp;string&nbsp;'&nbsp;'.</P>
<P><BR>Why&nbsp;would&nbsp;I&nbsp;get&nbsp;an&nbsp;error&nbsp;here?&nbsp;After&nbsp;all&nbsp;I&nbsp;escaped&nbsp;out&nbsp;the&nbsp;quote&nbsp;in&nbsp;O'Reilly.&nbsp;Apparently&nbsp;this&nbsp;is&nbsp;not&nbsp;enough.&nbsp;</P>
<P>The&nbsp;Second&nbsp;Solution&nbsp;<BR>The&nbsp;problem&nbsp;is&nbsp;that&nbsp;when&nbsp;building&nbsp;a&nbsp;string&nbsp;for&nbsp;dyanmic&nbsp;sql,&nbsp;I&nbsp;must&nbsp;re-escape&nbsp;the&nbsp;quote&nbsp;character.&nbsp;Or&nbsp;any&nbsp;other&nbsp;reserver&nbsp;words&nbsp;because&nbsp;the&nbsp;new&nbsp;string&nbsp;will&nbsp;now&nbsp;have&nbsp;only&nbsp;a&nbsp;single&nbsp;quote&nbsp;inside.&nbsp;Since&nbsp;dynamic&nbsp;sql&nbsp;is&nbsp;executed&nbsp;as&nbsp;it's&nbsp;own&nbsp;batch,&nbsp;all&nbsp;reserver&nbsp;characters&nbsp;must&nbsp;be&nbsp;escaped.&nbsp;Dynamic&nbsp;sql&nbsp;is&nbsp;executed&nbsp;just&nbsp;as&nbsp;if&nbsp;you&nbsp;connected&nbsp;to&nbsp;SQL&nbsp;Server&nbsp;using&nbsp;Query&nbsp;Analyzer,&nbsp;pasted&nbsp;the&nbsp;sql&nbsp;in&nbsp;the&nbsp;window&nbsp;and&nbsp;executed&nbsp;it.&nbsp;If&nbsp;we&nbsp;examine&nbsp;the&nbsp;dynamic&nbsp;sql&nbsp;string&nbsp;for&nbsp;the&nbsp;last&nbsp;submission,&nbsp;it&nbsp;looks&nbsp;like:&nbsp;</P>
<P><BR>select&nbsp;1&nbsp;from&nbsp;Users&nbsp;where&nbsp;[username]&nbsp;=&nbsp;'to'reilly'&nbsp;and&nbsp;password&nbsp;=&nbsp;'mypassword'&nbsp;</P>
<P>Note&nbsp;that&nbsp;the&nbsp;username&nbsp;only&nbsp;has&nbsp;a&nbsp;single&nbsp;quote&nbsp;in&nbsp;it.&nbsp;</P>
<P>So&nbsp;how&nbsp;can&nbsp;we&nbsp;fix&nbsp;this?&nbsp;The&nbsp;easy&nbsp;way&nbsp;is&nbsp;to&nbsp;use&nbsp;the&nbsp;same&nbsp;string&nbsp;manipulation&nbsp;technique&nbsp;previously&nbsp;discussed&nbsp;in&nbsp;Part&nbsp;3,&nbsp;REPLACE.&nbsp;In&nbsp;this&nbsp;case,&nbsp;however,&nbsp;we&nbsp;need&nbsp;to&nbsp;escape&nbsp;the&nbsp;characters&nbsp;we&nbsp;are&nbsp;searching&nbsp;for&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;replacement,&nbsp;so&nbsp;the&nbsp;REPLACE&nbsp;function&nbsp;looks&nbsp;like:&nbsp;</P>
<P>replace(&nbsp;@pwd,&nbsp;'''',&nbsp;'''''')</P>
<P>with&nbsp;each&nbsp;single&nbsp;quote&nbsp;we&nbsp;want&nbsp;to&nbsp;match&nbsp;replaced&nbsp;with&nbsp;two&nbsp;single&nbsp;quotes,&nbsp;plus&nbsp;the&nbsp;opening&nbsp;and&nbsp;closing&nbsp;single&nbsp;quotes.&nbsp;Note&nbsp;that&nbsp;we&nbsp;only&nbsp;want&nbsp;to&nbsp;replace&nbsp;the&nbsp;parameters&nbsp;passed&nbsp;in&nbsp;because&nbsp;these&nbsp;are&nbsp;the&nbsp;items&nbsp;we&nbsp;have&nbsp;no&nbsp;control&nbsp;over.&nbsp;If&nbsp;we&nbsp;were&nbsp;to&nbsp;run&nbsp;this&nbsp;replace&nbsp;on&nbsp;the&nbsp;dynamic&nbsp;string,&nbsp;the&nbsp;opening&nbsp;and&nbsp;closing&nbsp;quotes&nbsp;for&nbsp;each&nbsp;term&nbsp;of&nbsp;the&nbsp;where&nbsp;clause&nbsp;would&nbsp;get&nbsp;replaced&nbsp;and&nbsp;cause&nbsp;additional&nbsp;formatting&nbsp;problems.&nbsp;</P>
<P>Here's&nbsp;new&nbsp;new&nbsp;procedure:&nbsp;</P>
<P>alter&nbsp;procedure&nbsp;spValidateUser<BR>&nbsp;@user&nbsp;varchar(&nbsp;100)<BR>&nbsp;,&nbsp;@pwd&nbsp;varchar(&nbsp;100)<BR>as</P>
<P>declare&nbsp;@sql&nbsp;nvarchar(&nbsp;1000)</P>
<P>select&nbsp;@sql&nbsp;=&nbsp;'select&nbsp;1&nbsp;from&nbsp;Users&nbsp;where&nbsp;[username]&nbsp;=&nbsp;'''&nbsp;+&nbsp;replace(&nbsp;@user,&nbsp;'''',&nbsp;'''''')&nbsp;+&nbsp;'''&nbsp;and&nbsp;password&nbsp;=&nbsp;'''&nbsp;+&nbsp;replace(&nbsp;@pwd,&nbsp;'''',&nbsp;'''''')&nbsp;+&nbsp;'''&nbsp;'</P>
<P>exec&nbsp;sp_executesql&nbsp;@sql</P>
<P>return<BR>go</P>
<P>This&nbsp;will&nbsp;return&nbsp;the&nbsp;following&nbsp;results:&nbsp;<BR>exec&nbsp;spValidateUser&nbsp;'to''reilly',&nbsp;'writer'</P>
<P>(no&nbsp;column&nbsp;name)<BR>----------------<BR>1</P>
<P>We&nbsp;now&nbsp;get&nbsp;the&nbsp;expected&nbsp;result.&nbsp;</P>
<P>Conclusions&nbsp;<BR>Once&nbsp;again,&nbsp;this&nbsp;isn't&nbsp;anything&nbsp;that&nbsp;is&nbsp;tremndously&nbsp;enlightening,&nbsp;but&nbsp;it&nbsp;is&nbsp;something&nbsp;that&nbsp;you&nbsp;might&nbsp;miss&nbsp;and&nbsp;spend&nbsp;some&nbsp;time&nbsp;tracking&nbsp;down.&nbsp;As&nbsp;I&nbsp;mentioned&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;this&nbsp;article,&nbsp;I&nbsp;don't&nbsp;like&nbsp;dynamic&nbsp;sql,&nbsp;but&nbsp;if&nbsp;you&nbsp;are&nbsp;building&nbsp;dynamic&nbsp;sql&nbsp;based&nbsp;on&nbsp;parameters&nbsp;passed&nbsp;into&nbsp;the&nbsp;procedure,&nbsp;this&nbsp;is&nbsp;something&nbsp;you&nbsp;should&nbsp;be&nbsp;aware&nbsp;of.&nbsp;</P>
<P>As&nbsp;always&nbsp;I&nbsp;welcome&nbsp;feedback&nbsp;on&nbsp;this&nbsp;article&nbsp;using&nbsp;the&nbsp;"Your&nbsp;Opinion"&nbsp;button&nbsp;below.&nbsp;Please&nbsp;also&nbsp;rate&nbsp;this&nbsp;article.&nbsp;</P>
<P>Steve&nbsp;Jones<BR>©dkRanch.net&nbsp;March&nbsp;2002</P></FONT>