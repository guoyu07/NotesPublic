<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>GetDate&nbsp;Function&nbsp;and&nbsp;Stored&nbsp;Procedure</B><BR>GetDate&nbsp;Function&nbsp;and&nbsp;Stored&nbsp;Procedure
<P></P>
<P></P>
<P><BR>&gt;&gt;Script&nbsp;Language&nbsp;and&nbsp;Platform:&nbsp;MS&nbsp;SQL&nbsp;2000&nbsp;,MS&nbsp;SQL&nbsp;7.0<BR>Get&nbsp;a&nbsp;specific&nbsp;weekday&nbsp;of&nbsp;a&nbsp;month&nbsp;by&nbsp;passing&nbsp;any&nbsp;date.&nbsp;</P>
<P>--Usage&nbsp;explanation&nbsp;for&nbsp;Function&nbsp;Getting&nbsp;Second&nbsp;Tuesday&nbsp;of&nbsp;May/2003&nbsp;by&nbsp;executing&nbsp;select&nbsp;dbo.UDF_getdate(2,3,'5/26/2003')&nbsp;</P>
<P>--Usage&nbsp;explanation&nbsp;for&nbsp;Stored&nbsp;Procedure&nbsp;Getting&nbsp;the&nbsp;fifth&nbsp;Friday&nbsp;of&nbsp;May/2003&nbsp;by&nbsp;excuting&nbsp;exec&nbsp;usp_getdate&nbsp;5,6,'5/1/2003'&nbsp;</P>
<P>--Both&nbsp;Function&nbsp;and&nbsp;Stored&nbsp;procedure&nbsp;can&nbsp;detect&nbsp;error&nbsp;inserts.&nbsp;</P>
<P>Author:&nbsp;Claire&nbsp;Hsu&nbsp;</P>
<P></P>
<P>/*<BR>&nbsp;&nbsp;&nbsp;*&nbsp;Script&nbsp;Language&nbsp;and&nbsp;Platform:MS&nbsp;SQL&nbsp;2000<BR>&nbsp;&nbsp;&nbsp;*&nbsp;Objecttive:&nbsp;Get&nbsp;specific&nbsp;weekday&nbsp;of&nbsp;a&nbsp;month&nbsp;by&nbsp;passing&nbsp;any&nbsp;date&nbsp;<BR>&nbsp;&nbsp;&nbsp;*&nbsp;Usage:Getting&nbsp;Second&nbsp;Tuesday&nbsp;of&nbsp;May/2003&nbsp;by&nbsp;passing&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;*&nbsp;select&nbsp;dbo.UDF_getdate(2,3,'5/26/2003')<BR>&nbsp;&nbsp;&nbsp;*&nbsp;Author:Claire&nbsp;Hsu&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;*&nbsp;Date&nbsp;&nbsp;:2003/5/26<BR>&nbsp;&nbsp;&nbsp;*&nbsp;Email:messageclaire@yahoo.com<BR>&nbsp;&nbsp;&nbsp;*&nbsp;Description:This&nbsp;script&nbsp;contains&nbsp;both&nbsp;funciton&nbsp;and&nbsp;procedure.<BR>&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;could&nbsp;apply&nbsp;accordingly<BR>*/</P>
<P>--Here&nbsp;is&nbsp;the&nbsp;code&nbsp;for&nbsp;Function<BR>-------------------------------------------------------------------------------<BR>create&nbsp;function&nbsp;dbo.UDF_getdate&nbsp;(@week&nbsp;int,@dw&nbsp;int,@dayw1&nbsp;varchar(25))<BR>returns&nbsp;datetime<BR>as<BR>begin</P>
<P>declare&nbsp;@v1&nbsp;int<BR>declare&nbsp;@v2&nbsp;int<BR>declare&nbsp;@dayw&nbsp;datetime</P>
<P>if&nbsp;isdate(@dayw1)&nbsp;&lt;&gt;&nbsp;1<BR>begin<BR>set&nbsp;@dayw&nbsp;=&nbsp;null<BR>end</P>
<P>else<BR>begin<BR>set&nbsp;@dayw&nbsp;=&nbsp;convert(datetime,@dayw1&nbsp;)<BR>&nbsp;if&nbsp;@dw&nbsp;&gt;8&nbsp;or&nbsp;@dw&nbsp;&lt;=0&nbsp;or&nbsp;@week&nbsp;&gt;=6&nbsp;or&nbsp;@week&nbsp;&lt;=0<BR>&nbsp;begin<BR>&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;null<BR>&nbsp;end</P>
<P>&nbsp;else<BR>&nbsp;begin<BR>&nbsp;set&nbsp;@v1&nbsp;=&nbsp;month(@dayw)<BR>&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;cast(convert(char,@v1)+'/1/'+convert(char,year(@dayw))&nbsp;as&nbsp;datetime)<BR>&nbsp;set&nbsp;@v2&nbsp;=&nbsp;datepart(dw,@dayw)<BR>&nbsp;</P>
<P>&nbsp;&nbsp;if&nbsp;@v2&nbsp;&gt;@dw<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;dateadd(d,@week*7-(@v2-@dw),@dayw)<BR>&nbsp;&nbsp;end<BR>&nbsp;&nbsp;<BR>&nbsp;&nbsp;if&nbsp;@v2&lt;=@dw<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;dateadd(d,(@week-1)*7+(@dw-@v2),@dayw)<BR>&nbsp;&nbsp;end<BR>&nbsp;<BR>&nbsp;&nbsp;if&nbsp;month(@dayw)&gt;@v1<BR>&nbsp;&nbsp;begin&nbsp;<BR>&nbsp;&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;null<BR>&nbsp;&nbsp;end<BR>&nbsp;<BR>&nbsp;&nbsp;else<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;@dayw<BR>&nbsp;&nbsp;end<BR>&nbsp;end<BR>end<BR>return(@dayw)<BR>end</P>
<P>--Usage&nbsp;on&nbsp;single&nbsp;select&nbsp;statement<BR>--Example1<BR>--The&nbsp;following&nbsp;statement&nbsp;gives&nbsp;you&nbsp;the&nbsp;Second&nbsp;Sunday&nbsp;of&nbsp;May/2003<BR>--select&nbsp;dbo.UDF_getdate(2,1,'5/35/2003')</P>
<P>--Example2<BR>--The&nbsp;following&nbsp;statement&nbsp;gives&nbsp;you&nbsp;the&nbsp;Third&nbsp;Wednesday&nbsp;of&nbsp;Feb/2003<BR>--select&nbsp;dbo.UDF_getdate(3,4,'2/14/2003')</P>
<P>--Example3<BR>--The&nbsp;following&nbsp;statement&nbsp;gives&nbsp;you&nbsp;the&nbsp;Forth&nbsp;Monday&nbsp;of&nbsp;Dec/2003<BR>--select&nbsp;dbo.UDF_getdate(4,2,'12/25/2003')</P>
<P>--Usage&nbsp;on&nbsp;table<BR>--The&nbsp;following&nbsp;statement&nbsp;gives&nbsp;you&nbsp;the&nbsp;reuslt&nbsp;for&nbsp;the&nbsp;whole&nbsp;table<BR>--select&nbsp;dbo.UDF_getdate(week,weekday,datetime_filed_column)&nbsp;from&nbsp;table_name<BR>----------------------------------------------------------------------------<BR>----------------------------------------------------------------------------</P>
<P>--Here&nbsp;is&nbsp;the&nbsp;code&nbsp;for&nbsp;Stored&nbsp;Procedure<BR>create&nbsp;proc&nbsp;USP_getdate&nbsp;@week&nbsp;int,@dw&nbsp;int,@dayw1&nbsp;varchar(25)<BR>as&nbsp;<BR>declare&nbsp;@v1&nbsp;int<BR>declare&nbsp;@v2&nbsp;int<BR>declare&nbsp;@dayw&nbsp;datetime</P>
<P>if&nbsp;isdate(@dayw1)&nbsp;&lt;&gt;&nbsp;1<BR>begin<BR>raiserror("Out-of-Range&nbsp;datetime&nbsp;value",16,1)<BR>end<BR>else</P>
<P>begin<BR>set&nbsp;@dayw&nbsp;=&nbsp;convert(datetime,@dayw1&nbsp;)<BR>if&nbsp;@dw&nbsp;&gt;8&nbsp;or&nbsp;@dw&nbsp;&lt;=0&nbsp;or&nbsp;@week&nbsp;&gt;=6&nbsp;or&nbsp;@week&nbsp;&lt;=0<BR>&nbsp;begin<BR>&nbsp;raiserror("Your&nbsp;insert&nbsp;in&nbsp;invalid&nbsp;wither&nbsp;in&nbsp;week&nbsp;or&nbsp;day&nbsp;of&nbsp;the&nbsp;week",16,1)<BR>&nbsp;end</P>
<P>&nbsp;else<BR>&nbsp;begin<BR>&nbsp;set&nbsp;@v1&nbsp;=&nbsp;month(@dayw)<BR>&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;cast(convert(char,@v1)+'/1/'+convert(char,year(@dayw))&nbsp;as&nbsp;datetime)<BR>&nbsp;set&nbsp;@v2&nbsp;=&nbsp;datepart(dw,@dayw)<BR>&nbsp;</P>
<P>&nbsp;&nbsp;if&nbsp;@v2&nbsp;&gt;@dw<BR>&nbsp;&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;dateadd(d,@week*7-(@v2-@dw),@dayw)<BR>&nbsp;&nbsp;<BR>&nbsp;&nbsp;if&nbsp;@v2&lt;=@dw<BR>&nbsp;&nbsp;set&nbsp;@dayw&nbsp;=&nbsp;dateadd(d,(@week-1)*7+(@dw-@v2),@dayw)</P>
<P>&nbsp;&nbsp;if&nbsp;month(@dayw)&gt;@v1<BR>&nbsp;&nbsp;raiserror("Your&nbsp;insert&nbsp;is&nbsp;invalid&nbsp;in&nbsp;week&nbsp;,the&nbsp;week&nbsp;should&nbsp;be&nbsp;<BR>&nbsp;&nbsp;&nbsp;less&nbsp;or&nbsp;equal&nbsp;to&nbsp;4",16,1)</P>
<P>&nbsp;&nbsp;else<BR>&nbsp;&nbsp;select&nbsp;@dayw<BR>&nbsp;&nbsp;end<BR>&nbsp;end</P>
<P><BR>--Usage&nbsp;<BR>--exec&nbsp;usp_getdate&nbsp;2,5,'6/23/2003'&nbsp;The&nbsp;second&nbsp;Thursday&nbsp;of&nbsp;Jun/2003<BR>--exec&nbsp;usp_getdate&nbsp;5,6,'5/1/2003'&nbsp;The&nbsp;fifth&nbsp;Friday&nbsp;of&nbsp;May/2003</P></FONT>