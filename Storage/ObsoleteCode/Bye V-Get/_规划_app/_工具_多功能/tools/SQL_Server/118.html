<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>CreateTriggers</B><BR>CreateTriggers.sql
<P></P>
<P></P>
<P><BR>Create&nbsp;TimeStamp&nbsp;triggers&nbsp;for&nbsp;all&nbsp;user&nbsp;defined&nbsp;Tables&nbsp;This&nbsp;uses&nbsp;a&nbsp;two&nbsp;pass&nbsp;system.&nbsp;The&nbsp;first&nbsp;pass&nbsp;generates&nbsp;the&nbsp;Triggers&nbsp;that&nbsp;affect&nbsp;the&nbsp;UpdateStamp&nbsp;fields&nbsp;and&nbsp;the&nbsp;second&nbsp;pass&nbsp;creates&nbsp;the&nbsp;triggers&nbsp;that&nbsp;affect&nbsp;the&nbsp;CreateStamp&nbsp;fields.&nbsp;</P>
<P>Author:&nbsp;Mike&nbsp;Meerding&nbsp;</P>
<P>/*<BR>&nbsp;*&nbsp;Create&nbsp;TimeStamp&nbsp;triggers&nbsp;for&nbsp;all&nbsp;user&nbsp;defined&nbsp;Tables<BR>&nbsp;*&nbsp;This&nbsp;uses&nbsp;a&nbsp;two&nbsp;pass&nbsp;system.&nbsp;The&nbsp;first&nbsp;pass&nbsp;generates&nbsp;the&nbsp;Triggers&nbsp;that&nbsp;affect&nbsp;the&nbsp;UpdateStamp&nbsp;fields&nbsp;and&nbsp;the&nbsp;<BR>&nbsp;*&nbsp;second&nbsp;pass&nbsp;creates&nbsp;the&nbsp;triggers&nbsp;that&nbsp;affect&nbsp;the&nbsp;CreateStamp&nbsp;fields.<BR>&nbsp;*/<BR>CREATE&nbsp;PROCEDURE&nbsp;CreateTriggers&nbsp;&nbsp;AS</P>
<P>/*&nbsp;&nbsp;Local&nbsp;Variables&nbsp;*/<BR>Declare&nbsp;@TableName&nbsp;NVarChar(128)<BR>Declare&nbsp;@Statement&nbsp;NVarChar(512)<BR>Declare&nbsp;@Column_Name&nbsp;NVarChar&nbsp;(128)<BR>Declare&nbsp;@KeyFields&nbsp;NVarChar(256)<BR>Declare&nbsp;@FieldName&nbsp;NVarChar(128)<BR>Declare&nbsp;@Table_ID&nbsp;Int<BR>Declare&nbsp;@PassCount&nbsp;Int</P>
<P>Set&nbsp;@PassCount&nbsp;=&nbsp;0</P>
<P>WHILE(@PassCount&nbsp;&lt;=&nbsp;1)<BR>Begin<BR>&nbsp;/*&nbsp;Cursor&nbsp;declaration&nbsp;to&nbsp;figure&nbsp;out&nbsp;names&nbsp;of&nbsp;all&nbsp;user&nbsp;tables&nbsp;*/<BR>&nbsp;Declare&nbsp;AllTables&nbsp;CURSOR&nbsp;<BR>&nbsp;&nbsp;For&nbsp;Select&nbsp;Name&nbsp;from&nbsp;sysobjects&nbsp;<BR>&nbsp;&nbsp;&nbsp;Where&nbsp;xtype&nbsp;=&nbsp;"U"<BR>&nbsp;Open&nbsp;AllTables</P>
<P>&nbsp;/*&nbsp;Scan&nbsp;the&nbsp;sysobjects&nbsp;table&nbsp;for&nbsp;names&nbsp;of&nbsp;all&nbsp;user&nbsp;tables&nbsp;*/<BR>&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;AllTables&nbsp;Into&nbsp;@TableName<BR>&nbsp;While&nbsp;(@@Fetch_Status&nbsp;=&nbsp;0&nbsp;)<BR>&nbsp;Begin<BR>&nbsp;&nbsp;Print&nbsp;'Checking&nbsp;Table&nbsp;'&nbsp;+&nbsp;@TableNAME</P>
<P>&nbsp;&nbsp;Print&nbsp;'Finding&nbsp;Primary&nbsp;Key&nbsp;Fields...'<BR>&nbsp;<BR>&nbsp;&nbsp;Select&nbsp;@Table_ID&nbsp;=&nbsp;Object_ID(@TableName)</P>
<P>&nbsp;&nbsp;/*&nbsp;Does&nbsp;this&nbsp;table&nbsp;have&nbsp;the&nbsp;required&nbsp;fields&nbsp;?&nbsp;*/<BR>&nbsp;&nbsp;if&nbsp;@PassCount&nbsp;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@FieldName&nbsp;=&nbsp;'UpdateStamp'<BR>&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@FieldName&nbsp;=&nbsp;'CreateStamp'</P>
<P>&nbsp;&nbsp;exec&nbsp;sp_columns&nbsp;@TABLE_NAME&nbsp;=&nbsp;@TableName,&nbsp;@Column_name&nbsp;=&nbsp;@FieldName</P>
<P>&nbsp;&nbsp;IF&nbsp;(@@RowCount&nbsp;=&nbsp;1)<BR>&nbsp;&nbsp;BEGIN</P>
<P>&nbsp;&nbsp;&nbsp;/*&nbsp;Cursor&nbsp;declaration&nbsp;to&nbsp;figure&nbsp;out&nbsp;names&nbsp;of&nbsp;key&nbsp;fields&nbsp;for&nbsp;a&nbsp;specific&nbsp;table&nbsp;(swiped&nbsp;from&nbsp;sp_pkeys)&nbsp;*/&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Declare&nbsp;ThisTable&nbsp;CURSOR&nbsp;<BR>&nbsp;&nbsp;&nbsp;FOR<BR>&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;&nbsp;COLUMN_NAME&nbsp;=&nbsp;convert(sysname,&nbsp;c.name)&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;From&nbsp;sysindexes&nbsp;i,&nbsp;syscolumns&nbsp;c,&nbsp;sysobjects&nbsp;o,&nbsp;syscolumns&nbsp;c1<BR>&nbsp;&nbsp;&nbsp;&nbsp;Where&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.id&nbsp;=&nbsp;@Table_ID&nbsp;and&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.id&nbsp;=&nbsp;c.id&nbsp;and&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.id&nbsp;=&nbsp;i.id&nbsp;and&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(i.status&nbsp;&amp;&nbsp;0x800)&nbsp;=&nbsp;0x800&nbsp;and&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.name&nbsp;=&nbsp;index_col&nbsp;(@TableName,&nbsp;i.indid,&nbsp;c1.colid)&nbsp;and&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c1.colid&nbsp;&lt;=&nbsp;i.keycnt&nbsp;and&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c1.id&nbsp;=&nbsp;@table_id&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Open&nbsp;ThisTable</P>
<P>&nbsp;&nbsp;&nbsp;/*&nbsp;Generate&nbsp;SQL&nbsp;string&nbsp;that&nbsp;will&nbsp;create&nbsp;the&nbsp;trigger&nbsp;which&nbsp;creates&nbsp;the&nbsp;timestamps&nbsp;*/<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;''&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;id&nbsp;=&nbsp;object_id(N'dbo.'&nbsp;+&nbsp;@FieldName+'_'&nbsp;+&nbsp;@TableName)&nbsp;and&nbsp;OBJECTPROPERTY(id,&nbsp;N'IsTrigger')&nbsp;=&nbsp;1)<BR>&nbsp;&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;'drop&nbsp;trigger&nbsp;dbo.'&nbsp;+&nbsp;@FieldName+'_'&nbsp;+&nbsp;@TableName&nbsp;&nbsp;+&nbsp;char(13)<BR>&nbsp;&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)<BR>&nbsp;&nbsp;&nbsp;&nbsp;Print&nbsp;@Statement<BR>&nbsp;&nbsp;&nbsp;&nbsp;Execute&nbsp;sp_executesql&nbsp;&nbsp;@Statement&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)<BR>&nbsp;&nbsp;&nbsp;END<BR>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;'Create&nbsp;Trigger&nbsp;dbo.'&nbsp;+&nbsp;@FieldName+'_'&nbsp;&nbsp;+&nbsp;@TableName&nbsp;+&nbsp;'&nbsp;ON&nbsp;'&nbsp;+&nbsp;@TableName&nbsp;+&nbsp;char(13)&nbsp;<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;FOR&nbsp;'<BR>&nbsp;&nbsp;&nbsp;IF&nbsp;@PassCount&nbsp;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;Update&nbsp;'&nbsp;<BR>&nbsp;&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;Insert&nbsp;&nbsp;'&nbsp;<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;AS&nbsp;'&nbsp;+&nbsp;char(13)&nbsp;<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;BEGIN&nbsp;'&nbsp;+&nbsp;char(13)&nbsp;<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UPDATE&nbsp;'&nbsp;+&nbsp;@TABLENAME&nbsp;+&nbsp;char(13)&nbsp;<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;'&nbsp;+&nbsp;@FieldName&nbsp;+&nbsp;'&nbsp;=&nbsp;GetDate()&nbsp;'&nbsp;+&nbsp;char(13)&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;/*&nbsp;scan&nbsp;the&nbsp;system&nbsp;tables&nbsp;to&nbsp;build&nbsp;a&nbsp;list&nbsp;of&nbsp;primary&nbsp;keyfield&nbsp;names&nbsp;*/<BR>&nbsp;&nbsp;&nbsp;Set&nbsp;@KeyFields&nbsp;=&nbsp;""<BR>&nbsp;&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;ThisTable&nbsp;into&nbsp;@COLUMN_NAME<BR>&nbsp;&nbsp;&nbsp;WHILE&nbsp;(@@FETCH_STATUS=&nbsp;0)<BR>&nbsp;&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;@KeyFields&nbsp;=&nbsp;""<BR>&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set&nbsp;@KeyFields&nbsp;=&nbsp;@COLUMN_NAME<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;'&nbsp;&nbsp;+&nbsp;@COLUMN_NAME&nbsp;+'&nbsp;in&nbsp;(SELECT&nbsp;'&nbsp;+&nbsp;@COLUMN_NAME&nbsp;+&nbsp;&nbsp;'&nbsp;FROM&nbsp;INSERTED)'&nbsp;+&nbsp;char(13)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;ELSE<BR>&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set&nbsp;@KeyFields&nbsp;=&nbsp;@KeyFields&nbsp;+&nbsp;",&nbsp;"&nbsp;+&nbsp;@COLUMN_NAME<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;'&nbsp;&nbsp;+&nbsp;@COLUMN_NAME&nbsp;+'&nbsp;in&nbsp;(SELECT&nbsp;'&nbsp;+&nbsp;@COLUMN_NAME&nbsp;+&nbsp;&nbsp;'&nbsp;FROM&nbsp;INSERTED)'&nbsp;+&nbsp;char(13)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;END</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;ThisTable&nbsp;into&nbsp;@COLUMN_NAME<BR>&nbsp;&nbsp;&nbsp;END</P>
<P>&nbsp;&nbsp;&nbsp;Print&nbsp;'Keyfields&nbsp;are&nbsp;:-&nbsp;'&nbsp;+&nbsp;@KeyFields</P>
<P>&nbsp;&nbsp;&nbsp;Close&nbsp;ThisTable<BR>&nbsp;&nbsp;&nbsp;Deallocate&nbsp;ThisTable</P>
<P>&nbsp;&nbsp;&nbsp;Set&nbsp;@Statement&nbsp;=&nbsp;@Statement&nbsp;+&nbsp;'&nbsp;END'&nbsp;+&nbsp;char(13)<BR>&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)<BR>&nbsp;&nbsp;&nbsp;Print&nbsp;@Statement</P>
<P>&nbsp;&nbsp;&nbsp;If&nbsp;@KeyFields&nbsp;!=&nbsp;""<BR>&nbsp;&nbsp;&nbsp;&nbsp;Execute&nbsp;sp_executesql&nbsp;&nbsp;@Statement&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)<BR>&nbsp;&nbsp;END</P>
<P>&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;AllTables&nbsp;Into&nbsp;@TableName<BR>&nbsp;END<BR>&nbsp;Set&nbsp;@PassCount&nbsp;=&nbsp;@PassCount&nbsp;+&nbsp;1</P>
<P>&nbsp;Close&nbsp;AllTables<BR>&nbsp;Deallocate&nbsp;AllTables</P>
<P>End</P></FONT>