<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>replace_substring</B><BR>Version:&nbsp;SQL&nbsp;Server&nbsp;7.0/2000<BR>Created&nbsp;by:&nbsp;Alexander&nbsp;Chigrik
<P></P>
<P>This&nbsp;stored&nbsp;procedure&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;search&nbsp;and&nbsp;replace&nbsp;substring<BR>in&nbsp;the&nbsp;char,&nbsp;nchar,&nbsp;varchar&nbsp;and&nbsp;nvarchar&nbsp;columns&nbsp;in&nbsp;all&nbsp;tables<BR>in&nbsp;the&nbsp;current&nbsp;database.&nbsp;You&nbsp;should&nbsp;pass&nbsp;the&nbsp;text&nbsp;value&nbsp;to<BR>search&nbsp;and&nbsp;the&nbsp;text&nbsp;value&nbsp;to&nbsp;replace.&nbsp;So,&nbsp;to&nbsp;replace&nbsp;all<BR>char,&nbsp;nchar,&nbsp;varchar&nbsp;and&nbsp;nvarchar&nbsp;columns&nbsp;which&nbsp;contain<BR>the&nbsp;substring&nbsp;'John'&nbsp;with&nbsp;the&nbsp;substring&nbsp;'Bill',&nbsp;you&nbsp;can&nbsp;use&nbsp;the<BR>following&nbsp;(in&nbsp;comparison&nbsp;with&nbsp;the&nbsp;SetTbColvalues&nbsp;stored&nbsp;procedure,<BR>this&nbsp;stored&nbsp;procedure&nbsp;replace&nbsp;only&nbsp;substring,&nbsp;not&nbsp;the&nbsp;entire<BR>column's&nbsp;value):</P>
<P>EXEC&nbsp;replace_substring&nbsp;@search_value&nbsp;=&nbsp;'John',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@replace_value&nbsp;=&nbsp;'Bill'</P>
<P><BR>/*<BR>Version:&nbsp;SQL&nbsp;Server&nbsp;7.0/2000<BR>Created&nbsp;by:&nbsp;Alexander&nbsp;Chigrik<BR><IMG 
src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.MSSQLCity.com/" 
target=_blank>http://www.MSSQLCity.com/</A>&nbsp;-&nbsp;all&nbsp;about&nbsp;MS&nbsp;SQL<BR>(SQL&nbsp;Server&nbsp;Articles,&nbsp;FAQ,&nbsp;Scripts,&nbsp;Tips&nbsp;and&nbsp;Test&nbsp;Exams).</P>
<P>This&nbsp;stored&nbsp;procedure&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;search&nbsp;and&nbsp;replace&nbsp;substring<BR>in&nbsp;the&nbsp;char,&nbsp;nchar,&nbsp;varchar&nbsp;and&nbsp;nvarchar&nbsp;columns&nbsp;in&nbsp;all&nbsp;tables<BR>in&nbsp;the&nbsp;current&nbsp;database.&nbsp;You&nbsp;should&nbsp;pass&nbsp;the&nbsp;text&nbsp;value&nbsp;to<BR>search&nbsp;and&nbsp;the&nbsp;text&nbsp;value&nbsp;to&nbsp;replace.&nbsp;So,&nbsp;to&nbsp;replace&nbsp;all<BR>char,&nbsp;nchar,&nbsp;varchar&nbsp;and&nbsp;nvarchar&nbsp;columns&nbsp;which&nbsp;contain<BR>the&nbsp;substring&nbsp;'John'&nbsp;with&nbsp;the&nbsp;substring&nbsp;'Bill',&nbsp;you&nbsp;can&nbsp;use&nbsp;the<BR>following&nbsp;(in&nbsp;comparison&nbsp;with&nbsp;the&nbsp;SetTbColvalues&nbsp;stored&nbsp;procedure,<BR>this&nbsp;stored&nbsp;procedure&nbsp;replace&nbsp;only&nbsp;substring,&nbsp;not&nbsp;the&nbsp;entire<BR>column's&nbsp;value):</P>
<P>EXEC&nbsp;replace_substring&nbsp;@search_value&nbsp;=&nbsp;'John',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@replace_value&nbsp;=&nbsp;'Bill'<BR>*/</P>
<P>IF&nbsp;OBJECT_ID('replace_substring')&nbsp;IS&nbsp;NOT&nbsp;NULL&nbsp;DROP&nbsp;PROC&nbsp;replace_substring<BR>GO</P>
<P>CREATE&nbsp;PROCEDURE&nbsp;replace_substring&nbsp;(<BR>&nbsp;&nbsp;@search_value&nbsp;varchar(128)&nbsp;=&nbsp;null,<BR>&nbsp;&nbsp;@replace_value&nbsp;varchar(128)&nbsp;=&nbsp;null<BR>)<BR>AS<BR>DECLARE&nbsp;<BR>&nbsp;&nbsp;@execstr&nbsp;varchar(1000),<BR>&nbsp;&nbsp;@objectname&nbsp;sysname,<BR>&nbsp;&nbsp;@colname&nbsp;sysname</P>
<P>SET&nbsp;NOCOUNT&nbsp;ON<BR>IF&nbsp;@search_value&nbsp;IS&nbsp;NULL<BR>&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;RAISERROR&nbsp;('You&nbsp;must&nbsp;specify&nbsp;the&nbsp;value&nbsp;to&nbsp;search',&nbsp;16,&nbsp;1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>&nbsp;&nbsp;END<BR>IF&nbsp;@replace_value&nbsp;IS&nbsp;NULL<BR>&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;RAISERROR&nbsp;('You&nbsp;must&nbsp;specify&nbsp;the&nbsp;value&nbsp;to&nbsp;replace',&nbsp;16,&nbsp;1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>&nbsp;&nbsp;END</P>
<P>DECLARE&nbsp;tb_fetch_cursor&nbsp;CURSOR&nbsp;FOR<BR>&nbsp;&nbsp;SELECT&nbsp;name&nbsp;FROM&nbsp;sysobjects&nbsp;WHERE&nbsp;type&nbsp;=&nbsp;'U'<BR>OPEN&nbsp;tb_fetch_cursor<BR>FETCH&nbsp;NEXT&nbsp;FROM&nbsp;tb_fetch_cursor&nbsp;INTO&nbsp;@objectname<BR>WHILE&nbsp;(@@fetch_status&nbsp;&lt;&gt;&nbsp;-1)<BR>&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;DECLARE&nbsp;col_fetch_cursor&nbsp;CURSOR&nbsp;FOR<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;name&nbsp;FROM&nbsp;syscolumns&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;OBJECT_ID(@objectname)&nbsp;AND&nbsp;type&nbsp;IN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(SELECT&nbsp;type&nbsp;FROM&nbsp;systypes&nbsp;WHERE&nbsp;name&nbsp;=&nbsp;'char'&nbsp;OR&nbsp;name&nbsp;=&nbsp;'nchar'&nbsp;OR&nbsp;name&nbsp;=&nbsp;'varchar'&nbsp;OR&nbsp;name&nbsp;=&nbsp;'nvarchar')<BR>&nbsp;&nbsp;&nbsp;&nbsp;OPEN&nbsp;col_fetch_cursor&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;col_fetch_cursor&nbsp;INTO&nbsp;@colname<BR>&nbsp;&nbsp;&nbsp;&nbsp;WHILE&nbsp;(@@fetch_status&nbsp;&lt;&gt;&nbsp;-1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;@execstr&nbsp;=&nbsp;'IF&nbsp;EXISTS&nbsp;(SELECT&nbsp;*&nbsp;FROM&nbsp;'&nbsp;+&nbsp;@objectname&nbsp;+&nbsp;'&nbsp;WHERE&nbsp;'&nbsp;+&nbsp;@colname&nbsp;+&nbsp;'&nbsp;like&nbsp;''%'&nbsp;+&nbsp;@search_value&nbsp;+&nbsp;'%'')&nbsp;BEGIN&nbsp;SELECT&nbsp;'''&nbsp;+&nbsp;@objectname&nbsp;+&nbsp;'''&nbsp;as&nbsp;tbname,&nbsp;'''&nbsp;+&nbsp;@colname&nbsp;+&nbsp;'''&nbsp;as&nbsp;colname&nbsp;PRINT&nbsp;''''&nbsp;UPDATE&nbsp;'&nbsp;+&nbsp;@objectname&nbsp;+&nbsp;'&nbsp;SET&nbsp;'&nbsp;+&nbsp;@colname&nbsp;+&nbsp;'&nbsp;=&nbsp;REPLACE('&nbsp;+&nbsp;@colname&nbsp;+&nbsp;','''&nbsp;+&nbsp;@search_value&nbsp;+&nbsp;''','''&nbsp;+&nbsp;@replace_value&nbsp;+&nbsp;''')&nbsp;&nbsp;WHERE&nbsp;'&nbsp;+&nbsp;@colname&nbsp;+&nbsp;'&nbsp;like&nbsp;''%'&nbsp;+&nbsp;@search_value&nbsp;+&nbsp;'%''&nbsp;&nbsp;END'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXEC&nbsp;(@execstr)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;col_fetch_cursor&nbsp;INTO&nbsp;@colname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END<BR>&nbsp;&nbsp;&nbsp;&nbsp;DEALLOCATE&nbsp;col_fetch_cursor<BR>&nbsp;&nbsp;&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;tb_fetch_cursor&nbsp;INTO&nbsp;@objectname<BR>&nbsp;&nbsp;END<BR>DEALLOCATE&nbsp;tb_fetch_cursor<BR>GO<BR></P></FONT>