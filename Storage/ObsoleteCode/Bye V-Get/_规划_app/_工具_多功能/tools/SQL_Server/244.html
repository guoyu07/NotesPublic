<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>交叉表</B><BR>CREATE&nbsp;PROCEDURE&nbsp;prCrosstab&nbsp;<BR>@chrRowHead&nbsp;char(30),/*表示列，在交叉表的结果中作为第一列出现*/&nbsp;<BR>@chrColHead&nbsp;char(30),/*表示列，在交叉表的结果中该列中的数据被变换为新列名称*/&nbsp;<BR>@chrvalue&nbsp;char(30),/*表示列，在该列中执行聚合函数*/&nbsp;<BR>@chrSource&nbsp;char(30),/*源表或视图*/&nbsp;<BR>@inyType&nbsp;tinyint=1,/*1-求和，2-平均值，3-最小值，4-最大值，5-计数*/&nbsp;<BR>@inyGrouping&nbsp;tinyint=0/*1-工作日，2-年内的周数，3-月份，4-季度，5-年份*/&nbsp;<BR>AS&nbsp;<BR>/*过程变量*/&nbsp;<BR>Declare&nbsp;<BR>@chvRow&nbsp;varchar(255),&nbsp;<BR>@chvCol&nbsp;varchar(255),&nbsp;<BR>@chvVal&nbsp;varchar(255),&nbsp;<BR>@chvType&nbsp;varchar(10),&nbsp;<BR>@chvRowType&nbsp;varchar(10),&nbsp;<BR>@chvColType&nbsp;varchar(255),&nbsp;<BR>@chvTemp&nbsp;varchar(255),&nbsp;<BR>@chvColTemp&nbsp;varchar(255),&nbsp;<BR>@chvRowTemp&nbsp;varchar(255),&nbsp;<BR>@intType&nbsp;int,&nbsp;<BR>@intRowType&nbsp;int,&nbsp;<BR>@intColType&nbsp;int,&nbsp;<BR>@chvExec&nbsp;varchar(255),&nbsp;<BR>@chvGroup&nbsp;varchar(255),&nbsp;<BR>@fltTemp&nbsp;float,&nbsp;<BR>@dtmTemp&nbsp;Datetime,&nbsp;<BR>@insR&nbsp;smallint,&nbsp;<BR>@intColumn&nbsp;int,&nbsp;<BR>@intReturn&nbsp;int,&nbsp;<BR>@intTemp&nbsp;int,&nbsp;<BR>@intColNameLen&nbsp;int,&nbsp;<BR>@intMaxRowHead&nbsp;int&nbsp;<BR>Set&nbsp;NoCount&nbsp;On&nbsp; 

<P></P>
<P>/*检查数据源是否存在*/&nbsp;<BR>if&nbsp;not&nbsp;Exists&nbsp;<BR>(select&nbsp;*&nbsp;From&nbsp;sysobjects&nbsp;<BR>where&nbsp;name=@chrSource&nbsp;and&nbsp;type&nbsp;in('v','u'))&nbsp;<BR>Begin&nbsp;<BR>Raiserror&nbsp;51001&nbsp;'数据源不存在'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>/*检查列是否存在*/&nbsp;<BR>if&nbsp;not&nbsp;Exists&nbsp;<BR>(select&nbsp;sc.name&nbsp;from&nbsp;syscolumns&nbsp;sc&nbsp;<BR>join&nbsp;sysobjects&nbsp;so&nbsp;on&nbsp;sc.id=so.id&nbsp;<BR>where&nbsp;so.name=@chrSource&nbsp;<BR>and&nbsp;sc.name=@chrColHead)&nbsp;<BR>Begin&nbsp;<BR>Raiserror&nbsp;51002&nbsp;'无效&nbsp;@chrColHead&nbsp;名称'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>if&nbsp;not&nbsp;Exists&nbsp;<BR>(select&nbsp;sc.name&nbsp;from&nbsp;syscolumns&nbsp;sc&nbsp;<BR>join&nbsp;sysobjects&nbsp;so&nbsp;on&nbsp;sc.id=so.id&nbsp;<BR>where&nbsp;so.name=@chrSource&nbsp;<BR>and&nbsp;sc.name=@chrRowHead)&nbsp;<BR>Begin&nbsp;<BR>Raiserror&nbsp;51002&nbsp;'无效&nbsp;@chrRowHead名称'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>if&nbsp;not&nbsp;Exists&nbsp;<BR>(select&nbsp;sc.name&nbsp;from&nbsp;syscolumns&nbsp;sc&nbsp;<BR>join&nbsp;sysobjects&nbsp;so&nbsp;on&nbsp;sc.id=so.id&nbsp;<BR>where&nbsp;so.name=@chrSource&nbsp;<BR>and&nbsp;sc.name=@chrvalue)&nbsp;<BR>Begin&nbsp;<BR>Raiserror&nbsp;51002&nbsp;'无效&nbsp;@chrvalue&nbsp;名称'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>/*检查聚合函数类型，是否是有效值*/&nbsp;<BR>if&nbsp;@inyType&lt;1&nbsp;or&nbsp;@inyType&gt;5&nbsp;<BR>Begin&nbsp;<BR>Raiserror&nbsp;51000&nbsp;'无效聚合函数类型'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>/*确定聚合函数类型*/&nbsp;<BR>Select&nbsp;@chvType=&nbsp;<BR>Case&nbsp;@inyType&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'SUM'&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'AVG'&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;'MAX'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'MIN'&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'COUNT'&nbsp;<BR>else&nbsp;'SUM'&nbsp;<BR>End&nbsp;</P>
<P>/*取得@chrvalue的数据类型*/&nbsp;<BR>Select&nbsp;@chvTemp=t2.name&nbsp;<BR>From&nbsp;sysobjects&nbsp;o&nbsp;<BR>join&nbsp;syscolumns&nbsp;c&nbsp;on&nbsp;(o.id=c.id)&nbsp;<BR>join&nbsp;systypes&nbsp;t1&nbsp;on&nbsp;(t1.usertype=c.usertype)&nbsp;<BR>join&nbsp;systypes&nbsp;t2&nbsp;on&nbsp;(t1.type=t2.type)&nbsp;<BR>where&nbsp;t2.usertype&lt;100&nbsp;<BR>and&nbsp;t2.usertype&lt;&gt;18&nbsp;<BR>and&nbsp;t2.usertype&lt;&gt;80&nbsp;<BR>and&nbsp;o.type&nbsp;in&nbsp;('u','v')&nbsp;<BR>and&nbsp;o.name=@chrSource&nbsp;<BR>and&nbsp;c.name=@chrvalue&nbsp;</P>
<P>/*数据类型分类*/&nbsp;<BR>Select&nbsp;@intTemp=&nbsp;<BR>Case&nbsp;<BR>when&nbsp;@chvTemp&nbsp;in&nbsp;('int','smallint','tinyint','float','real','decimal','numeric','money','smallmoney')&nbsp;then&nbsp;1&nbsp;<BR>when&nbsp;@chvTemp&nbsp;in&nbsp;('datetime','smalldatetime')&nbsp;then&nbsp;3&nbsp;<BR>when&nbsp;@chvTemp&nbsp;in&nbsp;('bit','char','varchar')&nbsp;then&nbsp;5&nbsp;<BR>else&nbsp;100&nbsp;<BR>End&nbsp;</P>
<P>/*检查数据类型与聚合类型是否匹配*/&nbsp;<BR>if&nbsp;@inyType&lt;@intTemp&nbsp;<BR>Begin&nbsp;<BR>Raiserror&nbsp;51020&nbsp;'无效的数据类型&nbsp;@chrvalue'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>/*转换成合适的数据类型*/&nbsp;<BR>Select&nbsp;@chvColType=Rtrim(&nbsp;<BR>Case&nbsp;@inyType&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'int'&nbsp;<BR>else&nbsp;<BR>case&nbsp;<BR>when&nbsp;@chvTemp&nbsp;in&nbsp;('bit','char','varchar&nbsp;')&nbsp;then&nbsp;'int'&nbsp;<BR>when&nbsp;@chvTemp&nbsp;in&nbsp;('decimal','numeric')&nbsp;then&nbsp;'float'&nbsp;<BR>else&nbsp;@chvTemp&nbsp;<BR>end&nbsp;<BR>End)&nbsp;</P>
<P>/*确认数据分组是否有效*/&nbsp;<BR>if&nbsp;@inyGrouping&lt;0&nbsp;or&nbsp;@inyGrouping&gt;5&nbsp;<BR>Begin&nbsp;<BR>Raiserror&nbsp;51010&nbsp;'无效的数据分组'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>/*取得@chrColHead列的合法数据类型*/&nbsp;<BR>Select&nbsp;@chvTemp=t2.name&nbsp;<BR>From&nbsp;sysobjects&nbsp;o&nbsp;<BR>join&nbsp;syscolumns&nbsp;c&nbsp;on&nbsp;(o.id=c.id)&nbsp;<BR>join&nbsp;systypes&nbsp;t1&nbsp;on&nbsp;(t1.usertype=c.usertype)&nbsp;<BR>join&nbsp;systypes&nbsp;t2&nbsp;on&nbsp;(t1.type=t2.type)&nbsp;<BR>Where&nbsp;t2.usertype&lt;100&nbsp;<BR>and&nbsp;t2.usertype&lt;&gt;18&nbsp;<BR>and&nbsp;t2.usertype&lt;&gt;80&nbsp;<BR>and&nbsp;o.type&nbsp;in&nbsp;('u','v')&nbsp;<BR>and&nbsp;o.name=@chrSource&nbsp;<BR>and&nbsp;c.name=@chrColHead&nbsp;</P>
<P>if&nbsp;upper(@chvTemp)&nbsp;not&nbsp;in&nbsp;('CHAR','VARCHAR')&nbsp;<BR>Select&nbsp;@intColType=1&nbsp;<BR>else&nbsp;<BR>Select&nbsp;@intColType=0&nbsp;</P>
<P>/*取得@chrRowHead的合法数据类型*/&nbsp;<BR>Select&nbsp;@chvRowType=t2.name&nbsp;<BR>From&nbsp;sysobjects&nbsp;o&nbsp;<BR>join&nbsp;syscolumns&nbsp;c&nbsp;on&nbsp;(o.id=c.id)&nbsp;<BR>join&nbsp;systypes&nbsp;t1&nbsp;on&nbsp;(t1.usertype=c.usertype)&nbsp;<BR>join&nbsp;systypes&nbsp;t2&nbsp;on&nbsp;(t1.type=t2.type)&nbsp;<BR>Where&nbsp;t2.usertype&lt;100&nbsp;<BR>and&nbsp;t2.usertype&lt;&gt;18&nbsp;<BR>and&nbsp;t2.usertype&lt;&gt;80&nbsp;<BR>and&nbsp;o.type&nbsp;in&nbsp;('u','v')&nbsp;<BR>and&nbsp;o.name=@chrSource&nbsp;<BR>and&nbsp;c.name=@chrRowHead&nbsp;</P>
<P>if&nbsp;upper(@chvRowTemp)&nbsp;not&nbsp;in&nbsp;('CHAR','VARCHAR')&nbsp;<BR>Select&nbsp;@intRowType=1&nbsp;<BR>else&nbsp;<BR>Select&nbsp;@intRowType=0&nbsp;</P>
<P>/*检查组分类类型*/&nbsp;</P>
<P>Select&nbsp;@intTemp=&nbsp;<BR>Case&nbsp;<BR>when&nbsp;@chvTemp&nbsp;in&nbsp;('int','smallint','tinyint','float','real','decimal','numeric','money','smallmoney')&nbsp;then&nbsp;1&nbsp;<BR>when&nbsp;@chvTemp&nbsp;in&nbsp;('datetime','smalldatetime')&nbsp;then&nbsp;3&nbsp;<BR>when&nbsp;@chvTemp&nbsp;in&nbsp;('bit','char','varchar')&nbsp;then&nbsp;5&nbsp;<BR>else&nbsp;100&nbsp;<BR>End&nbsp;</P>
<P>/*验证数据类型与日期分组类型的一致性*/&nbsp;<BR>/*将来可扩充成其他数据类型分组*/&nbsp;<BR>if&nbsp;(@intTemp=5&nbsp;and&nbsp;@inyGrouping&gt;0)&nbsp;or&nbsp;(@intTemp=1&nbsp;and&nbsp;@inyGrouping&gt;0)&nbsp;or&nbsp;(@intTemp=3&nbsp;and&nbsp;@inyGrouping=0)&nbsp;<BR>Begin&nbsp;<BR>Raiserror&nbsp;51030&nbsp;'分组数据与分组类型不一致'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>/*安全性检查*/&nbsp;<BR>/*此部分以后完成&nbsp;<BR>if&nbsp;user_id()&lt;&gt;1&nbsp;<BR>Begin&nbsp;<BR>if&nbsp;(Select&nbsp;Count(distinct&nbsp;c.name)&nbsp;<BR>From&nbsp;syscolumns&nbsp;c,sysobjects&nbsp;o,sysprotects&nbsp;p,sysusers&nbsp;u,master..spt_values&nbsp;v&nbsp;<BR>Where&nbsp;c.name&nbsp;in&nbsp;(@chrColHead,@chrRowHead,@chrvalue)&nbsp;<BR>*/&nbsp;</P>
<P>/*定义临时表*/&nbsp;<BR>Create&nbsp;Table&nbsp;#colNames(colname&nbsp;varchar(255),colnumber&nbsp;int&nbsp;Null)&nbsp;<BR>Create&nbsp;Table&nbsp;#rownames(rowname&nbsp;varchar(255)&nbsp;null)&nbsp;</P>
<P><BR>/*创建colnames表*/&nbsp;<BR>Select&nbsp;@chvExec='insert&nbsp;#colnames&nbsp;select&nbsp;col1,col2&nbsp;from'&nbsp;<BR>+'(select&nbsp;distinct&nbsp;col1='+&nbsp;<BR>case&nbsp;@intTemp&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;<BR>case&nbsp;<BR>when&nbsp;@inyGrouping&nbsp;in&nbsp;(1,3)&nbsp;then&nbsp;'datename('+&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'weekday'&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;'month'&nbsp;<BR>end&nbsp;+','+RTrim(@chrColHead)+')'&nbsp;<BR>else&nbsp;<BR>Case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'''Week'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'''quarth'&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'''year'&nbsp;<BR>end+'_''+'+'datename('+&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'week'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'quarth'&nbsp;<BR>when&nbsp;5&nbsp;then'year'&nbsp;<BR>end+','+RTrim(@chrColHead)+')'&nbsp;<BR>end&nbsp;<BR>else&nbsp;<BR>case&nbsp;@intColType&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'convert(varchar(255),'+RTrim(@chrColHead)+')'&nbsp;<BR>else&nbsp;RTrim(@chrColHead)&nbsp;<BR>end&nbsp;<BR>end+',col2='+&nbsp;<BR>case&nbsp;@intTemp&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;'datepart('+&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'weekday'&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'week'&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;'month'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'quarter'&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'year'&nbsp;<BR>end+','+Rtrim(@chrColHead)+')'&nbsp;<BR>else&nbsp;'0'&nbsp;<BR>end+',col3='+&nbsp;<BR>case&nbsp;@intTemp&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;'datepart('+&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'weekday'&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'week'&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;'month'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'quarter'&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'year'&nbsp;<BR>end+','+RTrim(@chrColHead)+')'&nbsp;<BR>else&nbsp;RTrim(@chrColHead)&nbsp;<BR>end+'&nbsp;from&nbsp;'+RTrim(@chrSource)+')xyz&nbsp;order&nbsp;by&nbsp;col3'&nbsp;</P>
<P>--Print&nbsp;@chvExec&nbsp;<BR>Exec(@chvExec)&nbsp;<BR>--select&nbsp;*&nbsp;from&nbsp;#ColNames&nbsp;</P>
<P>/*检查列计数值*/&nbsp;<BR>if&nbsp;(select&nbsp;Count(*)&nbsp;from&nbsp;#colnames)&gt;1023&nbsp;<BR>begin&nbsp;<BR>drop&nbsp;table&nbsp;#colnames&nbsp;<BR>raiserror&nbsp;51004&nbsp;'Distinct&nbsp;column&nbsp;count&nbsp;exceeded&nbsp;max&nbsp;of&nbsp;1023.'&nbsp;<BR>return&nbsp;-1&nbsp;<BR>end&nbsp;</P>
<P>/*检验名称长度*/&nbsp;<BR>if&nbsp;(Select&nbsp;max(DataLength(Rtrim(colname))-1)&nbsp;from&nbsp;#colnames)&gt;29&nbsp;<BR>Begin&nbsp;<BR>Drop&nbsp;Table&nbsp;#colnames&nbsp;<BR>RaisError&nbsp;51050&nbsp;'Column&nbsp;data&nbsp;length&nbsp;exceeded&nbsp;max&nbsp;of&nbsp;30.'&nbsp;<BR>Return&nbsp;-1&nbsp;<BR>End&nbsp;</P>
<P>/*填写RowNames表*/&nbsp;<BR>Select&nbsp;@chvExec='insert&nbsp;#rownames&nbsp;select&nbsp;distinct&nbsp;'+&nbsp;<BR>Case&nbsp;@intRowtype&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'convert(varchar255),'&nbsp;<BR>else&nbsp;''&nbsp;<BR>end+Rtrim(@chrRowHead)+&nbsp;<BR>Case&nbsp;@intRowType&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;')'&nbsp;<BR>else&nbsp;''&nbsp;<BR>End+'&nbsp;from&nbsp;'+@chrSource&nbsp;</P>
<P>--Print&nbsp;@chvExec&nbsp;<BR>Exec(@chvExec)&nbsp;</P>
<P>/*创建和修改crosstable*/&nbsp;<BR>Select&nbsp;@intMaxRowHead=&nbsp;<BR>(Select&nbsp;Max(DataLength(RTrim(rowname)))&nbsp;from&nbsp;#rownames)&nbsp;</P>
<P>/*创建Crosstable*/&nbsp;<BR>/*定义Crosstable的RowHead字段*/&nbsp;<BR>Create&nbsp;Table&nbsp;#crosstable(Rowhead&nbsp;varchar(255)&nbsp;null)&nbsp;<BR>/*在Crosstable中加入列*/&nbsp;<BR>Declare&nbsp;colname_cursor2&nbsp;cursor&nbsp;for&nbsp;<BR>select&nbsp;colname&nbsp;from&nbsp;#colnames&nbsp;<BR>open&nbsp;colname_cursor2&nbsp;<BR>Fetch&nbsp;colname_cursor2&nbsp;into&nbsp;@chvCol&nbsp;<BR>while&nbsp;@@fetch_status&gt;=0&nbsp;<BR>Begin&nbsp;<BR>Select&nbsp;@chvColTemp=''&nbsp;<BR>if&nbsp;@chvCol&nbsp;Like&nbsp;'%[^A-Z0-9]%'&nbsp;<BR>Begin&nbsp;<BR>Select&nbsp;@insR=1&nbsp;<BR>While&nbsp;@insr&lt;=DataLength(RTrim(@chvCol))&nbsp;<BR>Begin&nbsp;<BR>Select&nbsp;@chvColTemp=Rtrim(@chvColtemp)+&nbsp;<BR>Case&nbsp;<BR>when&nbsp;substring(@chvCol,@insR,1)&nbsp;Like&nbsp;'[A-Z0-9_]'&nbsp;<BR>then&nbsp;substring(@chvCol,@insR,1)&nbsp;<BR>Else&nbsp;''&nbsp;<BR>End&nbsp;<BR>Select&nbsp;@insR=@insr+1&nbsp;<BR>end&nbsp;<BR>Select&nbsp;@chvCol=@chvColTemp&nbsp;<BR>End&nbsp;<BR>Select&nbsp;@chvExec='alter&nbsp;table&nbsp;#crosstable&nbsp;add&nbsp;'+&nbsp;<BR>Case&nbsp;<BR>when&nbsp;substring(@chvCol,1,1)&nbsp;Like&nbsp;'[^1234567890]'&nbsp;then&nbsp;@chvCol&nbsp;<BR>else&nbsp;'_'+LTrim(@chvCol)&nbsp;<BR>End&nbsp;<BR>+'&nbsp;'+@chvColType+'&nbsp;null&nbsp;default&nbsp;(0)'&nbsp;</P>
<P>--Print&nbsp;@chvExec&nbsp;<BR>Exec(@chvExec)&nbsp;<BR>Fetch&nbsp;colname_cursor2&nbsp;into&nbsp;@chvCol&nbsp;<BR>End&nbsp;<BR>Close&nbsp;colname_cursor2&nbsp;<BR>Deallocate&nbsp;colname_cursor2&nbsp;</P>
<P>/*加入初始Crosstable数据*/&nbsp;<BR>Select&nbsp;@chvExec='insert&nbsp;#crosstable(rowhead)&nbsp;select&nbsp;rowname&nbsp;from&nbsp;#rownames'&nbsp;<BR>--Print&nbsp;@chvExec&nbsp;<BR>Exec(@chvExec)&nbsp;</P>
<P>/*使用游标填写crosstable的剩余部分*/&nbsp;<BR>/*创建游标*/&nbsp;<BR>Select&nbsp;@chvExec='declare&nbsp;colname_cursor3&nbsp;cursor&nbsp;for&nbsp;select&nbsp;'+&nbsp;<BR>Case&nbsp;@intRowType&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'convert(varchar(255),'+RTrim(@chrRowHead)+')'&nbsp;<BR>Else&nbsp;RTrim(@chrRowHead)&nbsp;<BR>End+','+&nbsp;<BR>Case&nbsp;<BR>when&nbsp;@intTemp=3&nbsp;then&nbsp;<BR>case&nbsp;<BR>when&nbsp;@inyGrouping&nbsp;in&nbsp;(1,3)&nbsp;then&nbsp;'Datename('+&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'weekday'&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;'month'&nbsp;<BR>end+','+RTrim(@chrColHead)+')'&nbsp;<BR>else&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'''Week'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'''Quarth'&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'''Year'&nbsp;<BR>End+'_''+'+'datename('+&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'week'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'quarth'&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'year'&nbsp;<BR>end+','+RTrim(@chrColHead)+')'&nbsp;<BR>End&nbsp;</P>
<P>Else&nbsp;<BR>Case&nbsp;@intColType&nbsp;<BR>When&nbsp;1&nbsp;then&nbsp;'convert(varchar(255),'+RTrim(@chrColHead)+')'&nbsp;<BR>Else&nbsp;RTrim(@chrColHead)&nbsp;<BR>End&nbsp;<BR>End+',total=Convert(varchar(255),'+RTrim(@chvType)+'('+RTrim(@chrvalue)+'))&nbsp;from&nbsp;'+&nbsp;<BR>RTrim(@chrSource)+'&nbsp;group&nbsp;by&nbsp;'+RTRim(@chrRowHead)+','+&nbsp;<BR>Case&nbsp;@intTemp&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;<BR>case&nbsp;<BR>when&nbsp;@inyGrouping&nbsp;in&nbsp;(1,3)&nbsp;then&nbsp;'Datename('+&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;1&nbsp;then&nbsp;'weekday'&nbsp;<BR>when&nbsp;3&nbsp;then&nbsp;'month'&nbsp;<BR>end+','+RTrim(@chrColHead)+')'&nbsp;<BR>else&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'''Week'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'''Quarth'&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'''Year'&nbsp;<BR>end+'_''+'+'datename('+&nbsp;<BR>case&nbsp;@inyGrouping&nbsp;<BR>when&nbsp;2&nbsp;then&nbsp;'week'&nbsp;<BR>when&nbsp;4&nbsp;then&nbsp;'quarter'&nbsp;<BR>when&nbsp;5&nbsp;then&nbsp;'year'&nbsp;<BR>end+','+RTrim(@chrColHead)+')'&nbsp;<BR>end&nbsp;<BR>else&nbsp;Rtrim(@chrColHead)&nbsp;<BR>End&nbsp;<BR>--Print&nbsp;@chvExec&nbsp;<BR>Exec(@chvExec)&nbsp;</P>
<P>/*更新Crosstable表*/&nbsp;<BR>Begin&nbsp;Tran&nbsp;<BR>Open&nbsp;colname_cursor3&nbsp;<BR>Fetch&nbsp;colname_cursor3&nbsp;into&nbsp;@chvRow,@chvCol,@chvVal&nbsp;<BR>while&nbsp;@@fetch_status&gt;=0&nbsp;<BR>Begin&nbsp;<BR>Select&nbsp;@chvColTemp=''&nbsp;<BR>if&nbsp;@chvCol&nbsp;Like&nbsp;'%[^A-Z0-9]%'&nbsp;<BR>Begin&nbsp;<BR>Select&nbsp;@insR=1&nbsp;<BR>While&nbsp;@insR&lt;=DataLength(RTRim(@chvCol))&nbsp;<BR>Begin&nbsp;<BR>Select&nbsp;@chvColTemp=RTRim(@chvColTemp)+&nbsp;<BR>Case&nbsp;<BR>When&nbsp;Substring(@chvCol,@insR,1)&nbsp;Like&nbsp;'[A-Z0-9_]'&nbsp;then&nbsp;Substring(@chvCol,@insR,1)&nbsp;<BR>Else&nbsp;'&nbsp;'&nbsp;<BR>End&nbsp;<BR>Select&nbsp;@insR=@insR+1&nbsp;<BR>End&nbsp;<BR>Select&nbsp;@chvCol=@chvColTemp&nbsp;<BR>End&nbsp;<BR>Select&nbsp;@chvExec='update&nbsp;#crosstable&nbsp;set&nbsp;'+&nbsp;<BR>Case&nbsp;<BR>when&nbsp;substring(@chvCol,1,1)&nbsp;Like&nbsp;'[^1234567890]'&nbsp;then&nbsp;@chvCol&nbsp;<BR>Else&nbsp;'_'+LTrim(@chvCol)&nbsp;<BR>End+'='+&nbsp;<BR>Case&nbsp;<BR>when&nbsp;@chvVal&nbsp;is&nbsp;Null&nbsp;then&nbsp;'0'&nbsp;<BR>Else&nbsp;RTrim(@chvVal)&nbsp;<BR>End+'&nbsp;where&nbsp;Rowhead='''+RTRim(@chvRow)&nbsp;<BR>Select&nbsp;@chvRow=&nbsp;<BR>Case&nbsp;<BR>When&nbsp;@chvRow&nbsp;is&nbsp;Null&nbsp;Then&nbsp;'NULL'&nbsp;<BR>Else&nbsp;RTrim(@chvRow)&nbsp;<BR>End&nbsp;<BR>Select&nbsp;@chvRowTemp=''&nbsp;<BR>if&nbsp;@chvRow&nbsp;Like'%'&nbsp;<BR>Begin&nbsp;<BR>Select&nbsp;@insR=1&nbsp;<BR>While&nbsp;@insR&lt;=DataLength(RTrim(@chvRowTemp))-1&nbsp;<BR>Begin&nbsp;<BR>Select&nbsp;@chvRowTemp=RTrim(@chvRowTemp)+&nbsp;<BR>Case&nbsp;<BR>When&nbsp;Substring(@chvRow,@insR,1)&nbsp;Like&nbsp;'[^'']'&nbsp;then&nbsp;Substring(@chvRow,@insR,1)&nbsp;<BR>Else&nbsp;'&nbsp;''&nbsp;''&nbsp;'&nbsp;<BR>End&nbsp;<BR>Select&nbsp;@insR=@insR+1&nbsp;<BR>End&nbsp;<BR>End&nbsp;<BR>Select&nbsp;@chvRow=@chvRowTemp&nbsp;<BR>Select&nbsp;@chvExec=@chvExec+@chvRow+''''&nbsp;<BR>--Print&nbsp;@chvExec&nbsp;<BR>Exec(@chvExec)&nbsp;<BR>Fetch&nbsp;colname_cursor3&nbsp;into&nbsp;@chvRow,@chvCol,@chvVal&nbsp;<BR>End&nbsp;</P>
<P>Close&nbsp;colname_cursor3&nbsp;<BR>Deallocate&nbsp;colname_cursor3&nbsp;<BR>Commit&nbsp;Tran&nbsp;</P>
<P>Set&nbsp;NoCount&nbsp;off&nbsp;<BR>Select&nbsp;@chvExec='Select&nbsp;*&nbsp;from&nbsp;#crosstable'&nbsp;<BR>--Print&nbsp;@chvExec&nbsp;<BR>Exec(@chvExec)&nbsp;</P>
<P>Drop&nbsp;Table&nbsp;#colnames&nbsp;<BR>Drop&nbsp;Table&nbsp;#rownames&nbsp;<BR>Drop&nbsp;Table&nbsp;#crosstable</P></FONT>