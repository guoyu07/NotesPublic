<meta http-equiv="content-type" content="text/html; charset=gb2312">&nbsp;<FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>交叉制表-验证数据类型和聚合操作(4)</B><BR>现在用户需要找到value列的数据类型并确认它对于所使用请求的聚合类型是有效的
<P></P>
<P>--create&nbsp;typestr&nbsp;to&nbsp;hold&nbsp;aggregate&nbsp;name<BR>&nbsp;select&nbsp;@chvtype=<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;@inytype<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;1&nbsp;then&nbsp;''sum''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;2&nbsp;then&nbsp;''avg''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;3&nbsp;then&nbsp;''max''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;4&nbsp;then&nbsp;''min''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;5&nbsp;then&nbsp;''count''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;''sum''&nbsp;end<BR>--get&nbsp;standard&nbsp;&nbsp;data&nbsp;type&nbsp;of&nbsp;@chrvalue&nbsp;column<BR>select&nbsp;@chvtemp=t2.name<BR>&nbsp;&nbsp;from&nbsp;sysobjects&nbsp;o&nbsp;<BR>&nbsp;&nbsp;&nbsp;join&nbsp;syscolumns&nbsp;c&nbsp;on&nbsp;(o.id=c.id)<BR>&nbsp;&nbsp;&nbsp;join&nbsp;systypes&nbsp;t1&nbsp;on(t1.usertype=c.usertype)<BR>&nbsp;&nbsp;&nbsp;join&nbsp;systypes&nbsp;t2&nbsp;on(t1.type=t2.type)<BR>where&nbsp;t2.usertype&lt;100&nbsp;<BR>&nbsp;and&nbsp;t2.usertype&lt;&gt;18<BR>&nbsp;and&nbsp;t2.usertype&lt;&gt;80<BR>&nbsp;and&nbsp;o.type&nbsp;in(''u'',''v'')<BR>&nbsp;and&nbsp;o.name=@chrsource<BR>&nbsp;and&nbsp;c.name=@chrvalue<BR>--categorize&nbsp;type&nbsp;for&nbsp;aggregate&nbsp;check&nbsp;<BR>&nbsp;select&nbsp;@inttemp=case<BR>&nbsp;&nbsp;&nbsp;when&nbsp;@chvtemp&nbsp;in&nbsp;(''int'',''smallint'',''tinyint'',''float'',''real'',''decimal'',''numeric'',''money'',''smallmoney'')&nbsp;then&nbsp;1<BR>&nbsp;&nbsp;when&nbsp;@chvtemp&nbsp;in(''datetime'',''smalldatetime'')&nbsp;then&nbsp;3<BR>&nbsp;&nbsp;when&nbsp;@chvtemp&nbsp;in(''bit'',''char'',''varchar'')&nbsp;then&nbsp;5&nbsp;<BR>&nbsp;&nbsp;else&nbsp;100<BR>&nbsp;end<BR>--validate&nbsp;existing&nbsp;data&nbsp;type&nbsp;is&nbsp;consistent&nbsp;with&nbsp;selected&nbsp;aggregate<BR>&nbsp;if&nbsp;@inytype&nbsp;&lt;@inttemp<BR>&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;raiserror&nbsp;51020&nbsp;''crosstab&nbsp;type&nbsp;not&nbsp;valid&nbsp;with&nbsp;@chrvalue&nbsp;definition''<BR>&nbsp;&nbsp;&nbsp;return&nbsp;-1<BR>end<BR>--hold&nbsp;the&nbsp;data&nbsp;type&nbsp;&nbsp;for&nbsp;future&nbsp;use<BR>select&nbsp;@chrcoltype=rtrim(case&nbsp;@inytype&nbsp;when&nbsp;5&nbsp;then&nbsp;''int''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;case&nbsp;when&nbsp;@chvtemp&nbsp;in&nbsp;(''bit'',''char'',''varchar'')&nbsp;then&nbsp;''int''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;@chvtemp&nbsp;in(''decimal'',''numeric'')&nbsp;&nbsp;then&nbsp;''flaot''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;@chvtemp&nbsp;end<BR>&nbsp;&nbsp;&nbsp;end)<BR>--verfy&nbsp;grouping&nbsp;is&nbsp;valid&nbsp;for&nbsp;colhead<BR>&nbsp;if&nbsp;@inygrouping&lt;0&nbsp;or&nbsp;@inygrouping&gt;5<BR>begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;raiserror&nbsp;51010&nbsp;''invalid&nbsp;crosstab&nbsp;grouping''<BR>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1<BR>end<BR>数据类型可以分为1,3,5,100.聚合类型是否能有效使用value的数据类型.<BR>数据类型.聚合操作和分类值的列表.每个数据类型支持任何处于同一级别或更高级别的聚合操作.因为当传递给过程时聚合操作已经被分配了一个值,所以数据类型被分组</P>
<P>分类&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数据类型&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;聚合操作<BR>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numerics&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum<BR>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;avg<BR>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datetime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;min<BR>4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max<BR>5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其他所有类型&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count</P>
<P>如果需要计数,用户将value列的数据类型转换为int.否则&nbsp;bit.char和varchar值被转换为int<BR>(因为只有计数操作可以在bit,char和varchar上执行),并且numeric和decimals被转换成float.<BR>&nbsp;&nbsp;&nbsp;&nbsp;</P></FONT>