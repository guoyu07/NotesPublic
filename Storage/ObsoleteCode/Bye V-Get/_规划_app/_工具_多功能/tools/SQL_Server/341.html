<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>SQL&nbsp;Agent&nbsp;Date&nbsp;and&nbsp;Time&nbsp;Handling</B><BR>version:&nbsp;1.0.0.1
<P></P>
<P>last&nbsp;updated:&nbsp;22&nbsp;November&nbsp;2002</P>
<P>SQL&nbsp;Agent&nbsp;uses&nbsp;two&nbsp;ways&nbsp;to&nbsp;represent&nbsp;date&nbsp;and&nbsp;time&nbsp;information.&nbsp;In&nbsp;some&nbsp;cases&nbsp;it&nbsp;uses&nbsp;the&nbsp;SQL&nbsp;Server&nbsp;datatime&nbsp;data&nbsp;type,&nbsp;but&nbsp;in&nbsp;most&nbsp;occasions&nbsp;it&nbsp;uses&nbsp;two&nbsp;integers&nbsp;to&nbsp;represent&nbsp;the&nbsp;date&nbsp;and&nbsp;time&nbsp;separately.&nbsp;The&nbsp;format&nbsp;of&nbsp;the&nbsp;date&nbsp;and&nbsp;time&nbsp;integers&nbsp;are&nbsp;very&nbsp;straight&nbsp;forward,&nbsp;the&nbsp;date&nbsp;is&nbsp;formatted&nbsp;as&nbsp;YYYYMMDD&nbsp;and&nbsp;the&nbsp;time&nbsp;is&nbsp;formatted&nbsp;as&nbsp;HHMMSS.&nbsp;Everywhere&nbsp;where&nbsp;schedule&nbsp;information&nbsp;is&nbsp;represented&nbsp;the&nbsp;date&nbsp;and&nbsp;time&nbsp;are&nbsp;stored&nbsp;using&nbsp;integers.&nbsp;</P>
<P>The&nbsp;problem&nbsp;is&nbsp;that&nbsp;you&nbsp;need&nbsp;to&nbsp;convert&nbsp;the&nbsp;integer&nbsp;representation&nbsp;to&nbsp;a&nbsp;datetime,&nbsp;before&nbsp;you&nbsp;can&nbsp;leverage&nbsp;the&nbsp;existing&nbsp;datetime&nbsp;manipulation&nbsp;functions&nbsp;in&nbsp;SQL&nbsp;Server.&nbsp;This&nbsp;article&nbsp;provides&nbsp;helper&nbsp;functions&nbsp;to&nbsp;convert&nbsp;between&nbsp;the&nbsp;two&nbsp;representations.&nbsp;In&nbsp;total&nbsp;there&nbsp;are&nbsp;five&nbsp;user&nbsp;defined&nbsp;functions.</P>
<P>Name&nbsp;Description&nbsp;<BR>fn_AgentDate2DateTime&nbsp;Converts&nbsp;an&nbsp;SQL&nbsp;Agent&nbsp;integer&nbsp;date&nbsp;representation&nbsp;in&nbsp;to&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;datetime&nbsp;datatype,&nbsp;since&nbsp;the&nbsp;time&nbsp;is&nbsp;not&nbsp;specified,&nbsp;the&nbsp;time&nbsp;is&nbsp;always&nbsp;00:00:00.000&nbsp;<BR>fn_AgentTime2DateTime&nbsp;Converts&nbsp;an&nbsp;SQL&nbsp;Agent&nbsp;integer&nbsp;time&nbsp;representation&nbsp;in&nbsp;to&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;datetime&nbsp;datatype,&nbsp;since&nbsp;the&nbsp;date&nbsp;is&nbsp;not&nbsp;specified,&nbsp;the&nbsp;date&nbsp;is&nbsp;always&nbsp;1900-01-01&nbsp;<BR>fn_AgentDateTime2DateTime&nbsp;Converts&nbsp;an&nbsp;SQL&nbsp;Agent&nbsp;integer&nbsp;date&nbsp;and&nbsp;time&nbsp;representation&nbsp;in&nbsp;to&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;datetime&nbsp;datatype&nbsp;<BR>fn_DateTime2AgentDate&nbsp;Converts&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;datetime&nbsp;into&nbsp;an&nbsp;SQL&nbsp;Agent&nbsp;integer&nbsp;date&nbsp;representation&nbsp;<BR>fn_DateTime2AgentTime&nbsp;Converts&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;datetime&nbsp;into&nbsp;an&nbsp;SQL&nbsp;Agent&nbsp;integer&nbsp;time&nbsp;representation&nbsp;</P>
<P>Below&nbsp;follows&nbsp;the&nbsp;source&nbsp;code&nbsp;for&nbsp;the&nbsp;five&nbsp;user&nbsp;defined&nbsp;functions:</P>
<P>create&nbsp;function&nbsp;[dbo].[fn_AgentDate2DateTime]&nbsp;(@agentdate&nbsp;int)<BR>returns&nbsp;datetime<BR>as<BR>begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;@date&nbsp;datetime,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@year&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@month&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@day&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@datestr&nbsp;nvarchar(40)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@year&nbsp;=&nbsp;(@agentdate&nbsp;/&nbsp;10000)<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@month&nbsp;=&nbsp;(@agentdate&nbsp;-&nbsp;(@year&nbsp;*&nbsp;10000))&nbsp;/&nbsp;100<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@day&nbsp;=&nbsp;(@agentdate&nbsp;-&nbsp;(@year&nbsp;*&nbsp;10000)&nbsp;-&nbsp;(@month&nbsp;*&nbsp;100))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@datestr&nbsp;=&nbsp;convert(nvarchar(4),&nbsp;@year)&nbsp;+&nbsp;N'-'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert(nvarchar(2),&nbsp;@month)&nbsp;+&nbsp;N'-'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert(nvarchar(4),&nbsp;@day)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@date&nbsp;=&nbsp;convert(datetime,&nbsp;@datestr)<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;@date<BR>end<BR>go</P>
<P>--&nbsp;example<BR>select&nbsp;[dbo].[fn_AgentDate2DateTime](20020430)<BR>go</P>
<P>create&nbsp;function&nbsp;[dbo].[fn_AgentTime2DateTime](@agenttime&nbsp;int)<BR>returns&nbsp;datetime<BR>as<BR>begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;@date&nbsp;datetime,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@hour&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@min&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@sec&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@datestr&nbsp;nvarchar(40)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@hour&nbsp;=&nbsp;(@agenttime&nbsp;/&nbsp;10000)<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@min&nbsp;=&nbsp;(@agenttime&nbsp;-&nbsp;(@hour&nbsp;*&nbsp;10000))&nbsp;/&nbsp;100<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@sec&nbsp;=&nbsp;(@agenttime&nbsp;-&nbsp;(@hour&nbsp;*&nbsp;10000)&nbsp;-&nbsp;(@min&nbsp;*&nbsp;100))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@datestr&nbsp;=&nbsp;replace(convert(nvarchar(2),&nbsp;@hour)&nbsp;+&nbsp;N':'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert(nvarchar(2),&nbsp;@min)&nbsp;+&nbsp;N':'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert(nvarchar(2),&nbsp;@sec),&nbsp;'&nbsp;',&nbsp;'0')</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@date&nbsp;=&nbsp;convert(datetime,&nbsp;@datestr)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;@date<BR>end<BR>go</P>
<P>--&nbsp;example<BR>select&nbsp;[dbo].[fn_AgentTime2DateTime]&nbsp;(110015)<BR>go</P>
<P>create&nbsp;function&nbsp;[dbo].[fn_AgentDateTime2DateTime]&nbsp;(@agentdate&nbsp;int,&nbsp;@agenttime&nbsp;int)<BR>returns&nbsp;datetime<BR>as<BR>begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;@date&nbsp;datetime,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@year&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@month&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@day&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@hour&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@min&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@sec&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@datestr&nbsp;nvarchar(40)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@year&nbsp;=&nbsp;(@agentdate&nbsp;/&nbsp;10000)<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@month&nbsp;=&nbsp;(@agentdate&nbsp;-&nbsp;(@year&nbsp;*&nbsp;10000))&nbsp;/&nbsp;100<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@day&nbsp;=&nbsp;(@agentdate&nbsp;-&nbsp;(@year&nbsp;*&nbsp;10000)&nbsp;-&nbsp;(@month&nbsp;*&nbsp;100))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@hour&nbsp;=&nbsp;(@agenttime&nbsp;/&nbsp;10000)<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@min&nbsp;=&nbsp;(@agenttime&nbsp;-&nbsp;(@hour&nbsp;*&nbsp;10000))&nbsp;/&nbsp;100<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@sec&nbsp;=&nbsp;(@agenttime&nbsp;-&nbsp;(@hour&nbsp;*&nbsp;10000)&nbsp;-&nbsp;(@min&nbsp;*&nbsp;100))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@datestr&nbsp;=&nbsp;convert(nvarchar(4),&nbsp;@year)&nbsp;+&nbsp;N'-'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert(nvarchar(2),&nbsp;@month)&nbsp;+&nbsp;N'-'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert(nvarchar(4),&nbsp;@day)&nbsp;+&nbsp;N'&nbsp;'&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replace(convert(nchar(2),&nbsp;@hour)&nbsp;+&nbsp;N':'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert(nchar(2),&nbsp;@min)&nbsp;+&nbsp;N':'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert(nchar(2),&nbsp;@sec),&nbsp;'&nbsp;',&nbsp;'0')</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@date&nbsp;=&nbsp;convert(datetime,&nbsp;@datestr)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;@date<BR>end<BR>go</P>
<P>--&nbsp;example<BR>select&nbsp;[dbo].[fn_AgentDateTime2DateTime]&nbsp;(20020222,&nbsp;110015)<BR>go</P>
<P>create&nbsp;function&nbsp;[dbo].[fn_DateTime2AgentDate]&nbsp;(@date&nbsp;datetime)<BR>returns&nbsp;int<BR>as<BR>begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;@dateint&nbsp;int</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@dateint&nbsp;=&nbsp;(datepart(year,&nbsp;@date)&nbsp;*&nbsp;10000)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(datepart(month,&nbsp;@date)&nbsp;*&nbsp;100)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(datepart(day,&nbsp;@date))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;@dateint&nbsp;<BR>end<BR>go</P>
<P>--&nbsp;example<BR>select&nbsp;[dbo].[fn_DateTime2AgentDate]&nbsp;(getdate())<BR>go</P>
<P>create&nbsp;function&nbsp;[dbo].[fn_DateTime2AgentTime]&nbsp;(@date&nbsp;datetime)<BR>returns&nbsp;int<BR>as<BR>begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;@timeint&nbsp;int</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@timeint&nbsp;=&nbsp;(datepart(hour,&nbsp;@date)&nbsp;*&nbsp;10000)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(datepart(minute,&nbsp;@date)&nbsp;*&nbsp;100)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(datepart(second,&nbsp;@date))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;@timeint<BR>end<BR>go</P>
<P>--&nbsp;example<BR>select&nbsp;[dbo].[fn_DateTime2AgentTime]&nbsp;(getdate())<BR>go</P></FONT>