<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Reusing&nbsp;Identities</B><BR>What&nbsp;is&nbsp;the&nbsp;best&nbsp;way&nbsp;to&nbsp;Find&nbsp;and&nbsp;reuse&nbsp;deleted&nbsp;identities&nbsp;
<P></P>
<P>By:&nbsp;Dinesh&nbsp;Priyankara&nbsp;</P>
<P>In&nbsp;most&nbsp;table&nbsp;designs,&nbsp;Identity&nbsp;columns&nbsp;are&nbsp;used&nbsp;to&nbsp;maintain&nbsp;the&nbsp;uniqueness&nbsp;of&nbsp;records.&nbsp;There&nbsp;is&nbsp;no&nbsp;problem&nbsp;with&nbsp;insertion&nbsp;and&nbsp;modification&nbsp;of&nbsp;data&nbsp;using&nbsp;an&nbsp;identity&nbsp;column.&nbsp;With&nbsp;deletions&nbsp;though,&nbsp;gaps&nbsp;can&nbsp;occur&nbsp;between&nbsp;identity&nbsp;values.&nbsp;There&nbsp;are&nbsp;several&nbsp;ways&nbsp;to&nbsp;reuse&nbsp;these&nbsp;deleted&nbsp;(removed)&nbsp;identity&nbsp;values.&nbsp;&nbsp;</P>
<P>You&nbsp;can&nbsp;find&nbsp;a&nbsp;good&nbsp;solution&nbsp;in&nbsp;Books&nbsp;Online&nbsp;but&nbsp;I&nbsp;wanted&nbsp;to&nbsp;find&nbsp;a&nbsp;new&nbsp;way&nbsp;and&nbsp;my&nbsp;research&nbsp;ended&nbsp;up&nbsp;with&nbsp;a&nbsp;good&nbsp;solution.&nbsp;After&nbsp;several&nbsp;comparisons,&nbsp;I&nbsp;decided&nbsp;to&nbsp;continue&nbsp;with&nbsp;my&nbsp;solution.&nbsp;So,&nbsp;I'd&nbsp;like&nbsp;to&nbsp;share&nbsp;my&nbsp;method&nbsp;with&nbsp;you&nbsp;all&nbsp;and&nbsp;let&nbsp;you&nbsp;decide&nbsp;what&nbsp;solution&nbsp;to&nbsp;use.&nbsp;</P>
<P><BR>First&nbsp;of&nbsp;all,&nbsp;let’s&nbsp;create&nbsp;a&nbsp;table&nbsp;called&nbsp;&nbsp;?OrderHeader'?that&nbsp;has&nbsp;three&nbsp;columns.&nbsp;Note&nbsp;that&nbsp;the&nbsp;first&nbsp;column&nbsp;intID&nbsp;is&nbsp;identity&nbsp;type&nbsp;column.&nbsp;<BR>&nbsp;</P>
<P>IF&nbsp;OBJECT_ID('OrderHeader')&nbsp;IS&nbsp;NOT&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DROP&nbsp;TABLE&nbsp;OrderHeader<BR>GO<BR>CREATE&nbsp;TABLE&nbsp;OrderHeader<BR>(intID&nbsp;int&nbsp;IDENTITY(1,1)&nbsp;PRIMARY&nbsp;KEY,<BR>strOrderNumber&nbsp;varchar(10)&nbsp;NOT&nbsp;NULL,<BR>strDescription&nbsp;varchar(100))&nbsp;<BR>&nbsp;</P>
<P>Now&nbsp;let’s&nbsp;add&nbsp;some&nbsp;records&nbsp;to&nbsp;table.&nbsp;If&nbsp;you&nbsp;want,&nbsp;you&nbsp;can&nbsp;add&nbsp;small&nbsp;amount&nbsp;of&nbsp;records&nbsp;but&nbsp;I&nbsp;added&nbsp;10000&nbsp;records&nbsp;because&nbsp;most&nbsp;tables&nbsp;have&nbsp;more&nbsp;than&nbsp;10000&nbsp;records&nbsp;and&nbsp;we&nbsp;must&nbsp;always&nbsp;try&nbsp;to&nbsp;make&nbsp;our&nbsp;testing&nbsp;environment&nbsp;real.&nbsp;<BR>DECLARE&nbsp;@A&nbsp;smallint<BR>SET&nbsp;@A&nbsp;=&nbsp;1&nbsp;<BR>WHILE&nbsp;(@A&nbsp;&lt;&gt;&nbsp;10001)<BR>BEGIN&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT&nbsp;INTO&nbsp;OrderHeader&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(strOrderNumber,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strDescription)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;valueS&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(‘OD-'&nbsp;+&nbsp;CONVERT(varchar(3),&nbsp;@A),&nbsp;--&nbsp;Adding&nbsp;something&nbsp;for&nbsp;Order&nbsp;Number&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Description'&nbsp;+&nbsp;CONVERT(varchar(3),&nbsp;@A))&nbsp;--&nbsp;Adding&nbsp;something&nbsp;for&nbsp;Description&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;@A&nbsp;=&nbsp;@A&nbsp;+&nbsp;1&nbsp;<BR>END&nbsp;&nbsp;</P>
<P>OK.&nbsp;Let’s&nbsp;delete&nbsp;some&nbsp;randomly&nbsp;selected&nbsp;records&nbsp;from&nbsp;the&nbsp;table.&nbsp;</P>
<P>DELETE&nbsp;OrderHeader&nbsp;WHERE&nbsp;intID&nbsp;=&nbsp;9212<BR>DELETE&nbsp;OrderHeader&nbsp;WHERE&nbsp;intID&nbsp;=&nbsp;2210<BR>DELETE&nbsp;OrderHeader&nbsp;WHERE&nbsp;intID&nbsp;=&nbsp;3200<BR>&nbsp;<BR>If&nbsp;you&nbsp;run&nbsp;now&nbsp;a&nbsp;simple&nbsp;select&nbsp;query&nbsp;against&nbsp;the&nbsp;table,&nbsp;you&nbsp;will&nbsp;see&nbsp;some&nbsp;gaps&nbsp;between&nbsp;the&nbsp;column&nbsp;intID&nbsp;values.&nbsp;</P>
<P>Now&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;find&nbsp;these&nbsp;gaps&nbsp;and&nbsp;reuse.&nbsp;As&nbsp;I&nbsp;mentioned&nbsp;above&nbsp;there&nbsp;are&nbsp;two&nbsp;methods&nbsp;(or&nbsp;more&nbsp;methods&nbsp;if&nbsp;you&nbsp;have&nbsp;already&nbsp;done&nbsp;in&nbsp;some&nbsp;other&nbsp;way).&nbsp;First&nbsp;let’s&nbsp;see&nbsp;the&nbsp;BOL&nbsp;example.&nbsp;</P>
<P><BR>Method&nbsp;1&nbsp;</P>
<P>DECLARE&nbsp;@NextIdentityvalue&nbsp;int</P>
<P>SELECT&nbsp;@NextIdentityvalue&nbsp;=&nbsp;MIN(IDENTITYCOL)&nbsp;+&nbsp;IDENT_INCR('OrderHeader')&nbsp;<BR>FROM&nbsp;OrderHeader&nbsp;t1<BR>WHERE&nbsp;IDENTITYCOL&nbsp;BETWEEN&nbsp;IDENT_SEED('OrderHeader')&nbsp;AND&nbsp;32766&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;NOT&nbsp;EXISTS&nbsp;(SELECT&nbsp;*&nbsp;FROM&nbsp;OrderHeader&nbsp;t2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;t2.IDENTITYCOL&nbsp;=&nbsp;t1.IDENTITYCOL&nbsp;+&nbsp;IDENT_INCR('OrderHeader'))</P>
<P>SELECT&nbsp;@NextIdentityvalue&nbsp;AS&nbsp;NextIdentityvalue</P>
<P>Output:<BR>NextIdentityvalue<BR>--------------------<BR>2210<BR>&nbsp;</P>
<P>This&nbsp;is&nbsp;very&nbsp;simple&nbsp;query.&nbsp;You&nbsp;can&nbsp;find&nbsp;the&nbsp;first&nbsp;deleted&nbsp;identity&nbsp;value&nbsp;and&nbsp;can&nbsp;reuse&nbsp;it.&nbsp;But&nbsp;remember&nbsp;you&nbsp;have&nbsp;to&nbsp;set&nbsp;the&nbsp;IDENTITY_INSERT&nbsp;ON&nbsp;that&nbsp;is&nbsp;allowed&nbsp;to&nbsp;explicit&nbsp;values&nbsp;to&nbsp;be&nbsp;inserted&nbsp;into&nbsp;identity&nbsp;column.&nbsp;</P>
<P>SET&nbsp;IDENTITY_INSERT&nbsp;OrderHeader&nbsp;ON</P>
<P>INSERT&nbsp;INTO&nbsp;OrderHeader<BR>&nbsp;&nbsp;&nbsp;&nbsp;(intID,<BR>&nbsp;&nbsp;&nbsp;&nbsp;strOrderNumber,<BR>&nbsp;&nbsp;&nbsp;&nbsp;strDescription)<BR>valueS<BR>&nbsp;&nbsp;&nbsp;&nbsp;(@NextIdentityvalue,<BR>&nbsp;&nbsp;&nbsp;&nbsp;‘OD-'&nbsp;+&nbsp;CONVERT(varchar(3),&nbsp;@A),<BR>&nbsp;&nbsp;&nbsp;&nbsp;'Description'&nbsp;+&nbsp;CONVERT(varchar(3),&nbsp;@A))</P>
<P>SET&nbsp;IDENTITY_INSERT&nbsp;OrderHeader&nbsp;OFF<BR>&nbsp;<BR>Now&nbsp;let’s&nbsp;see&nbsp;the&nbsp;method&nbsp;2.</P>
<P>Method&nbsp;2&nbsp;&nbsp;</P>
<P>Now&nbsp;I&nbsp;am&nbsp;going&nbsp;to&nbsp;create&nbsp;another&nbsp;table&nbsp;that&nbsp;is&nbsp;called&nbsp;“tb_Numbers?and&nbsp;has&nbsp;only&nbsp;one&nbsp;column&nbsp;that&nbsp;contains&nbsp;numbers&nbsp;in&nbsp;sequence.&nbsp;In&nbsp;my&nbsp;most&nbsp;databases,&nbsp;I&nbsp;have&nbsp;created&nbsp;and&nbsp;used&nbsp;this&nbsp;table&nbsp;for&nbsp;many&nbsp;tasks.&nbsp;Let&nbsp;me&nbsp;come&nbsp;with&nbsp;those&nbsp;in&nbsp;my&nbsp;future&nbsp;articles.&nbsp;</P>
<P>IF&nbsp;OBJECT_ID('tb_Numbers')&nbsp;IS&nbsp;NOT&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;&nbsp;DROP&nbsp;TABLE&nbsp;tb_Numbers<BR>GO<BR>CREATE&nbsp;TABLE&nbsp;tb_Numbers<BR>(intNumber&nbsp;int&nbsp;PRIMARY&nbsp;KEY)<BR>&nbsp;</P>
<P>Note&nbsp;that&nbsp;I&nbsp;have&nbsp;inserted&nbsp;30000&nbsp;records&nbsp;(numbers)&nbsp;into&nbsp;the&nbsp;table.&nbsp;The&nbsp;range&nbsp;is&nbsp;depending&nbsp;on&nbsp;the&nbsp;usage&nbsp;of&nbsp;this&nbsp;table.&nbsp;In&nbsp;my&nbsp;some&nbsp;of&nbsp;databases,&nbsp;this&nbsp;range&nbsp;was&nbsp;1&nbsp;to&nbsp;1000000.&nbsp;</P>
<P>DECLARE&nbsp;@A1&nbsp;int<BR>SET&nbsp;@A1&nbsp;=&nbsp;1</P>
<P>WHILE&nbsp;(@A1&nbsp;&lt;&gt;&nbsp;30000)&nbsp;<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;INSERT&nbsp;INTO&nbsp;tb_Numbers&nbsp;(intNumber)&nbsp;valueS&nbsp;(@A1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;@A1&nbsp;=&nbsp;@A1&nbsp;+&nbsp;1<BR>END<BR>&nbsp;</P>
<P>Now&nbsp;let’s&nbsp;query&nbsp;the&nbsp;gaps&nbsp;(or&nbsp;first&nbsp;deleted&nbsp;identity&nbsp;value)&nbsp;in&nbsp;the&nbsp;OrderHeader&nbsp;table&nbsp;</P>
<P>SELECT&nbsp;TOP&nbsp;1&nbsp;@NextIdentityvalue&nbsp;=&nbsp;intNumber<BR>FROM&nbsp;OrderHeader&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;RIGHT&nbsp;OUTER&nbsp;JOIN&nbsp;tb_Numbers<BR>&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;tb_Numbers.intNumber&nbsp;=&nbsp;OrderHeader.intID<BR>WHERE&nbsp;intID&nbsp;IS&nbsp;NULL&nbsp;AND&nbsp;intNumber&nbsp;&lt;&nbsp;=&nbsp;(SELECT&nbsp;MAX(intID)&nbsp;FROM&nbsp;OrderHeader)&nbsp;</P>
<P>SELECT&nbsp;@NextIdentityvalue&nbsp;AS&nbsp;NextIdentityvalue<BR>Output:<BR>NextIdentityvalue<BR>--------------------<BR>2210<BR>&nbsp;</P>
<P>This&nbsp;is&nbsp;very&nbsp;simple&nbsp;query&nbsp;too.&nbsp;I&nbsp;have&nbsp;used&nbsp;RIGHT&nbsp;OUTER&nbsp;JOIN&nbsp;to&nbsp;join&nbsp;the&nbsp;OrderHeader&nbsp;table&nbsp;with&nbsp;tb_Numbers.&nbsp;This&nbsp;join&nbsp;causes&nbsp;to&nbsp;return&nbsp;all&nbsp;rows&nbsp;(numbers)&nbsp;from&nbsp;tb_Numbers&nbsp;table.&nbsp;Then&nbsp;I&nbsp;have&nbsp;used&nbsp;some&nbsp;search&nbsp;conditions&nbsp;(WHERE&nbsp;clauses)&nbsp;to&nbsp;get&nbsp;the&nbsp;correct&nbsp;result&nbsp;set.&nbsp;&nbsp;This&nbsp;result&nbsp;set&nbsp;contains&nbsp;all&nbsp;missing&nbsp;values&nbsp;in&nbsp;intID&nbsp;column.&nbsp;&nbsp;By&nbsp;using&nbsp;TOP&nbsp;1,&nbsp;we&nbsp;can&nbsp;get&nbsp;the&nbsp;desired&nbsp;result.</P>
<P>You&nbsp;can&nbsp;do&nbsp;the&nbsp;insertion&nbsp;same&nbsp;way&nbsp;as&nbsp;I&nbsp;have&nbsp;done&nbsp;in&nbsp;method&nbsp;1.&nbsp;</P>
<P><BR>Now&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;compare&nbsp;these&nbsp;two&nbsp;methods.&nbsp;I&nbsp;simply&nbsp;used&nbsp;STATISTICS&nbsp;IO&nbsp;and&nbsp;the&nbsp;EXECUTION&nbsp;TIME&nbsp;to&nbsp;get&nbsp;the&nbsp;evaluation.&nbsp;</P>
<P><BR>Comparison&nbsp;</P>
<P>DECLARE&nbsp;@StartingTime&nbsp;datetime,&nbsp;@EndingTime&nbsp;datetime</P>
<P>Print&nbsp;‘method1:?BR&gt;<BR>SET&nbsp;STATISTICS&nbsp;IO&nbsp;ON<BR>SET&nbsp;@StartingTime&nbsp;=&nbsp;getdate()</P>
<P>SELECT&nbsp;MIN(IDENTITYCOL)&nbsp;+&nbsp;IDENT_INCR('OrderHeader')<BR>FROM&nbsp;OrderHeader&nbsp;t1<BR>WHERE&nbsp;IDENTITYCOL&nbsp;BETWEEN&nbsp;IDENT_SEED('OrderHeader')&nbsp;AND&nbsp;32766&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;NOT&nbsp;EXISTS&nbsp;(SELECT&nbsp;*&nbsp;FROM&nbsp;OrderHeader&nbsp;t2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;t2.IDENTITYCOL&nbsp;=&nbsp;t1.IDENTITYCOL&nbsp;+&nbsp;IDENT_INCR('OrderHeader'))</P>
<P>SET&nbsp;@EndingTime&nbsp;=&nbsp;getdate()<BR>SET&nbsp;STATISTICS&nbsp;IO&nbsp;OFF</P>
<P>SELECT&nbsp;DATEDIFF(ms,&nbsp;@StartingTime,&nbsp;@EndingTime&nbsp;)&nbsp;AS&nbsp;ExecTimeInMS</P>
<P>Print&nbsp;‘method2:?BR&gt;<BR>SET&nbsp;STATISTICS&nbsp;IO&nbsp;ON<BR>SET&nbsp;@StartingTime&nbsp;=&nbsp;getdate()</P>
<P>SELECT&nbsp;TOP&nbsp;1&nbsp;intNumber&nbsp;<BR>FROM&nbsp;OrderHeader&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;RIGHT&nbsp;OUTER&nbsp;JOIN&nbsp;tb_Numbers<BR>&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;tb_Numbers.intNumber&nbsp;=&nbsp;OrderHeader.intID<BR>WHERE&nbsp;intID&nbsp;IS&nbsp;NULL&nbsp;AND&nbsp;intNumber&nbsp;&lt;&nbsp;=&nbsp;(SELECT&nbsp;MAX(intID)&nbsp;FROM&nbsp;OrderHeader)&nbsp;</P>
<P>SET&nbsp;@EndingTime&nbsp;=&nbsp;getdate()<BR>SET&nbsp;STATISTICS&nbsp;IO&nbsp;OFF</P>
<P>SELECT&nbsp;DATEDIFF(ms,&nbsp;@StartingTime,&nbsp;@EndingTime&nbsp;)&nbsp;AS&nbsp;ExecTimeInMS<BR>Output:<BR>Method1:</P>
<P>2210</P>
<P>Table&nbsp;'OrderHeader'.&nbsp;Scan&nbsp;count&nbsp;9998,&nbsp;logical&nbsp;reads&nbsp;20086,&nbsp;physical&nbsp;reads&nbsp;0,&nbsp;read-ahead&nbsp;reads&nbsp;0.</P>
<P>ExecTimeInMS&nbsp;<BR>------------&nbsp;<BR>200</P>
<P>Method2:<BR>2210</P>
<P>Table&nbsp;'tb_Numbers'.&nbsp;Scan&nbsp;count&nbsp;1,&nbsp;logical&nbsp;reads&nbsp;5,&nbsp;physical&nbsp;reads&nbsp;0,&nbsp;read-ahead&nbsp;reads&nbsp;0.<BR>Table&nbsp;'OrderHeader'.&nbsp;Scan&nbsp;count&nbsp;2,&nbsp;logical&nbsp;reads&nbsp;14,&nbsp;physical&nbsp;reads&nbsp;0,&nbsp;read-ahead&nbsp;reads&nbsp;0.</P>
<P>ExecTimeInMS&nbsp;<BR>------------&nbsp;<BR>0<BR>&nbsp;</P>
<P>As&nbsp;per&nbsp;the&nbsp;output,&nbsp;there&nbsp;are&nbsp;20086&nbsp;logical&nbsp;reads&nbsp;and&nbsp;it&nbsp;has&nbsp;taken&nbsp;200&nbsp;ms&nbsp;for&nbsp;the&nbsp;first&nbsp;method.&nbsp;But&nbsp;in&nbsp;second&nbsp;method&nbsp;there&nbsp;are&nbsp;only&nbsp;19&nbsp;logical&nbsp;reads&nbsp;and&nbsp;the&nbsp;execution&nbsp;time&nbsp;is&nbsp;less&nbsp;considerable.&nbsp;</P>
<P>That’s&nbsp;why&nbsp;I&nbsp;selected&nbsp;to&nbsp;continue&nbsp;in&nbsp;my&nbsp;way.&nbsp;But&nbsp;there&nbsp;may&nbsp;be&nbsp;a&nbsp;side&nbsp;that&nbsp;I&nbsp;have&nbsp;not&nbsp;seen&nbsp;but&nbsp;you&nbsp;can&nbsp;see.&nbsp;So,&nbsp;try&nbsp;on&nbsp;this&nbsp;and&nbsp;see&nbsp;whether&nbsp;how&nbsp;this&nbsp;T-SQL&nbsp;solution&nbsp;suit&nbsp;for&nbsp;you.&nbsp;</P>
<P><BR>I&nbsp;highly&nbsp;appreciate&nbsp;your&nbsp;comments&nbsp;and&nbsp;suggestion.&nbsp;</P></FONT>