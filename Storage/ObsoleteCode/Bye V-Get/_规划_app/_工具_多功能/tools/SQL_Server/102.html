<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Auditing&nbsp;Your&nbsp;SQL&nbsp;Server&nbsp;-&nbsp;Part&nbsp;2</B><BR>Auditing&nbsp;Your&nbsp;SQL&nbsp;Server&nbsp;-&nbsp;Part&nbsp;2&nbsp;-&nbsp;Using&nbsp;a&nbsp;Mirror&nbsp;<BR>Introduction 

<P></P>
<P>Auditing&nbsp;your&nbsp;SQL&nbsp;Server&nbsp;can&nbsp;be&nbsp;a&nbsp;tough&nbsp;task.&nbsp;The&nbsp;amount&nbsp;of&nbsp;activity&nbsp;and&nbsp;variety&nbsp;of&nbsp;events&nbsp;make&nbsp;this&nbsp;a&nbsp;challenging&nbsp;operation.&nbsp;This&nbsp;article&nbsp;continues&nbsp;my&nbsp;series&nbsp;on&nbsp;auditing&nbsp;by&nbsp;looking&nbsp;at&nbsp;a&nbsp;more&nbsp;advanced&nbsp;method&nbsp;of&nbsp;auditing&nbsp;changes&nbsp;to&nbsp;a&nbsp;table.&nbsp;Part&nbsp;1&nbsp;of&nbsp;this&nbsp;series&nbsp;examined&nbsp;simple&nbsp;auditing&nbsp;using&nbsp;in&nbsp;row&nbsp;fields&nbsp;for&nbsp;tracking&nbsp;the&nbsp;last&nbsp;time&nbsp;and&nbsp;user&nbsp;who&nbsp;made&nbsp;a&nbsp;change.</P>
<P>More&nbsp;Advanced&nbsp;Auditing</P>
<P>In&nbsp;the&nbsp;last&nbsp;article,&nbsp;we&nbsp;looked&nbsp;at&nbsp;simple&nbsp;auditing&nbsp;using&nbsp;additional&nbsp;fields&nbsp;in&nbsp;a&nbsp;row.&nbsp;This&nbsp;article&nbsp;takes&nbsp;this&nbsp;a&nbsp;step&nbsp;further&nbsp;by&nbsp;using&nbsp;a&nbsp;mirror&nbsp;table&nbsp;to&nbsp;track&nbsp;the&nbsp;changes&nbsp;to&nbsp;all&nbsp;fields.&nbsp;While&nbsp;the&nbsp;amount&nbsp;of&nbsp;detail&nbsp;captured&nbsp;in&nbsp;this&nbsp;level&nbsp;of&nbsp;auditing&nbsp;is&nbsp;much&nbsp;greater,&nbsp;you&nbsp;pay&nbsp;the&nbsp;price&nbsp;with&nbsp;additional&nbsp;overhead&nbsp;on&nbsp;the&nbsp;server&nbsp;during&nbsp;insert/update/delete&nbsp;operations&nbsp;as&nbsp;well&nbsp;as&nbsp;additional&nbsp;space&nbsp;needs&nbsp;for&nbsp;storing&nbsp;the&nbsp;audit&nbsp;data.</P>
<P>What&nbsp;is&nbsp;a&nbsp;mirror&nbsp;table?&nbsp;The&nbsp;easiest&nbsp;way&nbsp;to&nbsp;explain&nbsp;this&nbsp;is&nbsp;with&nbsp;an&nbsp;example.&nbsp;Let's&nbsp;start&nbsp;with&nbsp;the&nbsp;Northwind&nbsp;database&nbsp;and&nbsp;assume&nbsp;that&nbsp;we&nbsp;want&nbsp;to&nbsp;track&nbsp;the&nbsp;changes&nbsp;to&nbsp;the&nbsp;Orders&nbsp;table.&nbsp;I'll&nbsp;start&nbsp;with&nbsp;a&nbsp;clean&nbsp;Northwind&nbsp;database,&nbsp;so&nbsp;you&nbsp;can&nbsp;reset&nbsp;yours&nbsp;to&nbsp;follow&nbsp;along.&nbsp;The&nbsp;instnwnd.sql&nbsp;script&nbsp;in&nbsp;your&nbsp;/MSSQL/Install&nbsp;folder&nbsp;will&nbsp;clean&nbsp;your&nbsp;version.&nbsp;This&nbsp;table&nbsp;is&nbsp;a&nbsp;fairly&nbsp;standard&nbsp;orders&nbsp;table&nbsp;that&nbsp;looks&nbsp;like&nbsp;many&nbsp;I&nbsp;have&nbsp;seen.&nbsp;Let's&nbsp;create&nbsp;a&nbsp;mirror&nbsp;table:</P>
<P></P>
<P></P>
<P>I&nbsp;cheated&nbsp;by&nbsp;using&nbsp;the&nbsp;Object&nbsp;Browser&nbsp;in&nbsp;Query&nbsp;Analyzer&nbsp;to&nbsp;script&nbsp;this&nbsp;table&nbsp;out&nbsp;quickly.&nbsp;Each&nbsp;field&nbsp;in&nbsp;this&nbsp;table&nbsp;corresponds&nbsp;to&nbsp;the&nbsp;matching&nbsp;field&nbsp;in&nbsp;the&nbsp;original&nbsp;table.&nbsp;Now&nbsp;let's&nbsp;add&nbsp;a&nbsp;few&nbsp;fields.&nbsp;Specifically,&nbsp;let's&nbsp;add&nbsp;these&nbsp;rows&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;script:</P>
<P><BR>&nbsp;,&nbsp;modifiedby&nbsp;varchar(40)<BR>&nbsp;,&nbsp;modified&nbsp;datetime<BR>&nbsp;,&nbsp;action&nbsp;char(1)</P>
<P>These&nbsp;are&nbsp;similar&nbsp;fields&nbsp;to&nbsp;those&nbsp;used&nbsp;in&nbsp;part&nbsp;1&nbsp;to&nbsp;"mark"&nbsp;the&nbsp;time&nbsp;and&nbsp;user&nbsp;who&nbsp;made&nbsp;a&nbsp;change.&nbsp;These&nbsp;are&nbsp;an&nbsp;important&nbsp;part&nbsp;of&nbsp;performing&nbsp;an&nbsp;audit,&nbsp;allowing&nbsp;us&nbsp;to&nbsp;quickly&nbsp;and&nbsp;easily&nbsp;determine&nbsp;the&nbsp;order&nbsp;in&nbsp;which&nbsp;changes&nbsp;occur.&nbsp;this&nbsp;table&nbsp;is&nbsp;designed&nbsp;to&nbsp;"mirror"&nbsp;the&nbsp;Orders&nbsp;table&nbsp;and&nbsp;record&nbsp;all&nbsp;of&nbsp;the&nbsp;information&nbsp;that&nbsp;is&nbsp;in&nbsp;that&nbsp;table&nbsp;along&nbsp;with&nbsp;dates&nbsp;and&nbsp;times&nbsp;of&nbsp;change.</P>
<P>Auditing&nbsp;to&nbsp;a&nbsp;Mirror&nbsp;Table<BR>The&nbsp;next&nbsp;step&nbsp;is&nbsp;to&nbsp;implement&nbsp;the&nbsp;auditing&nbsp;of&nbsp;actions&nbsp;on&nbsp;the&nbsp;Orders&nbsp;table.&nbsp;To&nbsp;do&nbsp;this,&nbsp;we'll&nbsp;again&nbsp;use&nbsp;a&nbsp;trigger&nbsp;that&nbsp;records&nbsp;the&nbsp;audit&nbsp;information&nbsp;for&nbsp;us.&nbsp;Specifically,&nbsp;we'll&nbsp;use&nbsp;3&nbsp;triggers,&nbsp;one&nbsp;for&nbsp;inserts,&nbsp;one&nbsp;for&nbsp;updates,&nbsp;one&nbsp;for&nbsp;deletes.&nbsp;For&nbsp;the&nbsp;sake&nbsp;of&nbsp;brevity,&nbsp;I'm&nbsp;only&nbsp;showing&nbsp;the&nbsp;insert&nbsp;trigger&nbsp;in&nbsp;the&nbsp;article.&nbsp;The&nbsp;update&nbsp;and&nbsp;delete&nbsp;triggers&nbsp;are&nbsp;available&nbsp;in&nbsp;the&nbsp;code&nbsp;download&nbsp;for&nbsp;this&nbsp;article.</P>
<P>The&nbsp;insert&nbsp;trigger,&nbsp;which&nbsp;I'll&nbsp;call&nbsp;Orders_tri,&nbsp;according&nbsp;to&nbsp;my&nbsp;naming&nbsp;convention,&nbsp;will&nbsp;duplicate&nbsp;the&nbsp;information&nbsp;inserted&nbsp;into&nbsp;Orders&nbsp;into&nbsp;Orders_audit.&nbsp;The&nbsp;code&nbsp;looks&nbsp;like:</P>
<P></P>
<P>create&nbsp;trigger&nbsp;Orders_tri&nbsp;on&nbsp;orders&nbsp;for&nbsp;insert<BR>as<BR>insert&nbsp;orders_audit<BR>&nbsp;select&nbsp;<BR>&nbsp;*<BR>&nbsp;,&nbsp;suser_sname()<BR>&nbsp;,&nbsp;getdate()<BR>&nbsp;,&nbsp;'I'<BR>&nbsp;from&nbsp;inserted&nbsp;i<BR>&nbsp;return</P>
<P><BR>A&nbsp;pretty&nbsp;basic&nbsp;trigger,&nbsp;and&nbsp;one&nbsp;which&nbsp;will&nbsp;take&nbsp;all&nbsp;the&nbsp;rows&nbsp;inserted&nbsp;into&nbsp;this&nbsp;table&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;the&nbsp;Orders_Audit&nbsp;table&nbsp;along&nbsp;with&nbsp;the&nbsp;login&nbsp;user&nbsp;name,&nbsp;the&nbsp;current&nbsp;server&nbsp;date&nbsp;and&nbsp;time,&nbsp;and&nbsp;mark&nbsp;these&nbsp;rows&nbsp;as&nbsp;"I"&nbsp;for&nbsp;inserts.&nbsp;The&nbsp;delete&nbsp;trigger&nbsp;functions&nbsp;in&nbsp;the&nbsp;same&nbsp;manner&nbsp;by&nbsp;inserting&nbsp;all&nbsp;the&nbsp;rows&nbsp;from&nbsp;"deleted"&nbsp;into&nbsp;the&nbsp;Orders_Audit&nbsp;table&nbsp;using&nbsp;a&nbsp;"D"&nbsp;to&nbsp;mark&nbsp;them.&nbsp;The&nbsp;update&nbsp;trigger&nbsp;is&nbsp;just&nbsp;like&nbsp;this&nbsp;trigger,&nbsp;only&nbsp;inserting&nbsp;the&nbsp;new&nbsp;data,&nbsp;but&nbsp;using&nbsp;a&nbsp;"U"&nbsp;to&nbsp;mark&nbsp;the&nbsp;update.</P>
<P>In&nbsp;practice,&nbsp;this&nbsp;looks&nbsp;like&nbsp;the&nbsp;following.&nbsp;Let's&nbsp;assume&nbsp;we've&nbsp;just&nbsp;implemented&nbsp;auditing&nbsp;(which&nbsp;you&nbsp;have&nbsp;if&nbsp;you've&nbsp;run&nbsp;the&nbsp;code&nbsp;download)&nbsp;and&nbsp;Orders_Audit&nbsp;is&nbsp;empty.&nbsp;We&nbsp;now&nbsp;add&nbsp;a&nbsp;new&nbsp;order:</P>
<P><BR>&nbsp;insert&nbsp;Orders<BR>&nbsp;&nbsp;select&nbsp;1,2,3,4,5</P>
<P><BR>If&nbsp;we&nbsp;now&nbsp;check&nbsp;the&nbsp;Order_Audit&nbsp;table,&nbsp;we&nbsp;will&nbsp;see&nbsp;that&nbsp;there&nbsp;is&nbsp;a&nbsp;new&nbsp;row&nbsp;that&nbsp;exactly&nbsp;matches&nbsp;the&nbsp;new&nbsp;row&nbsp;in&nbsp;Orders&nbsp;with&nbsp;a&nbsp;few&nbsp;additional&nbsp;fields:</P>
<P><BR>&nbsp;select&nbsp;*&nbsp;from&nbsp;Orders&nbsp;where&nbsp;orderid&nbsp;=&nbsp;xxx<BR>&nbsp;select&nbsp;*&nbsp;from&nbsp;Orders_Audit</P>
<P>-------------------<BR>OrderID&nbsp;&nbsp;&nbsp;&nbsp;CustomerID&nbsp;......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</P>
<P>OrderID&nbsp;&nbsp;&nbsp;&nbsp;CustomerID&nbsp;......&nbsp;&nbsp;&nbsp;&nbsp;ModifiedBy&nbsp;&nbsp;&nbsp;&nbsp;Modified&nbsp;&nbsp;&nbsp;Action</P>
<P></P>
<P>Suppose&nbsp;I&nbsp;now&nbsp;wish&nbsp;to&nbsp;modify&nbsp;the&nbsp;order&nbsp;because&nbsp;the&nbsp;quantity&nbsp;was&nbsp;incorrect.&nbsp;I&nbsp;issue&nbsp;the&nbsp;following:</P>
<P><BR>&nbsp;update&nbsp;orders<BR>&nbsp;&nbsp;&nbsp;set&nbsp;quantity&nbsp;=&nbsp;11<BR>&nbsp;&nbsp;&nbsp;where&nbsp;orderid&nbsp;=&nbsp;</P>
<P><BR>A&nbsp;further&nbsp;check&nbsp;of&nbsp;Order_Audit&nbsp;shows&nbsp;that&nbsp;there&nbsp;are&nbsp;now&nbsp;two&nbsp;rows.&nbsp;One&nbsp;is&nbsp;the&nbsp;original&nbsp;insert&nbsp;and&nbsp;the&nbsp;other&nbsp;is&nbsp;the&nbsp;updated&nbsp;row.&nbsp;</P>
<P>&nbsp;select&nbsp;*&nbsp;from&nbsp;Orders_Audit</P>
<P>-------------------<BR>OrderID&nbsp;&nbsp;&nbsp;&nbsp;CustomerID&nbsp;......&nbsp;&nbsp;&nbsp;&nbsp;ModifiedBy&nbsp;&nbsp;&nbsp;&nbsp;Modified&nbsp;&nbsp;&nbsp;Action</P>
<P></P>
<P>The&nbsp;results&nbsp;are&nbsp;abbreviated,&nbsp;but&nbsp;here&nbsp;we&nbsp;see&nbsp;the&nbsp;two&nbsp;rows.&nbsp;As&nbsp;a&nbsp;final&nbsp;test,&nbsp;let's&nbsp;remove&nbsp;the&nbsp;order&nbsp;with&nbsp;a&nbsp;"delete&nbsp;orders&nbsp;where&nbsp;orderid&nbsp;=&nbsp;xx".&nbsp;After&nbsp;issuing&nbsp;this&nbsp;statement,&nbsp;we&nbsp;will&nbsp;see&nbsp;an&nbsp;Order_Audit&nbsp;table&nbsp;that&nbsp;looks&nbsp;like:&nbsp;</P>
<P>&nbsp;select&nbsp;*&nbsp;from&nbsp;Orders&nbsp;where&nbsp;orderid&nbsp;=&nbsp;xxx<BR>&nbsp;select&nbsp;*&nbsp;from&nbsp;Orders_Audit</P>
<P>-------------------<BR>OrderID&nbsp;&nbsp;&nbsp;&nbsp;CustomerID&nbsp;......&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>---------&nbsp;&nbsp;----------<BR>0&nbsp;rows&nbsp;affected</P>
<P>OrderID&nbsp;&nbsp;&nbsp;&nbsp;CustomerID&nbsp;......&nbsp;&nbsp;&nbsp;&nbsp;ModifiedBy&nbsp;&nbsp;&nbsp;&nbsp;Modified&nbsp;&nbsp;&nbsp;Action</P>
<P></P>
<P>I&nbsp;reformatted&nbsp;the&nbsp;results,&nbsp;but&nbsp;basically&nbsp;the&nbsp;order&nbsp;is&nbsp;removed&nbsp;from&nbsp;the&nbsp;system.&nbsp;Without&nbsp;some&nbsp;type&nbsp;of&nbsp;auditing,&nbsp;we&nbsp;would&nbsp;have&nbsp;no&nbsp;idea&nbsp;that&nbsp;there&nbsp;even&nbsp;was&nbsp;an&nbsp;order&nbsp;like&nbsp;this&nbsp;ever&nbsp;entered.&nbsp;However&nbsp;by&nbsp;tracing&nbsp;through&nbsp;the&nbsp;audit&nbsp;table,&nbsp;we&nbsp;can&nbsp;find&nbsp;out&nbsp;the&nbsp;history&nbsp;of&nbsp;this&nbsp;row.&nbsp;</P>
<P>Pros&nbsp;and&nbsp;Cons<BR>So&nbsp;is&nbsp;this&nbsp;a&nbsp;good&nbsp;idea?&nbsp;the&nbsp;end&nbsp;all&nbsp;for&nbsp;your&nbsp;auditing&nbsp;needs?&nbsp;Probably&nbsp;not.&nbsp;This&nbsp;type&nbsp;of&nbsp;auditing&nbsp;imposes&nbsp;overhead,&nbsp;essentially&nbsp;an&nbsp;extra&nbsp;write&nbsp;for&nbsp;each&nbsp;updated&nbsp;row&nbsp;along&nbsp;with&nbsp;index&nbsp;overhead&nbsp;on&nbsp;the&nbsp;indexes&nbsp;(you&nbsp;do&nbsp;want&nbsp;indexes&nbsp;on&nbsp;the&nbsp;audit&nbsp;table).&nbsp;Essentially&nbsp;2x&nbsp;the&nbsp;overhead&nbsp;for&nbsp;each&nbsp;transaction&nbsp;that&nbsp;modifies&nbsp;data.</P>
<P>It&nbsp;also&nbsp;increases&nbsp;the&nbsp;amount&nbsp;of&nbsp;storage&nbsp;that&nbsp;is&nbsp;required&nbsp;for&nbsp;each&nbsp;table.&nbsp;Sometimes&nbsp;exponentially&nbsp;as&nbsp;there&nbsp;will&nbsp;be&nbsp;a&nbsp;copy&nbsp;of&nbsp;each&nbsp;row&nbsp;for&nbsp;every&nbsp;modification.&nbsp;If&nbsp;your&nbsp;application&nbsp;were&nbsp;to&nbsp;issue:</P>
<P></P>
<P>update&nbsp;orders&nbsp;set&nbsp;quantity&nbsp;=&nbsp;6&nbsp;where&nbsp;orderid&nbsp;=&nbsp;12<BR>update&nbsp;orders&nbsp;set&nbsp;price&nbsp;=&nbsp;12.5&nbsp;where&nbsp;orderid&nbsp;=&nbsp;12</P>
<P><BR>then&nbsp;you&nbsp;will&nbsp;have&nbsp;two&nbsp;copies&nbsp;of&nbsp;this&nbsp;row,&nbsp;one&nbsp;for&nbsp;each&nbsp;update.&nbsp;An&nbsp;inefficiently&nbsp;written&nbsp;application&nbsp;(ever&nbsp;run&nbsp;into&nbsp;one&nbsp;of&nbsp;these?)&nbsp;can&nbsp;quickly&nbsp;overwhelm&nbsp;the&nbsp;auditing&nbsp;capabilities&nbsp;of&nbsp;the&nbsp;server.</P>
<P>On&nbsp;the&nbsp;positive&nbsp;side,&nbsp;this&nbsp;type&nbsp;of&nbsp;auditing&nbsp;can&nbsp;allow&nbsp;you&nbsp;to&nbsp;trace&nbsp;exactly&nbsp;what&nbsp;the&nbsp;history&nbsp;of&nbsp;each&nbsp;row&nbsp;may&nbsp;be.&nbsp;I&nbsp;have&nbsp;implemented&nbsp;this&nbsp;type&nbsp;of&nbsp;auditing&nbsp;in&nbsp;financial&nbsp;applications&nbsp;(for&nbsp;certain&nbsp;tables)&nbsp;where&nbsp;the&nbsp;audit&nbsp;trail&nbsp;must&nbsp;be&nbsp;extremely&nbsp;precise.&nbsp;and&nbsp;detailed.&nbsp;The&nbsp;tradeoffs&nbsp;are&nbsp;worth&nbsp;it&nbsp;because&nbsp;the&nbsp;liability&nbsp;can&nbsp;be&nbsp;very&nbsp;high.&nbsp;</P>
<P>Conclusions<BR>A&nbsp;step&nbsp;above&nbsp;Part&nbsp;1&nbsp;and&nbsp;auditing&nbsp;just&nbsp;the&nbsp;date&nbsp;and&nbsp;time&nbsp;of&nbsp;a&nbsp;change.&nbsp;However&nbsp;this&nbsp;type&nbsp;of&nbsp;auditing&nbsp;forces&nbsp;you&nbsp;to&nbsp;pay&nbsp;a&nbsp;price&nbsp;in&nbsp;disk&nbsp;space&nbsp;and&nbsp;overhead.&nbsp;In&nbsp;Part&nbsp;3,&nbsp;I'll&nbsp;examine&nbsp;a&nbsp;few&nbsp;ways&nbsp;to&nbsp;manage&nbsp;this&nbsp;audit&nbsp;data&nbsp;and&nbsp;keep&nbsp;control&nbsp;of&nbsp;your&nbsp;server.</P>
<P>As&nbsp;always,&nbsp;I&nbsp;welcome&nbsp;feedback&nbsp;on&nbsp;this&nbsp;article,&nbsp;including&nbsp;your&nbsp;suggestions,&nbsp;ideas,&nbsp;and&nbsp;criticisms.&nbsp;</P>
<P>Steve&nbsp;Jones<BR>©dkRanch.net&nbsp;March&nbsp;2003&nbsp;</P></FONT>