<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>×Ö·û´®-Bending&nbsp;Results</B><BR>Introduction&nbsp;<BR>I&nbsp;discovered&nbsp;an&nbsp;interesting&nbsp;string&nbsp;technique&nbsp;the&nbsp;other&nbsp;day&nbsp;while&nbsp;reading&nbsp;a&nbsp;SQL&nbsp;programming&nbsp;book.&nbsp;It&nbsp;presented&nbsp;a&nbsp;great&nbsp;way&nbsp;that&nbsp;one&nbsp;can&nbsp;build&nbsp;a&nbsp;string&nbsp;with&nbsp;a&nbsp;delimited&nbsp;list&nbsp;of&nbsp;items.&nbsp;It&nbsp;can&nbsp;also&nbsp;be&nbsp;used&nbsp;to&nbsp;"bend"&nbsp;a&nbsp;result&nbsp;set&nbsp;from&nbsp;a&nbsp;series&nbsp;of&nbsp;rows&nbsp;to&nbsp;a&nbsp;column.&nbsp;I&nbsp;am&nbsp;sure&nbsp;many&nbsp;of&nbsp;you&nbsp;can&nbsp;come&nbsp;up&nbsp;with&nbsp;a&nbsp;whole&nbsp;bunch&nbsp;of&nbsp;ideas&nbsp;that&nbsp;I&nbsp;would&nbsp;never&nbsp;think&nbsp;of,&nbsp;but&nbsp;this&nbsp;actually&nbsp;solved&nbsp;a&nbsp;problem&nbsp;that&nbsp;I&nbsp;had&nbsp;previously&nbsp;used&nbsp;a&nbsp;cursor&nbsp;to&nbsp;solve.&nbsp;And&nbsp;eliminating&nbsp;cursors&nbsp;is&nbsp;almost&nbsp;always&nbsp;a&nbsp;good&nbsp;thing.&nbsp;
<P></P>
<P>The&nbsp;Problem&nbsp;<BR>I&nbsp;have&nbsp;a&nbsp;number&nbsp;of&nbsp;email&nbsp;integration&nbsp;processes&nbsp;that&nbsp;send&nbsp;notifications&nbsp;to&nbsp;people.&nbsp;Most&nbsp;of&nbsp;these&nbsp;are&nbsp;business&nbsp;processes&nbsp;and&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;people&nbsp;who&nbsp;recieve&nbsp;the&nbsp;emails&nbsp;can&nbsp;change&nbsp;at&nbsp;any&nbsp;time.&nbsp;We&nbsp;store&nbsp;these&nbsp;emails&nbsp;in&nbsp;a&nbsp;table&nbsp;called,&nbsp;appropriately,&nbsp;email_notification.&nbsp;This&nbsp;table&nbsp;is&nbsp;defined&nbsp;with&nbsp;the&nbsp;following&nbsp;DDL:&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;create&nbsp;table&nbsp;email_notification<BR>&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;id&nbsp;int&nbsp;identity(&nbsp;1,&nbsp;1),<BR>&nbsp;&nbsp;&nbsp;process&nbsp;varchar(&nbsp;80),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recipients&nbsp;varchar(&nbsp;255),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc&nbsp;varchar(&nbsp;255)<BR>&nbsp;&nbsp;&nbsp;)</P>
<P>and&nbsp;contains&nbsp;data&nbsp;like&nbsp;the&nbsp;following:&nbsp;<BR>id&nbsp;&nbsp;&nbsp;&nbsp;process&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recipients&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc&nbsp;<BR>----&nbsp;&nbsp;--------------------&nbsp;&nbsp;-----------------------------------------------------&nbsp;&nbsp;&nbsp;------<BR>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;1&nbsp;steve@dkranch.net;steve@sqlservercentral.com&nbsp;&nbsp;<BR>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;2&nbsp;delaney@dkranch.net&nbsp;&nbsp;<BR>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;3&nbsp;kyle@dkranch.net;kendall@dkranch.net&nbsp;&nbsp;<BR>4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;4&nbsp;tia@dkranch.net&nbsp;&nbsp;</P>
<P><BR>This&nbsp;has&nbsp;worked&nbsp;fine&nbsp;as&nbsp;in&nbsp;various&nbsp;stored&nbsp;procedures&nbsp;as&nbsp;they&nbsp;can&nbsp;select&nbsp;a&nbsp;field&nbsp;from&nbsp;this&nbsp;table&nbsp;and&nbsp;use&nbsp;it&nbsp;in&nbsp;the&nbsp;xp_sendmail&nbsp;stored&nbsp;procedure.&nbsp;Emails&nbsp;go&nbsp;out&nbsp;fine&nbsp;and&nbsp;to&nbsp;multiple&nbsp;recipients.&nbsp;The&nbsp;problems&nbsp;come&nbsp;if&nbsp;I&nbsp;want&nbsp;to&nbsp;edit&nbsp;this&nbsp;table.&nbsp;If&nbsp;I&nbsp;want&nbsp;to&nbsp;add&nbsp;or&nbsp;remove&nbsp;an&nbsp;email&nbsp;from&nbsp;the&nbsp;list,&nbsp;I&nbsp;have&nbsp;to&nbsp;perform&nbsp;some&nbsp;string&nbsp;manipulation&nbsp;to&nbsp;ensure&nbsp;that&nbsp;I&nbsp;edit&nbsp;everything&nbsp;correctly.&nbsp;</P>
<P>Let's&nbsp;say&nbsp;that&nbsp;I&nbsp;want&nbsp;to&nbsp;remove&nbsp;Delaney&nbsp;from&nbsp;all&nbsp;the&nbsp;lines&nbsp;above.&nbsp;I&nbsp;have&nbsp;to&nbsp;first&nbsp;find&nbsp;all&nbsp;instances&nbsp;of&nbsp;delaney@dkranch.net&nbsp;and&nbsp;then&nbsp;replace&nbsp;them&nbsp;with&nbsp;spaces.&nbsp;Not&nbsp;the&nbsp;REPLACE&nbsp;function&nbsp;(see&nbsp;Part&nbsp;3&nbsp;of&nbsp;this&nbsp;series)&nbsp;will&nbsp;perform&nbsp;this&nbsp;work,&nbsp;but&nbsp;I&nbsp;have&nbsp;two&nbsp;cases&nbsp;here.&nbsp;I&nbsp;have&nbsp;to&nbsp;allow&nbsp;for&nbsp;the&nbsp;email&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;email&nbsp;separately&nbsp;from&nbsp;being&nbsp;in&nbsp;the&nbsp;middle.&nbsp;The&nbsp;reason:&nbsp;the&nbsp;semicolons&nbsp;that&nbsp;separate&nbsp;the&nbsp;emails.&nbsp;</P>
<P>This&nbsp;is&nbsp;not&nbsp;a&nbsp;huge&nbsp;problem&nbsp;and&nbsp;the&nbsp;REPLACE&nbsp;function&nbsp;will&nbsp;handle&nbsp;most&nbsp;edits&nbsp;that&nbsp;are&nbsp;needed,&nbsp;the&nbsp;other&nbsp;problem&nbsp;is&nbsp;that&nbsp;this&nbsp;storage&nbsp;is&nbsp;fundamentally&nbsp;a&nbsp;poor&nbsp;design.&nbsp;I&nbsp;am&nbsp;using&nbsp;a&nbsp;single&nbsp;field&nbsp;to&nbsp;hold&nbsp;multiple&nbsp;data&nbsp;elements.&nbsp;If&nbsp;I&nbsp;wanted&nbsp;to&nbsp;search&nbsp;on&nbsp;multiple&nbsp;emails,&nbsp;I&nbsp;have&nbsp;problems.&nbsp;If&nbsp;I&nbsp;want&nbsp;to&nbsp;total&nbsp;the&nbsp;number&nbsp;of&nbsp;emails&nbsp;a&nbsp;series&nbsp;of&nbsp;people&nbsp;recieve,&nbsp;I&nbsp;cannot&nbsp;easily&nbsp;do&nbsp;this.&nbsp;</P>
<P>Using&nbsp;this&nbsp;storage&nbsp;solution,&nbsp;however,&nbsp;has&nbsp;allowed&nbsp;me&nbsp;to&nbsp;easily&nbsp;send&nbsp;a&nbsp;group&nbsp;of&nbsp;emails&nbsp;into&nbsp;the&nbsp;mail&nbsp;stored&nbsp;procedure&nbsp;without&nbsp;using&nbsp;a&nbsp;cursor&nbsp;to&nbsp;concatenate&nbsp;the&nbsp;data.&nbsp;I&nbsp;can&nbsp;get&nbsp;a&nbsp;list&nbsp;of&nbsp;emails&nbsp;using&nbsp;the&nbsp;following&nbsp;code:&nbsp;</P>
<P>declare&nbsp;@r&nbsp;varchar(&nbsp;255)<BR>select&nbsp;@r&nbsp;=&nbsp;recipients<BR>&nbsp;from&nbsp;email_notification<BR>&nbsp;where&nbsp;process='Business&nbsp;Process&nbsp;1'</P>
<P>However,&nbsp;what&nbsp;I&nbsp;really&nbsp;want&nbsp;to&nbsp;get&nbsp;to&nbsp;is&nbsp;to&nbsp;have&nbsp;the&nbsp;data&nbsp;stored&nbsp;like&nbsp;this:&nbsp;<BR>id&nbsp;&nbsp;&nbsp;&nbsp;process&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recipients&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc&nbsp;<BR>----&nbsp;&nbsp;--------------------&nbsp;&nbsp;-----------------------------------------------------&nbsp;&nbsp;&nbsp;------<BR>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;1&nbsp;steve@dkranch.net<BR>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;1&nbsp;steve@sqlservercentral.com&nbsp;&nbsp;<BR>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;2&nbsp;delaney@dkranch.net&nbsp;&nbsp;<BR>4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;3&nbsp;kyle@dkranch.net<BR>5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;3&nbsp;kendall@dkranch.net&nbsp;&nbsp;<BR>6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;4&nbsp;tia@dkranch.net&nbsp;&nbsp;</P>
<P>How&nbsp;can&nbsp;I&nbsp;do&nbsp;it?&nbsp;Read&nbsp;on...&nbsp;</P>
<P>The&nbsp;Solution&nbsp;<BR>I&nbsp;have&nbsp;to&nbsp;admit&nbsp;that&nbsp;I&nbsp;would&nbsp;probably&nbsp;never&nbsp;have&nbsp;stumbled&nbsp;on&nbsp;this&nbsp;technique&nbsp;if&nbsp;I&nbsp;had&nbsp;read&nbsp;about&nbsp;it.&nbsp;That's&nbsp;a&nbsp;good&nbsp;reason&nbsp;to&nbsp;keep&nbsp;reading&nbsp;(hint,&nbsp;hint).&nbsp;</P>
<P>I&nbsp;have&nbsp;known&nbsp;for&nbsp;some&nbsp;time&nbsp;that&nbsp;there&nbsp;is&nbsp;a&nbsp;SET&nbsp;operator&nbsp;in&nbsp;T-SQL&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;value&nbsp;of&nbsp;a&nbsp;variable.&nbsp;I&nbsp;have&nbsp;never&nbsp;bothered&nbsp;to&nbsp;use&nbsp;it,&nbsp;preferring&nbsp;the&nbsp;SELECT&nbsp;operator.&nbsp;I&nbsp;don't&nbsp;have&nbsp;a&nbsp;good&nbsp;reason,&nbsp;I&nbsp;just&nbsp;like&nbsp;the&nbsp;SELECT&nbsp;operator.&nbsp;I&nbsp;had&nbsp;also&nbsp;assumed&nbsp;that&nbsp;these&nbsp;two&nbsp;operators&nbsp;performed&nbsp;the&nbsp;same&nbsp;function&nbsp;and&nbsp;one&nbsp;was&nbsp;kept&nbsp;for&nbsp;backwards&nbsp;compatibility.&nbsp;</P>
<P>Then&nbsp;I&nbsp;read&nbsp;about&nbsp;what&nbsp;the&nbsp;differences&nbsp;were&nbsp;in&nbsp;an&nbsp;advanced&nbsp;T-SQL&nbsp;programming&nbsp;book.&nbsp;The&nbsp;SET&nbsp;statement&nbsp;can&nbsp;only&nbsp;assign&nbsp;a&nbsp;single&nbsp;value,&nbsp;where&nbsp;SELECT&nbsp;can&nbsp;assing&nbsp;multiple&nbsp;values.&nbsp;</P>
<P>OK,&nbsp;that&nbsp;is&nbsp;interesting,&nbsp;but&nbsp;how&nbsp;does&nbsp;that&nbsp;help&nbsp;me.&nbsp;I&nbsp;don't&nbsp;really&nbsp;want&nbsp;to&nbsp;assign&nbsp;two&nbsp;variables&nbsp;like&nbsp;this:&nbsp;</P>
<P>declare&nbsp;@r&nbsp;varchar(&nbsp;255),&nbsp;@c&nbsp;varchar(&nbsp;255)<BR>select&nbsp;@r&nbsp;=&nbsp;recipients,&nbsp;@c&nbsp;=&nbsp;cc<BR>&nbsp;from&nbsp;email_notification<BR>&nbsp;where&nbsp;process='Business&nbsp;Process&nbsp;1'</P>
<P>Or&nbsp;even&nbsp;this:&nbsp;<BR>declare&nbsp;@r&nbsp;varchar(&nbsp;255),&nbsp;@c&nbsp;varchar(&nbsp;255)<BR>select&nbsp;@r&nbsp;=&nbsp;substring(&nbsp;recipients,&nbsp;1,&nbsp;charindex(&nbsp;';',&nbsp;recipients)-1),<BR>&nbsp;&nbsp;@c&nbsp;=&nbsp;substring(&nbsp;recipients,&nbsp;charindex(&nbsp;';',&nbsp;recipients)+1,&nbsp;255)<BR>&nbsp;from&nbsp;email_notification<BR>&nbsp;where&nbsp;process='Business&nbsp;Process&nbsp;1'<BR>select&nbsp;@r,&nbsp;@c</P>
<P>It&nbsp;was&nbsp;then&nbsp;that&nbsp;I&nbsp;kept&nbsp;reading&nbsp;and&nbsp;learned&nbsp;about&nbsp;another&nbsp;feature&nbsp;of&nbsp;the&nbsp;SELECT&nbsp;statemet.&nbsp;</P>
<P>I&nbsp;have&nbsp;known&nbsp;that&nbsp;I&nbsp;can&nbsp;assign&nbsp;a&nbsp;single&nbsp;value&nbsp;to&nbsp;a&nbsp;variable&nbsp;even&nbsp;if&nbsp;the&nbsp;query&nbsp;returns&nbsp;mutliple&nbsp;results.&nbsp;For&nbsp;example,&nbsp;look&nbsp;at&nbsp;his&nbsp;code:&nbsp;</P>
<P>declare&nbsp;@r&nbsp;varchar(&nbsp;255)<BR>select&nbsp;@r&nbsp;=&nbsp;recipients<BR>&nbsp;from&nbsp;email_notification</P>
<P>What&nbsp;will&nbsp;be&nbsp;the&nbsp;value&nbsp;of&nbsp;@r?&nbsp;It&nbsp;will&nbsp;be&nbsp;the&nbsp;last&nbsp;value&nbsp;returned&nbsp;by&nbsp;the&nbsp;result&nbsp;set.&nbsp;In&nbsp;this&nbsp;case&nbsp;the&nbsp;value&nbsp;will&nbsp;be&nbsp;"tia@dkranch.net".&nbsp;So&nbsp;does&nbsp;this&nbsp;help&nbsp;me?&nbsp;</P>
<P>Well,&nbsp;T-SQL&nbsp;is&nbsp;incredibly&nbsp;flexible&nbsp;and&nbsp;able&nbsp;to&nbsp;embed&nbsp;it's&nbsp;commands&nbsp;within&nbsp;other&nbsp;commands,&nbsp;much&nbsp;like&nbsp;I&nbsp;used&nbsp;to&nbsp;do&nbsp;in&nbsp;LISP&nbsp;early&nbsp;in&nbsp;my&nbsp;career.&nbsp;The&nbsp;SELECT&nbsp;statement&nbsp;will&nbsp;allow&nbsp;me&nbsp;to&nbsp;add&nbsp;an&nbsp;expression&nbsp;to&nbsp;the&nbsp;query&nbsp;inside&nbsp;the&nbsp;assinment&nbsp;and&nbsp;allow&nbsp;T-SQL&nbsp;to&nbsp;perform&nbsp;my&nbsp;concatenation.&nbsp;</P>
<P>Assume&nbsp;my&nbsp;data&nbsp;set&nbsp;now&nbsp;looks&nbsp;like&nbsp;this:&nbsp;</P>
<P>id&nbsp;&nbsp;&nbsp;&nbsp;process&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recipients&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cc&nbsp;<BR>----&nbsp;&nbsp;--------------------&nbsp;&nbsp;-----------------------------------------------------&nbsp;&nbsp;&nbsp;------<BR>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;1&nbsp;steve@dkranch.net<BR>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;1&nbsp;steve@sqlservercentral.com&nbsp;&nbsp;<BR>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;2&nbsp;delaney@dkranch.net&nbsp;&nbsp;<BR>4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;3&nbsp;kyle@dkranch.net<BR>5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;3&nbsp;kendall@dkranch.net&nbsp;&nbsp;<BR>6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Business&nbsp;Process&nbsp;4&nbsp;tia@dkranch.net&nbsp;&nbsp;</P>
<P>I&nbsp;can&nbsp;run&nbsp;the&nbsp;following:&nbsp;<BR>declare&nbsp;@r&nbsp;varchar(&nbsp;1000)<BR>select&nbsp;@r&nbsp;=&nbsp;''<BR>select&nbsp;@r&nbsp;=&nbsp;rtrim(@r)&nbsp;+&nbsp;recipients&nbsp;+&nbsp;';'<BR>&nbsp;from&nbsp;email_notification<BR>&nbsp;where&nbsp;process&nbsp;=&nbsp;'business&nbsp;process&nbsp;1'<BR>select&nbsp;substring(&nbsp;@r,&nbsp;1,&nbsp;len(&nbsp;@r)&nbsp;-&nbsp;1)</P>
<P>Note&nbsp;that&nbsp;I&nbsp;initialize&nbsp;my&nbsp;variable&nbsp;to&nbsp;a&nbsp;blank&nbsp;string&nbsp;and&nbsp;then&nbsp;allow&nbsp;T-SQL&nbsp;to&nbsp;concatenate&nbsp;my&nbsp;string&nbsp;for&nbsp;me.&nbsp;The&nbsp;result&nbsp;is&nbsp;"steve@dkranch.net;steve@sqlservercentral.com".&nbsp;The&nbsp;last&nbsp;substring&nbsp;is&nbsp;designed&nbsp;to&nbsp;merely&nbsp;remove&nbsp;the&nbsp;final&nbsp;semicolon&nbsp;from&nbsp;the&nbsp;string.&nbsp;</P>
<P>I&nbsp;included&nbsp;the&nbsp;sample&nbsp;script&nbsp;that&nbsp;I&nbsp;used&nbsp;to&nbsp;write&nbsp;this&nbsp;article&nbsp;here:tam&nbsp;</P></FONT>