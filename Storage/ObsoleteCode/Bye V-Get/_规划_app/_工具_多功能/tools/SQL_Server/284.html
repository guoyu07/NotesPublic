<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>View&nbsp;Database&nbsp;Information</B><BR>View&nbsp;Database&nbsp;Information&nbsp;Script
<P></P>
<P></P>
<P><BR>This&nbsp;stored&nbsp;procedure&nbsp;is&nbsp;designed&nbsp;to&nbsp;view&nbsp;database&nbsp;information&nbsp;in&nbsp;an&nbsp;active&nbsp;database&nbsp;--&nbsp;i.e.&nbsp;database,&nbsp;tables,&nbsp;objects,&nbsp;users,&nbsp;jobs,&nbsp;etc.&nbsp;The&nbsp;script&nbsp;basically&nbsp;acts&nbsp;as&nbsp;a&nbsp;'wrap-around'&nbsp;and&nbsp;enables&nbsp;one&nbsp;procedure&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;view&nbsp;a&nbsp;wealth&nbsp;of&nbsp;database&nbsp;information.&nbsp;Tested&nbsp;on&nbsp;SQL&nbsp;Server&nbsp;2000.&nbsp;</P>
<P>Accepts&nbsp;viewtype&nbsp;parameters&nbsp;of&nbsp;'database',&nbsp;'tables',&nbsp;'objects',&nbsp;'jobs',&nbsp;'users'&nbsp;and&nbsp;'alerts'.&nbsp;Type&nbsp;the&nbsp;database&nbsp;name&nbsp;and&nbsp;the&nbsp;parameter&nbsp;type,&nbsp;then&nbsp;execute&nbsp;the&nbsp;procedure.&nbsp;</P>
<P>Example:&nbsp;</P>
<P>exec&nbsp;usp_dbinfo&nbsp;'[database&nbsp;name]','[parameter&nbsp;type]'&nbsp;</P>
<P>Author:&nbsp;Lauryn&nbsp;Bradley&nbsp;<BR>--&nbsp;if&nbsp;sp&nbsp;exists,&nbsp;drop&nbsp;it<BR>IF&nbsp;EXISTS&nbsp;(&nbsp;&nbsp;SELECT&nbsp;*&nbsp;<BR>&nbsp;&nbsp;FROM&nbsp;sysobjects&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;object_id(N'[dbo].[usp_DBinfo]')<BR>&nbsp;&nbsp;and&nbsp;OBJECTPROPERTY(id,&nbsp;N'IsProcedure')&nbsp;=&nbsp;1)</P>
<P>DROP&nbsp;PROCEDURE&nbsp;[dbo].[usp_dbinfo]&nbsp;<BR>GO</P>
<P>SET&nbsp;QUOTED_IDENTIFIER&nbsp;OFF&nbsp;SET&nbsp;ANSI_NULLS&nbsp;ON&nbsp;<BR>GO</P>
<P>--&nbsp;create&nbsp;procedure&nbsp;usp_dbinfo&nbsp;with&nbsp;2&nbsp;input&nbsp;parameters<BR>CREATE&nbsp;PROCEDURE&nbsp;usp_dbinfo&nbsp;@DBname&nbsp;sysname&nbsp;=&nbsp;null,&nbsp;@VType&nbsp;varchar(25)&nbsp;<BR>AS<BR>DECLARE&nbsp;<BR>@TName&nbsp;varchar(50),&nbsp;&nbsp;&nbsp;--&nbsp;Table&nbsp;name<BR>@FName&nbsp;varchar(50),&nbsp;&nbsp;--&nbsp;Field&nbsp;name<BR>@Len&nbsp;varchar(30),&nbsp;&nbsp;--&nbsp;Field&nbsp;length<BR>@DType&nbsp;varchar(15),&nbsp;&nbsp;--&nbsp;Data&nbsp;type<BR>@Cmd&nbsp;varchar(30),&nbsp;&nbsp;--&nbsp;Command&nbsp;<BR>@Id&nbsp;varchar&nbsp;(20),&nbsp;&nbsp;--&nbsp;Table&nbsp;object&nbsp;id<BR>@Nulls&nbsp;varchar&nbsp;(20)&nbsp;&nbsp;--&nbsp;Allows&nbsp;nulls</P>
<P>SET&nbsp;NOCOUNT&nbsp;ON</P>
<P>--&nbsp;see&nbsp;if&nbsp;database&nbsp;exists<BR>IF&nbsp;not&nbsp;exists&nbsp;(&nbsp;SELECT&nbsp;name<BR>&nbsp;&nbsp;FROM&nbsp;master.dbo.sysdatabases&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;(name&nbsp;=&nbsp;@DBname))<BR>BEGIN</P>
<P>--&nbsp;if&nbsp;not,&nbsp;raise&nbsp;error<BR>RAISERROR(15010,-1,-1,&nbsp;@DBname)<BR>RETURN&nbsp;(1)<BR>END</P>
<P>--&nbsp;print&nbsp;exec&nbsp;msg&nbsp;<BR>PRINT&nbsp;'Executing:&nbsp;usp_dbinfo&nbsp;for&nbsp;'&nbsp;+&nbsp;UPPER(@DBname)+&nbsp;'&nbsp;...&nbsp;'<BR>PRINT&nbsp;''</P>
<P>--&nbsp;to&nbsp;view&nbsp;server&nbsp;jobs<BR>IF&nbsp;@VType&nbsp;=&nbsp;'jobs'<BR>BEGIN<BR>SELECT&nbsp;@Cmd&nbsp;=&nbsp;'USE&nbsp;msdb&nbsp;exec&nbsp;sp_help_job'<BR>EXEC&nbsp;(@Cmd)<BR>RETURN&nbsp;(1)&nbsp;<BR>END</P>
<P>--&nbsp;to&nbsp;view&nbsp;server&nbsp;alerts<BR>IF&nbsp;@VType&nbsp;=&nbsp;'alerts'<BR>BEGIN<BR>SELECT&nbsp;@Cmd&nbsp;=&nbsp;'USE&nbsp;msdb&nbsp;exec&nbsp;sp_help_alert'<BR>EXEC&nbsp;(@Cmd)<BR>RETURN&nbsp;(1)<BR>END</P>
<P>--&nbsp;to&nbsp;view&nbsp;database&nbsp;properties&nbsp;&amp;&nbsp;space&nbsp;allocation&nbsp;info<BR>IF&nbsp;@VType&nbsp;=&nbsp;'database'<BR>BEGIN<BR>DBCC&nbsp;CHECKALLOC&nbsp;WITH&nbsp;ALL_ERRORMSGS&nbsp;<BR>EXEC&nbsp;sp_helpdb&nbsp;@DBname<BR>RETURN&nbsp;(1)<BR>END</P>
<P>--&nbsp;to&nbsp;view&nbsp;database&nbsp;objects&nbsp;<BR>IF&nbsp;@VType&nbsp;=&nbsp;'objects'&nbsp;<BR>BEGIN<BR>EXEC&nbsp;sp_help<BR>RETURN&nbsp;(1)<BR>END</P>
<P>--&nbsp;to&nbsp;view&nbsp;database&nbsp;users&nbsp;<BR>IF&nbsp;@VType&nbsp;=&nbsp;'users'<BR>BEGIN<BR>EXEC&nbsp;sp_helpuser<BR>RETURN&nbsp;(1)<BR>END</P>
<P>--&nbsp;to&nbsp;view&nbsp;database&nbsp;tables&nbsp;&amp;&nbsp;info<BR>IF&nbsp;@VType&nbsp;=&nbsp;'tables'<BR>BEGIN<BR>PRINT&nbsp;'**&nbsp;ALL&nbsp;TABLE&nbsp;INFORMATION&nbsp;**'<BR>END</P>
<P>--&nbsp;declare&nbsp;main&nbsp;cursor&nbsp;to&nbsp;get&nbsp;first&nbsp;user&nbsp;table&nbsp;name&nbsp;from&nbsp;sysobjects<BR>DECLARE&nbsp;TabNameCur&nbsp;CURSOR&nbsp;FOR&nbsp;</P>
<P>&nbsp;SELECT&nbsp;&nbsp;so.name&nbsp;<BR>&nbsp;FROM&nbsp;sysobjects&nbsp;so&nbsp;<BR>&nbsp;WHERE&nbsp;so.xtype&nbsp;=&nbsp;'u'<BR>&nbsp;ORDER&nbsp;BY&nbsp;name</P>
<P>--&nbsp;open&nbsp;cursor&nbsp;and&nbsp;fetch&nbsp;table&nbsp;info&nbsp;data<BR>OPEN&nbsp;&nbsp;TabNameCur&nbsp;FETCH&nbsp;TabNameCur&nbsp;INTO&nbsp;@TName</P>
<P>--&nbsp;while&nbsp;fetch&nbsp;status&nbsp;is&nbsp;0,&nbsp;fetch&nbsp;&nbsp;table&nbsp;info<BR>WHILE&nbsp;@@FETCH_STATUS&nbsp;=&nbsp;0<BR>BEGIN&nbsp;</P>
<P>--&nbsp;display&nbsp;space&nbsp;used&nbsp;for&nbsp;table<BR>EXEC&nbsp;sp_spaceused&nbsp;@TName</P>
<P>PRINT&nbsp;'-------------------&nbsp;'&nbsp;+&nbsp;@TName&nbsp;+&nbsp;'&nbsp;-------------------------------'</P>
<P>--&nbsp;declare&nbsp;cursor&nbsp;to&nbsp;get&nbsp;table&nbsp;info<BR>DECLARE&nbsp;TableInfoCur&nbsp;CURSOR&nbsp;FOR&nbsp;</P>
<P>&nbsp;--&nbsp;get&nbsp;all&nbsp;table&nbsp;information&nbsp;(linked&nbsp;to&nbsp;main&nbsp;cursor&nbsp;by&nbsp;@TabName)<BR>&nbsp;SELECT&nbsp;DISTINCT&nbsp;sc.name,&nbsp;sc.length,&nbsp;st.name,&nbsp;sc.id,&nbsp;st.allownulls<BR>&nbsp;FROM&nbsp;sysobjects&nbsp;so&nbsp;<BR>&nbsp;INNER&nbsp;JOIN&nbsp;syscolumns&nbsp;sc&nbsp;ON&nbsp;so.id&nbsp;=&nbsp;sc.id&nbsp;<BR>&nbsp;INNER&nbsp;JOIN&nbsp;systypes&nbsp;st&nbsp;ON&nbsp;sc.xtype&nbsp;=&nbsp;st.xtype</P>
<P>&nbsp;WHERE&nbsp;(so.xtype&nbsp;=&nbsp;'U')&nbsp;&nbsp;&nbsp;<BR>&nbsp;and&nbsp;st.name&nbsp;&lt;&gt;&nbsp;'sysname'<BR>&nbsp;and&nbsp;so.name&nbsp;=&nbsp;@TName</P>
<P>--&nbsp;open&nbsp;tableinfo&nbsp;nested&nbsp;cursor&nbsp;to&nbsp;get&nbsp;table&nbsp;info<BR>OPEN&nbsp;&nbsp;TableInfoCur</P>
<P>--&nbsp;print&nbsp;item&nbsp;headers<BR>PRINT&nbsp;''<BR>PRINT&nbsp;''&nbsp;+&nbsp;CAST('NAME'&nbsp;as&nbsp;char(30))&nbsp;+&nbsp;''&nbsp;+&nbsp;CAST('OBJ&nbsp;ID'&nbsp;as&nbsp;char(7))&nbsp;+&nbsp;'&nbsp;'&nbsp;+&nbsp;<BR>CAST('NULLS?'&nbsp;as&nbsp;char(6))&nbsp;+&nbsp;'&nbsp;&nbsp;'&nbsp;+&nbsp;CAST('TYPE'&nbsp;as&nbsp;char(10))&nbsp;+&nbsp;'&nbsp;'&nbsp;+&nbsp;CAST('LEN'&nbsp;as&nbsp;char(3))<BR>PRINT&nbsp;''</P>
<P>--&nbsp;fetch&nbsp;items&nbsp;into&nbsp;nested&nbsp;cursor<BR>FETCH&nbsp;TableInfoCur&nbsp;INTO&nbsp;@FName,&nbsp;@Len&nbsp;,&nbsp;@DType,&nbsp;@Id,&nbsp;@Nulls</P>
<P>--&nbsp;if&nbsp;fetch&nbsp;status&nbsp;less&nbsp;than&nbsp;0,&nbsp;there&nbsp;are&nbsp;no&nbsp;user&nbsp;tables<BR>IF&nbsp;@@FETCH_STATUS&nbsp;&lt;&nbsp;0<BR>PRINT&nbsp;'No&nbsp;User&nbsp;Tables'</P>
<P>--&nbsp;while&nbsp;fetch&nbsp;status&nbsp;=&nbsp;0,&nbsp;print&nbsp;table&nbsp;info<BR>WHILE&nbsp;@@FETCH_STATUS&nbsp;=&nbsp;0<BR>BEGIN</P>
<P>--&nbsp;print&nbsp;data<BR>PRINT&nbsp;''&nbsp;+&nbsp;CAST&nbsp;(@FName&nbsp;as&nbsp;char(30))&nbsp;+&nbsp;CAST&nbsp;(@Id&nbsp;as&nbsp;char(6))&nbsp;+&nbsp;'&nbsp;&nbsp;'&nbsp;+&nbsp;CAST&nbsp;(@Nulls&nbsp;as&nbsp;char(8))<BR>+&nbsp;''&nbsp;+&nbsp;CAST&nbsp;(@DType&nbsp;as&nbsp;char(10))&nbsp;+&nbsp;'&nbsp;('&nbsp;+&nbsp;rtrim(@Len)+&nbsp;')&nbsp;'</P>
<P>--&nbsp;fetch&nbsp;next&nbsp;row&nbsp;of&nbsp;table&nbsp;data<BR>FETCH&nbsp;NEXT&nbsp;FROM&nbsp;TableInfoCur&nbsp;<BR>INTO&nbsp;@FName,&nbsp;@Len&nbsp;,&nbsp;@DType,&nbsp;@Id,&nbsp;@Nulls&nbsp;<BR>END</P>
<P>--&nbsp;close&nbsp;&amp;&nbsp;deallocate&nbsp;nested&nbsp;cursor<BR>CLOSE&nbsp;TableInfoCur&nbsp;DEALLOCATE&nbsp;TableInfoCur</P>
<P>--&nbsp;get&nbsp;next&nbsp;database&nbsp;name&nbsp;from&nbsp;main&nbsp;cursor<BR>FETCH&nbsp;NEXT&nbsp;FROM&nbsp;TabNameCur&nbsp;INTO&nbsp;@TName<BR>END</P>
<P>--&nbsp;close&nbsp;&amp;&nbsp;deallocate&nbsp;main&nbsp;cursor<BR>CLOSE&nbsp;TabNameCur&nbsp;DEALLOCATE&nbsp;TabNameCur</P>
<P>--&nbsp;Author:&nbsp;Lauryn&nbsp;Bradley&nbsp;&nbsp;02/02/02<BR>--&nbsp;Shows&nbsp;various&nbsp;info&nbsp;for&nbsp;active&nbsp;database<BR>--&nbsp;Accepts&nbsp;viewtype&nbsp;parameter&nbsp;of&nbsp;either:&nbsp;<BR>--&nbsp;&nbsp;'database',&nbsp;'tables',&nbsp;'users',&nbsp;'objects',&nbsp;'alerts'&nbsp;or&nbsp;'jobs'</P>
<P>--&nbsp;EXEC&nbsp;usp_dbinfo&nbsp;'database_name',&nbsp;'viewtype_name'<BR>GO</P></FONT>