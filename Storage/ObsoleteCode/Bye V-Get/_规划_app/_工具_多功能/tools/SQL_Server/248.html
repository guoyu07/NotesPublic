<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>交叉制表-检查列的安全性(6)</B><BR>在查询用于sp_column_privileges&nbsp;系统存储过程之后,对查询建立模型.一个相当复杂的查询用于检查具有选择权限的列的号码是否等于3.该查询中检查每个列的参数,并且给那些当前用户有选择权限的列返回一个值1.如果所有三列都是可以访问的,if语句成功执行并且过程继续执行下去.否则,产生一个错误并且过程继续执行.<BR>--check&nbsp;for&nbsp;permission&nbsp;on&nbsp;source<BR>if&nbsp;user_id()&lt;&gt;1&nbsp;<BR>begin<BR>&nbsp;&nbsp;if&nbsp;select&nbsp;count(distinct&nbsp;c.name)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;syscolumns&nbsp;c,sysobjects&nbsp;o,sysprotects&nbsp;p,sysusers&nbsp;u,master..spt_values&nbsp;v<BR>&nbsp;&nbsp;&nbsp;where&nbsp;c.name&nbsp;in(@chrcolhead,@chrrowhead,@chrvalue)<BR>&nbsp;&nbsp;&nbsp;and&nbsp;c.id=o.id&nbsp;and&nbsp;p.id=c.id&nbsp;and&nbsp;c.colid=v.number&nbsp;and&nbsp;v.type='p'<BR>&nbsp;&nbsp;and&nbsp;o.id=object_id(@chrsource)&nbsp;and&nbsp;u.uid=user_id()&nbsp;or&nbsp;u.uid&nbsp;in<BR>&nbsp;&nbsp;(select&nbsp;u1.uid&nbsp;from&nbsp;sysusers&nbsp;u1&nbsp;where&nbsp;u1.gid=u1.uid&nbsp;and&nbsp;u1.gid&nbsp;in<BR>&nbsp;&nbsp;(select&nbsp;u2.gid&nbsp;from&nbsp;sysusers&nbsp;u2&nbsp;where&nbsp;u2.uid=user_id()&nbsp;or&nbsp;u2.uid=user_id('public'))))<BR>&nbsp;&nbsp;and&nbsp;p.uid=u.uid<BR>&nbsp;&nbsp;and&nbsp;p.action=193&nbsp;and&nbsp;p.protecttype=205<BR>&nbsp;&nbsp;and&nbsp;&nbsp;columns&nbsp;is&nbsp;not&nbsp;null&nbsp;and&nbsp;&nbsp;<BR>&nbsp;&nbsp;case&nbsp;&nbsp;substring(p.columns,1,1)&amp;1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;&nbsp;null&nbsp;then&nbsp;255<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;0&nbsp;then&nbsp;&nbsp;convert(tinyint,substring(p.columns,v.low,1))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else(~convert(tinyint,isnull(substring(p.columns,v.low,1),0)))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;&amp;v.high&lt;&gt;0<BR>&nbsp;&nbsp;and&nbsp;not&nbsp;exists<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(select&nbsp;*&nbsp;from&nbsp;syscolumns&nbsp;c5,sysobjects&nbsp;o5,sysprotects&nbsp;p5,sysusers&nbsp;&nbsp;&nbsp;u5,master..spt_values&nbsp;v5<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;c.name&nbsp;in(@chrcolhead,#@chrrowhead,@chrvalue)<BR>&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;c5.colid=c.colid&nbsp;and&nbsp;c5.id=o5.id&nbsp;and&nbsp;p5.id=c5.id<BR>&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;c5.colid=v5.number&nbsp;and&nbsp;v5.type='p'<BR>&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;o5.id=object_id(@chrsource)<BR>&nbsp;&nbsp;&nbsp;and&nbsp;u5.uid=user_id()&nbsp;or&nbsp;u5.uid&nbsp;in<BR>&nbsp;&nbsp;&nbsp;(select&nbsp;u6.uid&nbsp;from&nbsp;sysusers&nbsp;u6&nbsp;where&nbsp;u6.gid=u6.uid&nbsp;and&nbsp;u6.gid&nbsp;in<BR>&nbsp;&nbsp;&nbsp;(select&nbsp;u7.gid&nbsp;from&nbsp;sysusers&nbsp;u7&nbsp;where&nbsp;u7.uid=user_id()&nbsp;or&nbsp;u7.uid=user_id('public'))))<BR>&nbsp;and&nbsp;p5.uid=u5.uid<BR>&nbsp;and&nbsp;p5.action=193<BR>&nbsp;and&nbsp;p5.protecttype=206<BR>&nbsp;and&nbsp;p5.columns&nbsp;is&nbsp;not&nbsp;null<BR>&nbsp;and&nbsp;case&nbsp;substring(p5.columns,1,1)&amp;1&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;null&nbsp;then&nbsp;255<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;0&nbsp;then&nbsp;convert(tinyint,substring(p5.columns,v5.low,1))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;(~convert&nbsp;(tinyint,isnull(substring(p5.columns,v5.low,1),0)))<BR>&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;&amp;v5.high&lt;&gt;0))&lt;&gt;3<BR>begin<BR>&nbsp;&nbsp;raiserror&nbsp;51003&nbsp;'permission&nbsp;denied&nbsp;on&nbsp;column'<BR>&nbsp;&nbsp;return&nbsp;-1<BR>end<BR>第一个if语句将dbo排除在查找之外,对数据库拥有者作额外的处理是不必要的.<BR>在这个语句中,列名数目的计数值是返回值.被查询的表都来自master数据库.<BR>当前用户的id必须与sysuser中的uid&nbsp;相匹配;或者与当前用户所属的任何组相匹配.<BR>来自sysprotect的uid需要与来自sysusers的uid相匹配,并<B>且要查找值为193的动作<BR>(选择权限)和值为205的protecttype(授予权限)</B><B>如果一个用户是一个组的成员,而不是public的成员,当被查询时,用户没有作为sysusers表中的public成员列举出--即使所有的用户总是public的一个成员.当检查一个用户的权限时,有必要检查public组.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</B><BR><B>spt_values表用于查找sysprotects表中columns列的bit位置,这个表的用户正为其检查权限的表.</B><BR>来自columns列(二进制数据类型)的数据的第一个字节在case表达式中被使用.来自spt_values的低位值用于查找来自二进制数据的另一个字节.该值和高位值之间执行位于(and)运算;如果不为0,用户对指定的列有访问权限.注意spt_value表的number列与来自syscolumns的colid相匹配,并且其类型值为'p'(permission,权限),这将保证当检查权限时高位和低位值从属表中的某一列.<BR>&nbsp;如果一切正常,查询返回3,表明用户在所有这三个列上具有选择权限.<BR></FONT>