<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Database&nbsp;User&nbsp;Permissions</B><BR>Database&nbsp;User&nbsp;Permissions&nbsp;Script
<P></P>
<P></P>
<P><BR>This&nbsp;stored&nbsp;procedure&nbsp;for&nbsp;SQL&nbsp;Server&nbsp;7.0&nbsp;and&nbsp;2000&nbsp;will&nbsp;return&nbsp;a&nbsp;user's&nbsp;permissions&nbsp;for&nbsp;a&nbsp;database&nbsp;object.&nbsp;It&nbsp;contains&nbsp;two&nbsp;null-able&nbsp;parameters:&nbsp;@user_name&nbsp;and&nbsp;@object_name.&nbsp;The&nbsp;parameter&nbsp;@user_name&nbsp;will&nbsp;accept&nbsp;a&nbsp;SQL&nbsp;Role&nbsp;name&nbsp;or&nbsp;a&nbsp;User&nbsp;name.&nbsp;The&nbsp;parameter&nbsp;@object_name&nbsp;will&nbsp;accept&nbsp;any&nbsp;type&nbsp;of&nbsp;database&nbsp;object&nbsp;name.&nbsp;The&nbsp;result&nbsp;set&nbsp;will&nbsp;return&nbsp;the&nbsp;types&nbsp;of&nbsp;permissions&nbsp;a&nbsp;user&nbsp;has&nbsp;on&nbsp;an&nbsp;object&nbsp;in&nbsp;the&nbsp;database.&nbsp;If&nbsp;the&nbsp;@user_name&nbsp;parameter&nbsp;contains&nbsp;a&nbsp;role&nbsp;name,&nbsp;it&nbsp;will&nbsp;also&nbsp;return&nbsp;the&nbsp;members&nbsp;of&nbsp;that&nbsp;role.&nbsp;If&nbsp;the&nbsp;@user_name&nbsp;parameter&nbsp;contains&nbsp;a&nbsp;user&nbsp;name,&nbsp;it&nbsp;will&nbsp;also&nbsp;return&nbsp;the&nbsp;roles&nbsp;that&nbsp;the&nbsp;user&nbsp;is&nbsp;a&nbsp;member&nbsp;of.&nbsp;Leaving&nbsp;one&nbsp;or&nbsp;more&nbsp;of&nbsp;the&nbsp;parameters&nbsp;null&nbsp;will&nbsp;return&nbsp;various&nbsp;types&nbsp;of&nbsp;results,&nbsp;experiment&nbsp;a&nbsp;bit&nbsp;and&nbsp;see&nbsp;if&nbsp;you&nbsp;find&nbsp;it&nbsp;useful.&nbsp;</P>
<P>Author:&nbsp;Jason&nbsp;Bohanon&nbsp;</P>
<P></P>
<P><BR>SET&nbsp;QUOTED_IDENTIFIER&nbsp;ON&nbsp;<BR>GO<BR>SET&nbsp;ANSI_NULLS&nbsp;ON&nbsp;<BR>GO</P>
<P>if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;dbo.sysobjects&nbsp;where&nbsp;id&nbsp;=&nbsp;object_id(N'[dbo].[sp_get_object_permissions]')&nbsp;and&nbsp;OBJECTPROPERTY(id,&nbsp;N'IsProcedure')&nbsp;=&nbsp;1)<BR>drop&nbsp;procedure&nbsp;[dbo].[sp_get_object_permissions]<BR>GO</P>
<P><BR>CREATE&nbsp;PROCEDURE&nbsp;sp_get_object_permissions<BR>@user_name&nbsp;nvarchar(128)&nbsp;=&nbsp;null,&nbsp;/***User&nbsp;Name&nbsp;to&nbsp;check,&nbsp;if&nbsp;null&nbsp;then&nbsp;all&nbsp;users***/<BR>@object_name&nbsp;nvarchar(128)&nbsp;=&nbsp;null&nbsp;/***Object&nbsp;Name&nbsp;to&nbsp;check,&nbsp;if&nbsp;null&nbsp;then&nbsp;all&nbsp;objects***/<BR>AS</P>
<P>/****CREATED&nbsp;BY&nbsp;JASON&nbsp;BOHANON.&nbsp;&nbsp;<BR>FOR&nbsp;QUESTIONS&nbsp;AND&nbsp;COMMENTS&nbsp;PLEASE&nbsp;CONTACT&nbsp;ME&nbsp;AT&nbsp;bohanon@qwest.net.&nbsp;****/</P>
<P>SELECT&nbsp;<BR>&nbsp;sobj.name&nbsp;as&nbsp;'Object&nbsp;Name',&nbsp;<BR>&nbsp;CASE&nbsp;&nbsp;WHEN&nbsp;sobj.xtype&nbsp;=&nbsp;'U'<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'USER&nbsp;TABLE'<BR>&nbsp;&nbsp;WHEN&nbsp;sobj.xtype&nbsp;=&nbsp;'P'<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'STORED&nbsp;PROCEDURE'<BR>&nbsp;&nbsp;WHEN&nbsp;sobj.xtype&nbsp;=&nbsp;'V'<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'VIEW'<BR>&nbsp;&nbsp;WHEN&nbsp;sobj.xtype&nbsp;=&nbsp;'FN'<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'SCALAR&nbsp;FUNCTION'<BR>&nbsp;&nbsp;WHEN&nbsp;sobj.xtype&nbsp;=&nbsp;'TF'<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'TABLE&nbsp;FUNCTION'<BR>&nbsp;&nbsp;WHEN&nbsp;sobj.xtype&nbsp;=&nbsp;'S'<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'SYSTEM&nbsp;TABLE'<BR>&nbsp;&nbsp;ELSE&nbsp;'UNKNOWN'<BR>&nbsp;&nbsp;END&nbsp;as&nbsp;'Object&nbsp;Type',<BR>&nbsp;susr.name&nbsp;as&nbsp;'User',<BR>&nbsp;CASE&nbsp;WHEN&nbsp;spro.action&nbsp;=&nbsp;193<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'SELECT'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;spro.action&nbsp;=&nbsp;195<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'INSERT'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;spro.action&nbsp;=&nbsp;196<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'DELETE'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;spro.action&nbsp;=&nbsp;197<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'UPDATE'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;spro.action&nbsp;=&nbsp;224<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'EXECUTE'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;spro.action&nbsp;=&nbsp;26<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;'REFERENCES'<BR>&nbsp;&nbsp;ELSE&nbsp;'UNKNOWN&nbsp;TYPE:&nbsp;'&nbsp;+&nbsp;CAST(spro.action&nbsp;as&nbsp;nvarchar(128))<BR>&nbsp;&nbsp;END&nbsp;as&nbsp;'Permission&nbsp;Type'<BR>FROM&nbsp;<BR>&nbsp;&nbsp;sysprotects&nbsp;spro<BR>&nbsp;&nbsp;JOIN&nbsp;<BR>&nbsp;sysusers&nbsp;susr<BR>&nbsp;&nbsp;&nbsp;on&nbsp;spro.uid&nbsp;=&nbsp;susr.uid<BR>&nbsp;&nbsp;JOIN&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sysobjects&nbsp;sobj<BR>&nbsp;&nbsp;&nbsp;on&nbsp;sobj.id&nbsp;=&nbsp;spro.id<BR>WHERE&nbsp;<BR>&nbsp;susr.name&nbsp;like<BR>&nbsp;CASE&nbsp;<BR>&nbsp;&nbsp;WHEN&nbsp;@user_name&nbsp;IS&nbsp;NOT&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;@user_name<BR>&nbsp;&nbsp;ELSE<BR>&nbsp;&nbsp;&nbsp;'%'<BR>&nbsp;END<BR>&nbsp;&nbsp;AND<BR>&nbsp;sobj.name&nbsp;like&nbsp;<BR>&nbsp;CASE<BR>&nbsp;&nbsp;WHEN&nbsp;@object_name&nbsp;IS&nbsp;NOT&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;THEN&nbsp;@object_name<BR>&nbsp;&nbsp;ELSE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'%'<BR>&nbsp;END&nbsp;&nbsp;<BR>ORDER&nbsp;BY&nbsp;<BR>&nbsp;sobj.xtype,<BR>&nbsp;susr.name,&nbsp;<BR>&nbsp;sobj.name,<BR>&nbsp;spro.action</P>
<P>/***IF&nbsp;SUPPLIED&nbsp;@user_name&nbsp;IS&nbsp;A&nbsp;ROLE,&nbsp;OR&nbsp;A&nbsp;USER&nbsp;THAT&nbsp;IS&nbsp;PART&nbsp;OF&nbsp;A&nbsp;ROLE***/<BR>IF&nbsp;@user_name&nbsp;IS&nbsp;NOT&nbsp;NULL&nbsp;and&nbsp;@user_name&nbsp;&lt;&gt;&nbsp;'public'<BR>&nbsp;BEGIN---CHECK&nbsp;TO&nbsp;SEE&nbsp;IF&nbsp;@user_name&nbsp;IS&nbsp;A&nbsp;ROLE<BR>&nbsp;IF&nbsp;(SELECT&nbsp;<BR>&nbsp;&nbsp;issqlrole&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;<BR>&nbsp;&nbsp;sysusers<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;<BR>&nbsp;&nbsp;name&nbsp;=&nbsp;@user_name)&nbsp;&gt;&nbsp;0<BR>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;<BR>&nbsp;&nbsp;&nbsp;susr2.name&nbsp;as&nbsp;'Role&nbsp;Users'<BR>&nbsp;&nbsp;FROM&nbsp;<BR>&nbsp;&nbsp;&nbsp;sysusers&nbsp;susr1&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;<BR>&nbsp;&nbsp;&nbsp;sysmembers&nbsp;smbr<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;smbr.groupuid&nbsp;=&nbsp;susr1.uid<BR>&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;<BR>&nbsp;&nbsp;&nbsp;sysusers&nbsp;susr2&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;smbr.memberuid&nbsp;=&nbsp;susr2.uid<BR>&nbsp;&nbsp;WHERE<BR>&nbsp;&nbsp;&nbsp;susr1.name&nbsp;=&nbsp;@user_name<BR>&nbsp;&nbsp;ELSE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;<BR>&nbsp;&nbsp;&nbsp;susr1.name&nbsp;as&nbsp;'User&nbsp;a&nbsp;Member&nbsp;In&nbsp;Role'<BR>&nbsp;&nbsp;FROM&nbsp;<BR>&nbsp;&nbsp;&nbsp;sysusers&nbsp;susr1&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;<BR>&nbsp;&nbsp;&nbsp;sysmembers&nbsp;smbr<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;smbr.groupuid&nbsp;=&nbsp;susr1.uid<BR>&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;<BR>&nbsp;&nbsp;&nbsp;sysusers&nbsp;susr2&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;smbr.memberuid&nbsp;=&nbsp;susr2.uid<BR>&nbsp;&nbsp;WHERE<BR>&nbsp;&nbsp;&nbsp;susr2.name&nbsp;=&nbsp;@user_name<BR>&nbsp;END&nbsp;---END&nbsp;ROLE&nbsp;CHECK</P>
<P><BR>GO<BR>SET&nbsp;QUOTED_IDENTIFIER&nbsp;OFF&nbsp;<BR>GO<BR>SET&nbsp;ANSI_NULLS&nbsp;ON&nbsp;<BR>GO</P></FONT>