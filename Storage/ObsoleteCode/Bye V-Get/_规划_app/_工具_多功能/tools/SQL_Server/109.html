<HEAD><TITLE>周周共享论坛--『数 据 库』浏览：UNDO Committed Transactions</TITLE>
<META charset=gb2312 http-equiv=Content-Type content=text/html;>
<META content=动网先锋,动网论坛,dvbbs name=keywords>
<STYLE type=text/css>
A:link,A:active,A:visited{TEXT-DECORATION:none ;Color:#000000}
A:hover{TEXT-DECORATION: underline;Color:#4455aa}

BODY{
FONT-SIZE: 12px;
COLOR: #000000;
FONT-FAMILY:  宋体;
background-color: #FFFFFF; 
scrollbar-face-color: #DEE3E7;
scrollbar-highlight-color: #FFFFFF;
scrollbar-shadow-color: #DEE3E7;
scrollbar-3dlight-color: #D1D7DC;
scrollbar-arrow-color:  #006699;
scrollbar-track-color: #EFEFEF;
scrollbar-darkshadow-color: #98AAB1;
}
TD{
font-family: 宋体;
font-size: 12px;
line-height: 15px;
}
th
{
background-image: url(skin/default/bg1.gif);
background-color: #4455aa;
color: white;
font-size: 12px;
font-weight:bold;
}
td.TableTitle2
{
background-color: #E4E8EF;
}
td.TableBody1
{
background-color: #FFFFFF;
}
td.TableBody2
{
background-color: #E4E8EF;
}
td.TopDarkNav
{
background-image: url(skin/default/topbg.gif);
}
td.TopLighNav
{
background-image: url(skin/default/bottombg.gif);
}
td.TopLighNav1
{
background-image: url(skin/default/tabs_m_tile.gif);
}
td.TopLighNav2
{
background-color:#FFFFFF
}
.tableBorder1
{
width:97%;
border: 1px; 
background-color: #6595D6;
}
.tableBorder2
{
width:97%;
border: 1px #DEDEDE solid; 
background-color: #EFEFEF;
}

#TableTitleLink A:link, #TableTitleLink A:visited, #TableTitleLink A:active {
	COLOR: #FFFFFF;
	TEXT-DECORATION: none;
}
#TableTitleLink A:hover {
	COLOR: #FFFFFF;
	TEXT-DECORATION: underline;}

input,select,Textarea{
font-family:Tahoma,Verdana,宋体; font-size: 12px; line-height: 15px;}
}
.normalTextSmall 
{ 
    font-size : 11px;
    color : #000000; 
    font-family: Verdana, Arial, Helvetica, sans-serif;
}
</STYLE>





<STYLE id=defaultPopStyle type=text/css>.cPopText {  background-color: #F8F8F5;color:#000000; border: 1px #000000 solid;font-color: font-size: 12px; padding-right: 4px; padding-left: 4px; height: 20px; padding-top: 2px; padding-bottom: 2px; filter: Alpha(Opacity=0)}</STYLE>
</head>
<BODY leftMargin=0 topMargin=0>
<DIV class=cPopText id=dypopLayer style="Z-INDEX: 1000; POSITION: absolute"></DIV>
<TABLE style="BORDER-RIGHT: #6595d6 1px solid; BORDER-TOP: #6595d6 0px solid; BORDER-LEFT: #6595d6 1px solid; WIDTH: 97%; BORDER-BOTTOM: #6595d6 0px solid" cellSpacing=0 cellPadding=0 align=center>
<TBODY>
<TR>
<TD width="100%">
<TABLE cellSpacing=0 cellPadding=0 width="100%" align=center border=0>
<TBODY>
<TR>
<TD class=TopDarkNav height=9></TD></TR>
<TR>
<TD class=TopLighNav2 height=70>
<TABLE width="100%" align=center border=0>
<TBODY>
<TR>
<TD align=left width="25%"><A href="http://www.pigtwo.com/"><IMG src="http://www.pigtwo.com/forum/images/LOGO.GIF" border=0></A></TD>
<TD align=middle width="65%">






<TABLE height=31 cellSpacing=0 cellPadding=0 width=88 background="http://www.pigtwo.com/count/images/stat_counter.gif" border=0>
<TBODY>
<TR>
<TD width=24 height=5></TD>
<TD width=57 height=5></TD>
<TD width=7 height=5></TD></TR>
<TR>
<TD height=16></TD>
<TD vAlign=top align=middle height=16>
<MARQUEE style="FONT-SIZE: 12px; LINE-HEIGHT: 15px" scrollAmount=3 scrollDelay=100 behavior=loop><A style="COLOR: #ffffff; TEXT-DECORATION: none" href="http://www.pigtwo.com/count/index.asp" target=_blank><FONT face="Arial, Verdana, san-serif" color=#407526>总访问量: 43764 &nbsp;今日访问: 119 &nbsp;昨日访问: 277 &nbsp;您的访量: </FONT></A></MARQUEE></TD>
<TD height=16></TD></TR>
<TR>
<TD height=10></TD>
<TD height=10></TD>
<TD height=10></TD></TR></TBODY></TABLE></TD>
<TD style="LINE-HEIGHT: 15pt" align=right width="10%"><A href="#"><SPAN style="CURSOR: hand" onclick="">加入收藏</SPAN></A> <BR><A href="http://www.pigtwo.com/forum/mailto:v_lucky@163.com">联系我们</A> <BR><A href="http://www.pigtwo.com/forum/boardhelp.asp">新手上路</A> </TD></TD></TR></TBODY></TABLE></TD></TR>
<TR>
<TD class=TopLighNav height=9></TD></TR>
<TR>
<TD class=TopLighNav1 vAlign=center height=22>&nbsp;&nbsp; <A href="http://www.pigtwo.com/forum/cookies.asp?action=online&amp;userid=42">上线</A> <IMG src="http://www.pigtwo.com/forum/pic/navspacer.gif" align=absMiddle> <A href="http://www.pigtwo.com/forum/login.asp">重登陆</A> <IMG src="http://www.pigtwo.com/forum/pic/navspacer.gif" align=absMiddle> <A href="http://www.pigtwo.com/forum/usermanager.asp">用户控制面板</A> <IMG src="http://www.pigtwo.com/forum/pic/navspacer.gif" align=absMiddle> <A href="http://www.pigtwo.com/forum/query.asp?boardid=14">搜索</A> <IMG src="http://www.pigtwo.com/forum/pic/navspacer.gif" align=absMiddle> <A href="http://www.pigtwo.com/forum/boardstat.asp?boardid=14">论坛状态</A> <IMG src="http://www.pigtwo.com/forum/pic/navspacer.gif" align=absMiddle> <A href="http://www.pigtwo.com/forum/boardhelp.asp?boardid=14">帮助</A> <IMG src="http://www.pigtwo.com/forum/pic/navspacer.gif" align=absMiddle> <A href="http://www.pigtwo.com/forum/logout.asp">退出</A> </TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE><BR>
<TABLE cellSpacing=1 cellPadding=3 width="97%" align=center border=0>
<TBODY>
<TR>
<TD width="65%">&gt;&gt; 欢迎 <B>ugvanxk</B> [ <A href="">发短信</A> :: <A href="http://www.pigtwo.com/forum/topicwithme.asp?s=2">发表的主题</A> :: <A href="http://www.pigtwo.com/forum/topicwithme.asp?s=1">参与的主题</A> :: <A href="http://www.pigtwo.com/forum/dispuser.asp?id=42&amp;boardid=14&amp;action=permission">我能做什么</A> ] </TD>
<TD align=right width="35%"><IMG src="http://www.pigtwo.com/forum/pic/msg_no_new_bar.gif"> <A href="http://www.pigtwo.com/forum/usersms.asp?action=inbox">我的收件箱</A> (<FONT color=gray>0 新</FONT>) </TD></TR></TBODY></TABLE>
<TABLE class=tableBorder2 cellSpacing=1 cellPadding=3 align=center>
<TBODY>
<TR>
<TD vAlign=center height=25><IMG src="http://www.pigtwo.com/forum/pic/Forum_nav.gif" align=absMiddle> <A href="http://www.pigtwo.com/forum/index.asp">周周共享论坛</A> → <A href="http://www.pigtwo.com/forum/list.asp?boardid=14">『数 据 库』</A> → 浏览：UNDO&nbsp;Committed&nbsp;Transactions <A name=top></A></TD></TD></TR></TBODY></TABLE><BR>
<TABLE cellSpacing=0 cellPadding=0 width="97%" align=center border=0>
<TBODY>
<TR>
<TD vAlign=center align=left width="30%">&nbsp; <A href="http://www.pigtwo.com/forum/announce.asp?BoardID=14"><IMG alt=发表一个新主题 src="http://www.pigtwo.com/forum/pic/post.gif" border=0></A>&nbsp; <A href="http://www.pigtwo.com/forum/vote.asp?BoardID=14"><IMG alt=发表一个新投票 src="http://www.pigtwo.com/forum/pic/newpoll.gif" border=0></A>&nbsp; <A href="http://www.pigtwo.com/forum/reannounce.asp?BoardID=14&amp;id=495&amp;star=1"><IMG alt=回复主题 src="http://www.pigtwo.com/forum/pic/newreply1.gif" border=0></A> </TD>
<TD vAlign=center align=right width="70%">您是本帖的第 <B>4</B> 个阅读者<A href="http://www.pigtwo.com/forum/go.asp?BoardID=14&amp;sid=495"><IMG height=12 alt=浏览上一篇主题 src="http://www.pigtwo.com/forum/pic/prethread.gif" width=52 border=0></A>&nbsp; <A href=""><IMG height=12 alt=刷新本主题 src="http://www.pigtwo.com/forum/pic/refresh.gif" width=40 border=0></A> &nbsp; <A href="http://www.pigtwo.com/forum/?BoardID=14&amp;replyID=495&amp;id=495&amp;star=1&amp;skin=1"><IMG height=12 alt=树形显示贴子 src="http://www.pigtwo.com/forum/pic/treeview.gif" width=40 border=0></A>　<A href="http://www.pigtwo.com/forum/go.asp?BoardID=14&amp;sid=495&amp;action=next"><IMG height=12 alt=浏览下一篇主题 src="http://www.pigtwo.com/forum/pic/nextthread.gif" width=52 border=0></A> </TD></TR></TBODY></TABLE>
<TABLE class=tableborder1 cellSpacing=1 cellPadding=0 align=center>
<TBODY>
<TR align=middle>
<TD vAlign=center align=left width="100%" height=25>
<TABLE cellSpacing=0 cellPadding=0 width="100%" border=0>
<TBODY>
<TR>
<TH vAlign=center align=left width="73%" height=25>&nbsp;* 贴子主题</B>： UNDO&nbsp;Committed&nbsp;Transactions</TH>
<TH align=right width="37%"><A onclick="" href="#"><IMG height=16 alt=保存该页为文件 src="http://www.pigtwo.com/forum/pic/saveas.gif" width=16 align=absMiddle border=0></A>&nbsp;
</OBJECT><A href="http://www.pigtwo.com/forum/report.asp?BoardID=14&amp;id=495"><IMG alt=报告本帖给版主 src="http://www.pigtwo.com/forum/pic/report.gif" border=0></A>&nbsp; <A href="http://www.pigtwo.com/forum/printpage.asp?BoardID=14&amp;id=495"><IMG alt=显示可打印的版本 src="http://www.pigtwo.com/forum/pic/printpage.gif" border=0></A>&nbsp; <A href="http://www.pigtwo.com/forum/pag.asp?BoardID=14&amp;id=495"><IMG alt=把本贴打包邮递 src="http://www.pigtwo.com/forum/pic/pag.gif" border=0></A>&nbsp; <A href="http://www.pigtwo.com/forum/favadd.asp?BoardID=14&amp;id=495"><IMG alt=把本贴加入论坛收藏夹 src="http://www.pigtwo.com/forum/pic/fav_add.gif" border=0></A>&nbsp; <A href="http://www.pigtwo.com/forum/sendpage.asp?BoardID=14&amp;id=495"><IMG alt=发送本页面给朋友 src="http://www.pigtwo.com/forum/pic/emailtofriend.gif" border=0></A>&nbsp; <A href="#"><SPAN style="CURSOR: hand" onclick=""><IMG height=15 alt=把本贴加入IE收藏夹 src="http://www.pigtwo.com/forum/pic/fav_add1.gif" width=15 border=0></A>&nbsp; </SPAN></TH></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
<TABLE class=tableborder1 style="TABLE-LAYOUT: fixed; WORD-BREAK: break-all" cellSpacing=1 cellPadding=5 align=center>
<TBODY>
<TR>
<TD class=tablebody1 vAlign=top width=175>
<TABLE cellSpacing=0 cellPadding=4 width="100%">
<TBODY>
<TR>
<TD style="FILTER: glow(color=#9898BA,strength=2)" vAlign=center width=*>&nbsp;<A name=1046><FONT color=#990000><B>ugvanxk</B></FONT></A> </TD>
<TD vAlign=center width=25><IMG alt=帅哥哟，在线，有人找我吗？ src="http://www.pigtwo.com/forum/pic/Male.gif"></TD>
<TD vAlign=center width=16></TD></TR></TBODY></TABLE>&nbsp;&nbsp;<IMG height=32 src="http://www.pigtwo.com/forum/pic/Image1.gif" width=32><BR>&nbsp;&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/level10.gif"><BR>&nbsp;&nbsp;等级：版主<BR>&nbsp;&nbsp;文章：219<BR>&nbsp;&nbsp;积分：569<BR>&nbsp;&nbsp;注册：2002-11-2<BR></TD>
<TD class=tablebody1 vAlign=top width=*>
<TABLE width="100%">
<TBODY>
<TR>
<TD width=*><A href=""><IMG alt=给ugvanxk发送一个短消息 src="http://www.pigtwo.com/forum/pic/message.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/friendlist.asp?action=addF&amp;myFriend=ugvanxk" target=_blank><IMG alt=把ugvanxk加入好友 src="http://www.pigtwo.com/forum/pic/friend.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/dispuser.asp?id=42" target=_blank><IMG alt=查看ugvanxk的个人资料 src="http://www.pigtwo.com/forum/pic/profile.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/queryResult.asp?stype=1&amp;nSearch=3&amp;keyword=ugvanxk&amp;BoardID=14&amp;SearchDate=ALL" target=_blank><IMG alt="搜索ugvanxk在『数 据 库』的所有贴子" src="http://www.pigtwo.com/forum/pic/find.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/mailto:jsqmail@163.com"><IMG alt=点击这里发送电邮给ugvanxk src="http://www.pigtwo.com/forum/pic/email.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/reannounce.asp?BoardID=14&amp;replyID=1046&amp;id=495&amp;star=1&amp;reply=true"><IMG alt=引用回复这个贴子 src="http://www.pigtwo.com/forum/pic/reply.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/reannounce.asp?BoardID=14&amp;replyID=1046&amp;id=495&amp;star=1"><IMG alt=回复这个贴子 src="http://www.pigtwo.com/forum/pic/reply_a.gif" border=0></A></TD>
<TD width=50><B>楼顶</B></TD></TR>
<TR>
<TD bgColor=#6595d6 colSpan=2 height=1></TD></TR></TBODY></TABLE>
<BLOCKQUOTE><IMG alt=发贴心情 src="http://www.pigtwo.com/forum/face/face1.gif" border=0>&nbsp;<FONT style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>UNDO&nbsp;Committed&nbsp;Transactions</B><BR>Script&nbsp;to&nbsp;UNDO&nbsp;Committed&nbsp;Transactions
<P></P>
<P></P>
<P><BR>This&nbsp;script&nbsp;is&nbsp;designed&nbsp;to&nbsp;undo&nbsp;committed&nbsp;transactions,&nbsp;functioning&nbsp;as&nbsp;an&nbsp;"UNDO"&nbsp;service&nbsp;in&nbsp;multiuser&nbsp;mode.&nbsp;The&nbsp;script&nbsp;works&nbsp;only&nbsp;in&nbsp;SQL&nbsp;Server&nbsp;2000.&nbsp;</P>
<P>The&nbsp;following&nbsp;is&nbsp;a&nbsp;description&nbsp;of&nbsp;how&nbsp;the&nbsp;script&nbsp;works&nbsp;--&nbsp;for&nbsp;more&nbsp;information&nbsp;see&nbsp;the&nbsp;readme&nbsp;file&nbsp;included&nbsp;in&nbsp;the&nbsp;script&nbsp;download:&nbsp;</P>
<P>"When&nbsp;you&nbsp;do&nbsp;changes&nbsp;in&nbsp;the&nbsp;database,&nbsp;SQL-UNDO&nbsp;saves&nbsp;previous&nbsp;data,&nbsp;types&nbsp;of&nbsp;the&nbsp;actions,&nbsp;ID&nbsp;of&nbsp;the&nbsp;transaction&nbsp;and&nbsp;additional&nbsp;information&nbsp;into&nbsp;special&nbsp;tables&nbsp;with&nbsp;the&nbsp;simple&nbsp;structure:&nbsp;SUActions,&nbsp;SURowsInfo,&nbsp;SUColsInfo&nbsp;and&nbsp;SULogins.&nbsp;Then,&nbsp;when&nbsp;you&nbsp;want&nbsp;to&nbsp;undo&nbsp;an&nbsp;transaction,&nbsp;you&nbsp;run&nbsp;stored&nbsp;procedure&nbsp;spSUUndoTransaction&nbsp;or&nbsp;spSUUndoLastOwnTransaction,&nbsp;that&nbsp;takes&nbsp;data&nbsp;from&nbsp;the&nbsp;tables,&nbsp;builds&nbsp;dynamic&nbsp;queries&nbsp;for&nbsp;back&nbsp;actions&nbsp;and&nbsp;executes&nbsp;them&nbsp;within&nbsp;one&nbsp;transaction.&nbsp;spSUUndoTransaction&nbsp;has&nbsp;one&nbsp;parameter&nbsp;"@IdAction".&nbsp;You&nbsp;can&nbsp;take&nbsp;value&nbsp;for&nbsp;the&nbsp;parameter&nbsp;from&nbsp;the&nbsp;field&nbsp;"Id"&nbsp;of&nbsp;the&nbsp;table&nbsp;"SUActions".&nbsp;If&nbsp;the&nbsp;action&nbsp;was&nbsp;runned&nbsp;within&nbsp;a&nbsp;transaction,&nbsp;all&nbsp;actions&nbsp;of&nbsp;the&nbsp;transaction&nbsp;will&nbsp;be&nbsp;undone&nbsp;too."&nbsp;<BR>Author:&nbsp;Gleb&nbsp;Oufimtsev&nbsp;</P>
<P><BR>SQL-UNDO&nbsp;3.0&nbsp;service&nbsp;for&nbsp;Microsoft&nbsp;SQL&nbsp;server&nbsp;2000<BR>&nbsp;&nbsp;&nbsp;&nbsp;==================================================</P>
<P></P>
<P>The&nbsp;service&nbsp;is&nbsp;meant&nbsp;for&nbsp;undoing&nbsp;any&nbsp;commited&nbsp;in&nbsp;the&nbsp;past&nbsp;transaction.&nbsp;In&nbsp;point&nbsp;of&nbsp;fact,&nbsp;it&nbsp;is&nbsp;a&nbsp;service&nbsp;of&nbsp;"UNDO"&nbsp;in&nbsp;the&nbsp;multiuser&nbsp;mode.</P>
<P></P>
<P>&nbsp;&nbsp;&nbsp;Installation<BR>&nbsp;&nbsp;&nbsp;------------</P>
<P>1.&nbsp;Run&nbsp;install.sql&nbsp;script&nbsp;on&nbsp;database&nbsp;where&nbsp;you&nbsp;want&nbsp;to&nbsp;have&nbsp;the&nbsp;service.&nbsp;The&nbsp;library's&nbsp;objects&nbsp;will&nbsp;be&nbsp;installed.&nbsp;The&nbsp;objects&nbsp;are&nbsp;following:<BR>&nbsp;&nbsp;&nbsp;1)&nbsp;Table&nbsp;"SUActions"<BR>&nbsp;&nbsp;&nbsp;2)&nbsp;Table&nbsp;"SURowsInfo"<BR>&nbsp;&nbsp;&nbsp;3)&nbsp;Table&nbsp;"SUColsInfo"<BR>&nbsp;&nbsp;&nbsp;4)&nbsp;Table&nbsp;"SULogins"<BR>&nbsp;&nbsp;&nbsp;5)&nbsp;Stored&nbsp;procedure&nbsp;"spSUSaveActions"<BR>&nbsp;&nbsp;&nbsp;6)&nbsp;Stored&nbsp;procedure&nbsp;"spSUUndoTransaction"<BR>&nbsp;&nbsp;&nbsp;7)&nbsp;Stored&nbsp;procedure&nbsp;"spSUUndoLastOwnTransaction"<BR>&nbsp;&nbsp;&nbsp;8)&nbsp;Stored&nbsp;procedure&nbsp;"spSUSetup"</P>
<P>2.&nbsp;Run&nbsp;procedure&nbsp;"spSUSetup"&nbsp;with&nbsp;the&nbsp;first&nbsp;string&nbsp;parameter&nbsp;"Create&nbsp;SQL-UNDO&nbsp;triggers".</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;spSUSetup&nbsp;'Create&nbsp;SQL-UNDO&nbsp;triggers'</P>
<P>Triggers&nbsp;of&nbsp;the&nbsp;service&nbsp;will&nbsp;be&nbsp;installed&nbsp;by&nbsp;the&nbsp;stored&nbsp;procedure.&nbsp;After&nbsp;the&nbsp;action&nbsp;SQL-UNDO&nbsp;library&nbsp;will&nbsp;work&nbsp;and&nbsp;you&nbsp;will&nbsp;be&nbsp;have&nbsp;the&nbsp;prepared&nbsp;UNDO-service&nbsp;in&nbsp;multiuser&nbsp;mode&nbsp;within&nbsp;your&nbsp;client-server&nbsp;application.<BR>NB.&nbsp;You&nbsp;can&nbsp;place&nbsp;a&nbsp;table's&nbsp;name&nbsp;as&nbsp;the&nbsp;second&nbsp;parameter.&nbsp;Then&nbsp;the&nbsp;SQL-UNDO&nbsp;trigger&nbsp;will&nbsp;be&nbsp;created&nbsp;only&nbsp;on&nbsp;this&nbsp;table.&nbsp;Thus,&nbsp;you&nbsp;can&nbsp;solve&nbsp;where&nbsp;UNDO-service&nbsp;will&nbsp;work&nbsp;and&nbsp;where&nbsp;-&nbsp;not.&nbsp;Also&nbsp;you&nbsp;can&nbsp;drop&nbsp;the&nbsp;triggers&nbsp;on&nbsp;some&nbsp;separate&nbsp;tables&nbsp;by&nbsp;the&nbsp;following&nbsp;syntax:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;spSUSetup&nbsp;'Remove&nbsp;SQL-UNDO&nbsp;triggers'&nbsp;[,&nbsp;TableName&nbsp;]</P>
<P>Thus,&nbsp;you&nbsp;can&nbsp;manage&nbsp;creating-removing&nbsp;of&nbsp;the&nbsp;SQL-UNDO&nbsp;triggers&nbsp;in&nbsp;work&nbsp;process&nbsp;at&nbsp;any&nbsp;time.</P>
<P></P>
<P>&nbsp;&nbsp;&nbsp;Deinstallation<BR>&nbsp;&nbsp;&nbsp;--------------</P>
<P>Run&nbsp;procedure&nbsp;"spSUSetup"&nbsp;with&nbsp;the&nbsp;first&nbsp;string&nbsp;parameter&nbsp;"Remove&nbsp;SQL-UNDO&nbsp;objects"&nbsp;and&nbsp;the&nbsp;second&nbsp;string&nbsp;parameter&nbsp;"Yes,&nbsp;I&nbsp;really&nbsp;want&nbsp;to&nbsp;delete&nbsp;all&nbsp;SQL-UNDO&nbsp;objects&nbsp;with&nbsp;data"</P>
<P>&nbsp;&nbsp;&nbsp;exec&nbsp;spSUSetup&nbsp;'Remove&nbsp;SQL-UNDO&nbsp;objects','Yes,&nbsp;I&nbsp;really&nbsp;want&nbsp;to&nbsp;delete&nbsp;all&nbsp;SQL-UNDO&nbsp;objects&nbsp;with&nbsp;data'</P>
<P>All&nbsp;tables,&nbsp;stored&nbsp;procedures&nbsp;and&nbsp;triggers&nbsp;of&nbsp;SQL-UNDO&nbsp;library&nbsp;will&nbsp;be&nbsp;killed.</P>
<P></P>
<P>&nbsp;&nbsp;&nbsp;Work&nbsp;restrictions<BR>&nbsp;&nbsp;&nbsp;-----------------</P>
<P>1.&nbsp;SQL-UNDO&nbsp;will&nbsp;work&nbsp;on&nbsp;tables&nbsp;where&nbsp;there&nbsp;are&nbsp;the&nbsp;Primary&nbsp;Keys&nbsp;and&nbsp;the&nbsp;Primary&nbsp;Keys&nbsp;containt&nbsp;only&nbsp;one&nbsp;field.&nbsp;Tables,&nbsp;where&nbsp;there&nbsp;are&nbsp;the&nbsp;composite&nbsp;Primary&nbsp;Keys,&nbsp;will&nbsp;be&nbsp;omitted&nbsp;by&nbsp;SQL-UNDO&nbsp;service.</P>
<P>2.&nbsp;SQL-UNDO&nbsp;will&nbsp;work&nbsp;on&nbsp;tables&nbsp;where&nbsp;there&nbsp;are&nbsp;not&nbsp;IMAGE,&nbsp;TEXT&nbsp;and&nbsp;NTEXT&nbsp;fields,&nbsp;because&nbsp;to&nbsp;work&nbsp;with&nbsp;blobs&nbsp;are&nbsp;impossible&nbsp;within&nbsp;triggers&nbsp;in&nbsp;MSSQL2000.&nbsp;It&nbsp;is&nbsp;a&nbsp;restriction&nbsp;of&nbsp;Microsoft.&nbsp;Tables,&nbsp;where&nbsp;there&nbsp;are&nbsp;blobs&nbsp;fields,&nbsp;will&nbsp;be&nbsp;omitted&nbsp;by&nbsp;SQL-UNDO&nbsp;service.</P>
<P>3.&nbsp;An&nbsp;ordinary&nbsp;user&nbsp;cannot&nbsp;undo&nbsp;an&nbsp;transaction&nbsp;of&nbsp;another&nbsp;user.&nbsp;Only&nbsp;DBA&nbsp;or&nbsp;member&nbsp;of&nbsp;"db_owner"&nbsp;can&nbsp;undo&nbsp;such&nbsp;transaction.</P>
<P>4.&nbsp;It&nbsp;is&nbsp;impossible&nbsp;-&nbsp;to&nbsp;undo&nbsp;an&nbsp;transaction,&nbsp;if&nbsp;the&nbsp;data&nbsp;within&nbsp;the&nbsp;records&nbsp;was&nbsp;changed&nbsp;after.&nbsp;SQL-UNDO&nbsp;puzzles&nbsp;out&nbsp;correctly&nbsp;such&nbsp;situations&nbsp;and&nbsp;gives&nbsp;warnings.</P>
<P>5.&nbsp;There&nbsp;is&nbsp;an&nbsp;particular&nbsp;situation.&nbsp;When&nbsp;table&nbsp;has&nbsp;IDENTITY&nbsp;column,&nbsp;the&nbsp;action&nbsp;was&nbsp;DELETE&nbsp;and&nbsp;the&nbsp;user&nbsp;is&nbsp;not&nbsp;the&nbsp;table's&nbsp;owner&nbsp;and&nbsp;not&nbsp;member&nbsp;of&nbsp;db_ddladmin,&nbsp;db_owner&nbsp;or&nbsp;sysadmin&nbsp;roles.&nbsp;Undoing&nbsp;of&nbsp;such&nbsp;action&nbsp;will&nbsp;be&nbsp;fail,&nbsp;because&nbsp;the&nbsp;undo-action&nbsp;will&nbsp;be&nbsp;INSERT&nbsp;with&nbsp;the&nbsp;directive&nbsp;"SET&nbsp;IDENTITY_INSERT",&nbsp;but&nbsp;an&nbsp;ordinary&nbsp;user&nbsp;has&nbsp;no&nbsp;rights&nbsp;to&nbsp;set&nbsp;the&nbsp;directive.&nbsp;And&nbsp;changing&nbsp;the&nbsp;rights&nbsp;are&nbsp;impossible.&nbsp;It&nbsp;is&nbsp;a&nbsp;restriction&nbsp;of&nbsp;Microsoft.&nbsp;Such&nbsp;action&nbsp;can&nbsp;be&nbsp;undo&nbsp;by&nbsp;DBA.</P>
<P>6.&nbsp;If&nbsp;your&nbsp;triggers&nbsp;modify&nbsp;other&nbsp;tables,&nbsp;set&nbsp;up&nbsp;the&nbsp;'nested&nbsp;trigger'&nbsp;option&nbsp;for&nbsp;correct&nbsp;work&nbsp;of&nbsp;SQL-UNDO.&nbsp;The&nbsp;service&nbsp;saves&nbsp;data&nbsp;for&nbsp;undoing&nbsp;with&nbsp;the&nbsp;help&nbsp;of&nbsp;triggers.</P>
<P>7.&nbsp;The&nbsp;SQL-UNDO&nbsp;service&nbsp;cannot&nbsp;be&nbsp;useful&nbsp;for&nbsp;databases&nbsp;with&nbsp;a&nbsp;big&nbsp;degree&nbsp;of&nbsp;transaction's&nbsp;activity&nbsp;because&nbsp;of&nbsp;the&nbsp;reason&nbsp;of&nbsp;the&nbsp;performance.</P>
<P>8.&nbsp;If&nbsp;you&nbsp;change&nbsp;Primary&nbsp;Key's&nbsp;value,&nbsp;you&nbsp;will&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;undo&nbsp;the&nbsp;action&nbsp;and&nbsp;all&nbsp;previous&nbsp;actions&nbsp;on&nbsp;this&nbsp;record.<BR>&nbsp;&nbsp;</P>
<P><BR>&nbsp;&nbsp;&nbsp;How&nbsp;it&nbsp;works<BR>&nbsp;&nbsp;&nbsp;------------</P>
<P>When&nbsp;you&nbsp;do&nbsp;changes&nbsp;in&nbsp;the&nbsp;database,&nbsp;SQL-UNDO&nbsp;saves&nbsp;previous&nbsp;data,&nbsp;types&nbsp;of&nbsp;the&nbsp;actions,&nbsp;ID&nbsp;of&nbsp;the&nbsp;transaction&nbsp;and&nbsp;another&nbsp;information&nbsp;into&nbsp;special&nbsp;tables&nbsp;with&nbsp;the&nbsp;simple&nbsp;structure:&nbsp;SUActions,&nbsp;SURowsInfo,&nbsp;SUColsInfo&nbsp;and&nbsp;SULogins.&nbsp;Then,&nbsp;when&nbsp;you&nbsp;want&nbsp;to&nbsp;undo&nbsp;an&nbsp;transaction,&nbsp;you&nbsp;run&nbsp;stored&nbsp;procedure&nbsp;spSUUndoTransaction&nbsp;or&nbsp;spSUUndoLastOwnTransaction,&nbsp;that&nbsp;takes&nbsp;data&nbsp;from&nbsp;the&nbsp;tables,&nbsp;builds&nbsp;dynamic&nbsp;queries&nbsp;for&nbsp;back&nbsp;actions&nbsp;and&nbsp;executes&nbsp;them&nbsp;within&nbsp;one&nbsp;transaction.&nbsp;spSUUndoTransaction&nbsp;has&nbsp;one&nbsp;parameter&nbsp;"@IdAction".&nbsp;You&nbsp;can&nbsp;take&nbsp;value&nbsp;for&nbsp;the&nbsp;parameter&nbsp;from&nbsp;the&nbsp;field&nbsp;"Id"&nbsp;of&nbsp;the&nbsp;table&nbsp;"SUActions".&nbsp;If&nbsp;the&nbsp;action&nbsp;was&nbsp;runned&nbsp;within&nbsp;a&nbsp;transaction,&nbsp;all&nbsp;actions&nbsp;of&nbsp;the&nbsp;transaction&nbsp;will&nbsp;be&nbsp;undone&nbsp;too.&nbsp;You&nbsp;can&nbsp;build&nbsp;a&nbsp;service&nbsp;of&nbsp;viewing&nbsp;actions&nbsp;on&nbsp;the&nbsp;SQL-UNDO&nbsp;tables&nbsp;for&nbsp;comfortable&nbsp;work&nbsp;with&nbsp;the&nbsp;SQL-UNDO&nbsp;service.&nbsp;The&nbsp;tables'&nbsp;structures&nbsp;are&nbsp;very&nbsp;easy&nbsp;and&nbsp;understandable.</P>
<P></P>
<P>&nbsp;&nbsp;&nbsp;Licensing&nbsp;and&nbsp;limitations<BR>&nbsp;&nbsp;&nbsp;-------------------------</P>
<P>SQL-UNDO&nbsp;library&nbsp;is&nbsp;fully&nbsp;freeware.&nbsp;It&nbsp;is&nbsp;"AS&nbsp;IS".&nbsp;You&nbsp;can&nbsp;use,&nbsp;modify,&nbsp;copy&nbsp;it&nbsp;without&nbsp;any&nbsp;restrictions.&nbsp;But&nbsp;any&nbsp;warranties,&nbsp;responsibilities&nbsp;are&nbsp;not&nbsp;given&nbsp;and&nbsp;any&nbsp;claims&nbsp;will&nbsp;not&nbsp;be&nbsp;taken.&nbsp;You&nbsp;use&nbsp;the&nbsp;library&nbsp;on&nbsp;your&nbsp;own&nbsp;risk.</P>
<P></P>
<P>Gleb&nbsp;Oufimtsev<BR>gvu@newmail.ru<BR><IMG src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.gvu.newmail.ru" target=_blank>http://www.gvu.newmail.ru</A><BR>Moscow,&nbsp;Russia,&nbsp;January&nbsp;2002</P>
<P><BR>If&nbsp;you&nbsp;like&nbsp;my&nbsp;work,&nbsp;why&nbsp;you&nbsp;didn't&nbsp;still&nbsp;invite&nbsp;me&nbsp;to&nbsp;work?&nbsp;:-)<BR>(It's&nbsp;a&nbsp;joke.&nbsp;Almost)<BR></FONT></P></BLOCKQUOTE></TD></TR>
<TR>
<TD class=tablebody1 vAlign=center align=middle width=175><A href="http://www.pigtwo.com/forum/look_ip.asp?boardid=14&amp;userid=42&amp;ip=61.48.16.123&amp;action=lookip" target=_blank><IMG height=15 alt="点击查看用户来源及管理<br>发贴IP：61.48.16.123" src="http://www.pigtwo.com/forum/pic/ip.gif" width=13 align=absMiddle border=0></A> 2003-6-5 11:58:37</TD>
<TD class=tablebody1 vAlign=center width=*>
<TABLE cellSpacing=0 cellPadding=0 width="100%">
<TBODY>
<TR>
<TD vAlign=center align=left><A href="http://www.pigtwo.com/forum/editannounce.asp?BoardID=14&amp;replyID=1046&amp;id=495&amp;star=1"><IMG alt=编辑这个贴子 src="http://www.pigtwo.com/forum/pic/edit.gif" align=absMiddle border=0></A>&nbsp;&nbsp;<A title=同意该帖观点，给他一朵鲜花，将消耗您5点金钱 href="http://www.pigtwo.com/forum/postagree.asp?boardid=14&amp;id=495&amp;isagree=1">鲜花</A>(<FONT color=#ff0000>0</FONT>)&nbsp;&nbsp;<A title=不同意该帖观点，给他一个鸡蛋，将消耗您5点金钱 href="http://www.pigtwo.com/forum/postagree.asp?boardid=14&amp;id=495&amp;isagree=2">鸡蛋</A>(<FONT color=#ff0000>0</FONT>)</TD>
<TD vAlign=bottom align=right width=110 nowarp><A title=复制单个贴子到别的版面 href="http://www.pigtwo.com/forum/admin_postings.asp?action=复制&amp;BoardID=14&amp;ID=495&amp;replyID=1046"><IMG src="http://www.pigtwo.com/forum/pic/copy.gif" border=0></A>&nbsp;<A title=精华 href="http://www.pigtwo.com/forum/admin_postings.asp?action=精华&amp;BoardID=14&amp;ID=495&amp;replyID=1046"><IMG src="http://www.pigtwo.com/forum/pic/jing.gif" border=0></A></TD>
<TD vAlign=bottom align=right width=4></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
<TABLE class=tableborder1 style="TABLE-LAYOUT: fixed; WORD-BREAK: break-all" cellSpacing=1 cellPadding=5 align=center>
<TBODY>
<TR>
<TD class=tablebody2 vAlign=top width=175>
<TABLE cellSpacing=0 cellPadding=4 width="100%">
<TBODY>
<TR>
<TD style="FILTER: glow(color=#9898BA,strength=2)" vAlign=center width=*>&nbsp;<A name=1047><FONT color=#990000><B>ugvanxk</B></FONT></A> </TD>
<TD vAlign=center width=25><IMG alt=帅哥哟，在线，有人找我吗？ src="http://www.pigtwo.com/forum/pic/Male.gif"></TD>
<TD vAlign=center width=16></TD></TR></TBODY></TABLE>&nbsp;&nbsp;<IMG height=32 src="http://www.pigtwo.com/forum/pic/Image1.gif" width=32><BR>&nbsp;&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/level10.gif"><BR>&nbsp;&nbsp;等级：版主<BR>&nbsp;&nbsp;文章：219<BR>&nbsp;&nbsp;积分：569<BR>&nbsp;&nbsp;注册：2002-11-2<BR></TD>
<TD class=tablebody2 vAlign=top width=*>
<TABLE width="100%">
<TBODY>
<TR>
<TD width=*><A href=""><IMG alt=给ugvanxk发送一个短消息 src="http://www.pigtwo.com/forum/pic/message.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/friendlist.asp?action=addF&amp;myFriend=ugvanxk" target=_blank><IMG alt=把ugvanxk加入好友 src="http://www.pigtwo.com/forum/pic/friend.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/dispuser.asp?id=42" target=_blank><IMG alt=查看ugvanxk的个人资料 src="http://www.pigtwo.com/forum/pic/profile.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/queryResult.asp?stype=1&amp;nSearch=3&amp;keyword=ugvanxk&amp;BoardID=14&amp;SearchDate=ALL" target=_blank><IMG alt="搜索ugvanxk在『数 据 库』的所有贴子" src="http://www.pigtwo.com/forum/pic/find.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/mailto:jsqmail@163.com"><IMG alt=点击这里发送电邮给ugvanxk src="http://www.pigtwo.com/forum/pic/email.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/reannounce.asp?BoardID=14&amp;replyID=1047&amp;id=495&amp;star=1&amp;reply=true"><IMG alt=引用回复这个贴子 src="http://www.pigtwo.com/forum/pic/reply.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/reannounce.asp?BoardID=14&amp;replyID=1047&amp;id=495&amp;star=1"><IMG alt=回复这个贴子 src="http://www.pigtwo.com/forum/pic/reply_a.gif" border=0></A></TD>
<TD width=50><B>第<FONT color=#ff0000>2</FONT>楼</B></TD></TR>
<TR>
<TD bgColor=#6595d6 colSpan=2 height=1></TD></TR></TBODY></TABLE>
<BLOCKQUOTE><IMG alt=发贴心情 src="http://www.pigtwo.com/forum/face/face0.gif" border=0>&nbsp;<FONT style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B></B><BR>/*************************************************************************/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Library&nbsp;SQL-UNDO&nbsp;3.0&nbsp;for&nbsp;MSSQL2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;(C)&nbsp;2002&nbsp;&nbsp;Gleb&nbsp;Oufimtsev&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gvu@newmail.ru,&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.gvu.newmail.ru" target=_blank>http://www.gvu.newmail.ru</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Moscow,&nbsp;Russia&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*************************************************************************/<BR>CREATE&nbsp;TABLE&nbsp;dbo.SULogins&nbsp;(<BR>&nbsp;Id&nbsp;smallint&nbsp;IDENTITY(1,1)&nbsp;NOT&nbsp;NULL&nbsp;PRIMARY&nbsp;KEY&nbsp;CLUSTERED,<BR>&nbsp;Login&nbsp;sysname&nbsp;NOT&nbsp;NULL&nbsp;UNIQUE<BR>)&nbsp;
<P></P>
<P>CREATE&nbsp;TABLE&nbsp;dbo.SUActions&nbsp;(<BR>&nbsp;Id&nbsp;bigint&nbsp;IDENTITY(1,1)&nbsp;NOT&nbsp;NULL&nbsp;PRIMARY&nbsp;KEY&nbsp;CLUSTERED,<BR>&nbsp;RegDate&nbsp;datetime&nbsp;NOT&nbsp;NULL&nbsp;,<BR>&nbsp;IdLogin&nbsp;smallint&nbsp;NOT&nbsp;NULL&nbsp;REFERENCES&nbsp;dbo.SULogins&nbsp;(Id),<BR>&nbsp;ActionType&nbsp;tinyint&nbsp;NOT&nbsp;NULL&nbsp;,<BR>&nbsp;TableId&nbsp;int&nbsp;NOT&nbsp;NULL&nbsp;,<BR>&nbsp;TranID&nbsp;varchar(255)&nbsp;NULL&nbsp;,<BR>&nbsp;&nbsp;&nbsp;&nbsp;CONSTRAINT&nbsp;CK_SUActions_ActionType&nbsp;CHECK&nbsp;(ActionType&nbsp;between&nbsp;1&nbsp;and&nbsp;3)<BR>)</P>
<P>PRINT&nbsp;'Please,&nbsp;ignore&nbsp;the&nbsp;following&nbsp;two&nbsp;warnings:&nbsp;'+char(10)</P>
<P>CREATE&nbsp;TABLE&nbsp;dbo.SURowsInfo&nbsp;(<BR>&nbsp;Id&nbsp;bigint&nbsp;IDENTITY(1,1)&nbsp;NOT&nbsp;NULL&nbsp;PRIMARY&nbsp;KEY&nbsp;CLUSTERED,<BR>&nbsp;IdAction&nbsp;bigint&nbsp;NOT&nbsp;NULL&nbsp;REFERENCES&nbsp;dbo.SUActions&nbsp;(Id),<BR>&nbsp;PKvalue&nbsp;sql_variant&nbsp;NOT&nbsp;NULL&nbsp;,<BR>&nbsp;&nbsp;&nbsp;&nbsp;CONSTRAINT&nbsp;UQ_SURowsInfo&nbsp;UNIQUE&nbsp;(IdAction,&nbsp;PKvalue)<BR>)</P>
<P>CREATE&nbsp;TABLE&nbsp;dbo.SUColsInfo&nbsp;(<BR>&nbsp;IdRowInfo&nbsp;bigint&nbsp;NOT&nbsp;NULL&nbsp;REFERENCES&nbsp;dbo.SURowsInfo&nbsp;(Id),<BR>&nbsp;ColumnId&nbsp;smallint&nbsp;NOT&nbsp;NULL&nbsp;,<BR>&nbsp;Oldvalue&nbsp;sql_variant&nbsp;NULL&nbsp;,<BR>&nbsp;&nbsp;&nbsp;&nbsp;CONSTRAINT&nbsp;PK_SUColsInfo&nbsp;PRIMARY&nbsp;KEY&nbsp;CLUSTERED&nbsp;(IdRowInfo,&nbsp;ColumnId)&nbsp;<BR>)</P>
<P>CREATE&nbsp;&nbsp;INDEX&nbsp;idx_SUActions_Tran&nbsp;ON&nbsp;dbo.SUActions&nbsp;(TranID)<BR>CREATE&nbsp;&nbsp;INDEX&nbsp;idx_SUActions_Table&nbsp;ON&nbsp;dbo.SUActions&nbsp;(TableId)<BR>CREATE&nbsp;&nbsp;INDEX&nbsp;idx_SUActions_Login&nbsp;ON&nbsp;dbo.SUActions&nbsp;(IdLogin)<BR>CREATE&nbsp;&nbsp;INDEX&nbsp;idx_SUActions_RegDate&nbsp;ON&nbsp;dbo.SUActions&nbsp;(RegDate)<BR>CREATE&nbsp;&nbsp;INDEX&nbsp;idx_SUColsInfo_Column&nbsp;ON&nbsp;dbo.SUColsInfo&nbsp;(ColumnId)<BR>CREATE&nbsp;&nbsp;INDEX&nbsp;idx_SURowsInfo_PKvalue&nbsp;ON&nbsp;dbo.SURowsInfo&nbsp;(PKvalue)</P>
<P>GO<BR>/*************************************************************************/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Library&nbsp;SQL-UNDO&nbsp;3.0&nbsp;for&nbsp;MSSQL2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;(C)&nbsp;2002&nbsp;&nbsp;Gleb&nbsp;Oufimtsev&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gvu@newmail.ru,&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.gvu.newmail.ru" target=_blank>http://www.gvu.newmail.ru</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Moscow,&nbsp;Russia&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*************************************************************************/<BR>CREATE&nbsp;PROCEDURE&nbsp;dbo.spSUSetup&nbsp;<BR>&nbsp;<BR>&nbsp;@Action&nbsp;varchar(50),&nbsp;<BR>&nbsp;@Parameter&nbsp;nvarchar(4000)=NULL&nbsp;<BR>&nbsp;<BR>AS<BR>&nbsp;<BR>if&nbsp;@Action&nbsp;not&nbsp;in&nbsp;('Create&nbsp;SQL-UNDO&nbsp;triggers','Remove&nbsp;SQL-UNDO&nbsp;triggers','Remove&nbsp;SQL-UNDO&nbsp;objects')<BR>begin<BR>&nbsp;&nbsp;raiserror('SQL-UNDO&nbsp;error.&nbsp;Incorrect&nbsp;value&nbsp;of&nbsp;@Action.&nbsp;It&nbsp;may&nbsp;be&nbsp;only&nbsp;''Create&nbsp;SQL-UNDO&nbsp;triggers'',''Remove&nbsp;SQL-UNDO&nbsp;triggers''&nbsp;or&nbsp;''Remove&nbsp;SQL-UNDO&nbsp;objects''',16,-1)<BR>&nbsp;&nbsp;return<BR>end<BR>&nbsp;<BR>if&nbsp;@Action='Remove&nbsp;SQL-UNDO&nbsp;objects'&nbsp;and&nbsp;IsNull(@Parameter,'')&lt;&gt;'Yes,&nbsp;I&nbsp;really&nbsp;want&nbsp;to&nbsp;delete&nbsp;all&nbsp;SQL-UNDO&nbsp;objects&nbsp;with&nbsp;data'<BR>begin<BR>&nbsp;&nbsp;raiserror('SQL-UNDO&nbsp;error.&nbsp;Incorrect&nbsp;value&nbsp;of&nbsp;@Parameter.&nbsp;It&nbsp;may&nbsp;be&nbsp;only&nbsp;''Yes,&nbsp;I&nbsp;really&nbsp;want&nbsp;to&nbsp;delete&nbsp;all&nbsp;SQL-UNDO&nbsp;objects&nbsp;with&nbsp;data&nbsp;by&nbsp;@Action=''Remove&nbsp;SQL-UNDO&nbsp;objects''',16,-1)<BR>&nbsp;&nbsp;return<BR>end<BR>&nbsp;<BR>if&nbsp;@Action&nbsp;in&nbsp;('Create&nbsp;SQL-UNDO&nbsp;triggers','Remove&nbsp;SQL-UNDO&nbsp;triggers')&nbsp;and&nbsp;@Parameter&nbsp;is&nbsp;not&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;not&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;xtype='U'&nbsp;and&nbsp;name=@Parameter)<BR>begin<BR>&nbsp;&nbsp;raiserror('SQL-UNDO&nbsp;error.&nbsp;Incorrect&nbsp;value&nbsp;of&nbsp;@Parameter.&nbsp;It&nbsp;may&nbsp;be&nbsp;only&nbsp;correct&nbsp;table''s&nbsp;name&nbsp;or&nbsp;NULL&nbsp;by&nbsp;@Action=''%s''',16,-1,@Action)<BR>&nbsp;&nbsp;return<BR>end<BR>&nbsp;<BR>set&nbsp;nocount&nbsp;on&nbsp;<BR>&nbsp;<BR>declare&nbsp;<BR>&nbsp;&nbsp;@TableName&nbsp;nvarchar(231),&nbsp;<BR>&nbsp;&nbsp;@TriggerName&nbsp;sysname,&nbsp;@OldTriggerName&nbsp;sysname,<BR>&nbsp;&nbsp;@NumFieldInPK&nbsp;smallint,&nbsp;<BR>&nbsp;&nbsp;@BlobsCount&nbsp;int,<BR>&nbsp;&nbsp;@dynsql&nbsp;nvarchar(4000)<BR>&nbsp;<BR>if&nbsp;@Action&nbsp;in&nbsp;('Create&nbsp;SQL-UNDO&nbsp;triggers','Remove&nbsp;SQL-UNDO&nbsp;triggers')<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;TBLS&nbsp;cursor&nbsp;local&nbsp;fast_forward&nbsp;for<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'['+u.name+'].['+t.name+']',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'tr_SQL_UNDO_30_on_'+t.name,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(select&nbsp;name&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;xtype='TR'&nbsp;and&nbsp;parent_obj=t.id&nbsp;and&nbsp;name&nbsp;like&nbsp;'tr_SQL_UNDO_30_on_%'),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(select&nbsp;count(distinct&nbsp;k.colid)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes&nbsp;i&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;sysindexkeys&nbsp;k&nbsp;on&nbsp;i.id=k.id&nbsp;and&nbsp;k.indid=i.indid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;sysobjects&nbsp;o&nbsp;on&nbsp;o.parent_obj=i.id&nbsp;and&nbsp;o.name=i.name&nbsp;and&nbsp;o.xtype='PK'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;i.id=t.id),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(select&nbsp;count(*)&nbsp;from&nbsp;syscolumns&nbsp;where&nbsp;id=t.id&nbsp;and&nbsp;xtype&nbsp;in&nbsp;(34/*image*/,99/*ntext*/,35/*text*/))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;sysobjects&nbsp;t<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;sysusers&nbsp;u&nbsp;on&nbsp;t.uid=u.uid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;t.xtype='U'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;(t.name=@Parameter&nbsp;or&nbsp;@Parameter&nbsp;is&nbsp;NULL)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;(@Parameter&nbsp;is&nbsp;not&nbsp;NULL&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;t.name&nbsp;not&nbsp;in&nbsp;('SUActions','SURowsInfo','SUColsInfo','SULogins','dtproperties'))&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;You&nbsp;can&nbsp;extend&nbsp;the&nbsp;list<BR>&nbsp;&nbsp;&nbsp;&nbsp;open&nbsp;TBLS<BR>&nbsp;&nbsp;&nbsp;&nbsp;fetch&nbsp;TBLS&nbsp;into&nbsp;@TableName,&nbsp;@TriggerName,&nbsp;@OldTriggerName,&nbsp;@NumFieldInPK,&nbsp;@BlobsCount<BR>&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;@@FETCH_STATUS=0<BR>&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@OldTriggerName&nbsp;is&nbsp;not&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=N'drop&nbsp;trigger&nbsp;['+@OldTriggerName+']'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;sp_executesql&nbsp;@dynsql<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@@ERROR=0&nbsp;print&nbsp;'SQL-UNDO&nbsp;old&nbsp;trigger&nbsp;on&nbsp;table&nbsp;'+@TableName+'&nbsp;has&nbsp;been&nbsp;dropped'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@Action='Create&nbsp;SQL-UNDO&nbsp;triggers'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@NumFieldInPK&gt;1&nbsp;print&nbsp;char(10)+'***&nbsp;SQL-UNDO&nbsp;trigger&nbsp;cannot&nbsp;be&nbsp;added&nbsp;on&nbsp;table&nbsp;'+@TableName+'&nbsp;because&nbsp;the&nbsp;table''s&nbsp;Primary&nbsp;Key&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;column'+char(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@NumFieldInPK=0&nbsp;print&nbsp;char(10)+'***&nbsp;SQL-UNDO&nbsp;trigger&nbsp;cannot&nbsp;be&nbsp;added&nbsp;on&nbsp;table&nbsp;'+@TableName+'&nbsp;because&nbsp;the&nbsp;table&nbsp;has&nbsp;no&nbsp;Primary&nbsp;Key'+char(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@BlobsCount&gt;0&nbsp;print&nbsp;char(10)+'***&nbsp;SQL-UNDO&nbsp;trigger&nbsp;cannot&nbsp;be&nbsp;added&nbsp;on&nbsp;table&nbsp;'+@TableName+'&nbsp;because&nbsp;the&nbsp;table&nbsp;has&nbsp;blobs&nbsp;(image,&nbsp;text,&nbsp;ntext)'+char(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*************************************************************************/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Library&nbsp;SQL-UNDO&nbsp;3.0&nbsp;for&nbsp;MSSQL2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;(C)&nbsp;2002&nbsp;&nbsp;Gleb&nbsp;Oufimtsev&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gvu@newmail.ru,&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.gvu.newmail.ru" target=_blank>http://www.gvu.newmail.ru</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Moscow,&nbsp;Russia&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*************************************************************************/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'CREATE&nbsp;TRIGGER&nbsp;['+@TriggerName+']&nbsp;ON&nbsp;'+@TableName+'&nbsp;'+NCHAR(10)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'FOR&nbsp;INSERT,&nbsp;UPDATE,&nbsp;DELETE&nbsp;'+NCHAR(10)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'AS&nbsp;'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Trigger&nbsp;of&nbsp;SQL-UNDO&nbsp;3.0&nbsp;library&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Generated&nbsp;by&nbsp;procedure&nbsp;spSUSetup&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/'+NCHAR(10)+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'set&nbsp;nocount&nbsp;on&nbsp;'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'select&nbsp;*&nbsp;into&nbsp;#SU03dt&nbsp;from&nbsp;deleted&nbsp;'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'select&nbsp;*&nbsp;into&nbsp;#SU03it&nbsp;from&nbsp;inserted&nbsp;'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'exec&nbsp;spSUSaveActions&nbsp;@@PROCID&nbsp;'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;sp_executesql&nbsp;@dynsql<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@@ERROR=0&nbsp;print&nbsp;'SQL-UNDO&nbsp;trigger&nbsp;has&nbsp;been&nbsp;added&nbsp;on&nbsp;table&nbsp;'+@TableName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fetch&nbsp;TBLS&nbsp;into&nbsp;@TableName,&nbsp;@TriggerName,&nbsp;@OldTriggerName,&nbsp;@NumFieldInPK,&nbsp;@BlobsCount<BR>&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;&nbsp;&nbsp;&nbsp;close&nbsp;TBLS<BR>&nbsp;&nbsp;&nbsp;&nbsp;deallocate&nbsp;TBLS<BR>&nbsp;&nbsp;end<BR>else&nbsp;if&nbsp;@Action='Remove&nbsp;SQL-UNDO&nbsp;objects'<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;sp_executesql&nbsp;N'exec&nbsp;spSUSetup&nbsp;''Remove&nbsp;SQL-UNDO&nbsp;triggers'''<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;table&nbsp;SUColsInfo<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;table&nbsp;SURowsInfo<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;table&nbsp;SUActions<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;table&nbsp;SULogins<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;procedure&nbsp;spSUSaveActions<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;procedure&nbsp;spSUUndoTransaction<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;procedure&nbsp;spSUUndoLastOwnTransaction<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;procedure&nbsp;spSUSetup<BR>&nbsp;&nbsp;end<BR>&nbsp;<BR>return<BR>GO</FONT></P></BLOCKQUOTE></TD></TR>
<TR>
<TD class=tablebody2 vAlign=center align=middle width=175><A href="http://www.pigtwo.com/forum/look_ip.asp?boardid=14&amp;userid=42&amp;ip=61.48.16.123&amp;action=lookip" target=_blank><IMG height=15 alt="点击查看用户来源及管理<br>发贴IP：61.48.16.123" src="http://www.pigtwo.com/forum/pic/ip.gif" width=13 align=absMiddle border=0></A> 2003-6-5 12:02:10</TD>
<TD class=tablebody2 vAlign=center width=*>
<TABLE cellSpacing=0 cellPadding=0 width="100%">
<TBODY>
<TR>
<TD vAlign=center align=left><A href="http://www.pigtwo.com/forum/editannounce.asp?BoardID=14&amp;replyID=1047&amp;id=495&amp;star=1"><IMG alt=编辑这个贴子 src="http://www.pigtwo.com/forum/pic/edit.gif" align=absMiddle border=0></A></TD>
<TD vAlign=bottom align=right width=110 nowarp><A title=注意：本操作将删除单个贴子 href="http://www.pigtwo.com/forum/admin_postings.asp?action=删除跟帖&amp;BoardID=14&amp;ID=495&amp;replyID=1047&amp;userid=42"><IMG src="http://www.pigtwo.com/forum/pic/delete.gif" border=0></A>&nbsp;<A title=复制单个贴子到别的版面 href="http://www.pigtwo.com/forum/admin_postings.asp?action=复制&amp;BoardID=14&amp;ID=495&amp;replyID=1047"><IMG src="http://www.pigtwo.com/forum/pic/copy.gif" border=0></A>&nbsp;<A title=精华 href="http://www.pigtwo.com/forum/admin_postings.asp?action=精华&amp;BoardID=14&amp;ID=495&amp;replyID=1047"><IMG src="http://www.pigtwo.com/forum/pic/jing.gif" border=0></A></TD>
<TD vAlign=bottom align=right width=4></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
<TABLE class=tableborder1 style="TABLE-LAYOUT: fixed; WORD-BREAK: break-all" cellSpacing=1 cellPadding=5 align=center>
<TBODY>
<TR>
<TD class=tablebody1 vAlign=top width=175>
<TABLE cellSpacing=0 cellPadding=4 width="100%">
<TBODY>
<TR>
<TD style="FILTER: glow(color=#9898BA,strength=2)" vAlign=center width=*>&nbsp;<A name=1048><FONT color=#990000><B>ugvanxk</B></FONT></A> </TD>
<TD vAlign=center width=25><IMG alt=帅哥哟，在线，有人找我吗？ src="http://www.pigtwo.com/forum/pic/Male.gif"></TD>
<TD vAlign=center width=16></TD></TR></TBODY></TABLE>&nbsp;&nbsp;<IMG height=32 src="http://www.pigtwo.com/forum/pic/Image1.gif" width=32><BR>&nbsp;&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/level10.gif"><BR>&nbsp;&nbsp;等级：版主<BR>&nbsp;&nbsp;文章：219<BR>&nbsp;&nbsp;积分：569<BR>&nbsp;&nbsp;注册：2002-11-2<BR></TD>
<TD class=tablebody1 vAlign=top width=*>
<TABLE width="100%">
<TBODY>
<TR>
<TD width=*><A href=""><IMG alt=给ugvanxk发送一个短消息 src="http://www.pigtwo.com/forum/pic/message.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/friendlist.asp?action=addF&amp;myFriend=ugvanxk" target=_blank><IMG alt=把ugvanxk加入好友 src="http://www.pigtwo.com/forum/pic/friend.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/dispuser.asp?id=42" target=_blank><IMG alt=查看ugvanxk的个人资料 src="http://www.pigtwo.com/forum/pic/profile.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/queryResult.asp?stype=1&amp;nSearch=3&amp;keyword=ugvanxk&amp;BoardID=14&amp;SearchDate=ALL" target=_blank><IMG alt="搜索ugvanxk在『数 据 库』的所有贴子" src="http://www.pigtwo.com/forum/pic/find.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/mailto:jsqmail@163.com"><IMG alt=点击这里发送电邮给ugvanxk src="http://www.pigtwo.com/forum/pic/email.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/reannounce.asp?BoardID=14&amp;replyID=1048&amp;id=495&amp;star=1&amp;reply=true"><IMG alt=引用回复这个贴子 src="http://www.pigtwo.com/forum/pic/reply.gif" border=0></A>&nbsp;<A href="http://www.pigtwo.com/forum/reannounce.asp?BoardID=14&amp;replyID=1048&amp;id=495&amp;star=1"><IMG alt=回复这个贴子 src="http://www.pigtwo.com/forum/pic/reply_a.gif" border=0></A></TD>
<TD width=50><B>第<FONT color=#ff0000>3</FONT>楼</B></TD></TR>
<TR>
<TD bgColor=#6595d6 colSpan=2 height=1></TD></TR></TBODY></TABLE>
<BLOCKQUOTE><IMG alt=发贴心情 src="http://www.pigtwo.com/forum/face/face0.gif" border=0>&nbsp;<FONT style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B></B><BR>/*************************************************************************/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Library&nbsp;SQL-UNDO&nbsp;3.0&nbsp;for&nbsp;MSSQL2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;(C)&nbsp;2002&nbsp;&nbsp;Gleb&nbsp;Oufimtsev&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gvu@newmail.ru,&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.gvu.newmail.ru" target=_blank>http://www.gvu.newmail.ru</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Moscow,&nbsp;Russia&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*************************************************************************/<BR>CREATE&nbsp;PROCEDURE&nbsp;dbo.spSUSaveActions&nbsp;@TriggerId&nbsp;int&nbsp;--&nbsp;@@PROCID&nbsp;of&nbsp;the&nbsp;trigger<BR>&nbsp;<BR>AS<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>--&nbsp;Do&nbsp;not&nbsp;use&nbsp;this&nbsp;procedure&nbsp;directly.<BR>--&nbsp;It&nbsp;is&nbsp;an&nbsp;internal&nbsp;service&nbsp;for&nbsp;using&nbsp;by&nbsp;triggers<BR>&nbsp;<BR>declare&nbsp;<BR>&nbsp;@SaveIdentity&nbsp;bigint,<BR>&nbsp;@TypeAction&nbsp;tinyint,&nbsp;--&nbsp;1-insert,&nbsp;2-delete,&nbsp;3-update<BR>&nbsp;@TranID&nbsp;varchar(255),&nbsp;@IdAction&nbsp;bigint,&nbsp;@IdLogin&nbsp;smallint,<BR>&nbsp;@TableId&nbsp;int,&nbsp;@ColId&nbsp;smallint,&nbsp;@ColName&nbsp;sysname,<BR>&nbsp;@PKname&nbsp;sysname,&nbsp;<BR>&nbsp;@dynsql&nbsp;nvarchar(4000)<BR>&nbsp;<BR>&nbsp;<BR>set&nbsp;nocount&nbsp;on<BR>&nbsp;<BR>if&nbsp;OBJECT_ID('tempdb..#sql_undo_30_keys')&gt;0&nbsp;RETURN&nbsp;0&nbsp;&nbsp;--&nbsp;This&nbsp;action&nbsp;is&nbsp;an&nbsp;UNDO&nbsp;action,&nbsp;not&nbsp;saveable.<BR>&nbsp;<BR>set&nbsp;@SaveIdentity=@@IDENTITY<BR>&nbsp;<BR>&nbsp;<BR>set&nbsp;@TypeAction=<BR>&nbsp;&nbsp;&nbsp;&nbsp;(case&nbsp;when&nbsp;(select&nbsp;count(*)&nbsp;from&nbsp;#SU03it)&gt;0&nbsp;then&nbsp;1&nbsp;else&nbsp;0&nbsp;end)<BR>&nbsp;&nbsp;&nbsp;+(case&nbsp;when&nbsp;(select&nbsp;count(*)&nbsp;from&nbsp;#SU03dt)&gt;0&nbsp;then&nbsp;2&nbsp;else&nbsp;0&nbsp;end)<BR>&nbsp;<BR>if&nbsp;@TypeAction=0&nbsp;RETURN<BR>&nbsp;<BR>&nbsp;<BR>--&nbsp;Determination&nbsp;of&nbsp;Transaction&nbsp;ID<BR>&nbsp;<BR>exec&nbsp;sp_getbindtoken&nbsp;@TranID&nbsp;OUTPUT<BR>&nbsp;<BR>&nbsp;&nbsp;<BR>--&nbsp;Determination&nbsp;of&nbsp;the&nbsp;target-table<BR>&nbsp;<BR>select&nbsp;@TableId=parent_obj&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;type='TR'&nbsp;and&nbsp;id=@TriggerId<BR>&nbsp;&nbsp;<BR>&nbsp;<BR>--&nbsp;Determination&nbsp;of&nbsp;the&nbsp;login<BR>&nbsp;<BR>select&nbsp;@IdLogin=Id&nbsp;from&nbsp;SULogins&nbsp;where&nbsp;Login=SUSER_SNAME()<BR>&nbsp;<BR>if&nbsp;@IdLogin&nbsp;is&nbsp;NULL<BR>begin<BR>&nbsp;&nbsp;insert&nbsp;into&nbsp;SULogins&nbsp;(Login)&nbsp;values&nbsp;(SUSER_SNAME())<BR>&nbsp;&nbsp;set&nbsp;@IdLogin=SCOPE_IDENTITY()<BR>end<BR>&nbsp;<BR>&nbsp;<BR>--&nbsp;Saving&nbsp;the&nbsp;action<BR>&nbsp;<BR>insert&nbsp;into&nbsp;SUActions&nbsp;(IdLogin,&nbsp;ActionType,&nbsp;TableId,&nbsp;RegDate,&nbsp;TranID)<BR>&nbsp;&nbsp;&nbsp;values&nbsp;(@IdLogin,&nbsp;@TypeAction,&nbsp;@TableId,&nbsp;GETDATE(),&nbsp;@TranID)<BR>set&nbsp;@IdAction=SCOPE_IDENTITY()<BR>&nbsp;<BR>&nbsp;<BR>--&nbsp;Determination&nbsp;of&nbsp;the&nbsp;target-table's&nbsp;PK<BR>&nbsp;<BR>select&nbsp;@PKname=COL_NAME(@TableId,&nbsp;k.colid)&nbsp;<BR>from&nbsp;sysindexes&nbsp;i&nbsp;<BR>inner&nbsp;join&nbsp;sysindexkeys&nbsp;k&nbsp;on&nbsp;i.id=k.id&nbsp;and&nbsp;k.indid=i.indid<BR>inner&nbsp;join&nbsp;sysobjects&nbsp;o&nbsp;on&nbsp;o.parent_obj=i.id&nbsp;and&nbsp;o.name=i.name&nbsp;and&nbsp;o.xtype='PK'<BR>where&nbsp;i.id=@TableId<BR>&nbsp;<BR>if&nbsp;@@ROWCOUNT&lt;&gt;1&nbsp;<BR>begin<BR>&nbsp;&nbsp;raiserror('SQL-UNDO&nbsp;error.&nbsp;Violation&nbsp;of&nbsp;PK&nbsp;condition.&nbsp;PK&nbsp;must&nbsp;present&nbsp;and&nbsp;PK&nbsp;must&nbsp;have&nbsp;only&nbsp;one&nbsp;column',16,-1)<BR>&nbsp;&nbsp;return<BR>end<BR>&nbsp;<BR>&nbsp;<BR>--Saving&nbsp;of&nbsp;rows-info<BR>&nbsp;<BR>create&nbsp;table&nbsp;#rinfo&nbsp;(PKvalue&nbsp;sql_variant&nbsp;not&nbsp;null,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IdRowInfo&nbsp;bigint&nbsp;null)<BR>set&nbsp;@dynsql='insert&nbsp;into&nbsp;#rinfo&nbsp;(PKvalue)&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'select&nbsp;distinct&nbsp;i.['+@PKname+']&nbsp;from&nbsp;#SU03it&nbsp;i&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'union&nbsp;select&nbsp;distinct&nbsp;d.['+@PKname+']&nbsp;from&nbsp;#SU03dt&nbsp;d&nbsp;'<BR>exec&nbsp;sp_executesql&nbsp;@dynsql<BR>&nbsp;&nbsp;<BR>insert&nbsp;into&nbsp;SURowsInfo&nbsp;(IdAction,&nbsp;PKvalue)&nbsp;<BR>&nbsp;&nbsp;select&nbsp;@IdAction,&nbsp;PKvalue&nbsp;from&nbsp;#rinfo<BR>&nbsp;<BR>update&nbsp;t&nbsp;set&nbsp;IdRowInfo=r.Id<BR>from&nbsp;#rinfo&nbsp;t<BR>inner&nbsp;join&nbsp;SURowsInfo&nbsp;r&nbsp;on&nbsp;r.IdAction=@IdAction&nbsp;and&nbsp;t.PKvalue=r.PKvalue<BR>&nbsp;<BR>&nbsp;<BR>if&nbsp;@TypeAction&nbsp;in&nbsp;(2,3)&nbsp;<BR>--&nbsp;By&nbsp;INSERT,&nbsp;we&nbsp;don't&nbsp;save&nbsp;the&nbsp;fields'&nbsp;values,<BR>--&nbsp;because&nbsp;UNDO-action&nbsp;will&nbsp;be&nbsp;"delete&nbsp;from&nbsp;Table&nbsp;where&nbsp;PK=@PK"<BR>--&nbsp;and&nbsp;the&nbsp;fields'&nbsp;values&nbsp;are&nbsp;not&nbsp;required&nbsp;for&nbsp;it.<BR>begin<BR>&nbsp;<BR>--&nbsp;Loop&nbsp;of&nbsp;saving&nbsp;the&nbsp;fields'&nbsp;values&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;create&nbsp;table&nbsp;#cinfo&nbsp;(IdRowInfo&nbsp;bigint&nbsp;not&nbsp;null,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColumnId&nbsp;smallint&nbsp;not&nbsp;null,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Oldvalue&nbsp;sql_variant&nbsp;null)<BR>&nbsp;&nbsp;declare&nbsp;VALS_CR&nbsp;cursor&nbsp;local&nbsp;fast_forward&nbsp;for<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;c.colid,&nbsp;c.name&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;syscolumns&nbsp;c&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;c.id=@TableId&nbsp;and&nbsp;c.name&lt;&gt;@PKname&nbsp;and&nbsp;c.xtype&lt;&gt;189/*timestamp*/&nbsp;and&nbsp;c.iscomputed=0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order&nbsp;by&nbsp;1<BR>&nbsp;&nbsp;open&nbsp;VALS_CR<BR>&nbsp;&nbsp;fetch&nbsp;VALS_CR&nbsp;into&nbsp;@ColId,&nbsp;@ColName<BR>&nbsp;&nbsp;while&nbsp;@@FETCH_STATUS=0<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@TypeAction=2&nbsp;--was&nbsp;DELETE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'insert&nbsp;into&nbsp;#cinfo&nbsp;(IdRowInfo,&nbsp;ColumnId,&nbsp;Oldvalue)&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'select&nbsp;r.IdRowInfo,'+cast(@ColId&nbsp;as&nbsp;NVARCHAR)+',d.['+@ColName+']&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'from&nbsp;#SU03dt&nbsp;d&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'inner&nbsp;join&nbsp;#rinfo&nbsp;r&nbsp;on&nbsp;r.PKvalue=d.['+@PKname+']&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'where&nbsp;d.['+@ColName+']&nbsp;is&nbsp;not&nbsp;NULL&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;@TypeAction=3&nbsp;--was&nbsp;UPDATE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'insert&nbsp;into&nbsp;#cinfo&nbsp;(IdRowInfo,&nbsp;ColumnId,&nbsp;Oldvalue)&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'select&nbsp;r.IdRowInfo,'+cast(@ColId&nbsp;as&nbsp;NVARCHAR)+',d.['+@ColName+']&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'from&nbsp;#SU03dt&nbsp;d&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'inner&nbsp;join&nbsp;#SU03it&nbsp;i&nbsp;on&nbsp;i.['+@PKname+']=d.['+@PKname+']&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'inner&nbsp;join&nbsp;#rinfo&nbsp;r&nbsp;on&nbsp;r.PKvalue=d.['+@PKname+']&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'where&nbsp;(d.['+@ColName+']&nbsp;is&nbsp;not&nbsp;NULL&nbsp;&nbsp;or&nbsp;&nbsp;i.['+@ColName+']&nbsp;is&nbsp;not&nbsp;NULL)&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+'and&nbsp;(d.['+@ColName+']&lt;&gt;i.['+@ColName+']&nbsp;or&nbsp;i.['+@ColName+']&nbsp;is&nbsp;NULL&nbsp;or&nbsp;d.['+@ColName+']&nbsp;is&nbsp;NULL)&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;sp_executesql&nbsp;@dynsql&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;fetch&nbsp;VALS_CR&nbsp;into&nbsp;@ColId,&nbsp;@ColName<BR>&nbsp;&nbsp;end<BR>&nbsp;&nbsp;close&nbsp;VALS_CR<BR>&nbsp;&nbsp;deallocate&nbsp;VALS_CR<BR>&nbsp;<BR>&nbsp;&nbsp;insert&nbsp;into&nbsp;SUColsInfo&nbsp;(IdRowInfo,&nbsp;ColumnId,&nbsp;Oldvalue)<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;IdRowInfo,&nbsp;ColumnId,&nbsp;Oldvalue<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;#cinfo<BR>&nbsp;&nbsp;&nbsp;&nbsp;order&nbsp;by&nbsp;1,2<BR>&nbsp;<BR>end&nbsp;--&nbsp;of&nbsp;"if&nbsp;@TypeAction..."<BR>&nbsp;<BR>&nbsp;<BR>--&nbsp;Restore&nbsp;@@IDENTITY&nbsp;value<BR>&nbsp;<BR>set&nbsp;@dynsql='select&nbsp;identity(decimal(38,0),'+cast(@SaveIdentity&nbsp;as&nbsp;nvarchar)+',1)&nbsp;Id&nbsp;into&nbsp;#tmpident'<BR>exec&nbsp;sp_executesql&nbsp;@dynsql<BR>&nbsp;<BR>&nbsp;&nbsp;<BR>--&nbsp;Some&nbsp;maintenance&nbsp;and&nbsp;optimization<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;--&nbsp;This&nbsp;code&nbsp;may&nbsp;be&nbsp;transfered&nbsp;to&nbsp;a&nbsp;scheduler&nbsp;and&nbsp;executed&nbsp;once&nbsp;a&nbsp;day<BR>&nbsp;&nbsp;--&nbsp;For&nbsp;it,&nbsp;kill&nbsp;the&nbsp;row&nbsp;"and&nbsp;a1.TranID&lt;&gt;@TranID"<BR>&nbsp;<BR>update&nbsp;SUActions&nbsp;with&nbsp;(rowlock)&nbsp;set&nbsp;TranID=NULL<BR>from&nbsp;SUActions<BR>where&nbsp;Id&nbsp;in&nbsp;(select&nbsp;a1.Id&nbsp;from&nbsp;SUActions&nbsp;a1&nbsp;with&nbsp;(READPAST)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;a1.TranID&nbsp;is&nbsp;not&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;a1.TranID&lt;&gt;@TranID<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;a1.RegDate&lt;GETDATE()-0.05<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;not&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;SUActions&nbsp;a2&nbsp;with&nbsp;(READPAST)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;a2.TranID=a1.TranID<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;a2.Id&lt;&gt;a1.Id))<BR>&nbsp;<BR>RETURN&nbsp;0<BR>GO<BR>/*************************************************************************/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Library&nbsp;SQL-UNDO&nbsp;3.0&nbsp;for&nbsp;MSSQL2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;(C)&nbsp;2002&nbsp;&nbsp;Gleb&nbsp;Oufimtsev&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gvu@newmail.ru,&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.gvu.newmail.ru" target=_blank>http://www.gvu.newmail.ru</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Moscow,&nbsp;Russia&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*************************************************************************/<BR>CREATE&nbsp;PROCEDURE&nbsp;dbo.spSUUndoTransaction&nbsp;@IdAction&nbsp;bigint&nbsp;AS<BR>&nbsp;<BR>declare&nbsp;<BR>&nbsp;&nbsp;@dynsql&nbsp;nvarchar(4000),&nbsp;@dyn1&nbsp;nvarchar(4000),&nbsp;@dyn2&nbsp;nvarchar(4000),<BR>&nbsp;&nbsp;@IdRowInfo&nbsp;bigint,<BR>&nbsp;&nbsp;@ActionType&nbsp;tinyint,<BR>&nbsp;&nbsp;@TableId&nbsp;int,&nbsp;@TableName&nbsp;sysname,&nbsp;<BR>&nbsp;&nbsp;@ColName&nbsp;sysname,&nbsp;@ColumnId&nbsp;smallint,&nbsp;@ColType&nbsp;sysname,<BR>&nbsp;&nbsp;@PKname&nbsp;sysname,&nbsp;@PKvalue&nbsp;sql_variant,&nbsp;@PKtype&nbsp;sysname<BR>&nbsp;<BR>set&nbsp;nocount&nbsp;on<BR>&nbsp;&nbsp;<BR>if&nbsp;IS_MEMBER('db_owner')=0<BR>&nbsp;&nbsp;&nbsp;and&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;SUActions&nbsp;a<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;SULogins&nbsp;l&nbsp;on&nbsp;a.IdLogin=l.Id<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;a.Id=@IdAction&nbsp;and&nbsp;l.Login&lt;&gt;SUSER_SNAME())<BR>begin<BR>&nbsp;&nbsp;raiserror('SQL-UNDO&nbsp;error.&nbsp;Only&nbsp;a&nbsp;member&nbsp;of&nbsp;"db_owner"&nbsp;or&nbsp;DBA&nbsp;can&nbsp;undo&nbsp;an&nbsp;action&nbsp;of&nbsp;another&nbsp;user',16,-1)<BR>&nbsp;&nbsp;goto&nbsp;EXIT_WITH_ERROR<BR>end<BR>&nbsp;<BR>SET&nbsp;XACT_ABORT&nbsp;ON<BR>SET&nbsp;TRANSACTION&nbsp;ISOLATION&nbsp;LEVEL&nbsp;REPEATABLE&nbsp;READ<BR>BEGIN&nbsp;TRAN<BR>&nbsp;<BR>&nbsp;&nbsp;declare&nbsp;ACNSCR&nbsp;cursor&nbsp;local&nbsp;fast_forward&nbsp;for<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;distinct&nbsp;a.Id,&nbsp;a.ActionType,&nbsp;a.TableId,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N'['+USER_NAME(ot.uid)+N'].['+ot.name+N']'&nbsp;TableName,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N'['+COL_NAME(a.TableId,&nbsp;k.colid)+N']'&nbsp;PKname,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.name&nbsp;PKtype<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;SUActions&nbsp;a<BR>&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;SUActions&nbsp;a0&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;((a0.TranID&nbsp;is&nbsp;not&nbsp;NULL&nbsp;and&nbsp;a0.TranID=a.TranID)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;(a0.TranID&nbsp;is&nbsp;NULL&nbsp;and&nbsp;a0.Id=a.Id))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;a0.Id=@IdAction<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;(a.RegDate-a0.RegDate)&nbsp;between&nbsp;'18991231'&nbsp;and&nbsp;'19000102'&nbsp;--&nbsp;just&nbsp;in&nbsp;case<BR>&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;sysindexes&nbsp;i&nbsp;on&nbsp;i.id=a.TableId<BR>&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;sysindexkeys&nbsp;k&nbsp;on&nbsp;i.id=k.id&nbsp;and&nbsp;k.indid=i.indid<BR>&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;sysobjects&nbsp;o&nbsp;on&nbsp;o.parent_obj=i.id&nbsp;and&nbsp;o.name=i.name&nbsp;and&nbsp;o.xtype='PK'<BR>&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;sysobjects&nbsp;ot&nbsp;on&nbsp;a.TableId=ot.id<BR>&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;syscolumns&nbsp;sc&nbsp;on&nbsp;sc.id=a.TableId&nbsp;and&nbsp;sc.colid=k.colid<BR>&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;systypes&nbsp;t&nbsp;on&nbsp;sc.xtype=t.xtype<BR>&nbsp;&nbsp;&nbsp;&nbsp;order&nbsp;by&nbsp;1&nbsp;desc<BR>&nbsp;&nbsp;open&nbsp;ACNSCR<BR>&nbsp;&nbsp;fetch&nbsp;ACNSCR&nbsp;into&nbsp;@IdAction,&nbsp;@ActionType,&nbsp;@TableId,&nbsp;@TableName,&nbsp;@PKname,&nbsp;@PKtype<BR>&nbsp;&nbsp;while&nbsp;@@FETCH_STATUS=0<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;SURowsInfo&nbsp;r<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;SUActions&nbsp;a&nbsp;on&nbsp;r.IdAction=a.Id<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;r.IdAction=@IdAction<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;(a.ActionType=1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;SUColsInfo&nbsp;where&nbsp;IdRowInfo=r.Id)))<BR>&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raiserror('SQL-UNDO&nbsp;error.&nbsp;Data&nbsp;for&nbsp;undoing&nbsp;are&nbsp;not&nbsp;enough.&nbsp;Check&nbsp;content&nbsp;in&nbsp;tables&nbsp;"SURowsInfo"&nbsp;and&nbsp;"SUColsInfo"',16,-1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;EXIT_WITH_ERROR<BR>&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;SURowsInfo&nbsp;r1&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;SUActions&nbsp;a1&nbsp;on&nbsp;r1.IdAction=a1.Id&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;SURowsInfo&nbsp;r2&nbsp;on&nbsp;r1.PKvalue=r2.PKvalue&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;SUActions&nbsp;a2&nbsp;on&nbsp;r2.IdAction=a2.Id&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;a1.TableId=a2.TableId&nbsp;and&nbsp;a1.Id=@IdAction&nbsp;and&nbsp;a2.Id&gt;a1.Id)<BR>&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raiserror('SQL-UNDO&nbsp;error.&nbsp;Attempt&nbsp;to&nbsp;restore&nbsp;a&nbsp;row&nbsp;that&nbsp;was&nbsp;changed&nbsp;after&nbsp;the&nbsp;action',16,-1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;EXIT_WITH_ERROR<BR>&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@IdAction&nbsp;IdAction,&nbsp;Id&nbsp;IdRowInfo,&nbsp;PKvalue&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;into&nbsp;#sql_undo_30_keys&nbsp;from&nbsp;SURowsInfo&nbsp;where&nbsp;IdAction=@IdAction&nbsp;&nbsp;&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;table&nbsp;#v&nbsp;(R&nbsp;bigint&nbsp;not&nbsp;NULL,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;V&nbsp;sql_variant&nbsp;NULL,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;smallint&nbsp;not&nbsp;NULL)<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@ActionType=1&nbsp;--&nbsp;Was:&nbsp;INSERT.&nbsp;&nbsp;UNDO-action:&nbsp;DELETE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=N'delete&nbsp;from&nbsp;'+@TableName+N'&nbsp;where&nbsp;'+@PKName+N'&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+N'&nbsp;in&nbsp;(select&nbsp;PKvalue&nbsp;from&nbsp;#sql_undo_30_keys)&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert&nbsp;into&nbsp;#v&nbsp;(R,&nbsp;V,&nbsp;C)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;c.IdRowInfo,&nbsp;Oldvalue,&nbsp;c.ColumnId<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;SUColsInfo&nbsp;c<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;SURowsInfo&nbsp;r&nbsp;on&nbsp;c.IdRowInfo=r.Id<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;SUActions&nbsp;a&nbsp;on&nbsp;r.IdAction=a.Id<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;r.IdAction=@IdAction<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=N''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dyn1=N''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dyn2=N''<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@ActionType=2&nbsp;--&nbsp;Was:&nbsp;DELETE.&nbsp;&nbsp;UNDO-action:&nbsp;INSERT<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;syscolumns&nbsp;where&nbsp;id=@TableId&nbsp;and&nbsp;status&amp;0x80=0x80)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=@dynsql+N'set&nbsp;identity_insert&nbsp;'+@TableName+N'&nbsp;on'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=@dynsql+N'insert&nbsp;into&nbsp;'+@TableName+N'&nbsp;('+@PKname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;--&nbsp;@ActionType=3&nbsp;&nbsp;Was:&nbsp;UPDATE.&nbsp;&nbsp;UNDO-action:&nbsp;UPDATE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=N'update&nbsp;trg&nbsp;set'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;COLSCR&nbsp;cursor&nbsp;local&nbsp;fast_forward&nbsp;for<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;distinct&nbsp;N'['+COL_NAME(@TableId,&nbsp;C)+N']',&nbsp;C,&nbsp;t.name&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;#v&nbsp;v&nbsp;inner&nbsp;join&nbsp;syscolumns&nbsp;c&nbsp;on&nbsp;c.id=@TableId&nbsp;and&nbsp;c.colid=v.C<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;systypes&nbsp;t&nbsp;on&nbsp;c.xtype=t.xusertype<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;open&nbsp;COLSCR<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fetch&nbsp;COLSCR&nbsp;into&nbsp;@ColName,&nbsp;@ColumnId,&nbsp;@ColType<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;@@FETCH_STATUS=0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@ActionType=2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dyn1=@dyn1+N','+@ColName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dyn2=@dyn2+N','+NCHAR(10)+N'&nbsp;&nbsp;&nbsp;(select&nbsp;CAST(V&nbsp;as&nbsp;'+@ColType+N')&nbsp;from&nbsp;#v&nbsp;where&nbsp;R=k.IdRowInfo&nbsp;and&nbsp;C='+CAST(@ColumnId&nbsp;as&nbsp;NVARCHAR)+N')'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=@dynsql+N'&nbsp;&nbsp;&nbsp;'+@ColName+N'=(CASE&nbsp;WHEN&nbsp;(select&nbsp;count(*)&nbsp;from&nbsp;#v&nbsp;where&nbsp;R=k.IdRowInfo&nbsp;and&nbsp;C='+CAST(@ColumnId&nbsp;as&nbsp;NVARCHAR)+N')=0&nbsp;THEN&nbsp;trg.'+@ColName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+N'&nbsp;ELSE&nbsp;(select&nbsp;CAST(V&nbsp;as&nbsp;'+@ColType+N')&nbsp;from&nbsp;#v&nbsp;where&nbsp;R=k.IdRowInfo&nbsp;and&nbsp;C='+CAST(@ColumnId&nbsp;as&nbsp;NVARCHAR)+N')&nbsp;END),'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fetch&nbsp;COLSCR&nbsp;into&nbsp;@ColName,&nbsp;@ColumnId,&nbsp;@ColType<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close&nbsp;COLSCR&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deallocate&nbsp;COLSCR<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@ActionType=2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=@dynsql+@dyn1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+N')'+NCHAR(10)+N'select&nbsp;CAST(k.PKvalue&nbsp;as&nbsp;'+@PKtype+N')'+@dyn2+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+N'from&nbsp;#sql_undo_30_keys&nbsp;k'+NCHAR(10)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;syscolumns&nbsp;where&nbsp;id=@TableId&nbsp;and&nbsp;status&amp;0x80=0x80)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=@dynsql+N'set&nbsp;identity_insert&nbsp;'+@TableName+N'&nbsp;off&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dynsql=SUBSTRING(@dynsql,1,LEN(@dynsql)-2)+CHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+N'from&nbsp;'+@TableName+'&nbsp;trg'+NCHAR(10)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+N'inner&nbsp;join&nbsp;#sql_undo_30_keys&nbsp;k&nbsp;on&nbsp;k.PKvalue=trg.'+@PKname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;sp_executesql&nbsp;@dynsql<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@@ERROR&lt;&gt;0&nbsp;GOTO&nbsp;EXIT_WITH_ERROR<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;delete&nbsp;from&nbsp;SUColsInfo&nbsp;where&nbsp;IdRowInfo&nbsp;in<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(select&nbsp;Id&nbsp;from&nbsp;SURowsInfo&nbsp;where&nbsp;IdAction=@IdAction)<BR>&nbsp;&nbsp;&nbsp;&nbsp;delete&nbsp;from&nbsp;SURowsInfo&nbsp;where&nbsp;IdAction=@IdAction&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;delete&nbsp;from&nbsp;SUActions&nbsp;where&nbsp;Id=@IdAction&nbsp;<BR>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;table&nbsp;#v<BR>&nbsp;&nbsp;&nbsp;&nbsp;drop&nbsp;table&nbsp;#sql_undo_30_keys<BR>&nbsp;&nbsp;&nbsp;&nbsp;fetch&nbsp;ACNSCR&nbsp;into&nbsp;@IdAction,&nbsp;@ActionType,&nbsp;@TableId,&nbsp;@TableName,&nbsp;@PKname,&nbsp;@PKtype<BR>&nbsp;&nbsp;end<BR>&nbsp;&nbsp;close&nbsp;ACNSCR<BR>&nbsp;&nbsp;deallocate&nbsp;ACNSCR<BR>&nbsp;<BR>COMMIT<BR>&nbsp;<BR>EXIT_WITH_ERROR:<BR>&nbsp;&nbsp;if&nbsp;@@TRANCOUNT&gt;0&nbsp;ROLLBACK<BR>&nbsp;&nbsp;RETURN<BR>GO<BR>/*************************************************************************/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Library&nbsp;SQL-UNDO&nbsp;3.0&nbsp;for&nbsp;MSSQL2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;(C)&nbsp;2002&nbsp;&nbsp;Gleb&nbsp;Oufimtsev&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gvu@newmail.ru,&nbsp;<IMG src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.gvu.newmail.ru" target=_blank>http://www.gvu.newmail.ru</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;<BR>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Moscow,&nbsp;Russia&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*************************************************************************/<BR>CREATE&nbsp;PROCEDURE&nbsp;dbo.spSUUndoLastOwnTransaction&nbsp;AS<BR>&nbsp;<BR>set&nbsp;nocount&nbsp;on<BR>&nbsp;<BR>declare&nbsp;@IdAction&nbsp;bigint<BR>&nbsp;<BR>select&nbsp;@IdAction=max(a.Id)&nbsp;<BR>from&nbsp;SUActions&nbsp;a&nbsp;(READPAST)<BR>inner&nbsp;join&nbsp;SULogins&nbsp;l&nbsp;on&nbsp;a.IdLogin=l.Id&nbsp;and&nbsp;l.Login=SUSER_SNAME()<BR>&nbsp;<BR>if&nbsp;@IdAction&nbsp;is&nbsp;not&nbsp;NULL<BR>&nbsp;&nbsp;exec&nbsp;spSUUndoTransaction&nbsp;@IdAction<BR>else<BR>&nbsp;&nbsp;raiserror('SQL-UNDO&nbsp;error.&nbsp;There&nbsp;isn''t&nbsp;such&nbsp;transactions&nbsp;for&nbsp;undoing',16,-1)<BR>&nbsp;<BR>return<BR>GO<BR>GRANT&nbsp;EXECUTE&nbsp;ON&nbsp;dbo.spSUUndoTransaction&nbsp;TO&nbsp;public<BR>GRANT&nbsp;EXECUTE&nbsp;ON&nbsp;dbo.spSUUndoLastOwnTransaction&nbsp;TO&nbsp;public<BR>GRANT&nbsp;EXECUTE&nbsp;ON&nbsp;dbo.spSUSaveActions&nbsp;TO&nbsp;public<BR>GO
<P></P>
<P></FONT></P></BLOCKQUOTE></TD></TR>
<TR>
<TD class=tablebody1 vAlign=center align=middle width=175><A href="http://www.pigtwo.com/forum/look_ip.asp?boardid=14&amp;userid=42&amp;ip=61.48.16.123&amp;action=lookip" target=_blank><IMG height=15 alt="点击查看用户来源及管理<br>发贴IP：61.48.16.123" src="http://www.pigtwo.com/forum/pic/ip.gif" width=13 align=absMiddle border=0></A> 2003-6-5 12:02:53</TD>
<TD class=tablebody1 vAlign=center width=*>
<TABLE cellSpacing=0 cellPadding=0 width="100%">
<TBODY>
<TR>
<TD vAlign=center align=left><A href="http://www.pigtwo.com/forum/editannounce.asp?BoardID=14&amp;replyID=1048&amp;id=495&amp;star=1"><IMG alt=编辑这个贴子 src="http://www.pigtwo.com/forum/pic/edit.gif" align=absMiddle border=0></A></TD>
<TD vAlign=bottom align=right width=110 nowarp><A title=注意：本操作将删除单个贴子 href="http://www.pigtwo.com/forum/admin_postings.asp?action=删除跟帖&amp;BoardID=14&amp;ID=495&amp;replyID=1048&amp;userid=42"><IMG src="http://www.pigtwo.com/forum/pic/delete.gif" border=0></A>&nbsp;<A title=复制单个贴子到别的版面 href="http://www.pigtwo.com/forum/admin_postings.asp?action=复制&amp;BoardID=14&amp;ID=495&amp;replyID=1048"><IMG src="http://www.pigtwo.com/forum/pic/copy.gif" border=0></A>&nbsp;<A title=精华 href="http://www.pigtwo.com/forum/admin_postings.asp?action=精华&amp;BoardID=14&amp;ID=495&amp;replyID=1048"><IMG src="http://www.pigtwo.com/forum/pic/jing.gif" border=0></A></TD>
<TD vAlign=bottom align=right width=4></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE><BR>
<TABLE cellSpacing=3 cellPadding=0 width="97%" align=center border=0>
<TBODY>
<TR>
<TD vAlign=center noWrap>本主题贴数<B>3</B>，分页： <FONT color=#ff0000>[1]</FONT></TD>
<TD vAlign=center noWrap align=right><SELECT onchange="if(this.options[this.selectedIndex].value!=''){location=this.options[this.selectedIndex].value;}"><OPTION selected>跳转论坛至...</OPTION><OPTION>╋ 技术论坛</OPTION><OPTION value=list.asp?boardid=11>　├『 JAVA 专区』</OPTION><OPTION value=list.asp?boardid=12>　├『 C / C ++ 』</OPTION><OPTION value=list.asp?boardid=13>　├『Delphi编程』</OPTION><OPTION value=list.asp?boardid=14>　├『数 据 库』</OPTION><OPTION value=list.asp?boardid=15>　├『综合技术』</OPTION><OPTION>╋ 休闲娱乐</OPTION><OPTION value=list.asp?boardid=21>　├『天天澡堂』</OPTION><OPTION value=list.asp?boardid=22>　├『随意贴图』</OPTION><OPTION value=list.asp?boardid=24>　├『关注社会』</OPTION><OPTION>╋ 站务处理</OPTION><OPTION value=list.asp?boardid=23>　├『站务处理』</OPTION></SELECT></TD></TR></TBODY></TABLE>
<TABLE class=tableborder1 cellSpacing=1 cellPadding=1 align=center>
<TBODY>
<TR>
<TH vAlign=center align=left width="100%" colSpan=2 height=25>&nbsp;*快速回复：UNDO&nbsp;Committed&nbsp;Transactions</TH></TR>
<FORM name=frmAnnounce onsubmit=submitonce(this) action=SaveReAnnounce.asp?method=fastreply&amp;BoardID=14 method=post><INPUT type=hidden value=1046 name=followup> <INPUT type=hidden value=495 name=RootID> <INPUT type=hidden value=1 name=star> <INPUT type=hidden value=bbs1 name=TotalUseTable> 
<TR>
<TD class=tablebody2 noWrap width=175><B>你的用户名:</B></TD>
<TD class=tablebody2 height=30><INPUT maxLength=25 size=23 value=ugvanxk name=UserName> &nbsp;&nbsp; <A href="http://www.pigtwo.com/forum/reg.asp">还没注册?</A> &nbsp;&nbsp; <B>密码:</B> <INPUT type=password maxLength=20 size=23 value="" name=passwd> &nbsp;&nbsp; <A href="http://www.pigtwo.com/forum/lostpass.asp">忘记密码?</A></TD></TR>
<TR>
<TD class=tablebody1 vAlign=top noWrap><B>内容</B><BR>
<LI>HTML标签： 不可用 
<LI>UBB标签： 可用 
<LI>贴图标签： 可用 
<LI>Flash标签：可用 
<LI>表情字符转换：可用 
<LI>上传图片：可用 
<LI>最多16KB </LI></TD>
<TD class=tablebody1><TEXTAREA onkeydown="" title=可以使用Ctrl+Enter直接提交贴子 name=Content rows=7 wrap=VIRTUAL cols=100></TEXTAREA> </TD></TR>
<TR bgColor=#ba0000 #FFFFFF;>
<TD class=tablebody2 noWrap height=30><INPUT type=checkbox value=yes name=Forum_Setting(2)> 邮件回复 <INPUT type=checkbox CHECKED value=yes name=signflag> 显示签名 </TD>
<TD class=tablebody2 width="100%"><INPUT type=submit value=OK!发表我的回应帖子 name=Submit> &nbsp;<INPUT onclick="" type=button value="预 览" name=Button>&nbsp;<INPUT type=reset value=清空内容！ name=Clear>[Ctrl+Enter直接提交贴子] </TD></TR></FORM></TBODY></TABLE><BR>
<TABLE cellSpacing=0 cellPadding=0 width="97%" align=center border=0>
<TBODY>
<TR vAlign=center>
<TD align=right width="100%"><A title=锁定本主题 href="http://www.pigtwo.com/forum/admin_postings.asp?action=锁定&amp;BoardID=14&amp;ID=495">锁定</A> | <A title=将本主题解开锁定 href="http://www.pigtwo.com/forum/admin_postings.asp?action=解锁&amp;BoardID=14&amp;ID=495">解锁</A> | <A title=注意：本操作将删除本主题所有贴子，不能恢复 href="http://www.pigtwo.com/forum/admin_postings.asp?action=删除主题&amp;BoardID=14&amp;ID=495">删除</A> | <A title=移动主题 href="http://www.pigtwo.com/forum/admin_postings.asp?action=移动&amp;BoardID=14&amp;ID=495&amp;replyID=1046">移动</A> | <A title=将本主题固顶 href="http://www.pigtwo.com/forum/admin_postings.asp?action=固顶&amp;BoardID=14&amp;ID=495">固顶</A> | <A title=对发起主题用户奖励 href="http://www.pigtwo.com/forum/admin_postings.asp?action=奖励&amp;BoardID=14&amp;ID=495">奖励</A> | <A title=对发起主题用户惩罚 href="http://www.pigtwo.com/forum/admin_postings.asp?action=惩罚&amp;BoardID=14&amp;ID=495">惩罚</A> | <A href="http://www.pigtwo.com/forum/announcements.asp?BoardID=14&amp;action=AddAnn">发布公告</A> </TD></TR></TBODY></TABLE>
<FORM name=preview action=preview.asp method=post target=preview_page><INPUT type=hidden name=title><INPUT type=hidden name=body> </FORM>




<P>
<TABLE cellSpacing=0 cellPadding=0 width="97%" align=center border=0>
<TBODY>
<TR>
<TD align=middle><A href="http://www.pigtwo.com/index.htm" target=_blank><IMG src="http://www.pigtwo.com/forum/pic/logo_2.gif"></IMG></A> </TD></TR>
<TR>
<TD align=middle>Powered by：<A href="http://www.dvbbs.net/download.asp">DVBBS Ver5.0 Final</A><BR>Copyright ?2002 - 2003 <A href="http://www.pigtwo.com"><FONT face=Verdana, size=1 sans-serif Helvetica, Arial,><B>pigtwo<FONT color=#cc0000>.com</FONT></B></FONT></A> , 页面执行时间：1,437.500毫秒 </TD></TR></TBODY></TABLE></P></BODY>