<meta http-equiv="content-type" content="text/html; charset=gb2312">作者&nbsp;几回魂梦
<P></P>
<P>前几天也碰到日志文件过大的问题，数据库实际大小为600M,&nbsp;日志文件实际大小为33M,&nbsp;但日志文件占用空间为2.8G!!!<BR>试了多种方式，SHIRNK&nbsp;DATABASE，&nbsp;TRUNCATE&nbsp;LOG&nbsp;FILE,&nbsp;都没办法将文件缩小。无论如何，这应该算SQL&nbsp;SERVER的一个BUG吧。</P>
<P>后来找到下面的代码，就可以将日志文件缩小到自己想要的大小了。把代码COPY到查询分析器里，，然后修改其中的3个参数(数据库名，日志文件名，和目标日志文件的大小)，运行即可(我已经用过多次了)<BR>-----<BR>SET&nbsp;NOCOUNT&nbsp;ON<BR>DECLARE&nbsp;@LogicalFileName&nbsp;sysname,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@MaxMinutes&nbsp;INT,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@NewSize&nbsp;INT</P>
<P><BR>USE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marias&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;要操作的数据库名<BR>SELECT&nbsp;&nbsp;@LogicalFileName&nbsp;=&nbsp;'Marias_log',&nbsp;&nbsp;--&nbsp;日志文件名<BR>@MaxMinutes&nbsp;=&nbsp;10,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;Limit&nbsp;on&nbsp;time&nbsp;allowed&nbsp;to&nbsp;wrap&nbsp;log.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@NewSize&nbsp;=&nbsp;100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;你想设定的日志文件的大小(M)</P>
<P>--&nbsp;Setup&nbsp;/&nbsp;initialize<BR>DECLARE&nbsp;@OriginalSize&nbsp;int<BR>SELECT&nbsp;@OriginalSize&nbsp;=&nbsp;size&nbsp;<BR>&nbsp;&nbsp;FROM&nbsp;sysfiles<BR>&nbsp;&nbsp;WHERE&nbsp;name&nbsp;=&nbsp;@LogicalFileName<BR>SELECT&nbsp;'Original&nbsp;Size&nbsp;of&nbsp;'&nbsp;+&nbsp;db_name()&nbsp;+&nbsp;'&nbsp;LOG&nbsp;is&nbsp;'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONVERT(VARCHAR(30),@OriginalSize)&nbsp;+&nbsp;'&nbsp;8K&nbsp;pages&nbsp;or&nbsp;'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONVERT(VARCHAR(30),(@OriginalSize*8/1024))&nbsp;+&nbsp;'MB'<BR>&nbsp;&nbsp;FROM&nbsp;sysfiles<BR>&nbsp;&nbsp;WHERE&nbsp;name&nbsp;=&nbsp;@LogicalFileName<BR>CREATE&nbsp;TABLE&nbsp;DummyTrans<BR>&nbsp;&nbsp;(DummyColumn&nbsp;char&nbsp;(8000)&nbsp;not&nbsp;null)</P>
<P><BR>DECLARE&nbsp;@Counter&nbsp;&nbsp;&nbsp;INT,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@StartTime&nbsp;DATETIME,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@TruncLog&nbsp;&nbsp;VARCHAR(255)<BR>SELECT&nbsp;&nbsp;@StartTime&nbsp;=&nbsp;GETDATE(),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@TruncLog&nbsp;=&nbsp;'BACKUP&nbsp;LOG&nbsp;'&nbsp;+&nbsp;db_name()&nbsp;+&nbsp;'&nbsp;WITH&nbsp;TRUNCATE_ONLY'</P>
<P>DBCC&nbsp;SHRINKFILE&nbsp;(@LogicalFileName,&nbsp;@NewSize)<BR>EXEC&nbsp;(@TruncLog)<BR>--&nbsp;Wrap&nbsp;the&nbsp;log&nbsp;if&nbsp;necessary.<BR>WHILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@MaxMinutes&nbsp;&gt;&nbsp;DATEDIFF&nbsp;(mi,&nbsp;@StartTime,&nbsp;GETDATE())&nbsp;--&nbsp;time&nbsp;has&nbsp;not&nbsp;expired<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;@OriginalSize&nbsp;=&nbsp;(SELECT&nbsp;size&nbsp;FROM&nbsp;sysfiles&nbsp;WHERE&nbsp;name&nbsp;=&nbsp;@LogicalFileName)&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;(@OriginalSize&nbsp;*&nbsp;8&nbsp;/1024)&nbsp;&gt;&nbsp;@NewSize&nbsp;&nbsp;<BR>&nbsp;&nbsp;BEGIN&nbsp;--&nbsp;Outer&nbsp;loop.<BR>&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;@Counter&nbsp;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;&nbsp;WHILE&nbsp;&nbsp;((@Counter&nbsp;&lt;&nbsp;@OriginalSize&nbsp;/&nbsp;16)&nbsp;AND&nbsp;(@Counter&nbsp;&lt;&nbsp;50000))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;--&nbsp;update<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT&nbsp;DummyTrans&nbsp;valueS&nbsp;('Fill&nbsp;Log')&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;DummyTrans<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;@Counter&nbsp;=&nbsp;@Counter&nbsp;+&nbsp;1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;EXEC&nbsp;(@TruncLog)&nbsp;&nbsp;<BR>&nbsp;&nbsp;END&nbsp;&nbsp;&nbsp;<BR>SELECT&nbsp;'Final&nbsp;Size&nbsp;of&nbsp;'&nbsp;+&nbsp;db_name()&nbsp;+&nbsp;'&nbsp;LOG&nbsp;is&nbsp;'&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONVERT(VARCHAR(30),size)&nbsp;+&nbsp;'&nbsp;8K&nbsp;pages&nbsp;or&nbsp;'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONVERT(VARCHAR(30),(size*8/1024))&nbsp;+&nbsp;'MB'<BR>&nbsp;&nbsp;FROM&nbsp;sysfiles&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;name&nbsp;=&nbsp;@LogicalFileName<BR>DROP&nbsp;TABLE&nbsp;DummyTrans<BR>SET&nbsp;NOCOUNT&nbsp;OFF</P>