<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>RC4&nbsp;Encryption/Decryption</B><BR>Script&nbsp;to&nbsp;Perform&nbsp;RC4&nbsp;Encryption/Decryption
<P></P>
<P></P>
<P><BR>This&nbsp;stored&nbsp;procedure&nbsp;will&nbsp;perform&nbsp;RC4&nbsp;encryption/decryption&nbsp;on&nbsp;strings&nbsp;up&nbsp;to&nbsp;255&nbsp;characters&nbsp;in&nbsp;length.&nbsp;The&nbsp;procedure&nbsp;works&nbsp;as&nbsp;is&nbsp;on&nbsp;SQL&nbsp;7&nbsp;and&nbsp;2000;&nbsp;in&nbsp;order&nbsp;to&nbsp;run&nbsp;on&nbsp;SQL&nbsp;6.5,&nbsp;you&nbsp;will&nbsp;need&nbsp;to&nbsp;change&nbsp;the&nbsp;SET&nbsp;statements&nbsp;to&nbsp;SELECT&nbsp;statements.&nbsp;</P>
<P>Author:&nbsp;Brad&nbsp;Baker&nbsp;</P>
<P>/*<BR>&nbsp;*&nbsp;Name:<BR>&nbsp;*&nbsp;uspGetProductCode<BR>&nbsp;*<BR>&nbsp;*&nbsp;Purpose:<BR>&nbsp;*&nbsp;This&nbsp;procedure&nbsp;uses&nbsp;RC4&nbsp;to&nbsp;encrypt/decrypt&nbsp;the&nbsp;first&nbsp;parameter<BR>&nbsp;*&nbsp;&nbsp;using&nbsp;the&nbsp;second&nbsp;parameter&nbsp;in&nbsp;the&nbsp;encryption&nbsp;key.<BR>&nbsp;*<BR>&nbsp;*&nbsp;Input&nbsp;Parameters:<BR>&nbsp;*&nbsp;&nbsp;@product&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(255)&nbsp;-&nbsp;The&nbsp;string&nbsp;to&nbsp;be&nbsp;encrypted/decrypted.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;@productCode&nbsp;varchar(32)&nbsp;&nbsp;-&nbsp;The&nbsp;string&nbsp;key&nbsp;used&nbsp;to&nbsp;encrypt/decrypt.<BR>&nbsp;*<BR>&nbsp;*&nbsp;Output&nbsp;Parameters:<BR>&nbsp;*&nbsp;&nbsp;&nbsp;@productName&nbsp;varchar(255)&nbsp;-&nbsp;The&nbsp;encrypted/decrypted&nbsp;string.<BR>&nbsp;*<BR>&nbsp;*&nbsp;Returns:<BR>&nbsp;*&nbsp;&nbsp;none<BR>&nbsp;*<BR>&nbsp;*&nbsp;DependsOn:<BR>&nbsp;*&nbsp;none<BR>&nbsp;*<BR>&nbsp;*&nbsp;Calls:<BR>&nbsp;*&nbsp;none<BR>&nbsp;*<BR>&nbsp;*&nbsp;Effects:<BR>&nbsp;*&nbsp;none<BR>&nbsp;*<BR>&nbsp;*&nbsp;CalledBy:<BR>&nbsp;*&nbsp;n/a<BR>&nbsp;*<BR>&nbsp;*&nbsp;History:<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;Date&nbsp;&nbsp;&nbsp;Developer&nbsp;&nbsp;Description<BR>&nbsp;*&nbsp;-------------&nbsp;------------&nbsp;--------------------------------------<BR>&nbsp;*&nbsp;01/22/2002&nbsp;&nbsp;Brad&nbsp;Baker&nbsp;&nbsp;Created&nbsp;procedure.<BR>&nbsp;*<BR>&nbsp;*&nbsp;Notes:<BR>&nbsp;*&nbsp;&nbsp;1.&nbsp;RC4&nbsp;is&nbsp;a&nbsp;stream&nbsp;cipher&nbsp;symmetric&nbsp;key&nbsp;algorithm.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;was&nbsp;developed&nbsp;in&nbsp;1987&nbsp;by&nbsp;Ronald&nbsp;Rivest&nbsp;and&nbsp;kept&nbsp;as&nbsp;a&nbsp;trade&nbsp;secret&nbsp;by&nbsp;RSA&nbsp;Data&nbsp;Security.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;September&nbsp;9,&nbsp;1994,&nbsp;the&nbsp;RC4&nbsp;algorithm&nbsp;was&nbsp;anonymously&nbsp;posted&nbsp;on&nbsp;the&nbsp;Internet&nbsp;on&nbsp;the&nbsp;Cyperpunks?“anonymous&nbsp;remailers?list.&nbsp;<BR>&nbsp;*<BR>&nbsp;*&nbsp;&nbsp;2.&nbsp;RC4&nbsp;uses&nbsp;a&nbsp;variable&nbsp;length&nbsp;key&nbsp;from&nbsp;1&nbsp;to&nbsp;256&nbsp;bytes&nbsp;to&nbsp;initialize&nbsp;a&nbsp;256-byte&nbsp;state&nbsp;table.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;state&nbsp;table&nbsp;is&nbsp;used&nbsp;for&nbsp;subsequent&nbsp;generation&nbsp;of&nbsp;pseudo-random&nbsp;bytes&nbsp;and&nbsp;then&nbsp;to&nbsp;generate&nbsp;a&nbsp;pseudo-random&nbsp;stream&nbsp;which&nbsp;is&nbsp;XORed<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;plaintext&nbsp;to&nbsp;give&nbsp;the&nbsp;ciphertext.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Each&nbsp;element&nbsp;in&nbsp;the&nbsp;state&nbsp;table&nbsp;is&nbsp;swapped&nbsp;at&nbsp;least&nbsp;once.&nbsp;&nbsp;<BR>&nbsp;*<BR>&nbsp;*&nbsp;&nbsp;3.&nbsp;The&nbsp;RC4&nbsp;key&nbsp;is&nbsp;often&nbsp;limited&nbsp;to&nbsp;40&nbsp;bits,&nbsp;because&nbsp;of&nbsp;export&nbsp;restrictions&nbsp;but&nbsp;it&nbsp;is&nbsp;sometimes&nbsp;used&nbsp;as&nbsp;a&nbsp;128&nbsp;bit&nbsp;key.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;has&nbsp;the&nbsp;capability&nbsp;of&nbsp;using&nbsp;keys&nbsp;between&nbsp;1&nbsp;and&nbsp;2048&nbsp;bits.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RC4&nbsp;is&nbsp;used&nbsp;in&nbsp;many&nbsp;commercial&nbsp;software&nbsp;packages&nbsp;such&nbsp;as&nbsp;Lotus&nbsp;Notes&nbsp;and&nbsp;Oracle&nbsp;Secure&nbsp;SQL.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;is&nbsp;also&nbsp;part&nbsp;of&nbsp;the&nbsp;Cellular&nbsp;Specification.&nbsp;<BR>&nbsp;*<BR>&nbsp;*&nbsp;&nbsp;4.&nbsp;Procedure&nbsp;name&nbsp;and&nbsp;parameter&nbsp;names&nbsp;should&nbsp;be&nbsp;meaningless.<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Renaming&nbsp;this&nbsp;procedure&nbsp;RC4&nbsp;would&nbsp;be&nbsp;very&nbsp;helpful&nbsp;to&nbsp;hackers.<BR>&nbsp;*<BR>&nbsp;*&nbsp;&nbsp;5.&nbsp;This&nbsp;procedure&nbsp;should&nbsp;always&nbsp;be&nbsp;encrypted.<BR>&nbsp;*<BR>&nbsp;*&nbsp;6.&nbsp;Since&nbsp;this&nbsp;procedure&nbsp;is&nbsp;used&nbsp;for&nbsp;both&nbsp;encryption&nbsp;and&nbsp;decryption,<BR>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;limit&nbsp;permissions&nbsp;to&nbsp;it.<BR>&nbsp;*<BR>&nbsp;*&nbsp;Example:<BR>&nbsp;*&nbsp;&nbsp;DECLARE<BR>&nbsp;*&nbsp;&nbsp;@encrypted&nbsp;varchar(255)<BR>&nbsp;*&nbsp;EXEC&nbsp;uspGetProductCode&nbsp;'mypassword',&nbsp;'mykey',&nbsp;@encrypted&nbsp;OUTPUT<BR>&nbsp;*/<BR>ALTER&nbsp;PROCEDURE&nbsp;uspGetProductCode<BR>&nbsp;(@product&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(255),<BR>&nbsp;&nbsp;@productCode&nbsp;varchar(32),<BR>&nbsp;&nbsp;@productName&nbsp;varchar(255)&nbsp;OUTPUT)<BR>WITH&nbsp;ENCRYPTION<BR>AS<BR>--&nbsp;Eliminate&nbsp;rowcount&nbsp;messages.<BR>SET&nbsp;NOCOUNT&nbsp;ON<BR>--&nbsp;Declare&nbsp;variables.<BR>DECLARE<BR>&nbsp;@state&nbsp;smallint,<BR>&nbsp;@key&nbsp;&nbsp;smallint,<BR>&nbsp;@tempSwap&nbsp;smallint,<BR>&nbsp;@a&nbsp;smallint,<BR>&nbsp;@b&nbsp;smallint,<BR>&nbsp;@N&nbsp;smallint,<BR>&nbsp;@temp&nbsp;smallint,<BR>&nbsp;@i&nbsp;smallint,<BR>&nbsp;@j&nbsp;smallint,<BR>&nbsp;@k&nbsp;smallint,<BR>&nbsp;@cipherby&nbsp;smallint,<BR>&nbsp;@cipher&nbsp;varchar(255),<BR>&nbsp;@code&nbsp;&nbsp;&nbsp;varchar(64)</P>
<P>&nbsp;--&nbsp;The&nbsp;RC4&nbsp;algorithm&nbsp;works&nbsp;in&nbsp;two&nbsp;phases,&nbsp;key&nbsp;setup&nbsp;and&nbsp;ciphering.<BR>&nbsp;--&nbsp;Key&nbsp;setup&nbsp;is&nbsp;the&nbsp;first&nbsp;and&nbsp;most&nbsp;difficult&nbsp;phase&nbsp;of&nbsp;this&nbsp;algorithm.<BR>&nbsp;--&nbsp;During&nbsp;a&nbsp;N-bit&nbsp;key&nbsp;setup&nbsp;(N&nbsp;being&nbsp;your&nbsp;key&nbsp;length),<BR>&nbsp;--&nbsp;&nbsp;the&nbsp;encryption&nbsp;key&nbsp;is&nbsp;used&nbsp;to&nbsp;generate&nbsp;an&nbsp;encrypting&nbsp;variable&nbsp;using&nbsp;two&nbsp;arrays,<BR>&nbsp;--&nbsp;&nbsp;state&nbsp;and&nbsp;key,&nbsp;and&nbsp;N-number&nbsp;of&nbsp;mixing&nbsp;operations.<BR>&nbsp;--&nbsp;&nbsp;These&nbsp;mixing&nbsp;operations&nbsp;consist&nbsp;of&nbsp;swapping&nbsp;bytes,<BR>&nbsp;--&nbsp;&nbsp;&nbsp;modulo&nbsp;operations,&nbsp;and&nbsp;other&nbsp;formulas.<BR>&nbsp;--&nbsp;&nbsp;A&nbsp;modulo&nbsp;operation&nbsp;is&nbsp;the&nbsp;process&nbsp;of&nbsp;yielding&nbsp;a&nbsp;remainder&nbsp;from&nbsp;division.<BR>&nbsp;--&nbsp;This&nbsp;implementation&nbsp;of&nbsp;RC4&nbsp;uses&nbsp;temporary&nbsp;tables&nbsp;in&nbsp;place&nbsp;of&nbsp;arrays.<BR>&nbsp;CREATE&nbsp;TABLE&nbsp;#Keys<BR>&nbsp;(<BR>&nbsp;&nbsp;ID&nbsp;&nbsp;&nbsp;&nbsp;smallint&nbsp;,<BR>&nbsp;&nbsp;state&nbsp;&nbsp;smallint&nbsp;,<BR>&nbsp;&nbsp;intKey&nbsp;&nbsp;smallint<BR>&nbsp;)<BR>&nbsp;--&nbsp;Initialize&nbsp;variable&nbsp;values.<BR>&nbsp;SET&nbsp;@code&nbsp;=&nbsp;@productcode&nbsp;+&nbsp;',./;''p[\`0-=Z&lt;?L:"P{|~!@#%^*(_'<BR>&nbsp;SELECT<BR>&nbsp;&nbsp;@N&nbsp;=&nbsp;Len(@code),<BR>&nbsp;&nbsp;@a&nbsp;=&nbsp;0<BR>&nbsp;--&nbsp;Initialize&nbsp;temp&nbsp;table&nbsp;with&nbsp;key&nbsp;and&nbsp;state&nbsp;values.<BR>&nbsp;WHILE&nbsp;@a&nbsp;&lt;&nbsp;256<BR>&nbsp;BEGIN<BR>&nbsp;&nbsp;SELECT<BR>&nbsp;&nbsp;&nbsp;@key&nbsp;=&nbsp;Ascii(Substring(@code,&nbsp;(@a%@N)&nbsp;+&nbsp;1,&nbsp;1)),<BR>&nbsp;&nbsp;&nbsp;@state&nbsp;=&nbsp;@a<BR>&nbsp;&nbsp;INSERT&nbsp;#Keys(ID,&nbsp;state,&nbsp;intKey)&nbsp;valueS(@a,&nbsp;@state,&nbsp;@key)<BR>&nbsp;&nbsp;SET&nbsp;@a&nbsp;=&nbsp;@a&nbsp;+&nbsp;1<BR>&nbsp;END</P>
<P>&nbsp;--&nbsp;Initialize&nbsp;variable&nbsp;values.<BR>&nbsp;SELECT<BR>&nbsp;&nbsp;@b&nbsp;=&nbsp;0,<BR>&nbsp;&nbsp;@a&nbsp;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;The&nbsp;state&nbsp;array&nbsp;now&nbsp;undergoes&nbsp;256&nbsp;mixing&nbsp;operations.<BR>&nbsp;WHILE&nbsp;@a&nbsp;&lt;&nbsp;256<BR>&nbsp;BEGIN<BR>&nbsp;&nbsp;SELECT&nbsp;@b&nbsp;=&nbsp;(@b&nbsp;+&nbsp;state&nbsp;+&nbsp;intKey)&nbsp;%&nbsp;256,&nbsp;@tempSwap&nbsp;=&nbsp;state&nbsp;<BR>&nbsp;&nbsp;FROM&nbsp;#Keys&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@a<BR>&nbsp;&nbsp;UPDATE&nbsp;#Keys&nbsp;<BR>&nbsp;&nbsp;SET&nbsp;state&nbsp;=&nbsp;(SELECT&nbsp;state&nbsp;FROM&nbsp;#Keys&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@b)&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@a<BR>&nbsp;&nbsp;UPDATE&nbsp;#Keys&nbsp;<BR>&nbsp;&nbsp;SET&nbsp;state&nbsp;=&nbsp;@tempSwap&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@b<BR>&nbsp;&nbsp;SET&nbsp;@a&nbsp;=&nbsp;@a&nbsp;+&nbsp;1<BR>&nbsp;END</P>
<P>&nbsp;--&nbsp;Initialize&nbsp;variable&nbsp;values.<BR>&nbsp;SELECT<BR>&nbsp;&nbsp;@i&nbsp;=&nbsp;0,<BR>&nbsp;&nbsp;@j&nbsp;=&nbsp;0,<BR>&nbsp;&nbsp;@a&nbsp;=&nbsp;1,<BR>&nbsp;&nbsp;@cipher&nbsp;=&nbsp;'',<BR>&nbsp;&nbsp;@cipherby&nbsp;=&nbsp;0</P>
<P>&nbsp;--&nbsp;Once&nbsp;the&nbsp;encrypting&nbsp;variable&nbsp;is&nbsp;produced&nbsp;from&nbsp;the&nbsp;key&nbsp;setup,<BR>&nbsp;--&nbsp;&nbsp;it&nbsp;enters&nbsp;the&nbsp;ciphering&nbsp;phase,<BR>&nbsp;--&nbsp;&nbsp;where&nbsp;it&nbsp;is&nbsp;XORed&nbsp;with&nbsp;the&nbsp;plain&nbsp;text&nbsp;message&nbsp;to&nbsp;create&nbsp;and&nbsp;encrypted&nbsp;message.<BR>&nbsp;--&nbsp;&nbsp;XOR&nbsp;is&nbsp;the&nbsp;logical&nbsp;operation&nbsp;of&nbsp;comparing&nbsp;two&nbsp;binary&nbsp;bits.<BR>&nbsp;--&nbsp;&nbsp;If&nbsp;the&nbsp;bits&nbsp;are&nbsp;different,&nbsp;the&nbsp;result&nbsp;is&nbsp;1.<BR>&nbsp;--&nbsp;&nbsp;If&nbsp;the&nbsp;bits&nbsp;are&nbsp;the&nbsp;same,&nbsp;the&nbsp;result&nbsp;is&nbsp;0.<BR>&nbsp;--&nbsp;&nbsp;The&nbsp;string&nbsp;is&nbsp;decrypted&nbsp;by&nbsp;XORing&nbsp;the&nbsp;encrypted&nbsp;message&nbsp;with&nbsp;the&nbsp;same&nbsp;encrypting&nbsp;key.&nbsp;<BR>&nbsp;WHILE&nbsp;@a&nbsp;&lt;&nbsp;Len(@product)&nbsp;+&nbsp;1<BR>&nbsp;BEGIN<BR>&nbsp;&nbsp;SET&nbsp;<BR>&nbsp;&nbsp;SELECT<BR>&nbsp;&nbsp;&nbsp;@i&nbsp;=&nbsp;(@i&nbsp;+&nbsp;1)&nbsp;%&nbsp;256,<BR>&nbsp;&nbsp;&nbsp;@j&nbsp;=&nbsp;(@j&nbsp;+&nbsp;state)&nbsp;%&nbsp;256,<BR>&nbsp;&nbsp;&nbsp;@temp&nbsp;=&nbsp;state<BR>&nbsp;&nbsp;FROM&nbsp;#Keys&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@i<BR>&nbsp;&nbsp;UPDATE&nbsp;#Keys&nbsp;<BR>&nbsp;&nbsp;SET&nbsp;state&nbsp;=&nbsp;(SELECT&nbsp;state&nbsp;FROM&nbsp;#Keys&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@j)&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@i<BR>&nbsp;&nbsp;UPDATE&nbsp;#Keys&nbsp;<BR>&nbsp;&nbsp;SET&nbsp;state&nbsp;=&nbsp;@temp&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@j<BR>&nbsp;&nbsp;SELECT&nbsp;@k&nbsp;=&nbsp;state&nbsp;<BR>&nbsp;&nbsp;FROM&nbsp;#Keys&nbsp;<BR>&nbsp;&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;(((SELECT&nbsp;state&nbsp;FROM&nbsp;#Keys&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@i)&nbsp;+&nbsp;(SELECT&nbsp;state&nbsp;FROM&nbsp;#Keys&nbsp;WHERE&nbsp;ID&nbsp;=&nbsp;@j))&nbsp;%&nbsp;256)<BR>&nbsp;&nbsp;SET&nbsp;@cipherby&nbsp;=&nbsp;Ascii(Substring(@product,&nbsp;@a,&nbsp;1))&nbsp;^&nbsp;@k<BR>&nbsp;&nbsp;SET&nbsp;@cipher&nbsp;=&nbsp;@cipher&nbsp;+&nbsp;Char(@cipherby)<BR>&nbsp;&nbsp;SET&nbsp;@a&nbsp;=&nbsp;@a&nbsp;+&nbsp;1<BR>&nbsp;END</P>
<P>&nbsp;--&nbsp;Clean&nbsp;up.<BR>&nbsp;DROP&nbsp;TABLE&nbsp;#Keys<BR>&nbsp;--&nbsp;Set&nbsp;ouput&nbsp;variable.<BR>&nbsp;SET&nbsp;@productName&nbsp;=&nbsp;@cipher<BR>&nbsp;SET&nbsp;NOCOUNT&nbsp;OFF</P></FONT>