<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Tracking&nbsp;Index&nbsp;Usage</B><BR>Tracking&nbsp;Index&nbsp;Usage<BR>&nbsp;<BR>How&nbsp;can&nbsp;I&nbsp;track&nbsp;how&nbsp;frequently&nbsp;my&nbsp;applications&nbsp;use&nbsp;indexes&nbsp;on&nbsp;a&nbsp;particular&nbsp;table&nbsp;and&nbsp;find&nbsp;out&nbsp;which&nbsp;applications&nbsp;are&nbsp;using&nbsp;the&nbsp;indexes?
<P></P>
<P>Tracking&nbsp;index&nbsp;usage&nbsp;helps&nbsp;you&nbsp;determine&nbsp;which&nbsp;indexes&nbsp;you&nbsp;need&nbsp;to&nbsp;keep,&nbsp;but&nbsp;you&nbsp;can't&nbsp;get&nbsp;this&nbsp;information&nbsp;without&nbsp;a&nbsp;detrimental&nbsp;effect&nbsp;on&nbsp;your&nbsp;server&nbsp;performance.&nbsp;To&nbsp;get&nbsp;the&nbsp;information,&nbsp;run&nbsp;an&nbsp;audit-object&nbsp;trace&nbsp;on&nbsp;the&nbsp;object&nbsp;IDs&nbsp;that&nbsp;represent&nbsp;the&nbsp;indexes.&nbsp;You&nbsp;can&nbsp;also&nbsp;get&nbsp;the&nbsp;information&nbsp;by&nbsp;running&nbsp;a&nbsp;Showplan&nbsp;trace&nbsp;using&nbsp;SQL&nbsp;Server&nbsp;Profiler.</P>
<P>Listing&nbsp;1:&nbsp;Code&nbsp;to&nbsp;Retrieve&nbsp;ID&nbsp;Numbers&nbsp;to&nbsp;Use&nbsp;for&nbsp;Filtering<BR>--&nbsp;Get&nbsp;the&nbsp;database&nbsp;ID&nbsp;number&nbsp;for&nbsp;your&nbsp;database.<BR>--&nbsp;Use&nbsp;this&nbsp;number&nbsp;to&nbsp;filter&nbsp;in&nbsp;Profiler.<BR>SELECT&nbsp;dbid&nbsp;FROM&nbsp;master..sysdatabases<BR>WHERE&nbsp;[name]&nbsp;=&nbsp;N'Northwind'<BR>--&nbsp;Get&nbsp;the&nbsp;object&nbsp;ID&nbsp;for&nbsp;the&nbsp;base&nbsp;table&nbsp;or&nbsp;view&nbsp;that&nbsp;you're&nbsp;interested&nbsp;in.<BR>--&nbsp;Use&nbsp;this&nbsp;number&nbsp;to&nbsp;filter&nbsp;in&nbsp;Profiler.<BR>SELECT&nbsp;object_id('dbo.employees')<BR>--&nbsp;Get&nbsp;your&nbsp;SPID.<BR>--&nbsp;Use&nbsp;this&nbsp;number&nbsp;to&nbsp;filter&nbsp;in&nbsp;Profiler.<BR>SELECT&nbsp;@@SPID</P>
<P>Listing&nbsp;2:&nbsp;Test&nbsp;Queries&nbsp;for&nbsp;the&nbsp;Employees&nbsp;Table&nbsp;in&nbsp;Northwind<BR>--&nbsp;Use&nbsp;the&nbsp;code&nbsp;below&nbsp;to&nbsp;generate&nbsp;test&nbsp;data&nbsp;showing<BR>--&nbsp;various&nbsp;execution&nbsp;plans&nbsp;against&nbsp;an&nbsp;object.<BR>--&nbsp;Index&nbsp;seek<BR>SELECT&nbsp;&nbsp;lastname<BR>FROM&nbsp;dbo.employees<BR>WHERE&nbsp;lastname&nbsp;=&nbsp;'Fuller'<BR>--&nbsp;Index&nbsp;scan<BR>SELECT&nbsp;&nbsp;lastname<BR>FROM&nbsp;dbo.employees<BR>--&nbsp;Clustered&nbsp;index&nbsp;scan<BR>SELECT&nbsp;&nbsp;*<BR>FROM&nbsp;dbo.employees<BR>--&nbsp;Index&nbsp;seek&nbsp;and&nbsp;bookmark&nbsp;lookup<BR>SELECT&nbsp;&nbsp;*<BR>FROM&nbsp;dbo.employees<BR>WHERE&nbsp;lastname&nbsp;=&nbsp;'Fuller'</P>
<P>Listing&nbsp;3:&nbsp;Script&nbsp;to&nbsp;Autostart&nbsp;a&nbsp;Trace&nbsp;Without&nbsp;Profiler<BR>/****************************************************/<BR>/*&nbsp;Created&nbsp;by:&nbsp;SQL&nbsp;Profiler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;Date:&nbsp;02/13/2003&nbsp;&nbsp;06:24:01&nbsp;PM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/****************************************************/<BR>/*&nbsp;Comments&nbsp;added&nbsp;by&nbsp;SQL&nbsp;Mag&nbsp;*/</P>
<P>--&nbsp;Create&nbsp;a&nbsp;queue.<BR>DECLARE&nbsp;@rc&nbsp;int<BR>DECLARE&nbsp;@QueueHandle&nbsp;int<BR>EXEC&nbsp;@rc&nbsp;=&nbsp;xp_trace_addnewqueue&nbsp;1000,&nbsp;5000,&nbsp;95,&nbsp;90,&nbsp;69216261,&nbsp;@QueueHandle&nbsp;output&nbsp;if&nbsp;<BR>(@rc&nbsp;!=&nbsp;0)&nbsp;GOTO&nbsp;error</P>
<P>--&nbsp;Set&nbsp;the&nbsp;events.<BR>--&nbsp;SQL&nbsp;Server&nbsp;2000–specific&nbsp;events&nbsp;won't&nbsp;be&nbsp;scripted.</P>
<P>/*&nbsp;SQL&nbsp;MAG:&nbsp;40&nbsp;=&nbsp;SQL:StmtStarting&nbsp;-&nbsp;to&nbsp;get&nbsp;the&nbsp;SQL&nbsp;statement&nbsp;being&nbsp;executed&nbsp;*/<BR>&nbsp;&nbsp;&nbsp;EXEC&nbsp;xp_trace_seteventclassrequired&nbsp;@QueueHandle,&nbsp;40,&nbsp;1</P>
<P>/*&nbsp;SQL&nbsp;MAG:&nbsp;48&nbsp;=&nbsp;Object&nbsp;Open&nbsp;-&nbsp;to&nbsp;check&nbsp;that&nbsp;the&nbsp;objects&nbsp;we're&nbsp;interested&nbsp;in&nbsp;are&nbsp;being&nbsp;opened&nbsp;*/&nbsp;<BR>&nbsp;&nbsp;&nbsp;EXEC&nbsp;xp_trace_seteventclassrequired&nbsp;@QueueHandle,&nbsp;48,&nbsp;1</P>
<P>/*&nbsp;SQL&nbsp;MAG:&nbsp;68&nbsp;=&nbsp;Execution&nbsp;Plan&nbsp;-&nbsp;to&nbsp;see&nbsp;what&nbsp;indexes&nbsp;are&nbsp;being&nbsp;used&nbsp;in&nbsp;the&nbsp;plan&nbsp;*/<BR>&nbsp;&nbsp;&nbsp;EXEC&nbsp;xp_trace_seteventclassrequired&nbsp;@QueueHandle,&nbsp;68,&nbsp;1</P>
<P><BR>--&nbsp;Set&nbsp;the&nbsp;filters.<BR>/*&nbsp;SQL&nbsp;MAG&nbsp;-&nbsp;Ignore&nbsp;Profiler&nbsp;events.&nbsp;*/<BR>EXEC&nbsp;xp_trace_setappfilter&nbsp;@QueueHandle,&nbsp;N'',&nbsp;N'SQL&nbsp;Profiler'</P>
<P>/*&nbsp;Only&nbsp;look&nbsp;at&nbsp;DBID&nbsp;6&nbsp;(Northwind).&nbsp;*/<BR>EXEC&nbsp;xp_trace_setdbidfilter&nbsp;@QueueHandle,&nbsp;6</P>
<P>/*&nbsp;Only&nbsp;look&nbsp;at&nbsp;the&nbsp;dbo.employees&nbsp;base&nbsp;object.&nbsp;*/<BR>EXEC&nbsp;xp_trace_setobjidfilter&nbsp;@QueueHandle,&nbsp;117575457</P>
<P>/*&nbsp;Only&nbsp;look&nbsp;at&nbsp;SPID&nbsp;7.&nbsp;*/<BR>EXEC&nbsp;xp_trace_setspidfilter&nbsp;@QueueHandle,&nbsp;7</P>
<P>--&nbsp;Set&nbsp;the&nbsp;destinations.</P>
<P>--&nbsp;Save&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;registry.<BR>EXEC&nbsp;xp_trace_savequeuedefinition&nbsp;&nbsp;@QueueHandle,&nbsp;&nbsp;N'Hunt&nbsp;for&nbsp;Index&nbsp;Usage',&nbsp;1</P>
<P>--&nbsp;Display&nbsp;queue&nbsp;handle&nbsp;for&nbsp;future&nbsp;references.<BR>SELECT&nbsp;QueueHandle=@QueueHandle<BR>GOTO&nbsp;finish</P>
<P>error:<BR>SELECT&nbsp;ErrorCode=@rc</P>
<P>finish:<BR>GO</P></FONT>