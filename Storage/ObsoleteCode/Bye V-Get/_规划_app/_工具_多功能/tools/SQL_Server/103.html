<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Auditing&nbsp;Your&nbsp;SQL&nbsp;Server&nbsp;-&nbsp;Part&nbsp;3</B><BR>Auditing&nbsp;Your&nbsp;SQL&nbsp;Server&nbsp;-&nbsp;Part&nbsp;3&nbsp;-&nbsp;Managing&nbsp;Audit&nbsp;Data&nbsp;<BR>Introduction 

<P></P>
<P>Auditing&nbsp;anything&nbsp;generates&nbsp;a&nbsp;tremendous&nbsp;amount&nbsp;of&nbsp;data.&nbsp;In&nbsp;the&nbsp;past,&nbsp;line&nbsp;printers&nbsp;were&nbsp;used&nbsp;in&nbsp;many&nbsp;applications,&nbsp;merely&nbsp;printing&nbsp;a&nbsp;new&nbsp;line&nbsp;on&nbsp;a&nbsp;piece&nbsp;of&nbsp;paper&nbsp;each&nbsp;time&nbsp;an&nbsp;event&nbsp;occurred,&nbsp;someone&nbsp;entered&nbsp;a&nbsp;door,&nbsp;a&nbsp;phone&nbsp;call&nbsp;was&nbsp;completed,&nbsp;etc.&nbsp;If&nbsp;you've&nbsp;ever&nbsp;used&nbsp;a&nbsp;system&nbsp;like&nbsp;this&nbsp;you&nbsp;have&nbsp;a&nbsp;great&nbsp;appreciation&nbsp;for&nbsp;the&nbsp;amount&nbsp;of&nbsp;paper&nbsp;that&nbsp;is&nbsp;consumed.</P>
<P>In&nbsp;Part&nbsp;2&nbsp;-&nbsp;Using&nbsp;a&nbsp;Mirror,&nbsp;I&nbsp;used&nbsp;a&nbsp;mirror&nbsp;table,&nbsp;essentially&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;table&nbsp;to&nbsp;store&nbsp;copies&nbsp;of&nbsp;the&nbsp;data&nbsp;rows&nbsp;at&nbsp;points&nbsp;in&nbsp;time&nbsp;to&nbsp;track&nbsp;the&nbsp;changes&nbsp;that&nbsp;were&nbsp;made.&nbsp;This&nbsp;type&nbsp;of&nbsp;auditing&nbsp;generates&nbsp;large&nbsp;numbers&nbsp;of&nbsp;rows,&nbsp;sometimes&nbsp;a&nbsp;large&nbsp;multiple&nbsp;of&nbsp;rows&nbsp;relative&nbsp;to&nbsp;the&nbsp;original&nbsp;table.&nbsp;So&nbsp;how&nbsp;do&nbsp;you&nbsp;manage&nbsp;this&nbsp;data?&nbsp;<BR>Separation</P>
<P>One&nbsp;of&nbsp;the&nbsp;ways&nbsp;that&nbsp;I've&nbsp;used&nbsp;to&nbsp;manage&nbsp;this&nbsp;data&nbsp;is&nbsp;to&nbsp;store&nbsp;the&nbsp;audit&nbsp;data&nbsp;in&nbsp;a&nbsp;separate&nbsp;database.&nbsp;In&nbsp;many&nbsp;applications,&nbsp;you&nbsp;will&nbsp;find&nbsp;that&nbsp;the&nbsp;audit&nbsp;data&nbsp;is&nbsp;examined&nbsp;very&nbsp;rarely.&nbsp;In&nbsp;fact,&nbsp;you&nbsp;will&nbsp;usually&nbsp;find&nbsp;that&nbsp;most&nbsp;of&nbsp;the&nbsp;audit&nbsp;data&nbsp;is&nbsp;never&nbsp;looked&nbsp;at&nbsp;again.</P>
<P>Using&nbsp;a&nbsp;separate&nbsp;database&nbsp;is&nbsp;very&nbsp;easy,&nbsp;simply&nbsp;create&nbsp;a&nbsp;database,&nbsp;continuing&nbsp;the&nbsp;example&nbsp;from&nbsp;Part&nbsp;2,&nbsp;I'd&nbsp;create&nbsp;a&nbsp;Northwind_Audit&nbsp;database,&nbsp;potentially&nbsp;on&nbsp;a&nbsp;separate&nbsp;physical&nbsp;disk&nbsp;if&nbsp;the&nbsp;amount&nbsp;of&nbsp;activity&nbsp;was&nbsp;high.&nbsp;When&nbsp;creating&nbsp;this&nbsp;database,&nbsp;keep&nbsp;in&nbsp;mind&nbsp;that&nbsp;your&nbsp;users&nbsp;will&nbsp;need&nbsp;access&nbsp;to&nbsp;this&nbsp;database&nbsp;to&nbsp;write&nbsp;the&nbsp;audit&nbsp;data,&nbsp;so&nbsp;user&nbsp;management&nbsp;becomes&nbsp;slightly&nbsp;more&nbsp;complex.</P>
<P>If&nbsp;I&nbsp;were&nbsp;auditing&nbsp;the&nbsp;Orders&nbsp;table,&nbsp;as&nbsp;in&nbsp;Part&nbsp;2,&nbsp;I'd&nbsp;next&nbsp;create&nbsp;my&nbsp;Orders_Audit&nbsp;table&nbsp;in&nbsp;the&nbsp;Northwind_Audit&nbsp;database.&nbsp;The&nbsp;structure&nbsp;would&nbsp;be&nbsp;the&nbsp;same,&nbsp;but&nbsp;the&nbsp;location&nbsp;would&nbsp;be&nbsp;different.&nbsp;My&nbsp;triggers&nbsp;would&nbsp;stay&nbsp;the&nbsp;same,&nbsp;but&nbsp;I'd&nbsp;add&nbsp;an&nbsp;additional&nbsp;object&nbsp;to&nbsp;Northwind:</P>
<P></P>
<P>&nbsp;create&nbsp;view&nbsp;Orders_Audit<BR>&nbsp;as<BR>&nbsp;&nbsp;&nbsp;select&nbsp;*<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;Northwind_Audit.dbo.Orders_Audit<BR>&nbsp;go</P>
<P><BR>By&nbsp;using&nbsp;a&nbsp;view,&nbsp;I've&nbsp;abstracted&nbsp;out&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;audit&nbsp;table.&nbsp;I've&nbsp;also&nbsp;used&nbsp;this&nbsp;type&nbsp;of&nbsp;structure&nbsp;to&nbsp;"move"&nbsp;my&nbsp;audit&nbsp;data&nbsp;from&nbsp;the&nbsp;main&nbsp;database&nbsp;to&nbsp;another&nbsp;one&nbsp;as&nbsp;it&nbsp;grew.&nbsp;If&nbsp;I&nbsp;implemented&nbsp;linked&nbsp;servers,&nbsp;this&nbsp;technique&nbsp;would&nbsp;also&nbsp;allow&nbsp;me&nbsp;to&nbsp;move&nbsp;the&nbsp;audit&nbsp;data&nbsp;to&nbsp;another&nbsp;server&nbsp;without&nbsp;disturbing&nbsp;the&nbsp;application.&nbsp;I&nbsp;would&nbsp;merely&nbsp;recompile&nbsp;the&nbsp;view.</P>
<P>Using&nbsp;a&nbsp;separate&nbsp;database&nbsp;also&nbsp;brings&nbsp;some&nbsp;additional&nbsp;benefits.&nbsp;First&nbsp;the&nbsp;data&nbsp;is&nbsp;stored&nbsp;in&nbsp;another&nbsp;file,&nbsp;so&nbsp;this&nbsp;data&nbsp;can&nbsp;be&nbsp;moved&nbsp;without&nbsp;disturbing&nbsp;the&nbsp;main&nbsp;data.&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;disaster,&nbsp;I&nbsp;can&nbsp;more&nbsp;quickly&nbsp;restore&nbsp;the&nbsp;application&nbsp;data&nbsp;because&nbsp;I&nbsp;do&nbsp;not&nbsp;have&nbsp;to&nbsp;restore&nbsp;the&nbsp;audit&nbsp;data&nbsp;at&nbsp;the&nbsp;same&nbsp;time.&nbsp;</P>
<P>Archiving<BR>Generating&nbsp;this&nbsp;much&nbsp;data&nbsp;will&nbsp;eventually&nbsp;become&nbsp;a&nbsp;problem&nbsp;for&nbsp;everyone.&nbsp;At&nbsp;some&nbsp;point,&nbsp;the&nbsp;amount&nbsp;of&nbsp;archive&nbsp;data&nbsp;can&nbsp;quickly&nbsp;grow&nbsp;larger&nbsp;than&nbsp;the&nbsp;amount&nbsp;of&nbsp;real&nbsp;data.&nbsp;Dealing&nbsp;with&nbsp;this&nbsp;data&nbsp;can&nbsp;be&nbsp;another&nbsp;problem&nbsp;in&nbsp;and&nbsp;of&nbsp;itself.</P>
<P>Not&nbsp;having&nbsp;an&nbsp;archive&nbsp;plan&nbsp;is&nbsp;a&nbsp;worst&nbsp;practice,&nbsp;but&nbsp;doubly&nbsp;so&nbsp;for&nbsp;audit&nbsp;data.&nbsp;This&nbsp;is&nbsp;something&nbsp;that's&nbsp;easy&nbsp;to&nbsp;implement&nbsp;and&nbsp;then&nbsp;you&nbsp;can&nbsp;forget&nbsp;about&nbsp;it,&nbsp;but&nbsp;you&nbsp;need&nbsp;to&nbsp;do&nbsp;it.&nbsp;I've&nbsp;got&nbsp;a&nbsp;couple&nbsp;of&nbsp;different&nbsp;methods&nbsp;of&nbsp;doing&nbsp;this.</P>
<P>First&nbsp;you&nbsp;can&nbsp;merely&nbsp;detach&nbsp;the&nbsp;audit&nbsp;database&nbsp;and&nbsp;create&nbsp;a&nbsp;new&nbsp;audit&nbsp;database&nbsp;periodically.&nbsp;This&nbsp;works&nbsp;well&nbsp;and&nbsp;keeps&nbsp;the&nbsp;data&nbsp;handy&nbsp;in&nbsp;a&nbsp;form&nbsp;that&nbsp;it&nbsp;can&nbsp;easily&nbsp;be&nbsp;restored.&nbsp;I&nbsp;did&nbsp;this&nbsp;quarterly&nbsp;for&nbsp;one&nbsp;system&nbsp;and&nbsp;it&nbsp;allowed&nbsp;us&nbsp;to&nbsp;attach&nbsp;the&nbsp;database&nbsp;back&nbsp;as&nbsp;Northwind_Audit_2002_Q3,&nbsp;or&nbsp;whatever&nbsp;the&nbsp;date&nbsp;was&nbsp;and&nbsp;then&nbsp;access&nbsp;the&nbsp;data.&nbsp;The&nbsp;downsides&nbsp;were&nbsp;that&nbsp;our&nbsp;application&nbsp;could&nbsp;not&nbsp;easily&nbsp;find&nbsp;this&nbsp;data&nbsp;and&nbsp;custom&nbsp;queries&nbsp;were&nbsp;required&nbsp;to&nbsp;report&nbsp;on&nbsp;the&nbsp;audit.</P>
<P>Another&nbsp;solution&nbsp;that&nbsp;worked&nbsp;much&nbsp;better&nbsp;was&nbsp;to&nbsp;BCP&nbsp;or&nbsp;DTS&nbsp;out&nbsp;some&nbsp;amount&nbsp;of&nbsp;old&nbsp;data&nbsp;periodically.&nbsp;In&nbsp;most&nbsp;cases&nbsp;I've&nbsp;found&nbsp;that&nbsp;the&nbsp;last&nbsp;30&nbsp;or&nbsp;60&nbsp;days&nbsp;of&nbsp;audit&nbsp;data&nbsp;was&nbsp;most&nbsp;often&nbsp;accessed.&nbsp;After&nbsp;that&nbsp;it&nbsp;was&nbsp;rare&nbsp;that&nbsp;someone&nbsp;needed&nbsp;to&nbsp;track&nbsp;the&nbsp;history&nbsp;of&nbsp;a&nbsp;record,&nbsp;and&nbsp;even&nbsp;then,&nbsp;they&nbsp;usually&nbsp;knew&nbsp;the&nbsp;time&nbsp;period&nbsp;that&nbsp;needed&nbsp;to&nbsp;be&nbsp;audited.</P>
<P>To&nbsp;handle&nbsp;this,&nbsp;I&nbsp;wrote&nbsp;a&nbsp;script&nbsp;that&nbsp;would&nbsp;BCP&nbsp;out&nbsp;data&nbsp;that&nbsp;was&nbsp;older&nbsp;than&nbsp;60&nbsp;days&nbsp;into&nbsp;a&nbsp;file&nbsp;that&nbsp;was&nbsp;named&nbsp;for&nbsp;the&nbsp;time&nbsp;period.&nbsp;Using&nbsp;the&nbsp;Northwind.dbo.Orders&nbsp;example,&nbsp;I'd&nbsp;bcp&nbsp;out&nbsp;the&nbsp;data&nbsp;from&nbsp;December&nbsp;2002&nbsp;as&nbsp;"Northwind_Orders_Audit_200212.txt.&nbsp;I&nbsp;like&nbsp;text&nbsp;files&nbsp;because&nbsp;I&nbsp;can&nbsp;easily&nbsp;view&nbsp;them&nbsp;in&nbsp;Notepad&nbsp;or&nbsp;any&nbsp;editor.&nbsp;This&nbsp;script&nbsp;was&nbsp;set&nbsp;to&nbsp;run&nbsp;monthly&nbsp;and&nbsp;would&nbsp;also&nbsp;zip&nbsp;up&nbsp;the&nbsp;text&nbsp;file,&nbsp;which&nbsp;was&nbsp;then&nbsp;backed&nbsp;up&nbsp;to&nbsp;tape.&nbsp;If&nbsp;someone&nbsp;needed&nbsp;older&nbsp;audit&nbsp;data,&nbsp;we&nbsp;could&nbsp;BCP&nbsp;it&nbsp;back&nbsp;into&nbsp;the&nbsp;Northwind_Audit.dbo.Orders_Audit&nbsp;table,&nbsp;allow&nbsp;them&nbsp;to&nbsp;query&nbsp;it&nbsp;from&nbsp;their&nbsp;application,&nbsp;and&nbsp;then&nbsp;delete&nbsp;it&nbsp;out&nbsp;of&nbsp;the&nbsp;table.&nbsp;We&nbsp;still&nbsp;had&nbsp;the&nbsp;text&nbsp;file,&nbsp;so&nbsp;this&nbsp;could&nbsp;be&nbsp;repeated&nbsp;as&nbsp;needed.&nbsp;</P>
<P>The&nbsp;downside&nbsp;to&nbsp;this&nbsp;was&nbsp;that&nbsp;we&nbsp;had&nbsp;to&nbsp;take&nbsp;manual&nbsp;action&nbsp;to&nbsp;restore&nbsp;the&nbsp;data&nbsp;as&nbsp;well&nbsp;as&nbsp;remember&nbsp;to&nbsp;remove&nbsp;it&nbsp;(otherwise&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;script&nbsp;ran,&nbsp;it&nbsp;would&nbsp;duplicate&nbsp;audit&nbsp;data).&nbsp;This&nbsp;also&nbsp;could&nbsp;be&nbsp;cumbersome&nbsp;if&nbsp;someone&nbsp;wanted&nbsp;a&nbsp;large&nbsp;amount&nbsp;of&nbsp;audit&nbsp;data.&nbsp;You&nbsp;might&nbsp;spend&nbsp;your&nbsp;entire&nbsp;data&nbsp;doing&nbsp;BCPs.</P>
<P>Conclusions<BR>Building&nbsp;an&nbsp;archive&nbsp;plan&nbsp;and&nbsp;managing&nbsp;your&nbsp;audit&nbsp;data&nbsp;is&nbsp;something&nbsp;that&nbsp;invariable&nbsp;is&nbsp;a&nbsp;custom&nbsp;solution.&nbsp;You&nbsp;need&nbsp;to&nbsp;understand&nbsp;the&nbsp;audit&nbsp;review&nbsp;requirements&nbsp;to&nbsp;know&nbsp;what&nbsp;frequency&nbsp;to&nbsp;archive&nbsp;data&nbsp;and&nbsp;whether&nbsp;or&nbsp;now&nbsp;a&nbsp;separation&nbsp;of&nbsp;the&nbsp;audit&nbsp;data&nbsp;from&nbsp;the&nbsp;source&nbsp;data&nbsp;is&nbsp;needed.</P>
<P>In&nbsp;Part&nbsp;4,&nbsp;I'll&nbsp;look&nbsp;at&nbsp;selective&nbsp;auditing&nbsp;of&nbsp;particular&nbsp;types&nbsp;of&nbsp;data,&nbsp;a&nbsp;custom&nbsp;solution&nbsp;that&nbsp;makes&nbsp;the&nbsp;audit&nbsp;data&nbsp;management&nbsp;easier&nbsp;to&nbsp;deal&nbsp;with.&nbsp;</P>
<P>As&nbsp;always,&nbsp;I&nbsp;welcome&nbsp;feedback&nbsp;on&nbsp;this&nbsp;article,&nbsp;including&nbsp;your&nbsp;suggestions,&nbsp;ideas,&nbsp;and&nbsp;criticisms.&nbsp;</P>
<P>Steve&nbsp;Jones<BR>©dkRanch.net&nbsp;March&nbsp;2003&nbsp;</P></FONT>