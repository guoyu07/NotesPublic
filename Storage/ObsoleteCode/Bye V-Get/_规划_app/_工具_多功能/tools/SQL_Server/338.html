<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Set&nbsp;SQL&nbsp;Agent&nbsp;login&nbsp;and&nbsp;password</B><BR>--&nbsp;Copyright&nbsp;(C)&nbsp;1991-2002&nbsp;SQLDev.Net<BR>--&nbsp;<BR>--&nbsp;file:&nbsp;sp_sqlagent_set_connection.sql<BR>--&nbsp;descr.:&nbsp;Set&nbsp;login&nbsp;and&nbsp;password&nbsp;for&nbsp;regular&nbsp;connections&nbsp;to&nbsp;SQL&nbsp;Agent<BR>--&nbsp;author:&nbsp;Gert&nbsp;E.R.&nbsp;Drapers&nbsp;(GertD@SQLDev.Net)<BR>--<BR>--&nbsp;@@bof_revsion_marker<BR>--&nbsp;revision&nbsp;history<BR>--&nbsp;yyyy/mm/dd&nbsp;&nbsp;by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;description<BR>--&nbsp;==========&nbsp;&nbsp;=======&nbsp;&nbsp;==========================================================<BR>--&nbsp;2003/03/20&nbsp;&nbsp;gertd&nbsp;v1.0.0.0&nbsp;first&nbsp;release<BR>--&nbsp;<BR>--&nbsp;@@eof_revsion_marker<BR>--&nbsp;***************************************************************************<BR>use&nbsp;msdb<BR>go
<P></P>
<P>if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;name&nbsp;=&nbsp;'sp_sqlagent_set_connection'&nbsp;and&nbsp;type&nbsp;=&nbsp;'P')<BR>&nbsp;drop&nbsp;proc&nbsp;dbo.sp_sqlagent_set_connection<BR>go</P>
<P>create&nbsp;proc&nbsp;dbo.sp_sqlagent_set_connection&nbsp;@host_login_name&nbsp;sysname,&nbsp;@host_login_password&nbsp;sysname,&nbsp;@regular_connections&nbsp;int&nbsp;=&nbsp;NULL<BR>as<BR>&nbsp;set&nbsp;nocount&nbsp;on</P>
<P>&nbsp;declare&nbsp;@rc&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;@os&nbsp;int</P>
<P>&nbsp;--&nbsp;check&nbsp;if&nbsp;sysadmin&nbsp;role&nbsp;member<BR>&nbsp;if&nbsp;is_srvrolemember&nbsp;('sysadmin')&nbsp;&lt;&gt;&nbsp;1<BR>&nbsp;begin<BR>&nbsp;&nbsp;raiserror('Only&nbsp;members&nbsp;of&nbsp;the&nbsp;sysadmin&nbsp;role&nbsp;can&nbsp;execute&nbsp;sp_sqlagent_set_connection',&nbsp;16,&nbsp;1)<BR>&nbsp;&nbsp;return<BR>&nbsp;end</P>
<P>&nbsp;--&nbsp;check&nbsp;parameters<BR>&nbsp;if&nbsp;(@host_login_name&nbsp;is&nbsp;null)&nbsp;or&nbsp;(len(@host_login_name)&nbsp;=&nbsp;0)<BR>&nbsp;begin<BR>&nbsp;&nbsp;raiserror('Illegal&nbsp;parameter&nbsp;value&nbsp;%s&nbsp;is&nbsp;NULL&nbsp;or&nbsp;empty',&nbsp;16,&nbsp;1,&nbsp;'@host_login_name')<BR>&nbsp;&nbsp;return<BR>&nbsp;end</P>
<P>&nbsp;if&nbsp;(@host_login_password&nbsp;is&nbsp;null)&nbsp;or&nbsp;(len(@host_login_password)&nbsp;=&nbsp;0)<BR>&nbsp;begin<BR>&nbsp;&nbsp;raiserror('Illegal&nbsp;parameter&nbsp;value&nbsp;%s&nbsp;is&nbsp;NULL&nbsp;or&nbsp;empty',&nbsp;16,&nbsp;1,&nbsp;'@host_login_password')<BR>&nbsp;&nbsp;return<BR>&nbsp;end<BR>&nbsp;<BR>&nbsp;--&nbsp;check&nbsp;if&nbsp;SQL&nbsp;Server&nbsp;2000,&nbsp;depends&nbsp;on&nbsp;master.dbo.xp_sqlagent_param<BR>&nbsp;if&nbsp;(charindex(N'8.00',&nbsp;@@version,&nbsp;0)&nbsp;=&nbsp;0)<BR>&nbsp;begin<BR>&nbsp;&nbsp;raiserror('sp_sqlagent_set_connection&nbsp;is&nbsp;not&nbsp;supported&nbsp;for&nbsp;versions&nbsp;earlier&nbsp;than&nbsp;SQL&nbsp;Server&nbsp;2000',&nbsp;18,&nbsp;1)<BR>&nbsp;&nbsp;return<BR>&nbsp;end</P>
<P>&nbsp;--&nbsp;check&nbsp;OS,&nbsp;master.dbo.xp_sqlagent_param&nbsp;only&nbsp;works&nbsp;on&nbsp;NT<BR>&nbsp;exec&nbsp;@rc&nbsp;=&nbsp;master.dbo.xp_MSplatform&nbsp;@os&nbsp;output<BR>&nbsp;if&nbsp;(@os&nbsp;=&nbsp;2)&nbsp;--&nbsp;Windows&nbsp;9x<BR>&nbsp;begin<BR>&nbsp;&nbsp;raiserror('sp_sqlagent_set_connection&nbsp;is&nbsp;not&nbsp;supported&nbsp;on&nbsp;Windows&nbsp;95/98&nbsp;platforms',&nbsp;18,&nbsp;1)<BR>&nbsp;&nbsp;return<BR>&nbsp;end<BR>&nbsp;<BR>&nbsp;--&nbsp;only&nbsp;if&nbsp;@regular_connections&nbsp;is&nbsp;turned&nbsp;on&nbsp;we&nbsp;allow&nbsp;setting&nbsp;the&nbsp;connection,&nbsp;otherwise&nbsp;we&nbsp;delete&nbsp;it<BR>&nbsp;if&nbsp;(@regular_connections&nbsp;is&nbsp;null)<BR>&nbsp;begin<BR>&nbsp;&nbsp;exec&nbsp;@rc&nbsp;=&nbsp;master.dbo.xp_instance_regread&nbsp;<BR>&nbsp;&nbsp;&nbsp;N'HKEY_LOCAL_MACHINE',<BR>&nbsp;&nbsp;&nbsp;N'SOFTWARE\Microsoft\MSSQLServer\SQLServerAgent',<BR>&nbsp;&nbsp;&nbsp;N'RegularConnections',<BR>&nbsp;&nbsp;&nbsp;@regular_connections&nbsp;OUTPUT,<BR>&nbsp;&nbsp;&nbsp;N'no_output'<BR>&nbsp;end<BR>&nbsp;else<BR>&nbsp;begin<BR>&nbsp;&nbsp;exec&nbsp;@rc&nbsp;=&nbsp;master.dbo.xp_instance_regwrite&nbsp;<BR>&nbsp;&nbsp;&nbsp;N'HKEY_LOCAL_MACHINE',<BR>&nbsp;&nbsp;&nbsp;N'SOFTWARE\Microsoft\MSSQLServer\SQLServerAgent',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N'RegularConnections',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N'REG_DWORD',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@regular_connections<BR>&nbsp;end</P>
<P>&nbsp;--&nbsp;delete&nbsp;user&nbsp;id&nbsp;and&nbsp;password<BR>&nbsp;if&nbsp;(@regular_connections&nbsp;=&nbsp;0)<BR>&nbsp;begin<BR>&nbsp;&nbsp;print&nbsp;N'Delete&nbsp;HostLoginID'<BR>&nbsp;&nbsp;exec&nbsp;@rc&nbsp;=&nbsp;master.dbo.xp_sqlagent_param&nbsp;2,&nbsp;N'HostLoginID'<BR>&nbsp;&nbsp;print&nbsp;N'Delete&nbsp;HostPassword'<BR>&nbsp;&nbsp;exec&nbsp;@rc&nbsp;=&nbsp;master.dbo.xp_sqlagent_param&nbsp;2,&nbsp;N'HostPassword'<BR>&nbsp;end<BR>&nbsp;<BR>&nbsp;--&nbsp;set&nbsp;user&nbsp;id&nbsp;and&nbsp;password<BR>&nbsp;if&nbsp;(@regular_connections&nbsp;=&nbsp;1)<BR>&nbsp;begin<BR>&nbsp;&nbsp;print&nbsp;N'Set&nbsp;HostLoginID'<BR>&nbsp;&nbsp;exec&nbsp;@rc&nbsp;=&nbsp;master.dbo.xp_sqlagent_param&nbsp;1,&nbsp;N'HostLoginID',&nbsp;@host_login_name<BR>&nbsp;&nbsp;print&nbsp;N'Set&nbsp;HostPassword'<BR>&nbsp;&nbsp;exec&nbsp;@rc&nbsp;=&nbsp;master.dbo.xp_sqlagent_param&nbsp;3,&nbsp;N'HostPassword',&nbsp;@host_login_password<BR>&nbsp;end<BR>go</P>
<P>--&nbsp;sample&nbsp;usage</P>
<P>--&nbsp;regular_connections&nbsp;is&nbsp;already&nbsp;turned&nbsp;on&nbsp;either&nbsp;using&nbsp;SQL&nbsp;Enterprise&nbsp;Manager&nbsp;or&nbsp;<BR>--&nbsp;exec&nbsp;msdb.dbo.sp_set_sqlagent_properties&nbsp;@regular_connections&nbsp;=&nbsp;1<BR>--&nbsp;this&nbsp;sets&nbsp;the&nbsp;login&nbsp;and&nbsp;password<BR>exec&nbsp;msdb.dbo.sp_sqlagent_set_connection&nbsp;N'sa',&nbsp;N'LowRider99'</P>
<P>--&nbsp;this&nbsp;switches&nbsp;to&nbsp;regular&nbsp;connections&nbsp;and&nbsp;set&nbsp;the&nbsp;login&nbsp;and&nbsp;password<BR>exec&nbsp;msdb.dbo.sp_sqlagent_set_connection&nbsp;N'sa',&nbsp;N'LowRider99',&nbsp;1<BR></P></FONT>