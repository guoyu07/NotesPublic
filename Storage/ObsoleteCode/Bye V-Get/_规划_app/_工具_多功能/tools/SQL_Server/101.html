<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Auditing&nbsp;Your&nbsp;SQL&nbsp;Server&nbsp;-&nbsp;Part&nbsp;1</B><BR>Auditing&nbsp;Your&nbsp;SQL&nbsp;Server&nbsp;-&nbsp;Part&nbsp;1&nbsp;<BR>Introduction&nbsp;<BR>I&nbsp;constantly&nbsp;see&nbsp;postings&nbsp;in&nbsp;our&nbsp;forums&nbsp;and&nbsp;others&nbsp;regarding&nbsp;auditing&nbsp;SQL&nbsp;Server.&nbsp;I&nbsp;know&nbsp;there&nbsp;is&nbsp;lots&nbsp;of&nbsp;confusion&nbsp;as&nbsp;well&nbsp;as&nbsp;a&nbsp;variety&nbsp;of&nbsp;philosophies&nbsp;for&nbsp;how&nbsp;one&nbsp;goes&nbsp;about&nbsp;auditing,&nbsp;so&nbsp;I&nbsp;decided&nbsp;to&nbsp;drop&nbsp;my&nbsp;thoughts&nbsp;down&nbsp;and&nbsp;provide&nbsp;some&nbsp;guidance&nbsp;for&nbsp;others.&nbsp;Not&nbsp;that&nbsp;I'm&nbsp;correct&nbsp;or&nbsp;these&nbsp;are&nbsp;the&nbsp;best&nbsp;ways,&nbsp;but&nbsp;hey,&nbsp;I&nbsp;like&nbsp;to&nbsp;write&nbsp;and&nbsp;share&nbsp;my&nbsp;opinions. 

<P></P>
<P>So,&nbsp;what&nbsp;is&nbsp;auditing?</P>
<P>Well,&nbsp;there&nbsp;are&nbsp;two&nbsp;types&nbsp;of&nbsp;auditing&nbsp;to&nbsp;me.&nbsp;Server&nbsp;auditing&nbsp;and&nbsp;data&nbsp;auditing.&nbsp;I'll&nbsp;tackle&nbsp;server&nbsp;auditing&nbsp;in&nbsp;later&nbsp;articles&nbsp;and&nbsp;start&nbsp;my&nbsp;look&nbsp;at&nbsp;data&nbsp;auditing&nbsp;here.&nbsp;It's&nbsp;a&nbsp;complex&nbsp;topic&nbsp;and&nbsp;I'm&nbsp;expecting&nbsp;at&nbsp;least&nbsp;3&nbsp;articles&nbsp;on&nbsp;data&nbsp;auditing,&nbsp;but&nbsp;we'll&nbsp;see&nbsp;as&nbsp;I&nbsp;dive&nbsp;into&nbsp;this&nbsp;and&nbsp;get&nbsp;feedback&nbsp;from&nbsp;all&nbsp;of&nbsp;you&nbsp;out&nbsp;there.</P>
<P>To&nbsp;me,&nbsp;data&nbsp;auditing&nbsp;is&nbsp;the&nbsp;act&nbsp;of&nbsp;looking&nbsp;at&nbsp;the&nbsp;changes&nbsp;that&nbsp;occur&nbsp;within&nbsp;your&nbsp;database&nbsp;to&nbsp;your&nbsp;data.&nbsp;Someone&nbsp;changes&nbsp;a&nbsp;row,&nbsp;adds&nbsp;a&nbsp;new&nbsp;one,&nbsp;deletes&nbsp;one,&nbsp;etc.&nbsp;and&nbsp;you&nbsp;need&nbsp;to&nbsp;know&nbsp;what&nbsp;happened.&nbsp;This&nbsp;is&nbsp;typical&nbsp;in&nbsp;most&nbsp;systems&nbsp;that&nbsp;I've&nbsp;worked&nbsp;with&nbsp;in&nbsp;that&nbsp;a&nbsp;manager&nbsp;somewhere&nbsp;wants&nbsp;to&nbsp;know&nbsp;who&nbsp;changed&nbsp;a&nbsp;particular&nbsp;row.&nbsp;It&nbsp;may&nbsp;be&nbsp;rows&nbsp;in&nbsp;multiple&nbsp;tables,&nbsp;but&nbsp;the&nbsp;manager&nbsp;is&nbsp;looking&nbsp;at&nbsp;his&nbsp;screen&nbsp;and&nbsp;the&nbsp;order&nbsp;screen&nbsp;shows&nbsp;him&nbsp;something&nbsp;different&nbsp;than&nbsp;(what&nbsp;he&nbsp;remembers)&nbsp;it&nbsp;did&nbsp;yesterday.&nbsp;Without&nbsp;some&nbsp;type&nbsp;of&nbsp;system&nbsp;in&nbsp;place&nbsp;for&nbsp;tracking&nbsp;changes&nbsp;of&nbsp;data,&nbsp;this&nbsp;can&nbsp;be&nbsp;a&nbsp;HUGE&nbsp;pain&nbsp;in&nbsp;your&nbsp;rear&nbsp;when&nbsp;he&nbsp;comes&nbsp;traipsing&nbsp;down&nbsp;to&nbsp;your&nbsp;office.</P>
<P>So&nbsp;where&nbsp;do&nbsp;you&nbsp;start?&nbsp;Well,&nbsp;I'll&nbsp;start&nbsp;by&nbsp;examining&nbsp;a&nbsp;simple&nbsp;auditing&nbsp;system.</P>
<P><BR>Simple&nbsp;Auditing<BR>The&nbsp;easy&nbsp;and&nbsp;simple&nbsp;way&nbsp;to&nbsp;audit&nbsp;is&nbsp;to&nbsp;track&nbsp;the&nbsp;changes&nbsp;in&nbsp;a&nbsp;row.&nbsp;I&nbsp;know,&nbsp;I&nbsp;know,&nbsp;there&nbsp;are&nbsp;all&nbsp;kinds&nbsp;of&nbsp;holes&nbsp;in&nbsp;this&nbsp;approach,&nbsp;but&nbsp;bear&nbsp;with&nbsp;me&nbsp;a&nbsp;minute&nbsp;because&nbsp;I've&nbsp;seen&nbsp;this&nbsp;type&nbsp;of&nbsp;auditing&nbsp;(and&nbsp;implemented&nbsp;it)&nbsp;in&nbsp;a&nbsp;number&nbsp;of&nbsp;cases.</P>
<P>Let's&nbsp;setup&nbsp;a&nbsp;simple&nbsp;table,&nbsp;similar&nbsp;to&nbsp;one&nbsp;I&nbsp;built&nbsp;for&nbsp;a&nbsp;scheduling&nbsp;application.</P>
<P></P>
<P>create&nbsp;table&nbsp;ServerBackup<BR>(&nbsp;&nbsp;MyPK&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;PK&nbsp;for&nbsp;the&nbsp;table.&nbsp;The&nbsp;values&nbsp;aren't&nbsp;important&nbsp;here<BR>&nbsp;&nbsp;&nbsp;,&nbsp;ServerName&nbsp;varchar(80)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;Name&nbsp;of&nbsp;the&nbsp;server<BR>&nbsp;&nbsp;&nbsp;,&nbsp;BackupFile&nbsp;varchar(200)&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;Name&nbsp;of&nbsp;the&nbsp;backup&nbsp;file<BR>&nbsp;&nbsp;&nbsp;,&nbsp;BackupDate&nbsp;datetime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;Date&nbsp;of&nbsp;the&nbsp;backup&nbsp;file<BR>&nbsp;&nbsp;&nbsp;,&nbsp;BackupSize&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;Size&nbsp;of&nbsp;the&nbsp;file&nbsp;in&nbsp;bytes<BR>&nbsp;&nbsp;&nbsp;,&nbsp;Modified&nbsp;datetime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;date&nbsp;the&nbsp;record&nbsp;was&nbsp;modified<BR>&nbsp;&nbsp;&nbsp;,&nbsp;ModifiedBy&nbsp;varchar(80)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;user&nbsp;who&nbsp;modified&nbsp;the&nbsp;record.<BR>)</P>
<P></P>
<P>This&nbsp;table&nbsp;is&nbsp;part&nbsp;of&nbsp;a&nbsp;scheduling&nbsp;system&nbsp;and&nbsp;contains&nbsp;information&nbsp;that&nbsp;is&nbsp;manually&nbsp;entered&nbsp;by&nbsp;a&nbsp;person&nbsp;who&nbsp;"backs&nbsp;up"&nbsp;or&nbsp;archives&nbsp;a&nbsp;server&nbsp;resource.&nbsp;The&nbsp;application&nbsp;allows&nbsp;each&nbsp;person&nbsp;to&nbsp;perform&nbsp;the&nbsp;backup&nbsp;(a&nbsp;manual&nbsp;process)&nbsp;and&nbsp;then&nbsp;record&nbsp;the&nbsp;information&nbsp;about&nbsp;the&nbsp;file&nbsp;name,&nbsp;date,&nbsp;and&nbsp;size&nbsp;of&nbsp;the&nbsp;file.&nbsp;Some&nbsp;of&nbsp;this&nbsp;information&nbsp;is&nbsp;pre-filled,&nbsp;but&nbsp;the&nbsp;user&nbsp;verifies&nbsp;it.</P>
<P>The&nbsp;auditing&nbsp;in&nbsp;this&nbsp;case&nbsp;is&nbsp;handled&nbsp;by&nbsp;triggers&nbsp;such&nbsp;as&nbsp;the&nbsp;one&nbsp;below:</P>
<P><BR>create&nbsp;trigger&nbsp;ServerBackup_tri&nbsp;on&nbsp;ServerBackup&nbsp;for&nbsp;Insert&nbsp;<BR>as<BR>update&nbsp;Sb<BR>&nbsp;set&nbsp;Modified&nbsp;=&nbsp;getdate()<BR>&nbsp;,&nbsp;ModifiedBy&nbsp;=&nbsp;suser_sname()<BR>&nbsp;from&nbsp;inserted&nbsp;i<BR>&nbsp;inner&nbsp;join&nbsp;ServerBackup&nbsp;sb<BR>&nbsp;&nbsp;on&nbsp;i.mypk&nbsp;=&nbsp;sb.mypk</P>
<P></P>
<P>There&nbsp;is&nbsp;a&nbsp;similar&nbsp;trigger&nbsp;for&nbsp;updates,&nbsp;but&nbsp;both&nbsp;of&nbsp;these&nbsp;triggers&nbsp;work&nbsp;by&nbsp;"stamping"&nbsp;the&nbsp;record&nbsp;with&nbsp;the&nbsp;last&nbsp;update&nbsp;based&nbsp;on&nbsp;the&nbsp;server&nbsp;time&nbsp;and&nbsp;the&nbsp;logged&nbsp;in&nbsp;user.&nbsp;</P>
<P>Pros&nbsp;and&nbsp;Cons<BR>I'm&nbsp;sure&nbsp;lots&nbsp;of&nbsp;people&nbsp;are&nbsp;thinking&nbsp;this&nbsp;is&nbsp;a&nbsp;stupid&nbsp;way&nbsp;to&nbsp;audit&nbsp;records.&nbsp;And&nbsp;you&nbsp;may&nbsp;be&nbsp;right,&nbsp;but&nbsp;this&nbsp;method&nbsp;works&nbsp;well&nbsp;in&nbsp;our&nbsp;case&nbsp;for&nbsp;a&nbsp;few&nbsp;reasons.&nbsp;First,&nbsp;this&nbsp;is&nbsp;for&nbsp;internal&nbsp;auditing&nbsp;of&nbsp;a&nbsp;small&nbsp;application.&nbsp;Only&nbsp;about&nbsp;6&nbsp;people&nbsp;have&nbsp;access&nbsp;to&nbsp;this&nbsp;information&nbsp;and&nbsp;it&nbsp;is&nbsp;primarily&nbsp;for&nbsp;catching&nbsp;mistakes,&nbsp;like&nbsp;someone&nbsp;put&nbsp;the&nbsp;size&nbsp;at&nbsp;6MB&nbsp;instead&nbsp;of&nbsp;6GB.&nbsp;There&nbsp;are&nbsp;no&nbsp;external&nbsp;reporting&nbsp;requirements&nbsp;and&nbsp;the&nbsp;last&nbsp;information&nbsp;saved&nbsp;is&nbsp;"good&nbsp;enough"&nbsp;for&nbsp;this&nbsp;application.</P>
<P>This&nbsp;auditing&nbsp;also&nbsp;has&nbsp;very&nbsp;little&nbsp;impact&nbsp;on&nbsp;the&nbsp;server.&nbsp;There&nbsp;is&nbsp;nothing&nbsp;to&nbsp;install,&nbsp;not&nbsp;overhead&nbsp;for&nbsp;object&nbsp;creation,&nbsp;and&nbsp;it's&nbsp;simple&nbsp;and&nbsp;self&nbsp;documenting.&nbsp;Anyone&nbsp;who&nbsp;can&nbsp;look&nbsp;at&nbsp;this&nbsp;record&nbsp;can&nbsp;see&nbsp;the&nbsp;audit.</P>
<P>There&nbsp;are&nbsp;problems&nbsp;with&nbsp;this&nbsp;type&nbsp;of&nbsp;audit,&nbsp;however.&nbsp;Not&nbsp;in&nbsp;my&nbsp;case,&nbsp;but&nbsp;most&nbsp;times&nbsp;the&nbsp;tracking&nbsp;of&nbsp;changes&nbsp;for&nbsp;a&nbsp;record&nbsp;is&nbsp;required.&nbsp;For&nbsp;example,&nbsp;if&nbsp;there&nbsp;were&nbsp;multiple&nbsp;backups&nbsp;made,&nbsp;and&nbsp;the&nbsp;filename&nbsp;was&nbsp;changed,&nbsp;the&nbsp;old&nbsp;data&nbsp;is&nbsp;lost.&nbsp;Only&nbsp;the&nbsp;most&nbsp;recent&nbsp;data&nbsp;is&nbsp;in&nbsp;the&nbsp;row&nbsp;and&nbsp;there&nbsp;is&nbsp;no&nbsp;way&nbsp;to&nbsp;backtrack&nbsp;through&nbsp;the&nbsp;old&nbsp;data.</P>
<P>There&nbsp;is&nbsp;also&nbsp;the&nbsp;loss&nbsp;of&nbsp;auditing&nbsp;data&nbsp;itself.&nbsp;If&nbsp;Bob&nbsp;changes&nbsp;this&nbsp;row&nbsp;and&nbsp;puts&nbsp;in&nbsp;the&nbsp;right&nbsp;information&nbsp;and&nbsp;then&nbsp;Andy&nbsp;updates&nbsp;the&nbsp;row&nbsp;with&nbsp;incorrect&nbsp;information,&nbsp;we&nbsp;lose&nbsp;the&nbsp;fact&nbsp;that&nbsp;Bob&nbsp;entered&nbsp;anything&nbsp;since&nbsp;we&nbsp;cannot&nbsp;track&nbsp;this&nbsp;change.&nbsp;</P>
<P>Conclusions<BR>I'm&nbsp;sure&nbsp;lots&nbsp;of&nbsp;you&nbsp;have&nbsp;other&nbsp;suggestions&nbsp;and&nbsp;I'd&nbsp;welcome&nbsp;hearing&nbsp;them,&nbsp;however&nbsp;keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;is&nbsp;a&nbsp;very&nbsp;simple&nbsp;auditing&nbsp;system.&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;other&nbsp;systems,&nbsp;like&nbsp;logging&nbsp;to&nbsp;a&nbsp;separate&nbsp;table,&nbsp;something&nbsp;I&nbsp;will&nbsp;tackle&nbsp;in&nbsp;the&nbsp;next&nbsp;article.&nbsp;</P>
<P>Steve&nbsp;Jones<BR>©dkRanch.net&nbsp;February&nbsp;2003&nbsp;</P></FONT>