<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Delete&nbsp;Old&nbsp;Files</B><BR>Delete&nbsp;Old&nbsp;Files
<P></P>
<P></P>
<P><BR>&gt;&gt;Script&nbsp;Language&nbsp;and&nbsp;Platform:&nbsp;SQL&nbsp;Server&nbsp;7.0&nbsp;and&nbsp;SQL&nbsp;Server&nbsp;2000<BR>This&nbsp;procedure&nbsp;deletes&nbsp;files&nbsp;that&nbsp;are&nbsp;older&nbsp;than&nbsp;a&nbsp;certain&nbsp;period&nbsp;from&nbsp;a&nbsp;folder.&nbsp;</P>
<P>Author:&nbsp;MAK&nbsp;[Muthusamy&nbsp;Anantha&nbsp;Kumar]&nbsp;<BR>Create&nbsp;procedure&nbsp;USP_DelOldFiles&nbsp;@path&nbsp;varchar(25),@duration&nbsp;int<BR>as<BR>--Objective:&nbsp;To&nbsp;delete&nbsp;files&nbsp;older&nbsp;than&nbsp;certain&nbsp;period&nbsp;from&nbsp;a&nbsp;folder<BR>--Usage&nbsp;example:&nbsp;<BR>--Exec&nbsp;USP_DelOldFiles&nbsp;'c:\test',30&nbsp;--&nbsp;which&nbsp;deletes&nbsp;files&nbsp;older&nbsp;than&nbsp;todaydate-30<BR>--Created&nbsp;by&nbsp;:MAK<BR>--Created&nbsp;date:&nbsp;Jan&nbsp;7,2003<BR>--OS:&nbsp;windows&nbsp;2000<BR>declare&nbsp;@myquery&nbsp;varchar(1000)<BR>declare&nbsp;@query&nbsp;varchar(1000)<BR>declare&nbsp;@name&nbsp;varchar(100)<BR>set&nbsp;@myquery&nbsp;=&nbsp;"exec&nbsp;master.dbo.xp_cmdshell&nbsp;'dir&nbsp;"+&nbsp;ltrim(rtrim(@path))&nbsp;+&nbsp;"\*.*&nbsp;/a/od'"<BR>print&nbsp;@query&nbsp;</P>
<P>create&nbsp;table&nbsp;#Filenames&nbsp;(id&nbsp;int&nbsp;identity(1,1)&nbsp;,name&nbsp;varchar(100))&nbsp;</P>
<P>insert&nbsp;#Filenames(name)<BR>exec&nbsp;(@Myquery)<BR>delete&nbsp;from&nbsp;#Filenames&nbsp;where&nbsp;substring(name,3,1)&nbsp;&lt;&gt;&nbsp;'/'&nbsp;or&nbsp;name&nbsp;is&nbsp;null&nbsp;or<BR>substring(name,25,1)&nbsp;='&lt;'&nbsp;</P>
<P>Declare&nbsp;mycursor&nbsp;cursor&nbsp;for&nbsp;<BR>select&nbsp;name&nbsp;from&nbsp;#Filenames&nbsp;where&nbsp;<BR>convert(datetime,left(name,10))&nbsp;&lt;=&nbsp;getdate()-@duration<BR>open&nbsp;mycursor&nbsp;</P>
<P>fetch&nbsp;next&nbsp;from&nbsp;mycursor&nbsp;into&nbsp;@name<BR>while&nbsp;(@@fetch_status&nbsp;=0)<BR>begin<BR>set&nbsp;@query&nbsp;=&nbsp;'exec&nbsp;master.dbo.xp_cmdshell&nbsp;"del&nbsp;'+@path+'\'+&nbsp;ltrim(rtrim(substring(@name,40,59)))+'"'<BR>--print&nbsp;@query<BR>exec&nbsp;(@query)<BR>fetch&nbsp;next&nbsp;from&nbsp;mycursor&nbsp;into&nbsp;@name<BR>end<BR>close&nbsp;mycursor&nbsp;<BR>deallocate&nbsp;mycursor&nbsp;</P>
<P>drop&nbsp;table&nbsp;#Filenames&nbsp;</P></FONT>