<meta http-equiv="content-type" content="text/html; charset=gb2312">create&nbsp;proc&nbsp;usp_remove_orphan_users&nbsp;as&nbsp;
<P></P>
<P>--&nbsp;Written&nbsp;by:&nbsp;Gregory&nbsp;A.&nbsp;Larsen&nbsp;&nbsp;<BR>--&nbsp;Script&nbsp;to&nbsp;modify&nbsp;database&nbsp;owner,&nbsp;and&nbsp;remove&nbsp;all&nbsp;users&nbsp;that&nbsp;<BR>--&nbsp;are&nbsp;not&nbsp;mapped&nbsp;to&nbsp;logins.</P>
<P>set&nbsp;nocount&nbsp;on</P>
<P>--&nbsp;Section&nbsp;1:&nbsp;Create&nbsp;temporary&nbsp;table&nbsp;to&nbsp;hold&nbsp;databases&nbsp;to&nbsp;process&nbsp;</P>
<P>--&nbsp;drop&nbsp;table&nbsp;if&nbsp;it&nbsp;already&nbsp;exists<BR>if&nbsp;(select&nbsp;object_id('tempdb..##dbnames'))&nbsp;is&nbsp;not&nbsp;null<BR>&nbsp;&nbsp;drop&nbsp;table&nbsp;##dbnames</P>
<P>--&nbsp;Create&nbsp;table&nbsp;to&nbsp;hold&nbsp;databases&nbsp;to&nbsp;process<BR>create&nbsp;table&nbsp;##dbnames&nbsp;(dbname&nbsp;varchar(128))</P>
<P>--&nbsp;Section&nbsp;2:&nbsp;Determine&nbsp;what&nbsp;databases&nbsp;have&nbsp;orphan&nbsp;users<BR>exec&nbsp;master.dbo.sp_MSforeachdb&nbsp;'insert&nbsp;into&nbsp;##dbnames&nbsp;select&nbsp;''?''&nbsp;from&nbsp;master..syslogins&nbsp;l&nbsp;right&nbsp;join&nbsp;?..sysusers&nbsp;u<BR>on&nbsp;l.sid&nbsp;=&nbsp;u.sid<BR>where&nbsp;l.sid&nbsp;is&nbsp;null&nbsp;and&nbsp;issqlrole&nbsp;&lt;&gt;&nbsp;1&nbsp;and&nbsp;isapprole&nbsp;&lt;&gt;&nbsp;1&nbsp;<BR>and&nbsp;(u.name&nbsp;&lt;&gt;&nbsp;''INFORMATION_SCHEMA''&nbsp;and&nbsp;u.name&nbsp;&lt;&gt;&nbsp;''guest''&nbsp;and&nbsp;u.name&nbsp;&lt;&gt;&nbsp;''system_function_schema'')&nbsp;<BR>having&nbsp;count(*)&nbsp;&gt;&nbsp;0'</P>
<P>--&nbsp;Section&nbsp;3:&nbsp;Create&nbsp;local&nbsp;variables&nbsp;needed<BR>declare&nbsp;@CNT&nbsp;int<BR>declare&nbsp;@name&nbsp;char(128)<BR>declare&nbsp;@sid&nbsp;&nbsp;varbinary(85)<BR>declare&nbsp;@cmd&nbsp;nchar(4000)<BR>declare&nbsp;@c&nbsp;int<BR>declare&nbsp;@hexnum&nbsp;char(100)<BR>declare&nbsp;@db&nbsp;varchar(100)&nbsp;</P>
<P>--&nbsp;Section&nbsp;5:&nbsp;Process&nbsp;through&nbsp;each&nbsp;database&nbsp;and&nbsp;remove&nbsp;orphan&nbsp;users<BR>select&nbsp;@cnt=count(*)&nbsp;from&nbsp;##DBNAMES<BR>While&nbsp;@CNT&nbsp;&gt;&nbsp;0<BR>begin</P>
<P>--&nbsp;get&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;top&nbsp;database<BR>&nbsp;&nbsp;select&nbsp;top&nbsp;1&nbsp;@db=dbname&nbsp;from&nbsp;##DBNAMES</P>
<P>--&nbsp;delete&nbsp;top&nbsp;database&nbsp;<BR>&nbsp;&nbsp;delete&nbsp;from&nbsp;##DBNAMES&nbsp;where&nbsp;dbname&nbsp;=&nbsp;@db</P>
<P>--&nbsp;Build&nbsp;and&nbsp;execute&nbsp;command&nbsp;to&nbsp;determine&nbsp;if&nbsp;DBO&nbsp;is&nbsp;not&nbsp;mapped&nbsp;to&nbsp;login<BR>&nbsp;&nbsp;set&nbsp;@cmd&nbsp;=&nbsp;'select&nbsp;@cnt&nbsp;=&nbsp;count(*)&nbsp;from&nbsp;master..syslogins&nbsp;l&nbsp;right&nbsp;join&nbsp;'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtrim(@db)&nbsp;+&nbsp;'..sysusers&nbsp;u&nbsp;on&nbsp;l.sid&nbsp;=&nbsp;u.sid'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;where&nbsp;l.sid&nbsp;is&nbsp;null&nbsp;and&nbsp;u.name&nbsp;=&nbsp;''DBO'''<BR>&nbsp;&nbsp;exec&nbsp;sp_executesql&nbsp;@cmd,N'@cnt&nbsp;int&nbsp;out',@cnt&nbsp;out</P>
<P>--&nbsp;if&nbsp;DB&nbsp;is&nbsp;not&nbsp;mapped&nbsp;to&nbsp;login&nbsp;that&nbsp;exists&nbsp;map&nbsp;DBO&nbsp;to&nbsp;SA<BR>&nbsp;&nbsp;if&nbsp;@cnt&nbsp;=&nbsp;1<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;'exec&nbsp;'&nbsp;+&nbsp;@db&nbsp;+&nbsp;'..sp_changedbowner&nbsp;''SA'''&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;exec&nbsp;sp_changedbowner&nbsp;'SA'<BR>&nbsp;&nbsp;end&nbsp;--&nbsp;if&nbsp;@cnt&nbsp;=&nbsp;1</P>
<P><BR>--&nbsp;drop&nbsp;table&nbsp;if&nbsp;it&nbsp;already&nbsp;exists<BR>if&nbsp;(select&nbsp;object_id('tempdb..##orphans'))&nbsp;is&nbsp;not&nbsp;null<BR>&nbsp;&nbsp;drop&nbsp;table&nbsp;##orphans</P>
<P>--&nbsp;Create&nbsp;table&nbsp;to&nbsp;hold&nbsp;orphan&nbsp;users<BR>create&nbsp;table&nbsp;##orphans&nbsp;(orphan&nbsp;varchar(128))</P>
<P>--&nbsp;Build&nbsp;and&nbsp;execute&nbsp;command&nbsp;to&nbsp;get&nbsp;list&nbsp;of&nbsp;all&nbsp;orphan&nbsp;users&nbsp;(Windows&nbsp;and&nbsp;SQL&nbsp;Server)<BR>--&nbsp;for&nbsp;current&nbsp;database&nbsp;being&nbsp;processed<BR>&nbsp;&nbsp;&nbsp;set&nbsp;@cmd&nbsp;=&nbsp;'insert&nbsp;into&nbsp;##orphans&nbsp;select&nbsp;u.name&nbsp;from&nbsp;master..syslogins&nbsp;l&nbsp;right&nbsp;join&nbsp;'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtrim(@db)&nbsp;+&nbsp;'..sysusers&nbsp;u&nbsp;on&nbsp;l.sid&nbsp;=&nbsp;u.sid&nbsp;'&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'where&nbsp;l.sid&nbsp;is&nbsp;null&nbsp;and&nbsp;issqlrole&nbsp;&lt;&gt;&nbsp;1&nbsp;and&nbsp;isapprole&nbsp;&lt;&gt;&nbsp;1&nbsp;'&nbsp;+&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'and&nbsp;(u.name&nbsp;&lt;&gt;&nbsp;''INFORMATION_SCHEMA''&nbsp;and&nbsp;u.name&nbsp;&lt;&gt;&nbsp;''guest''&nbsp;'&nbsp;+&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'and&nbsp;u.name&nbsp;&lt;&gt;&nbsp;''system_function_schema'')'<BR>&nbsp;&nbsp;&nbsp;exec&nbsp;(@cmd)</P>
<P><BR>--&nbsp;Are&nbsp;there&nbsp;orphans<BR>&nbsp;&nbsp;select&nbsp;@cnt&nbsp;=&nbsp;count(*)&nbsp;from&nbsp;##orphans<BR>&nbsp;&nbsp;<BR>&nbsp;&nbsp;WHILE&nbsp;@cnt&nbsp;&gt;&nbsp;0&nbsp;<BR>&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;<BR>--&nbsp;get&nbsp;top&nbsp;orphan<BR>&nbsp;&nbsp;select&nbsp;top&nbsp;1&nbsp;@name=&nbsp;orphan&nbsp;from&nbsp;##orphans</P>
<P>--&nbsp;delete&nbsp;top&nbsp;orphan<BR>&nbsp;&nbsp;delete&nbsp;from&nbsp;##orphans&nbsp;where&nbsp;orphan&nbsp;=&nbsp;@name</P>
<P>--&nbsp;Build&nbsp;command&nbsp;to&nbsp;drop&nbsp;user&nbsp;from&nbsp;database.<BR>&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@cmd&nbsp;=&nbsp;'exec&nbsp;'&nbsp;+&nbsp;rtrim(@db)&nbsp;+&nbsp;'..sp_revokedbaccess&nbsp;'''&nbsp;+&nbsp;rtrim(@name)&nbsp;+&nbsp;''''<BR>&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;@cmd<BR>&nbsp;&nbsp;&nbsp;&nbsp;--exec&nbsp;(@cmd)</P>
<P>&nbsp;&nbsp;&nbsp;<BR>--&nbsp;are&nbsp;there&nbsp;orphans&nbsp;left<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@cnt&nbsp;=&nbsp;count(*)&nbsp;from&nbsp;##orphans&nbsp;&nbsp;<BR>&nbsp;&nbsp;end&nbsp;--&nbsp;&nbsp;WHILE&nbsp;@cnt&nbsp;&gt;&nbsp;0</P>
<P><BR>--&nbsp;are&nbsp;the&nbsp;still&nbsp;databases&nbsp;to&nbsp;process<BR>select&nbsp;@cnt=count(*)&nbsp;from&nbsp;##dbnames</P>
<P>end&nbsp;--&nbsp;while&nbsp;@cnt&nbsp;&gt;&nbsp;0</P>
<P>--&nbsp;Remove&nbsp;temporary&nbsp;tables<BR>drop&nbsp;table&nbsp;##dbnames,&nbsp;##orphans</P>