<meta http-equiv="content-type" content="text/html; charset=gb2312">I&nbsp;recently&nbsp;had&nbsp;the&nbsp;basic&nbsp;need&nbsp;to&nbsp;retrieve&nbsp;a&nbsp;record&nbsp;from&nbsp;the&nbsp;database&nbsp;at&nbsp;random.&nbsp;What&nbsp;seemed&nbsp;to&nbsp;be&nbsp;an&nbsp;easy&nbsp;task&nbsp;quickly&nbsp;became&nbsp;a&nbsp;complex&nbsp;one.&nbsp;This&nbsp;case&nbsp;showed&nbsp;an&nbsp;interesting&nbsp;quirk&nbsp;with&nbsp;T-SQL&nbsp;that&nbsp;was&nbsp;resolved&nbsp;in&nbsp;an&nbsp;equally&nbsp;quirky&nbsp;way.&nbsp;This&nbsp;quick&nbsp;article&nbsp;shows&nbsp;you&nbsp;a&nbsp;method&nbsp;to&nbsp;retrieve&nbsp;random&nbsp;data&nbsp;or&nbsp;randomize&nbsp;the&nbsp;display&nbsp;of&nbsp;data.&nbsp;<BR>Why&nbsp;would&nbsp;you&nbsp;ever&nbsp;want&nbsp;to&nbsp;retrieve&nbsp;random&nbsp;data?&nbsp;
<P></P>
<P>In&nbsp;my&nbsp;case,&nbsp;I&nbsp;wanted&nbsp;to&nbsp;pull&nbsp;a&nbsp;random&nbsp;article&nbsp;to&nbsp;display&nbsp;on&nbsp;this&nbsp;site’s&nbsp;homepage&nbsp;<BR>Choose&nbsp;a&nbsp;random&nbsp;user&nbsp;to&nbsp;receive&nbsp;a&nbsp;prize&nbsp;<BR>Choose&nbsp;a&nbsp;random&nbsp;employee&nbsp;for&nbsp;a&nbsp;drug&nbsp;test&nbsp;<BR>The&nbsp;problem&nbsp;with&nbsp;retrieving&nbsp;random&nbsp;data&nbsp;using&nbsp;the&nbsp;RAND()&nbsp;function&nbsp;is&nbsp;how&nbsp;it’s&nbsp;actually&nbsp;used&nbsp;in&nbsp;the&nbsp;query.&nbsp;For&nbsp;example,&nbsp;if&nbsp;you&nbsp;run&nbsp;the&nbsp;below&nbsp;query&nbsp;against&nbsp;the&nbsp;Northwind&nbsp;database,&nbsp;you&nbsp;can&nbsp;see&nbsp;that&nbsp;you&nbsp;will&nbsp;see&nbsp;the&nbsp;same&nbsp;random&nbsp;value&nbsp;and&nbsp;date&nbsp;for&nbsp;each&nbsp;row&nbsp;in&nbsp;the&nbsp;results.&nbsp;</P>
<P><BR>SELECT&nbsp;TOP&nbsp;3&nbsp;RAND(),&nbsp;GETDATE(),&nbsp;ProductID,&nbsp;ProductName<BR>FROM&nbsp;Products</P>
<P>Results:<BR>0.54429273766415864&nbsp;&nbsp;2003-03-19&nbsp;15:06:27.327&nbsp;17&nbsp;Alice&nbsp;Mutton&nbsp;<BR>0.54429273766415864&nbsp;&nbsp;2003-03-19&nbsp;15:06:27.327&nbsp;3&nbsp;Aniseed&nbsp;Syrup&nbsp;<BR>0.54429273766415864&nbsp;&nbsp;2003-03-19&nbsp;15:06:27.327&nbsp;40&nbsp;Boston&nbsp;Crab&nbsp;Meat&nbsp;</P>
<P>This&nbsp;behavior&nbsp;prohibits&nbsp;the&nbsp;obvious&nbsp;way&nbsp;to&nbsp;retrieve&nbsp;random&nbsp;data&nbsp;by&nbsp;using&nbsp;a&nbsp;query&nbsp;like&nbsp;this:&nbsp;</P>
<P><BR>SELECT&nbsp;TOP&nbsp;3&nbsp;ProductID,&nbsp;ProductName&nbsp;<BR>FROM&nbsp;products<BR>ORDER&nbsp;BY&nbsp;RAND()</P>
<P>Results&nbsp;in:</P>
<P>ProductID&nbsp;&nbsp;&nbsp;ProductName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>-----------&nbsp;----------------------------------------&nbsp;<BR>17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Alice&nbsp;Mutton<BR>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aniseed&nbsp;Syrup<BR>40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Boston&nbsp;Crab&nbsp;Meat</P>
<P>If&nbsp;you&nbsp;execute&nbsp;this&nbsp;query&nbsp;over&nbsp;and&nbsp;over&nbsp;again,&nbsp;you&nbsp;should&nbsp;see&nbsp;the&nbsp;same&nbsp;results&nbsp;each&nbsp;time.&nbsp;The&nbsp;trick&nbsp;then&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;system&nbsp;function&nbsp;that&nbsp;doesn’t&nbsp;use&nbsp;this&nbsp;type&nbsp;of&nbsp;behavior.&nbsp;The&nbsp;newid()&nbsp;function&nbsp;is&nbsp;a&nbsp;system&nbsp;function&nbsp;used&nbsp;in&nbsp;replication&nbsp;that&nbsp;produces&nbsp;a&nbsp;Global&nbsp;Unique&nbsp;Identifier&nbsp;(GUID).&nbsp;You&nbsp;can&nbsp;see&nbsp;in&nbsp;the&nbsp;following&nbsp;query&nbsp;that&nbsp;it&nbsp;produces&nbsp;unique&nbsp;records&nbsp;at&nbsp;the&nbsp;row-level.&nbsp;</P>
<P></P>
<P>SELECT&nbsp;TOP&nbsp;3&nbsp;newid(),&nbsp;ProductID,&nbsp;ProductName<BR>FROM&nbsp;Products</P>
<P>Results&nbsp;in:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProductID&nbsp;&nbsp;&nbsp;ProductName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>------------------------------------&nbsp;&nbsp;&nbsp;&nbsp;-----------&nbsp;----------------------------------------&nbsp;<BR>8D0A4758-0C90-49DC-AF3A-3FC949540B45&nbsp;&nbsp;17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Alice&nbsp;Mutton<BR>E6460D00-A5D1-4ADC-86D5-DE8A08C2DCF0&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aniseed&nbsp;Syrup<BR>FC0D00BF-F3A2-4341-A584-728DC8DDA513&nbsp;&nbsp;40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Boston&nbsp;Crab&nbsp;Meat</P>
<P>You&nbsp;can&nbsp;also&nbsp;execute&nbsp;the&nbsp;following&nbsp;query&nbsp;to&nbsp;randomize&nbsp;your&nbsp;data&nbsp;(TOP&nbsp;clause&nbsp;optional):</P>
<P>SELECT&nbsp;TOP&nbsp;1&nbsp;ProductID,&nbsp;ProductName&nbsp;<BR>FROM&nbsp;products<BR>ORDER&nbsp;BY&nbsp;NEWID()</P>
<P>Results&nbsp;in:</P>
<P>ProductID&nbsp;&nbsp;&nbsp;ProductName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>-----------&nbsp;----------------------------------------&nbsp;<BR>7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Uncle&nbsp;Bob's&nbsp;Organic&nbsp;Dried&nbsp;Pears</P>
<P>Each&nbsp;time&nbsp;you&nbsp;fire&nbsp;it&nbsp;off,&nbsp;you&nbsp;should&nbsp;retrieve&nbsp;a&nbsp;different&nbsp;result.&nbsp;There’s&nbsp;also&nbsp;an&nbsp;additional&nbsp;way&nbsp;to&nbsp;actually&nbsp;use&nbsp;the&nbsp;rand()&nbsp;function&nbsp;that&nbsp;Itzik&nbsp;Ben-Gan&nbsp;has&nbsp;discovered&nbsp;using&nbsp;user&nbsp;defined&nbsp;functions&nbsp;and&nbsp;views&nbsp;as&nbsp;a&nbsp;workaround.&nbsp;The&nbsp;secret&nbsp;there&nbsp;is&nbsp;to&nbsp;produce&nbsp;a&nbsp;view&nbsp;that&nbsp;uses&nbsp;the&nbsp;rand()&nbsp;function&nbsp;as&nbsp;shown&nbsp;below:&nbsp;</P>
<P></P>
<P>CREATE&nbsp;VIEW&nbsp;VRand<BR>AS<BR>&nbsp;&nbsp;SELECT&nbsp;RAND()&nbsp;AS&nbsp;rnd<BR>GO</P>
<P>Then&nbsp;create&nbsp;a&nbsp;user&nbsp;defined&nbsp;function&nbsp;(only&nbsp;works&nbsp;in&nbsp;SQL&nbsp;Server&nbsp;2000)&nbsp;that&nbsp;selects&nbsp;from&nbsp;the&nbsp;view&nbsp;and&nbsp;returns&nbsp;the&nbsp;random&nbsp;value.&nbsp;</P>
<P></P>
<P>CREATE&nbsp;FUNCTION&nbsp;dbo.fn_row_rand()&nbsp;RETURNS&nbsp;FLOAT<BR>AS<BR>BEGIN<BR>&nbsp;&nbsp;RETURN&nbsp;(SELECT&nbsp;rnd&nbsp;FROM&nbsp;VRand)<BR>END</P>
<P>To&nbsp;use&nbsp;the&nbsp;function,&nbsp;you&nbsp;can&nbsp;use&nbsp;syntax&nbsp;as&nbsp;shown&nbsp;below&nbsp;to&nbsp;retrieve&nbsp;random&nbsp;records.&nbsp;</P>
<P>SELECT&nbsp;TOP&nbsp;1&nbsp;ProductID,&nbsp;ProductName&nbsp;<BR>FROM&nbsp;Products<BR>ORDER&nbsp;BY&nbsp;dbo.fn_row_rand()<BR>GO</P>
<P>This&nbsp;is&nbsp;also&nbsp;handy&nbsp;if&nbsp;you&nbsp;wish&nbsp;to&nbsp;use&nbsp;the&nbsp;getdate()&nbsp;function&nbsp;at&nbsp;the&nbsp;record&nbsp;level&nbsp;to&nbsp;display&nbsp;data.&nbsp;I&nbsp;have&nbsp;found&nbsp;that&nbsp;this&nbsp;method&nbsp;has&nbsp;slight&nbsp;performance&nbsp;enhancement&nbsp;but&nbsp;it&nbsp;is&nbsp;negligible.&nbsp;Make&nbsp;sure&nbsp;you&nbsp;test&nbsp;between&nbsp;the&nbsp;two&nbsp;methods&nbsp;before&nbsp;you&nbsp;use&nbsp;either.</P>