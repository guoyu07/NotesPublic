<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>see&nbsp;if&nbsp;a&nbsp;job&nbsp;is&nbsp;currently&nbsp;running</B><BR>Script&nbsp;to&nbsp;See&nbsp;if&nbsp;a&nbsp;Job&nbsp;is&nbsp;Running
<P></P>
<P></P>
<P><BR>Here's&nbsp;a&nbsp;simple&nbsp;script&nbsp;that&nbsp;checks&nbsp;to&nbsp;see&nbsp;if&nbsp;a&nbsp;job&nbsp;is&nbsp;currently&nbsp;running.&nbsp;</P>
<P>Updated&nbsp;on&nbsp;1/18/02&nbsp;with&nbsp;a&nbsp;working&nbsp;example&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;the&nbsp;script&nbsp;in&nbsp;the&nbsp;comments&nbsp;section.&nbsp;</P>
<P>Author:&nbsp;Allan&nbsp;Saywitz&nbsp;</P>
<P><BR>/*&nbsp;===============================================================================</P>
<P>Name:<BR>&nbsp;sp_IsJobRunning.sql</P>
<P>Description:<BR>&nbsp;See&nbsp;if&nbsp;a&nbsp;job&nbsp;is&nbsp;running.</P>
<P>Inputs:<BR>&nbsp;@JobName&nbsp;-&nbsp;name&nbsp;of&nbsp;job&nbsp;to&nbsp;see&nbsp;if&nbsp;running.</P>
<P>Outputs:<BR>&nbsp;@IsRunning&nbsp;-&nbsp;job&nbsp;running&nbsp;status.&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;'Y'&nbsp;=&nbsp;job&nbsp;is&nbsp;running.<BR>&nbsp;&nbsp;&nbsp;'N'&nbsp;=&nbsp;job&nbsp;is&nbsp;not&nbsp;running.</P>
<P>Returns:<BR>&nbsp;1&nbsp;-&nbsp;error&nbsp;occurred.<BR>&nbsp;0&nbsp;-&nbsp;no&nbsp;error&nbsp;occurred.</P>
<P>Example:<BR>&nbsp;Declare&nbsp;@IsRunning&nbsp;char(1)<BR>&nbsp;EXEC&nbsp;sp_IsJobRunning&nbsp;"some&nbsp;job&nbsp;name",&nbsp;@IsRunning&nbsp;OUTPUT<BR>&nbsp;IF&nbsp;@IsRunning&nbsp;=&nbsp;'Y'<BR>&nbsp;&nbsp;Print&nbsp;'Job&nbsp;is&nbsp;Running'<BR>&nbsp;ELSE<BR>&nbsp;&nbsp;Print&nbsp;'Job&nbsp;is&nbsp;not&nbsp;Running'</P>
<P><BR>Author:&nbsp;Allan&nbsp;Saywitz,&nbsp;divine&nbsp;inc.</P>
<P>Revision&nbsp;History:<BR>&nbsp;12/10/2001&nbsp;&nbsp;Created.</P>
<P>===============================================================================&nbsp;*/</P>
<P>IF&nbsp;EXISTS&nbsp;(SELECT&nbsp;*&nbsp;<BR>&nbsp;&nbsp;&nbsp;FROM&nbsp;sysobjects&nbsp;<BR>&nbsp;&nbsp;&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;object_id('sp_IsJobRunning')&nbsp;<BR>&nbsp;&nbsp;&nbsp;AND&nbsp;OBJECTPROPERTY(id,&nbsp;'IsProcedure')&nbsp;=&nbsp;1<BR>)<BR>DROP&nbsp;PROC&nbsp;sp_IsJobRunning<BR>GO</P>
<P>CREATE&nbsp;PROC&nbsp;sp_IsJobRunning<BR>(<BR>&nbsp;&nbsp;&nbsp;&nbsp;@JobName&nbsp;&nbsp;&nbsp;varchar(64),<BR>&nbsp;&nbsp;&nbsp;&nbsp;@IsRunning&nbsp;char(1)&nbsp;OUTPUT<BR>)<BR>AS</P>
<P>BEGIN</P>
<P>&nbsp;SET&nbsp;NOCOUNT&nbsp;ON</P>
<P>&nbsp;--&nbsp;declare&nbsp;variables&nbsp;<BR>&nbsp;DECLARE<BR>&nbsp;&nbsp;@job_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uniqueidentifier,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@is_sysadmin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int,<BR>&nbsp;&nbsp;@job_owner&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sysname,<BR>&nbsp;&nbsp;@execution_status&nbsp;int</P>
<P>&nbsp;--&nbsp;initialize&nbsp;variables&nbsp;<BR>&nbsp;SET&nbsp;@IsRunning&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'N'<BR>&nbsp;SET&nbsp;@job_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;NULL<BR>&nbsp;SET&nbsp;@is_sysadmin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0<BR>&nbsp;SET&nbsp;@job_owner&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;NULL<BR>&nbsp;SET&nbsp;@execution_status&nbsp;=&nbsp;0</P>
<P>&nbsp;--&nbsp;set&nbsp;job&nbsp;id<BR>&nbsp;SET&nbsp;@job_id&nbsp;=&nbsp;(SELECT&nbsp;job_id&nbsp;FROM&nbsp;msdb..sysjobs&nbsp;WHERE&nbsp;name&nbsp;=&nbsp;@JobName)<BR>&nbsp;IF&nbsp;(@job_id&nbsp;IS&nbsp;NULL)<BR>&nbsp;BEGIN<BR>&nbsp;&nbsp;RAISERROR('Unknown&nbsp;job&nbsp;name',&nbsp;16,&nbsp;1)<BR>&nbsp;&nbsp;RETURN&nbsp;1<BR>&nbsp;END<BR>&nbsp;<BR>&nbsp;--&nbsp;create&nbsp;temp&nbsp;table<BR>&nbsp;CREATE&nbsp;TABLE&nbsp;#xp_results<BR>&nbsp;(<BR>&nbsp;&nbsp;job_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNIQUEIDENTIFIER&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;last_run_date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;last_run_time&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;next_run_date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;next_run_time&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;next_run_schedule_id&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;requested_to_run&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR>&nbsp;&nbsp;NULL,&nbsp;<BR>&nbsp;&nbsp;request_source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;request_source_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sysname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,<BR>&nbsp;&nbsp;running&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR>&nbsp;&nbsp;NULL,&nbsp;<BR>&nbsp;&nbsp;current_step&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;current_retry_attempt&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL,<BR>&nbsp;&nbsp;job_state&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT&nbsp;NULL<BR>&nbsp;)</P>
<P>&nbsp;--&nbsp;set&nbsp;sysadmin&nbsp;flag<BR>&nbsp;SELECT&nbsp;@is_sysadmin&nbsp;=&nbsp;ISNULL(IS_SRVROLEMEMBER(N'sysadmin'),&nbsp;0)</P>
<P>&nbsp;--&nbsp;set&nbsp;job&nbsp;owner<BR>&nbsp;SELECT&nbsp;@job_owner&nbsp;=&nbsp;SUSER_SNAME()</P>
<P>&nbsp;--&nbsp;populate&nbsp;#xp_results<BR>&nbsp;INSERT&nbsp;INTO&nbsp;#xp_results&nbsp;EXECUTE&nbsp;master.dbo.xp_sqlagent_enum_jobs&nbsp;@is_sysadmin,&nbsp;@job_owner</P>
<P>&nbsp;--&nbsp;set&nbsp;execution&nbsp;status<BR>&nbsp;SET&nbsp;@execution_status&nbsp;=&nbsp;(SELECT&nbsp;job_state&nbsp;FROM&nbsp;#xp_results&nbsp;WHERE&nbsp;job_id&nbsp;=&nbsp;@job_id)</P>
<P>&nbsp;--&nbsp;set&nbsp;is&nbsp;running&nbsp;flag<BR>&nbsp;IF&nbsp;(@execution_status&nbsp;=&nbsp;1)<BR>&nbsp;BEGIN<BR>&nbsp;&nbsp;SET&nbsp;@IsRunning&nbsp;=&nbsp;'Y'<BR>&nbsp;END</P>
<P>&nbsp;--&nbsp;drop&nbsp;#xp_results<BR>&nbsp;IF&nbsp;EXISTS&nbsp;(SELECT&nbsp;1&nbsp;WHERE&nbsp;(OBJECT_ID('tempdb..#xp_results')&nbsp;IS&nbsp;NOT&nbsp;NULL)&nbsp;)<BR>&nbsp;BEGIN<BR>&nbsp;&nbsp;DROP&nbsp;TABLE&nbsp;#xp_results<BR>&nbsp;END</P>
<P>&nbsp;SET&nbsp;NOCOUNT&nbsp;OFF</P>
<P>&nbsp;RETURN&nbsp;0</P>
<P>END<BR>GO</P></FONT>