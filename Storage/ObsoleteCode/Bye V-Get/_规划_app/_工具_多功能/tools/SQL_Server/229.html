<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Script&nbsp;to&nbsp;Count&nbsp;Rows&nbsp;in&nbsp;SPs</B><BR>Script&nbsp;to&nbsp;Count&nbsp;Rows&nbsp;in&nbsp;SPs
<P></P>
<P></P>
<P><BR>This&nbsp;stored&nbsp;procedure&nbsp;for&nbsp;SQL&nbsp;Server&nbsp;7.0&nbsp;and&nbsp;2000&nbsp;will&nbsp;return&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;for&nbsp;stored&nbsp;procedures.&nbsp;Setting&nbsp;the&nbsp;parameter&nbsp;to&nbsp;a&nbsp;stored&nbsp;procedure&nbsp;name&nbsp;will&nbsp;return&nbsp;the&nbsp;count&nbsp;of&nbsp;rows&nbsp;for&nbsp;that&nbsp;procedure.&nbsp;Omitting&nbsp;the&nbsp;parameter&nbsp;or&nbsp;setting&nbsp;it&nbsp;to&nbsp;NULL&nbsp;will&nbsp;return&nbsp;all&nbsp;the&nbsp;stored&nbsp;procedures&nbsp;in&nbsp;the&nbsp;database&nbsp;and&nbsp;the&nbsp;row&nbsp;count&nbsp;for&nbsp;each.&nbsp;</P>
<P>Updated&nbsp;on&nbsp;3/12/02&nbsp;to&nbsp;correct&nbsp;a&nbsp;typographical&nbsp;error&nbsp;--&nbsp;the&nbsp;script&nbsp;contained&nbsp;an&nbsp;extra&nbsp;"and"&nbsp;that&nbsp;made&nbsp;it&nbsp;fail.&nbsp;</P>
<P>Author:&nbsp;Neil&nbsp;Mederich&nbsp;<BR>USE&nbsp;master<BR>go<BR>IF&nbsp;EXISTS(SELECT&nbsp;*&nbsp;FROM&nbsp;sysobjects&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;object_id('sp_getsprowcount')&nbsp;and&nbsp;objectproperty(id,'IsProcedure')=1)<BR>&nbsp;drop&nbsp;proc&nbsp;sp_getSProwcount<BR>go<BR>CREATE&nbsp;procedure&nbsp;sp_getSProwcount&nbsp;@ProcName&nbsp;varchar(128)=NULL<BR>as<BR>-------------------------------------------------------------------<BR>--&nbsp;Author:&nbsp;Neil&nbsp;Mederich<BR>--&nbsp;&nbsp;&nbsp;Date:&nbsp;2/6/2002<BR>--Purpose:&nbsp;Provide&nbsp;row&nbsp;counts&nbsp;for&nbsp;stored&nbsp;procedures<BR>--Remarks:&nbsp;Will&nbsp;not&nbsp;provide&nbsp;row&nbsp;count&nbsp;for&nbsp;encrypted&nbsp;procedures<BR>-------------------------------------------------------------------<BR>SET&nbsp;nocount&nbsp;on&nbsp;</P>
<P>DECLARE&nbsp;@strSQL&nbsp;varchar(350)<BR>DECLARE&nbsp;@dbname&nbsp;sysname</P>
<P>CREATE&nbsp;TABLE&nbsp;#spcount&nbsp;(sptext&nbsp;varchar(255))&nbsp;</P>
<P>IF&nbsp;@ProcName&nbsp;IS&nbsp;NOT&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;IF&nbsp;object_id(@ProcName)&nbsp;is&nbsp;null<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;@dbname&nbsp;=&nbsp;db_name()<BR>&nbsp;&nbsp;&nbsp;&nbsp;RAISERROR(15009,-1,-1,@ProcName,@dbname)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN&nbsp;(1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END</P>
<P>&nbsp;&nbsp;SET&nbsp;@strSQL&nbsp;=&nbsp;'insert&nbsp;#spcount&nbsp;EXECUTE&nbsp;sp_helptext&nbsp;'''&nbsp;+&nbsp;@ProcName&nbsp;+&nbsp;''''<BR>&nbsp;&nbsp;EXECUTE(@strsql)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;@ProcName&nbsp;as&nbsp;spname,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count(*)&nbsp;as&nbsp;[rows]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;#spcount</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN(0)&nbsp;<BR>&nbsp;&nbsp;&nbsp;END</P>
<P>SELECT&nbsp;b.[name]&nbsp;+&nbsp;'.'&nbsp;+&nbsp;a.[name]&nbsp;as&nbsp;spname,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;as&nbsp;[rows]<BR>&nbsp;&nbsp;INTO&nbsp;#one<BR>&nbsp;&nbsp;FROM&nbsp;sysobjects&nbsp;a&nbsp;INNER&nbsp;JOIN&nbsp;sysusers&nbsp;b<BR>&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;a.uid&nbsp;=&nbsp;b.uid<BR>&nbsp;WHERE&nbsp;xtype&nbsp;=&nbsp;'p'&nbsp;</P>
<P></P>
<P>DECLARE&nbsp;@x&nbsp;varchar(257)<BR>DECLARE&nbsp;@count&nbsp;int&nbsp;</P>
<P>DECLARE&nbsp;cone&nbsp;CURSOR&nbsp;FOR<BR>&nbsp;SELECT&nbsp;spname&nbsp;<BR>&nbsp;&nbsp;&nbsp;FROM&nbsp;#one&nbsp;</P>
<P>OPEN&nbsp;cone&nbsp;</P>
<P>FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cone&nbsp;INTO&nbsp;@x&nbsp;</P>
<P>WHILE&nbsp;@@FETCH_status=0<BR>&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;TRUNCATE&nbsp;TABLE&nbsp;#spcount<BR>&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;@strSQL&nbsp;=&nbsp;'insert&nbsp;#spcount&nbsp;EXECUTE&nbsp;sp_helptext&nbsp;'''&nbsp;+&nbsp;@x&nbsp;+&nbsp;''''<BR>&nbsp;&nbsp;&nbsp;&nbsp;EXECUTE(@strsql)<BR>&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;@count&nbsp;=&nbsp;count(*)&nbsp;FROM&nbsp;#spcount<BR>&nbsp;&nbsp;&nbsp;&nbsp;UPDATE&nbsp;#one&nbsp;SET&nbsp;[rows]&nbsp;=&nbsp;@count&nbsp;WHERE&nbsp;spname&nbsp;=&nbsp;@x<BR>&nbsp;&nbsp;&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cone&nbsp;INTO&nbsp;@x&nbsp;&nbsp;<BR>&nbsp;&nbsp;END<BR>CLOSE&nbsp;cone<BR>DEALLOCATE&nbsp;cone&nbsp;</P>
<P>SELECT&nbsp;*&nbsp;FROM&nbsp;#one&nbsp;<BR>go</P></FONT>