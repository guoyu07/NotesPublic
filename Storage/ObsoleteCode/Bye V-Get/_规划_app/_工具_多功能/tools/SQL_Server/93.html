<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>º¯Êý-Function&nbsp;Primer</B><BR>Introduction<BR>Many&nbsp;programming&nbsp;languages&nbsp;have&nbsp;supported&nbsp;User&nbsp;Defined&nbsp;Functions&nbsp;for&nbsp;years,&nbsp;but&nbsp;they&nbsp;are&nbsp;new&nbsp;to&nbsp;SQL&nbsp;Server&nbsp;2000.&nbsp;In&nbsp;this&nbsp;article&nbsp;we&nbsp;will&nbsp;look&nbsp;at&nbsp;some&nbsp;of&nbsp;the&nbsp;ways&nbsp;functions&nbsp;can&nbsp;be&nbsp;used&nbsp;within&nbsp;SQL&nbsp;Server&nbsp;2000.
<P></P>
<P>This&nbsp;document&nbsp;was&nbsp;developed&nbsp;against&nbsp;SQL&nbsp;Server&nbsp;2000&nbsp;Beta&nbsp;2,&nbsp;so&nbsp;some&nbsp;points&nbsp;may&nbsp;be&nbsp;subject&nbsp;to&nbsp;change&nbsp;in&nbsp;the&nbsp;release&nbsp;version.</P>
<P>What&nbsp;are&nbsp;functions?<BR>Functions&nbsp;are&nbsp;pre-prepared&nbsp;pieces&nbsp;of&nbsp;code&nbsp;that&nbsp;may&nbsp;accept&nbsp;parameters,&nbsp;and&nbsp;always&nbsp;return&nbsp;a&nbsp;value.&nbsp;Older&nbsp;versions&nbsp;of&nbsp;SQL&nbsp;Server&nbsp;supply&nbsp;some&nbsp;built-in&nbsp;functions,&nbsp;such&nbsp;as&nbsp;getdate()&nbsp;and&nbsp;object_name()&nbsp;but&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;define&nbsp;your&nbsp;own&nbsp;functions&nbsp;is&nbsp;a&nbsp;new&nbsp;feature&nbsp;in&nbsp;SQL&nbsp;Server&nbsp;2000.&nbsp;</P>
<P>Throughout&nbsp;the&nbsp;text&nbsp;I&nbsp;will&nbsp;use&nbsp;the&nbsp;abbreviation&nbsp;UDF&nbsp;for&nbsp;User&nbsp;Defined&nbsp;Function.</P>
<P>All&nbsp;functions&nbsp;(not&nbsp;just&nbsp;UDFs)&nbsp;are&nbsp;split&nbsp;into&nbsp;two&nbsp;groups,&nbsp;deterministic&nbsp;and&nbsp;non-deterministic.&nbsp;Deterministic&nbsp;functions&nbsp;will&nbsp;always&nbsp;return&nbsp;the&nbsp;save&nbsp;value&nbsp;if&nbsp;provided&nbsp;with&nbsp;the&nbsp;same&nbsp;parameters.&nbsp;Non-deterministic&nbsp;functions&nbsp;may&nbsp;produce&nbsp;different&nbsp;results&nbsp;each&nbsp;time&nbsp;they&nbsp;are&nbsp;called,&nbsp;even&nbsp;if&nbsp;any&nbsp;supplied&nbsp;parameters&nbsp;are&nbsp;unchanged.</P>
<P>SQL&nbsp;Server&nbsp;Books&nbsp;Online&nbsp;also&nbsp;uses&nbsp;the&nbsp;term&nbsp;"scalar&nbsp;functions"&nbsp;-&nbsp;these&nbsp;are&nbsp;simply&nbsp;functions&nbsp;that&nbsp;return&nbsp;one&nbsp;value,&nbsp;as&nbsp;opposed&nbsp;to&nbsp;functions&nbsp;that&nbsp;return&nbsp;a&nbsp;table.</P>
<P>getdate()&nbsp;is&nbsp;a&nbsp;good&nbsp;example&nbsp;of&nbsp;both&nbsp;a&nbsp;scalar&nbsp;and&nbsp;a&nbsp;non-deterministic&nbsp;function&nbsp;-&nbsp;call&nbsp;it&nbsp;twice&nbsp;in&nbsp;a&nbsp;row&nbsp;and&nbsp;you&nbsp;will&nbsp;get&nbsp;two&nbsp;different&nbsp;date-time&nbsp;results,&nbsp;but&nbsp;only&nbsp;one&nbsp;value&nbsp;from&nbsp;each&nbsp;call.</P>
<P>A&nbsp;simple&nbsp;UDF<BR>It's&nbsp;not&nbsp;uncommon&nbsp;to&nbsp;want&nbsp;to&nbsp;know&nbsp;the&nbsp;number&nbsp;of&nbsp;days&nbsp;in&nbsp;particular&nbsp;month,&nbsp;so&nbsp;let's&nbsp;look&nbsp;at&nbsp;a&nbsp;simple&nbsp;function&nbsp;to&nbsp;do&nbsp;this.&nbsp;Here&nbsp;is&nbsp;the&nbsp;code:</P>
<P>create&nbsp;function&nbsp;DaysInMonth&nbsp;(@when&nbsp;datetime)&nbsp;<BR>returns&nbsp;int&nbsp;<BR>as&nbsp;<BR>BEGIN&nbsp;<BR>declare&nbsp;@rv&nbsp;int</P>
<P>if&nbsp;datepart(month,&nbsp;@when)&nbsp;=&nbsp;2&nbsp;<BR>begin&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;datepart(year,&nbsp;@when)&nbsp;%&nbsp;400&nbsp;=&nbsp;0&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@rv&nbsp;=&nbsp;29&nbsp;<BR>else&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;datepart(year,&nbsp;@when)&nbsp;%&nbsp;100&nbsp;=&nbsp;0&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@rv&nbsp;=&nbsp;28&nbsp;<BR>else&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;datepart(year,&nbsp;@when)&nbsp;%&nbsp;4&nbsp;=&nbsp;0&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@rv&nbsp;=&nbsp;29&nbsp;<BR>else&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@rv&nbsp;=&nbsp;28&nbsp;<BR>end&nbsp;--&nbsp;if<BR>else<BR>begin&nbsp;<BR>select&nbsp;@rv&nbsp;=&nbsp;case&nbsp;(datepart(month,&nbsp;@when))&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;4&nbsp;then&nbsp;30&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;6&nbsp;then&nbsp;30&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;9&nbsp;then&nbsp;30&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;11&nbsp;then&nbsp;30&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;31&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;end&nbsp;--&nbsp;case&nbsp;<BR>end&nbsp;--&nbsp;else</P>
<P>return&nbsp;@rv</P>
<P>END&nbsp;--&nbsp;fn&nbsp;def&nbsp;</P>
<P>To&nbsp;execute&nbsp;the&nbsp;function,&nbsp;</P>
<P>select&nbsp;dbo.DaysInMonth('1&nbsp;may&nbsp;2000')&nbsp;<BR>select&nbsp;dbo.DaysInMonth(getdate())&nbsp;</P>
<P>As&nbsp;you&nbsp;can&nbsp;see,&nbsp;most&nbsp;of&nbsp;the&nbsp;code&nbsp;could&nbsp;have&nbsp;come&nbsp;from&nbsp;any&nbsp;SQL&nbsp;Server&nbsp;stored&nbsp;procedure.&nbsp;The&nbsp;new&nbsp;features&nbsp;are:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;function&nbsp;DaysInMonth&nbsp;(@when&nbsp;datetime)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;returns&nbsp;int&nbsp;&nbsp;</P>
<P>Clearly&nbsp;this&nbsp;is&nbsp;a&nbsp;function&nbsp;definition&nbsp;header&nbsp;-&nbsp;the&nbsp;returns&nbsp;int&nbsp;states&nbsp;that&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;single&nbsp;integer&nbsp;value.</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;@rv</P>
<P>The&nbsp;return&nbsp;@rv&nbsp;command&nbsp;must&nbsp;be&nbsp;the&nbsp;final&nbsp;line&nbsp;of&nbsp;the&nbsp;function,&nbsp;and&nbsp;it's&nbsp;this&nbsp;instruction&nbsp;that&nbsp;sends&nbsp;the&nbsp;output&nbsp;value&nbsp;back&nbsp;to&nbsp;the&nbsp;call.&nbsp;Almost&nbsp;any&nbsp;SQL&nbsp;Server&nbsp;data&nbsp;type&nbsp;can&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;UDF.</P>
<P>Using&nbsp;function&nbsp;calls<BR>You&nbsp;can&nbsp;code&nbsp;a&nbsp;function&nbsp;call&nbsp;anywhere&nbsp;you&nbsp;could&nbsp;code&nbsp;a&nbsp;variable&nbsp;or&nbsp;literal&nbsp;of&nbsp;the&nbsp;same&nbsp;data&nbsp;type&nbsp;as&nbsp;the&nbsp;function&nbsp;returns.&nbsp;For&nbsp;example,&nbsp;to&nbsp;calculate&nbsp;the&nbsp;number&nbsp;of&nbsp;days&nbsp;between&nbsp;now&nbsp;and&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;month:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;dbo.DaysInMonth(getdate())&nbsp;-&nbsp;datepart(day,&nbsp;getdate())&nbsp;</P>
<P>Note&nbsp;the&nbsp;repeated&nbsp;use&nbsp;of&nbsp;the&nbsp;owner&nbsp;qualification&nbsp;before&nbsp;the&nbsp;UDF&nbsp;name,&nbsp;(dbo.DaysInMonth()&nbsp;instead&nbsp;of&nbsp;DaysInMonth()&nbsp;-&nbsp;This&nbsp;qualification&nbsp;is&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;requirement&nbsp;in&nbsp;Beta&nbsp;2,&nbsp;and&nbsp;will&nbsp;probably&nbsp;go&nbsp;forward&nbsp;into&nbsp;the&nbsp;release&nbsp;version.</P>
<P>Functions&nbsp;within&nbsp;functions<BR>You&nbsp;can&nbsp;nest&nbsp;a&nbsp;function&nbsp;within&nbsp;another&nbsp;of&nbsp;you&nbsp;so&nbsp;wish.</P>
<P>create&nbsp;function&nbsp;daysTillMonthEnd&nbsp;(@when&nbsp;Datetime)<BR>returns&nbsp;int<BR>as<BR>begin<BR>return&nbsp;dbo.DaysInMonth(@when)&nbsp;-&nbsp;datepart(day,&nbsp;@when)<BR>end</P>
<P>Restrictions&nbsp;on&nbsp;using&nbsp;functions&nbsp;within&nbsp;functions<BR>&nbsp;There&nbsp;is&nbsp;a&nbsp;restriction&nbsp;on&nbsp;this&nbsp;which&nbsp;I&nbsp;ran&nbsp;straight&nbsp;into&nbsp;when&nbsp;I&nbsp;first&nbsp;started&nbsp;to&nbsp;play&nbsp;with&nbsp;UDFs.&nbsp;You&nbsp;cannot&nbsp;use&nbsp;a&nbsp;built-in&nbsp;non-deterministic&nbsp;function&nbsp;within&nbsp;a&nbsp;user&nbsp;defined&nbsp;function.&nbsp;When&nbsp;I&nbsp;made&nbsp;my&nbsp;first&nbsp;stab&nbsp;at&nbsp;coding&nbsp;the&nbsp;DaysInMonth&nbsp;function&nbsp;shown&nbsp;above,&nbsp;I&nbsp;tried&nbsp;to&nbsp;use&nbsp;the&nbsp;getdate()&nbsp;function&nbsp;as&nbsp;a&nbsp;default&nbsp;in&nbsp;case&nbsp;no&nbsp;parameters&nbsp;were&nbsp;supplied&nbsp;in&nbsp;the&nbsp;function&nbsp;call.&nbsp;SQL&nbsp;Server&nbsp;will&nbsp;not&nbsp;allow&nbsp;this.&nbsp;&nbsp;</P>
<P>Using&nbsp;other&nbsp;data&nbsp;types<BR>You&nbsp;can&nbsp;return&nbsp;almost&nbsp;any&nbsp;data&nbsp;type&nbsp;in&nbsp;a&nbsp;function,&nbsp;including&nbsp;User&nbsp;Defined&nbsp;Data&nbsp;Types.&nbsp;The&nbsp;following&nbsp;simple&nbsp;example&nbsp;returns&nbsp;a&nbsp;UDDT&nbsp;based&nbsp;on&nbsp;the&nbsp;varchar&nbsp;data&nbsp;type.</P>
<P>sp_addtype&nbsp;varstring,&nbsp;'varchar(32)'<BR>go<BR>create&nbsp;function&nbsp;capitalise&nbsp;(@string&nbsp;varstring)&nbsp;<BR>returns&nbsp;varstring<BR>as<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;UPPER(left(@string,&nbsp;1))&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOWER(substring&nbsp;(@string,&nbsp;2,&nbsp;datalength(@string)))<BR>END<BR>go<BR>select&nbsp;dbo.capitalise&nbsp;('abcdef')</P>
<P>SQL&nbsp;Server&nbsp;2000&nbsp;will&nbsp;not&nbsp;allow&nbsp;you&nbsp;to&nbsp;return&nbsp;text,&nbsp;image,&nbsp;cursor&nbsp;or&nbsp;timestamp&nbsp;data&nbsp;types&nbsp;from&nbsp;a&nbsp;function.</P>
<P>Recursive&nbsp;functions<BR>Functions&nbsp;have&nbsp;the&nbsp;ability&nbsp;to&nbsp;call&nbsp;themselves,&nbsp;or&nbsp;"recurse".&nbsp;The&nbsp;example&nbsp;below&nbsp;works&nbsp;out&nbsp;the&nbsp;factorial&nbsp;of&nbsp;the&nbsp;integer&nbsp;input.&nbsp;</P>
<P>create&nbsp;function&nbsp;factorial&nbsp;(@i&nbsp;bigint)&nbsp;<BR>returns&nbsp;bigint<BR>as<BR>BEGIN</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;@internalI&nbsp;bigint</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@i&nbsp;&gt;&nbsp;20&nbsp;OR&nbsp;@i&nbsp;IS&nbsp;NULL&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@internalI&nbsp;=&nbsp;NULL<BR>&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@i&nbsp;&lt;&nbsp;2&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@internalI&nbsp;=&nbsp;@i<BR>&nbsp;&nbsp;&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@internalI&nbsp;=&nbsp;@i&nbsp;*&nbsp;dbo.factorial(@i&nbsp;-&nbsp;1)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;@internalI</P>
<P>END&nbsp;--&nbsp;fn&nbsp;def<BR>go<BR>select&nbsp;dbo.factorial&nbsp;(3)<BR>select&nbsp;dbo.factorial&nbsp;(8)</P>
<P><BR>For&nbsp;the&nbsp;non-mathematically&nbsp;inclined,&nbsp;factorials&nbsp;are&nbsp;what&nbsp;you&nbsp;get&nbsp;when&nbsp;you&nbsp;multiply&nbsp;together&nbsp;all&nbsp;the&nbsp;whole&nbsp;numbers&nbsp;between&nbsp;1&nbsp;and&nbsp;the&nbsp;number&nbsp;you&nbsp;thought&nbsp;of.&nbsp;For&nbsp;example:</P>
<P>The&nbsp;Factorial&nbsp;of&nbsp;3&nbsp;=&nbsp;1&nbsp;x&nbsp;2&nbsp;x&nbsp;3&nbsp;=&nbsp;6&nbsp;<BR>The&nbsp;Factorial&nbsp;of&nbsp;8&nbsp;=&nbsp;1&nbsp;x&nbsp;2&nbsp;x&nbsp;3&nbsp;x&nbsp;4&nbsp;x&nbsp;5&nbsp;x&nbsp;6&nbsp;x&nbsp;7&nbsp;x&nbsp;8&nbsp;=&nbsp;40320&nbsp;<BR>Functions&nbsp;can&nbsp;recurse&nbsp;up&nbsp;to&nbsp;level&nbsp;32&nbsp;deep,&nbsp;after&nbsp;which&nbsp;SQL&nbsp;Server&nbsp;will&nbsp;generate&nbsp;an&nbsp;error.&nbsp;The&nbsp;example&nbsp;above&nbsp;is&nbsp;restricted&nbsp;to&nbsp;20&nbsp;times&nbsp;because&nbsp;Factorial&nbsp;21&nbsp;is&nbsp;too&nbsp;big&nbsp;for&nbsp;the&nbsp;bigint&nbsp;data&nbsp;type.</P>
<P>Passing&nbsp;tables&nbsp;out&nbsp;of&nbsp;functions<BR>Create&nbsp;a&nbsp;function&nbsp;that&nbsp;passes&nbsp;back&nbsp;a&nbsp;table&nbsp;and&nbsp;what&nbsp;you&nbsp;end&nbsp;up&nbsp;with&nbsp;is&nbsp;a&nbsp;kind&nbsp;of&nbsp;"parameterized&nbsp;view"&nbsp;-&nbsp;something&nbsp;you&nbsp;can&nbsp;treat&nbsp;as&nbsp;a&nbsp;view,&nbsp;but&nbsp;which&nbsp;will&nbsp;return&nbsp;different&nbsp;values&nbsp;depending&nbsp;on&nbsp;the&nbsp;parameters&nbsp;passed&nbsp;in.&nbsp;The&nbsp;following&nbsp;example&nbsp;for&nbsp;the&nbsp;PUBS&nbsp;database&nbsp;takes&nbsp;an&nbsp;author_id&nbsp;as&nbsp;it's&nbsp;parameter&nbsp;and&nbsp;returns&nbsp;a&nbsp;table&nbsp;containing&nbsp;all&nbsp;the&nbsp;author&nbsp;IDs&nbsp;that&nbsp;have&nbsp;collaborated&nbsp;with&nbsp;them,&nbsp;and&nbsp;the&nbsp;title_id&nbsp;they&nbsp;worked&nbsp;together&nbsp;on.</P>
<P>create&nbsp;function&nbsp;collaborator&nbsp;(@au_id&nbsp;char(11))<BR>returns&nbsp;@collaborator&nbsp;table&nbsp;(<BR>&nbsp;&nbsp;&nbsp;&nbsp;target_author&nbsp;char(11),<BR>&nbsp;&nbsp;&nbsp;&nbsp;title_id&nbsp;char(6),<BR>&nbsp;&nbsp;&nbsp;&nbsp;partner_author&nbsp;char(11)<BR>)<BR>as<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;insert&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@collaborator<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.au_id,&nbsp;l.title_id,&nbsp;r.au_id<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;titleauthor&nbsp;l&nbsp;inner&nbsp;join&nbsp;titleauthor&nbsp;r<BR>&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.title_id&nbsp;=&nbsp;r.title_id&nbsp;AND&nbsp;l.au_id&nbsp;&lt;&gt;&nbsp;r.au_id<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.au_id&nbsp;=&nbsp;COALESCE(@au_id,&nbsp;l.au_id)<BR>&nbsp;&nbsp;&nbsp;&nbsp;order&nbsp;by&nbsp;&nbsp;&nbsp;l.title_id,&nbsp;l.au_id</P>
<P>RETURN</P>
<P>END&nbsp;--&nbsp;fn&nbsp;def</P>
<P>select&nbsp;*&nbsp;from&nbsp;dbo.collaborator('472-27-2349')<BR>select&nbsp;*&nbsp;from&nbsp;dbo.collaborator(NULL)</P>
<P>Note&nbsp;the&nbsp;use&nbsp;of&nbsp;the&nbsp;COALESCE&nbsp;function.&nbsp;We&nbsp;use&nbsp;this&nbsp;to&nbsp;return&nbsp;data&nbsp;for&nbsp;all&nbsp;authors&nbsp;that&nbsp;have&nbsp;collaborated&nbsp;on&nbsp;a&nbsp;book&nbsp;if&nbsp;no&nbsp;specific&nbsp;author_id&nbsp;is&nbsp;given.</P>
<P>You&nbsp;could&nbsp;code&nbsp;the&nbsp;line&nbsp;create&nbsp;function&nbsp;collaborator&nbsp;(@au_id&nbsp;char(11)&nbsp;=&nbsp;NULL)&nbsp;to&nbsp;define&nbsp;a&nbsp;default&nbsp;value&nbsp;for&nbsp;the&nbsp;parameter,&nbsp;and&nbsp;SQL&nbsp;Server&nbsp;would&nbsp;accept&nbsp;this.&nbsp;However,&nbsp;if&nbsp;you&nbsp;then&nbsp;try&nbsp;calling&nbsp;the&nbsp;function&nbsp;without&nbsp;parameters&nbsp;(a&nbsp;perfectly&nbsp;valid&nbsp;thing&nbsp;to&nbsp;do&nbsp;with&nbsp;stored&nbsp;procedure&nbsp;parameters)&nbsp;then&nbsp;SQL&nbsp;Server&nbsp;will&nbsp;complain.&nbsp;Instead&nbsp;you&nbsp;have&nbsp;to&nbsp;code&nbsp;dbo.collaborator(DEFAULT)&nbsp;for&nbsp;the&nbsp;function&nbsp;call.</P>
<P>In-line&nbsp;table&nbsp;functions<BR>SQL&nbsp;Server&nbsp;differentiates&nbsp;between&nbsp;"user&nbsp;defined&nbsp;functions&nbsp;that&nbsp;return&nbsp;a&nbsp;table"&nbsp;and&nbsp;"in-line&nbsp;table&nbsp;functions".&nbsp;The&nbsp;previous&nbsp;example&nbsp;is&nbsp;a&nbsp;"user&nbsp;defined&nbsp;functions&nbsp;that&nbsp;return&nbsp;a&nbsp;table".&nbsp;We&nbsp;can&nbsp;re-code&nbsp;this&nbsp;as&nbsp;an&nbsp;in-line&nbsp;function&nbsp;as&nbsp;follows:</P>
<P>create&nbsp;function&nbsp;collaborator_inline&nbsp;(@au_id&nbsp;char(11))<BR>returns&nbsp;table&nbsp;as<BR>RETURN&nbsp;(<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;&nbsp;l.au_id&nbsp;as&nbsp;"author",&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.title_id&nbsp;as&nbsp;"title",&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.au_id&nbsp;as&nbsp;"co-author"<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;&nbsp;&nbsp;&nbsp;titleauthor&nbsp;l&nbsp;inner&nbsp;join&nbsp;titleauthor&nbsp;r<BR>&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.title_id&nbsp;=&nbsp;r.title_id&nbsp;AND&nbsp;l.au_id&nbsp;&lt;&gt;&nbsp;r.au_id<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;&nbsp;&nbsp;l.au_id&nbsp;=&nbsp;COALESCE(@au_id,&nbsp;l.au_id)<BR>--&nbsp;&nbsp;order&nbsp;by&nbsp;l.title_id,&nbsp;l.au_id<BR>)<BR>go</P>
<P><BR>select&nbsp;*&nbsp;from&nbsp;dbo.collaborator_inline('724-80-9391')<BR>select&nbsp;*&nbsp;from&nbsp;dbo.collaborator_inline(NULL)</P>
<P>This&nbsp;syntax&nbsp;is&nbsp;more&nbsp;compact&nbsp;than&nbsp;the&nbsp;previous&nbsp;example,&nbsp;but&nbsp;also&nbsp;more&nbsp;restrictive.&nbsp;While&nbsp;the&nbsp;"user&nbsp;defined&nbsp;functions&nbsp;that&nbsp;return&nbsp;a&nbsp;table"&nbsp;can&nbsp;include&nbsp;any&nbsp;amount&nbsp;of&nbsp;code,&nbsp;the&nbsp;in-line&nbsp;version&nbsp;is&nbsp;restricted&nbsp;to&nbsp;a&nbsp;single&nbsp;select&nbsp;statement.&nbsp;Even&nbsp;the&nbsp;"order&nbsp;by"&nbsp;clause&nbsp;needs&nbsp;to&nbsp;be&nbsp;removed&nbsp;from&nbsp;the&nbsp;in-line&nbsp;version.</P>
<P>Table&nbsp;function&nbsp;in&nbsp;joins<BR>Parameterized&nbsp;functions&nbsp;that&nbsp;return&nbsp;tables&nbsp;may&nbsp;be&nbsp;part&nbsp;of&nbsp;a&nbsp;standard&nbsp;SQL&nbsp;join&nbsp;statement.</P>
<P>select&nbsp;*&nbsp;<BR>from&nbsp;dbo.collaborator('472-27-2349')&nbsp;inner&nbsp;join&nbsp;authors&nbsp;as&nbsp;a&nbsp;<BR>on&nbsp;partner_author&nbsp;=&nbsp;a.au_id&nbsp;</P>
<P>Functions&nbsp;as&nbsp;columns&nbsp;in&nbsp;views<BR>UDFs&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;columns&nbsp;in&nbsp;a&nbsp;view.&nbsp;</P>
<P>Building&nbsp;on&nbsp;the&nbsp;daysInMonth()&nbsp;function&nbsp;we&nbsp;defined&nbsp;earlier,&nbsp;and&nbsp;a&nbsp;new&nbsp;function&nbsp;startOfMonth()&nbsp;function,&nbsp;we&nbsp;can&nbsp;create&nbsp;this&nbsp;NORTHWIND&nbsp;database&nbsp;view&nbsp;showing&nbsp;daily&nbsp;average&nbsp;sales&nbsp;figures&nbsp;per&nbsp;month&nbsp;without&nbsp;going&nbsp;to&nbsp;excessive&nbsp;lengths&nbsp;to&nbsp;cater&nbsp;for&nbsp;months&nbsp;with&nbsp;different&nbsp;numbers&nbsp;of&nbsp;days.</P>
<P>create&nbsp;function&nbsp;startOfMonth&nbsp;(@when&nbsp;datetime)<BR>returns&nbsp;smalldatetime&nbsp;as&nbsp;<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;dateadd&nbsp;(day,&nbsp;1&nbsp;+&nbsp;datepart(day,&nbsp;@when)&nbsp;*&nbsp;-1,&nbsp;@when)<BR>END&nbsp;--&nbsp;fn&nbsp;def<BR>go</P>
<P>create&nbsp;view&nbsp;monthlyAverages&nbsp;as<BR>select&nbsp;month,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;sum(quantity)&nbsp;/&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;dbo.daysInMonth(month)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;dailyAvgSale<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;(select&nbsp;dbo.startofMonth&nbsp;(orderDate)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;month,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quantity,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.OrderID<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;orders&nbsp;o&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner&nbsp;join&nbsp;"order&nbsp;details"&nbsp;od<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;o.OrderID&nbsp;=&nbsp;od.OrderID<BR>&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;as&nbsp;derived<BR>group&nbsp;by&nbsp;month<BR>go</P>
<P>select&nbsp;*&nbsp;from&nbsp;monthlyAverages&nbsp;order&nbsp;by&nbsp;month</P>
<P>Functions&nbsp;and&nbsp;constraints<BR>You&nbsp;can&nbsp;use&nbsp;functions&nbsp;as&nbsp;to&nbsp;define&nbsp;constraints,&nbsp;provided&nbsp;that&nbsp;both&nbsp;the&nbsp;table&nbsp;and&nbsp;the&nbsp;function&nbsp;share&nbsp;the&nbsp;same&nbsp;owner.&nbsp;This&nbsp;example&nbsp;defines&nbsp;a&nbsp;function&nbsp;called&nbsp;"&nbsp;midnight"&nbsp;that&nbsp;truncates&nbsp;a&nbsp;date-time&nbsp;to&nbsp;midnight,&nbsp;then&nbsp;uses&nbsp;this&nbsp;in&nbsp;a&nbsp;table's&nbsp;check&nbsp;constraint&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;prevShutdown&nbsp;column&nbsp;in&nbsp;test_table&nbsp;is&nbsp;always&nbsp;at&nbsp;least&nbsp;a&nbsp;day&nbsp;earlier&nbsp;then&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;startup&nbsp;column.</P>
<P>create&nbsp;function&nbsp;midnight&nbsp;(@when&nbsp;smalldatetime)<BR>returns&nbsp;smalldatetime<BR>as<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;convert(varchar(11),&nbsp;@when)<BR>END&nbsp;--&nbsp;fn&nbsp;def<BR>go</P>
<P>create&nbsp;table&nbsp;test_table&nbsp;(<BR>&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;identity,<BR>&nbsp;&nbsp;&nbsp;&nbsp;prevShutdown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smalldatetime,<BR>&nbsp;&nbsp;&nbsp;&nbsp;startup&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smalldatetime,<BR>&nbsp;&nbsp;&nbsp;&nbsp;CONSTRAINT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chk_midnight&nbsp;CHECK&nbsp;(prevShutdown&nbsp;&lt;&nbsp;dbo.midnight(startup))<BR>)<BR>go</P>
<P>You&nbsp;can&nbsp;also&nbsp;use&nbsp;a&nbsp;function&nbsp;as&nbsp;the&nbsp;basis&nbsp;for&nbsp;a&nbsp;default&nbsp;constraint,&nbsp;but&nbsp;presently&nbsp;you&nbsp;are&nbsp;limited&nbsp;to&nbsp;using&nbsp;constants&nbsp;in&nbsp;the&nbsp;function&nbsp;parameters,&nbsp;which&nbsp;restricts&nbsp;their&nbsp;usefulness.</P>
<P>Schema&nbsp;bound&nbsp;functions<BR>Particularly&nbsp;with&nbsp;older&nbsp;versions&nbsp;of&nbsp;SQL&nbsp;Server,&nbsp;you&nbsp;could&nbsp;get&nbsp;into&nbsp;trouble&nbsp;if&nbsp;you&nbsp;defined&nbsp;one&nbsp;object&nbsp;&nbsp;that&nbsp;was&nbsp;dependent&nbsp;on&nbsp;another,&nbsp;then&nbsp;dropped&nbsp;or&nbsp;changed&nbsp;the&nbsp;subordinate&nbsp;object.&nbsp;(In&nbsp;plain&nbsp;English:&nbsp;if&nbsp;you&nbsp;created&nbsp;a&nbsp;view&nbsp;on&nbsp;a&nbsp;table,&nbsp;then&nbsp;dropped&nbsp;the&nbsp;table,&nbsp;the&nbsp;view&nbsp;would&nbsp;still&nbsp;exist&nbsp;but&nbsp;it&nbsp;would&nbsp;obviously&nbsp;not&nbsp;work)&nbsp;</P>
<P>Schema&nbsp;binding&nbsp;tries&nbsp;to&nbsp;put&nbsp;a&nbsp;stop&nbsp;to&nbsp;this.&nbsp;If&nbsp;you&nbsp;create&nbsp;a&nbsp;function&nbsp;and&nbsp;specify&nbsp;it&nbsp;is&nbsp;Schema&nbsp;Bound,&nbsp;then&nbsp;the&nbsp;objects&nbsp;it&nbsp;depends&nbsp;on&nbsp;cannot&nbsp;be&nbsp;altered&nbsp;without&nbsp;you&nbsp;first&nbsp;dropping&nbsp;the&nbsp;schema&nbsp;binding.&nbsp;There&nbsp;are&nbsp;limitations&nbsp;as&nbsp;to&nbsp;when&nbsp;this&nbsp;will&nbsp;work&nbsp;(it&nbsp;will&nbsp;not&nbsp;work&nbsp;across&nbsp;multiple&nbsp;databases&nbsp;for&nbsp;example)&nbsp;but&nbsp;it&nbsp;is&nbsp;still&nbsp;a&nbsp;very&nbsp;useful&nbsp;feature.</P>
<P>Schema&nbsp;binding&nbsp;is&nbsp;invoked&nbsp;at&nbsp;function&nbsp;creation&nbsp;time.&nbsp;We&nbsp;can&nbsp;change&nbsp;our&nbsp;collaborator()&nbsp;function&nbsp;to&nbsp;a&nbsp;schema&nbsp;bound&nbsp;version&nbsp;as&nbsp;shown&nbsp;below.&nbsp;Note&nbsp;that&nbsp;in&nbsp;addition&nbsp;to&nbsp;the&nbsp;with&nbsp;schemabinding&nbsp;option,&nbsp;we&nbsp;need&nbsp;to&nbsp;specify&nbsp;a&nbsp;two&nbsp;part&nbsp;name&nbsp;(dbo.titleauthor&nbsp;instead&nbsp;of&nbsp;just&nbsp;titleauthor)&nbsp;for&nbsp;all&nbsp;referenced&nbsp;objects.</P>
<P>create&nbsp;function&nbsp;collaborator_sb&nbsp;(@au_id&nbsp;char(11))<BR>returns&nbsp;table&nbsp;<BR>with&nbsp;schemabinding<BR>as<BR>RETURN&nbsp;(<BR>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;&nbsp;l.au_id&nbsp;as&nbsp;"author",&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.title_id&nbsp;as&nbsp;"title",&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.au_id&nbsp;as&nbsp;"co-author"<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;&nbsp;&nbsp;&nbsp;dbo.titleauthor&nbsp;l&nbsp;inner&nbsp;join&nbsp;dbo.titleauthor&nbsp;r<BR>&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.title_id&nbsp;=&nbsp;r.title_id&nbsp;AND&nbsp;l.au_id&nbsp;&lt;&gt;&nbsp;r.au_id<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;&nbsp;&nbsp;l.au_id&nbsp;=&nbsp;COALESCE(@au_id,&nbsp;l.au_id)<BR>--&nbsp;order&nbsp;by&nbsp;l.title_id,&nbsp;l.au_id<BR>)</P>
<P>As&nbsp;long&nbsp;as&nbsp;schema&nbsp;binding&nbsp;is&nbsp;in&nbsp;place&nbsp;for&nbsp;this&nbsp;function,&nbsp;any&nbsp;attempt&nbsp;to&nbsp;change&nbsp;the&nbsp;structure&nbsp;of&nbsp;the&nbsp;titleauthor&nbsp;table&nbsp;will&nbsp;generate&nbsp;an&nbsp;error.</P>
<P>Overloading&nbsp;functions<BR>Overloading&nbsp;is&nbsp;the&nbsp;practice&nbsp;of&nbsp;having&nbsp;multiple&nbsp;functions&nbsp;with&nbsp;the&nbsp;name&nbsp;name,&nbsp;each&nbsp;doing&nbsp;different&nbsp;things.&nbsp;The&nbsp;'+'&nbsp;operator&nbsp;is&nbsp;overloaded&nbsp;as&nbsp;it&nbsp;can&nbsp;both&nbsp;add&nbsp;up&nbsp;numbers&nbsp;and&nbsp;concatenate&nbsp;strings.</P>
<P>select&nbsp;1&nbsp;+&nbsp;2&nbsp;+&nbsp;3<BR>select&nbsp;'1'&nbsp;+&nbsp;'2'&nbsp;+&nbsp;'3'</P>
<P>In&nbsp;Beta&nbsp;2&nbsp;at&nbsp;least,&nbsp;overloading&nbsp;functions&nbsp;is&nbsp;a&nbsp;non-starter&nbsp;due&nbsp;to&nbsp;the&nbsp;UNIQUE&nbsp;constraint&nbsp;on&nbsp;the&nbsp;sysobjects&nbsp;columns&nbsp;name&nbsp;and&nbsp;uid.&nbsp;There&nbsp;is&nbsp;some&nbsp;discussion&nbsp;in&nbsp;the&nbsp;Beta&nbsp;support&nbsp;newsgroups&nbsp;about&nbsp;implementing&nbsp;this&nbsp;in&nbsp;future,&nbsp;but&nbsp;I&nbsp;would&nbsp;not&nbsp;hold&nbsp;my&nbsp;breath.</P>
<P>About&nbsp;the&nbsp;author<BR></P></FONT>