<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Dynamic&nbsp;SQL</B><BR>The&nbsp;IN&nbsp;Clause<BR>The&nbsp;IN&nbsp;clause&nbsp;is&nbsp;a&nbsp;good&nbsp;example&nbsp;of&nbsp;a&nbsp;use&nbsp;for&nbsp;Dynamic&nbsp;SQL.&nbsp;A&nbsp;lot&nbsp;of&nbsp;SQL&nbsp;Server&nbsp;developers&nbsp;use&nbsp;ASP&nbsp;or&nbsp;a&nbsp;similar&nbsp;web&nbsp;scripting&nbsp;language.&nbsp;
<P></P>
<P>If&nbsp;in&nbsp;an&nbsp;asp&nbsp;page&nbsp;you&nbsp;have&nbsp;a&nbsp;Select&nbsp;list&nbsp;with&nbsp;multiple&nbsp;allowed&nbsp;values,&nbsp;the&nbsp;value&nbsp;of&nbsp;request.form("myList")&nbsp;on&nbsp;the&nbsp;processing&nbsp;page&nbsp;might&nbsp;look&nbsp;like&nbsp;this&nbsp;"1,3,4,6".&nbsp;</P>
<P>So&nbsp;we&nbsp;try&nbsp;to&nbsp;write&nbsp;a&nbsp;stored&nbsp;proc&nbsp;around&nbsp;this&nbsp;</P>
<P>Create&nbsp;Procedure&nbsp;Search<BR>&nbsp;@strIDs&nbsp;VarChar(100)<BR>AS</P>
<P>SELECT&nbsp;*&nbsp;<BR>FROM<BR>&nbsp;Products<BR>WHERE<BR>&nbsp;ProductID&nbsp;in&nbsp;(@strIDs)</P>
<P>GO<BR>Oooops!&nbsp;No&nbsp;Go.&nbsp;</P>
<P>This&nbsp;will&nbsp;work&nbsp;</P>
<P>Create&nbsp;Procedure&nbsp;Search<BR>&nbsp;@strIDs&nbsp;VarChar(100)<BR>AS</P>
<P>Declare&nbsp;@SQL&nbsp;VarChar(1000)</P>
<P>Select&nbsp;@SQL&nbsp;=&nbsp;'SELECT&nbsp;*&nbsp;FROM&nbsp;Products&nbsp;'<BR>Select&nbsp;@SQL&nbsp;=&nbsp;@SQL&nbsp;+&nbsp;'WHERE&nbsp;ProductID&nbsp;in&nbsp;('&nbsp;+&nbsp;@strIDs&nbsp;+')'</P>
<P>Exec&nbsp;(&nbsp;@SQL)</P>
<P>GO<BR>N.B.&nbsp;This&nbsp;can&nbsp;also&nbsp;be&nbsp;solved&nbsp;using&nbsp;a&nbsp;technique&nbsp;like&nbsp;this.&nbsp;</P>
<P>Aliases<BR>Giving&nbsp;a&nbsp;table&nbsp;or&nbsp;column&nbsp;a&nbsp;dynamic&nbsp;alias&nbsp;is&nbsp;a&nbsp;use&nbsp;for&nbsp;dynamic&nbsp;SQL.&nbsp;</P>
<P>This&nbsp;will&nbsp;not&nbsp;work&nbsp;</P>
<P>Select&nbsp;UserName&nbsp;FROM&nbsp;Table&nbsp;as&nbsp;@Alias<BR>This&nbsp;will&nbsp;</P>
<P>Exec('Select&nbsp;UserName&nbsp;FROM&nbsp;Table&nbsp;as&nbsp;'&nbsp;@Alias)&nbsp;<BR>DDL<BR>A&nbsp;common&nbsp;question&nbsp;asked&nbsp;of&nbsp;SQL&nbsp;Team&nbsp;is&nbsp;"How&nbsp;do&nbsp;I&nbsp;write&nbsp;a&nbsp;stored&nbsp;procedure&nbsp;that&nbsp;will&nbsp;create&nbsp;a&nbsp;table/database.&nbsp;I&nbsp;want&nbsp;to&nbsp;pass&nbsp;in&nbsp;the&nbsp;name"&nbsp;</P>
<P>SQL&nbsp;Server&nbsp;will&nbsp;not&nbsp;allow&nbsp;this&nbsp;</P>
<P>Create&nbsp;Table&nbsp;@TableName&nbsp;(<BR>&nbsp;ID&nbsp;int&nbsp;NOT&nbsp;NULL&nbsp;Primary&nbsp;Key,<BR>&nbsp;FieldName&nbsp;VarChar(10)<BR>&nbsp;)<BR>Once&nbsp;again,&nbsp;dynamic&nbsp;SQL&nbsp;to&nbsp;the&nbsp;rescue&nbsp;</P>
<P>Declare&nbsp;@SQL&nbsp;VarChar(1000)</P>
<P>SELECT&nbsp;@SQL&nbsp;=&nbsp;'Create&nbsp;Table&nbsp;'&nbsp;+&nbsp;@TableName&nbsp;+&nbsp;'('<BR>SELECT&nbsp;@SQL&nbsp;=&nbsp;@SQL&nbsp;+&nbsp;'ID&nbsp;int&nbsp;NOT&nbsp;NULL&nbsp;Primary&nbsp;Key,&nbsp;FieldName&nbsp;VarChar(10))'</P>
<P>Exec&nbsp;(@SQL)<BR>Similarly,&nbsp;the&nbsp;code&nbsp;to&nbsp;create&nbsp;a&nbsp;database&nbsp;would&nbsp;look&nbsp;like&nbsp;this:&nbsp;</P>
<P>Exec('Create&nbsp;Database&nbsp;'&nbsp;+&nbsp;@myDBName)<BR>sp_executesql<BR>sp_executesql&nbsp;is&nbsp;a&nbsp;system&nbsp;stored&nbsp;procedure&nbsp;that&nbsp;you&nbsp;can&nbsp;use&nbsp;in&nbsp;place&nbsp;of&nbsp;"exec"&nbsp;to&nbsp;execute&nbsp;your&nbsp;dynamic&nbsp;sql.&nbsp;</P>
<P>This&nbsp;allows&nbsp;you&nbsp;to&nbsp;have&nbsp;parameters&nbsp;in&nbsp;your&nbsp;dynamic&nbsp;query&nbsp;and&nbsp;pass&nbsp;them&nbsp;in.&nbsp;The&nbsp;end&nbsp;result&nbsp;is&nbsp;that&nbsp;SQL&nbsp;Server&nbsp;will&nbsp;try&nbsp;to&nbsp;cache&nbsp;the&nbsp;execution&nbsp;plan&nbsp;for&nbsp;your&nbsp;query&nbsp;giving&nbsp;you&nbsp;some&nbsp;of&nbsp;the&nbsp;advantages&nbsp;of&nbsp;a&nbsp;fully&nbsp;compiled&nbsp;query.&nbsp;</P>
<P>An&nbsp;example&nbsp;</P>
<P>Declare&nbsp;@SQL&nbsp;nVarChar(1000)&nbsp;--N.B.&nbsp;string&nbsp;must&nbsp;be&nbsp;unicode&nbsp;for&nbsp;sp_executesql<BR>SELECT&nbsp;@SQL&nbsp;=&nbsp;'SELECT&nbsp;*&nbsp;FROM&nbsp;pubs.DBO.Authors&nbsp;WHERE&nbsp;au_lname&nbsp;=&nbsp;@AuthorName'</P>
<P>Exec&nbsp;sp_executesql&nbsp;@SQL,&nbsp;N'@AuthorName&nbsp;nVarChar(50)',&nbsp;@AuthorName&nbsp;=&nbsp;'white'<BR>The&nbsp;first&nbsp;parameter&nbsp;here&nbsp;is&nbsp;the&nbsp;SQL&nbsp;statement,&nbsp;then&nbsp;you&nbsp;must&nbsp;declare&nbsp;the&nbsp;parameters,&nbsp;after&nbsp;that&nbsp;you&nbsp;pass&nbsp;the&nbsp;in&nbsp;parameters&nbsp;as&nbsp;normal,&nbsp;comma&nbsp;separated.&nbsp;</P>
<P>sp_executesql&nbsp;is&nbsp;also&nbsp;useful&nbsp;when&nbsp;you&nbsp;want&nbsp;to&nbsp;execute&nbsp;code&nbsp;in&nbsp;another&nbsp;database&nbsp;as&nbsp;it&nbsp;will&nbsp;run&nbsp;code&nbsp;in&nbsp;the&nbsp;context&nbsp;of&nbsp;it's&nbsp;database,&nbsp;rather&nbsp;than&nbsp;the&nbsp;one&nbsp;it&nbsp;was&nbsp;called&nbsp;from.&nbsp;</P>
<P>Try&nbsp;this&nbsp;from&nbsp;a&nbsp;database&nbsp;that&nbsp;is&nbsp;not&nbsp;Pubs&nbsp;</P>
<P>Create&nbsp;View&nbsp;pubs.dbo.Auths&nbsp;AS&nbsp;(SELECT&nbsp;au_id,&nbsp;au_lname,&nbsp;au_fname&nbsp;FROM&nbsp;Authors)<BR>You&nbsp;will&nbsp;get&nbsp;this&nbsp;error:&nbsp;'CREATE&nbsp;VIEW'&nbsp;does&nbsp;not&nbsp;allow&nbsp;specifying&nbsp;the&nbsp;database&nbsp;name&nbsp;as&nbsp;a&nbsp;prefix&nbsp;to&nbsp;the&nbsp;object&nbsp;name.&nbsp;</P>
<P>So&nbsp;you&nbsp;build&nbsp;the&nbsp;dynamic&nbsp;sql,&nbsp;then&nbsp;run&nbsp;it&nbsp;in&nbsp;Pub's&nbsp;copy&nbsp;of&nbsp;sp_executesql&nbsp;</P>
<P>I.E.&nbsp;</P>
<P>Declare&nbsp;@SQL&nbsp;nVarChar(1000)</P>
<P>Select&nbsp;@SQL&nbsp;=&nbsp;'Create&nbsp;View&nbsp;Auths&nbsp;AS&nbsp;(SELECT&nbsp;au_id,&nbsp;au_lname,&nbsp;au_fname&nbsp;FROM&nbsp;Authors)'</P>
<P>Execute&nbsp;pubs.dbo.sp_executesql&nbsp;@sql<BR>Permissions<BR>When&nbsp;executing&nbsp;dynamic&nbsp;SQL&nbsp;from&nbsp;a&nbsp;stored&nbsp;procedure,&nbsp;keep&nbsp;in&nbsp;mind&nbsp;that&nbsp;the&nbsp;SQL&nbsp;is&nbsp;executed&nbsp;in&nbsp;the&nbsp;permission&nbsp;context&nbsp;of&nbsp;the&nbsp;user,&nbsp;not&nbsp;the&nbsp;calling&nbsp;procedure.&nbsp;This&nbsp;means&nbsp;that&nbsp;if&nbsp;your&nbsp;user&nbsp;has&nbsp;no&nbsp;rights&nbsp;to&nbsp;the&nbsp;tables,&nbsp;only&nbsp;to&nbsp;the&nbsp;procedure,&nbsp;you&nbsp;may&nbsp;run&nbsp;into&nbsp;problems.&nbsp;</P>
<P>Scope<BR>When&nbsp;you&nbsp;run&nbsp;dynamic&nbsp;sql,&nbsp;it&nbsp;runs&nbsp;in&nbsp;it's&nbsp;own&nbsp;scope.&nbsp;</P>
<P>This&nbsp;</P>
<P>exec('set&nbsp;rowcount&nbsp;3')</P>
<P>Select&nbsp;*&nbsp;from&nbsp;Authors</P>
<P>exec('set&nbsp;rowcount&nbsp;0')<BR>Will&nbsp;have&nbsp;no&nbsp;effect&nbsp;on&nbsp;the&nbsp;result&nbsp;set&nbsp;returned&nbsp;from&nbsp;Authors.&nbsp;This&nbsp;is&nbsp;because&nbsp;by&nbsp;the&nbsp;rowcount&nbsp;statements&nbsp;have&nbsp;gone&nbsp;out&nbsp;of&nbsp;scope&nbsp;by&nbsp;the&nbsp;time&nbsp;the&nbsp;Select&nbsp;occurs.&nbsp;</P>
<P>This&nbsp;would&nbsp;be&nbsp;solved&nbsp;by&nbsp;this&nbsp;</P>
<P>exec('set&nbsp;rowcount&nbsp;3&nbsp;Select&nbsp;*&nbsp;from&nbsp;Authors&nbsp;Set&nbsp;rowcount&nbsp;0')<BR>Declaring&nbsp;variables&nbsp;inside&nbsp;a&nbsp;dynamic&nbsp;SQL&nbsp;batch&nbsp;will&nbsp;also&nbsp;not&nbsp;be&nbsp;available&nbsp;outside&nbsp;the&nbsp;batch&nbsp;and&nbsp;vice&nbsp;versa.&nbsp;As&nbsp;a&nbsp;result,&nbsp;this&nbsp;would&nbsp;also&nbsp;not&nbsp;work.&nbsp;</P>
<P>declare&nbsp;@i&nbsp;int<BR>Exec&nbsp;('Select&nbsp;@i&nbsp;=&nbsp;1')<BR>Temp&nbsp;tables&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;interact&nbsp;between&nbsp;batches&nbsp;of&nbsp;standard&nbsp;SQL&nbsp;and&nbsp;dynamic&nbsp;SQL.&nbsp;A&nbsp;temp&nbsp;table&nbsp;created&nbsp;within&nbsp;a&nbsp;dynamic&nbsp;SQL&nbsp;batch&nbsp;will&nbsp;be&nbsp;destroyed&nbsp;when&nbsp;the&nbsp;batch&nbsp;completes,&nbsp;however&nbsp;a&nbsp;temp&nbsp;table&nbsp;created&nbsp;before&nbsp;the&nbsp;batch&nbsp;will&nbsp;be&nbsp;available&nbsp;to&nbsp;it.&nbsp;</P>
<P>Create&nbsp;Table&nbsp;#tempauth(<BR>&nbsp;au_id&nbsp;VarChar(100),<BR>&nbsp;au_fname&nbsp;VarChar(100),<BR>&nbsp;au_lname&nbsp;VarChar(100)</P>
<P>)</P>
<P>declare&nbsp;@SQL&nbsp;VarChar(1000)<BR>Select&nbsp;@SQL&nbsp;=&nbsp;'Insert&nbsp;into&nbsp;#tempauth&nbsp;Select&nbsp;au_id,&nbsp;au_fname,&nbsp;au_lname&nbsp;FROM&nbsp;Authors'<BR>exec(@SQL)</P>
<P><BR>Select&nbsp;*&nbsp;from&nbsp;#tempauth</P>
<P>drop&nbsp;table&nbsp;#tempauth<BR>Summary<BR>That&nbsp;wraps&nbsp;up&nbsp;my&nbsp;intro&nbsp;to&nbsp;dynamic&nbsp;SQL.&nbsp;I&nbsp;hope&nbsp;it&nbsp;is&nbsp;a&nbsp;little&nbsp;clearer&nbsp;now&nbsp;than&nbsp;it&nbsp;was&nbsp;before.&nbsp;Dynamic&nbsp;SQL&nbsp;is&nbsp;a&nbsp;very&nbsp;powerful&nbsp;tool&nbsp;to&nbsp;have&nbsp;in&nbsp;your&nbsp;arsenal&nbsp;as&nbsp;long&nbsp;as&nbsp;it&nbsp;doesn't&nbsp;substitute&nbsp;for&nbsp;bad&nbsp;application&nbsp;design.&nbsp;If&nbsp;you&nbsp;can&nbsp;avoid&nbsp;it&nbsp;with&nbsp;better&nbsp;data&nbsp;modelling,&nbsp;then&nbsp;that&nbsp;is&nbsp;the&nbsp;best&nbsp;way&nbsp;to&nbsp;go&nbsp;as&nbsp;your&nbsp;code&nbsp;will&nbsp;end&nbsp;up&nbsp;neater&nbsp;and&nbsp;generally&nbsp;faster.&nbsp;</P>
<P>Until&nbsp;next&nbsp;time&nbsp;</P>
<P>Happy&nbsp;coding.&nbsp;</P></FONT>