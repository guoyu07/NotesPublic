<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Display&nbsp;Current&nbsp;SQL&nbsp;Activity</B><BR>Display&nbsp;Current&nbsp;SQL&nbsp;Activity
<P></P>
<P></P>
<P><BR>Here&nbsp;is&nbsp;a&nbsp;simple&nbsp;stored&nbsp;procedure&nbsp;for&nbsp;SQL&nbsp;Server&nbsp;2000&nbsp;(should&nbsp;work&nbsp;on&nbsp;SQL&nbsp;7&nbsp;as&nbsp;well)&nbsp;that&nbsp;lists&nbsp;users&nbsp;(like&nbsp;sp_who),&nbsp;locks&nbsp;(like&nbsp;sp_lock),&nbsp;and&nbsp;the&nbsp;input&nbsp;buffers&nbsp;of&nbsp;blocked&nbsp;and&nbsp;blocking&nbsp;users.</P>
<P>Author:&nbsp;Mitch&nbsp;van&nbsp;Huuksloot&nbsp;</P>
<P></P>
<P>use&nbsp;master<BR>GO<BR>if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;id&nbsp;=&nbsp;object_id('dbo.sp_activity')&nbsp;and&nbsp;sysstat&nbsp;&amp;&nbsp;0xf&nbsp;=&nbsp;4)<BR>drop&nbsp;procedure&nbsp;dbo.sp_activity<BR>GO</P>
<P>CREATE&nbsp;PROCEDURE&nbsp;sp_activity&nbsp;AS</P>
<P>/*&nbsp;SP_ACTIVITY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<BR>/*&nbsp;Author:&nbsp;Mitch&nbsp;van&nbsp;Huuksloot&nbsp;&nbsp;*/<BR>/*&nbsp;Date:&nbsp;April&nbsp;30,&nbsp;2001&nbsp;&nbsp;&nbsp;*/</P>
<P>set&nbsp;nocount&nbsp;on</P>
<P>select&nbsp;'Activity&nbsp;on'&nbsp;=&nbsp;convert(char(19),&nbsp;getdate(),&nbsp;20),&nbsp;Server&nbsp;=&nbsp;@@SERVERNAME</P>
<P>/*&nbsp;temp&nbsp;tables&nbsp;to&nbsp;hold&nbsp;more-or-less&nbsp;consistent&nbsp;sysprocesses/syslockinfo&nbsp;snapshots&nbsp;*/</P>
<P>create&nbsp;table&nbsp;#info<BR>(<BR>&nbsp;spid&nbsp;smallint,<BR>&nbsp;cmd&nbsp;char(16),<BR>&nbsp;status&nbsp;char(10),<BR>&nbsp;blocked&nbsp;smallint,<BR>&nbsp;waittype&nbsp;binary(2),<BR>&nbsp;waittime&nbsp;int,<BR>&nbsp;lastwaittype&nbsp;char(20),<BR>&nbsp;waitresource&nbsp;char(25),<BR>&nbsp;dbname&nbsp;char(30),<BR>&nbsp;loginname&nbsp;char(25),<BR>&nbsp;hostname&nbsp;char(15),<BR>&nbsp;cpu&nbsp;int,<BR>&nbsp;physical_io&nbsp;int,<BR>&nbsp;[memusage]&nbsp;int,<BR>&nbsp;login_time&nbsp;char(19),<BR>&nbsp;last_batch&nbsp;char(19),<BR>&nbsp;open_tran&nbsp;smallint,<BR>&nbsp;net_address&nbsp;char(12),<BR>&nbsp;net_library&nbsp;char(12),&nbsp;<BR>)</P>
<P>create&nbsp;table&nbsp;#locks<BR>(<BR>&nbsp;spid&nbsp;int,<BR>&nbsp;resource&nbsp;char(32),<BR>&nbsp;dbname&nbsp;char(30),<BR>&nbsp;indid&nbsp;smallint,<BR>&nbsp;indname&nbsp;char(30),<BR>&nbsp;objid&nbsp;integer,<BR>&nbsp;objectname&nbsp;char(30),<BR>&nbsp;typeid&nbsp;tinyint,<BR>&nbsp;type&nbsp;char(3),<BR>&nbsp;mode&nbsp;char(12),<BR>&nbsp;status&nbsp;char(10),<BR>&nbsp;refcnt&nbsp;smallint,<BR>&nbsp;ownertype&nbsp;char(12),<BR>&nbsp;transid&nbsp;bigint<BR>)</P>
<P>/*&nbsp;capture&nbsp;sysprocesses&nbsp;*/<BR>insert&nbsp;into&nbsp;#info<BR>&nbsp;select&nbsp;p.spid,<BR>&nbsp;&nbsp;convert(char(16),&nbsp;p.cmd),&nbsp;<BR>&nbsp;&nbsp;convert(char(10),&nbsp;p.status),<BR>&nbsp;&nbsp;p.blocked,<BR>&nbsp;&nbsp;p.waittype,<BR>&nbsp;&nbsp;p.waittime,<BR>&nbsp;&nbsp;convert(char(20),&nbsp;p.lastwaittype),<BR>&nbsp;&nbsp;convert(char(25),&nbsp;p.waitresource),<BR>&nbsp;&nbsp;convert(char(30),&nbsp;d.name),&nbsp;<BR>&nbsp;&nbsp;convert(char(25),&nbsp;p.loginame),&nbsp;<BR>&nbsp;&nbsp;convert(char(15),&nbsp;p.hostname),&nbsp;<BR>&nbsp;&nbsp;p.cpu,<BR>&nbsp;&nbsp;p.physical_io,<BR>&nbsp;&nbsp;p.memusage,&nbsp;<BR>&nbsp;&nbsp;convert(char(19),&nbsp;p.login_time,&nbsp;20),<BR>&nbsp;&nbsp;convert(char(19),&nbsp;p.last_batch,&nbsp;20),<BR>&nbsp;&nbsp;p.open_tran,<BR>&nbsp;&nbsp;convert(char(12),&nbsp;p.net_address),<BR>&nbsp;&nbsp;convert(char(12),&nbsp;p.net_library)<BR>&nbsp;from&nbsp;&nbsp;master.dbo.sysprocesses&nbsp;p&nbsp;(nolock),&nbsp;master.dbo.sysdatabases&nbsp;d&nbsp;(nolock)<BR>&nbsp;where&nbsp;p.dbid&nbsp;=&nbsp;d.dbid</P>
<P>/*&nbsp;capture&nbsp;syslockinfo&nbsp;*/<BR>insert&nbsp;into&nbsp;#locks<BR>&nbsp;select<BR>&nbsp;&nbsp;L.req_spid,<BR>&nbsp;&nbsp;convert(char(32),&nbsp;L.rsc_text),<BR>&nbsp;&nbsp;convert(char(30),&nbsp;d.name),<BR>&nbsp;&nbsp;L.rsc_indid,<BR>&nbsp;&nbsp;SPACE(30),<BR>&nbsp;&nbsp;L.rsc_objid,<BR>&nbsp;&nbsp;SPACE(30),<BR>&nbsp;&nbsp;L.rsc_type,<BR>&nbsp;&nbsp;convert(char(3),&nbsp;v.name),<BR>&nbsp;&nbsp;convert(char(12),&nbsp;v2.name),<BR>&nbsp;&nbsp;convert(CHAR(10),&nbsp;v3.name),<BR>&nbsp;&nbsp;L.req_refcnt&nbsp;smallint,<BR>&nbsp;&nbsp;case&nbsp;L.req_ownertype&nbsp;when&nbsp;1&nbsp;then&nbsp;'Transaction'&nbsp;when&nbsp;2&nbsp;then&nbsp;'Cursor'&nbsp;when&nbsp;3&nbsp;then&nbsp;'Session'&nbsp;when&nbsp;4&nbsp;then&nbsp;'ExSession'&nbsp;else&nbsp;cast(L.req_ownertype&nbsp;as&nbsp;char(12))&nbsp;end,<BR>&nbsp;&nbsp;req_transactionID&nbsp;<BR>&nbsp;from&nbsp;master..syslockinfo&nbsp;L&nbsp;(nolock),&nbsp;master..sysdatabases&nbsp;d&nbsp;(nolock),&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master..spt_values&nbsp;v&nbsp;(nolock),&nbsp;&nbsp;master..spt_values&nbsp;v2&nbsp;(nolock),&nbsp;master..spt_values&nbsp;v3&nbsp;(nolock)<BR>&nbsp;where&nbsp;&nbsp;L.rsc_dbid&nbsp;=&nbsp;d.dbid&nbsp;and&nbsp;<BR>&nbsp;&nbsp;l.rsc_type=v.number&nbsp;and&nbsp;v.type='LR'&nbsp;and&nbsp;<BR>&nbsp;&nbsp;(l.req_mode+1)=v2.number&nbsp;and&nbsp;v2.type='L'&nbsp;and<BR>&nbsp;&nbsp;l.req_status=v3.number&nbsp;and&nbsp;v3.type='LS'</P>
<P>/*&nbsp;Show&nbsp;active&nbsp;processes&nbsp;from&nbsp;sysprocesses&nbsp;capture&nbsp;*/</P>
<P>print&nbsp;''<BR>print&nbsp;'Active&nbsp;SQL&nbsp;Server&nbsp;Processes'<BR>print&nbsp;''<BR>select&nbsp;*&nbsp;from&nbsp;#info&nbsp;order&nbsp;by&nbsp;spid</P>
<P>/*&nbsp;Dump&nbsp;out&nbsp;block&nbsp;chain,&nbsp;if&nbsp;there&nbsp;is&nbsp;one&nbsp;*/</P>
<P>declare&nbsp;@blkd&nbsp;int<BR>select&nbsp;@blkd=count(spid)&nbsp;from&nbsp;#info&nbsp;where&nbsp;blocked&nbsp;=&nbsp;0&nbsp;and&nbsp;spid&nbsp;in&nbsp;(select&nbsp;distinct&nbsp;blocked&nbsp;from&nbsp;#info&nbsp;where&nbsp;blocked&nbsp;!=&nbsp;0)<BR>if&nbsp;@blkd&nbsp;&gt;&nbsp;0<BR>&nbsp;&nbsp;begin<BR>&nbsp;print&nbsp;''<BR>&nbsp;select&nbsp;'SPIDs&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;blocking&nbsp;chains'=spid&nbsp;from&nbsp;#info&nbsp;where&nbsp;blocked&nbsp;=&nbsp;0&nbsp;and&nbsp;spid&nbsp;in&nbsp;(select&nbsp;distinct&nbsp;blocked&nbsp;from&nbsp;#info&nbsp;where&nbsp;blocked&nbsp;!=&nbsp;0)<BR>&nbsp;print&nbsp;''<BR>&nbsp;&nbsp;end</P>
<P>/*&nbsp;Dump&nbsp;inputbuffers&nbsp;for&nbsp;each&nbsp;blocking&nbsp;process&nbsp;*/</P>
<P>declare&nbsp;@spid&nbsp;smallint,&nbsp;@spidch&nbsp;char(5),&nbsp;@msg&nbsp;varchar(100)</P>
<P>declare&nbsp;c1&nbsp;cursor&nbsp;for&nbsp;select&nbsp;distinct&nbsp;blocked&nbsp;from&nbsp;#info&nbsp;where&nbsp;blocked&nbsp;&gt;&nbsp;0&nbsp;FOR&nbsp;READ&nbsp;ONLY<BR>open&nbsp;c1<BR>fetch&nbsp;c1&nbsp;into&nbsp;&nbsp;@spid<BR>while&nbsp;@@fetch_status&nbsp;&gt;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;select&nbsp;@spidch&nbsp;=&nbsp;convert(char(5),&nbsp;@spid)<BR>&nbsp;print&nbsp;''<BR>&nbsp;select&nbsp;@msg&nbsp;=&nbsp;'Blocking&nbsp;SPID&nbsp;'&nbsp;+&nbsp;@spidch&nbsp;+&nbsp;'&nbsp;input&nbsp;buffer&nbsp;capture'<BR>&nbsp;print&nbsp;''<BR>&nbsp;print&nbsp;@msg<BR>&nbsp;select&nbsp;@msg&nbsp;=&nbsp;'dbcc&nbsp;inputbuffer('&nbsp;+&nbsp;@spidch&nbsp;+&nbsp;')'<BR>&nbsp;execute(@msg)<BR>&nbsp;fetch&nbsp;c1&nbsp;into&nbsp;&nbsp;@spid<BR>&nbsp;&nbsp;&nbsp;end<BR>deallocate&nbsp;c1</P>
<P>/*&nbsp;Dump&nbsp;inputbuffers&nbsp;for&nbsp;each&nbsp;blocked&nbsp;process&nbsp;*/</P>
<P>declare&nbsp;c1&nbsp;cursor&nbsp;for&nbsp;select&nbsp;spid&nbsp;from&nbsp;#info&nbsp;where&nbsp;blocked&nbsp;&gt;&nbsp;0&nbsp;FOR&nbsp;READ&nbsp;ONLY<BR>open&nbsp;c1<BR>fetch&nbsp;c1&nbsp;into&nbsp;&nbsp;@spid<BR>while&nbsp;@@fetch_status&nbsp;&gt;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;select&nbsp;@spidch&nbsp;=&nbsp;convert(char(5),&nbsp;@spid)<BR>&nbsp;print&nbsp;''<BR>&nbsp;select&nbsp;@msg&nbsp;=&nbsp;'Blocked&nbsp;SPID&nbsp;'&nbsp;+&nbsp;@spidch&nbsp;+&nbsp;'&nbsp;input&nbsp;buffer&nbsp;capture'<BR>&nbsp;print&nbsp;''<BR>&nbsp;print&nbsp;@msg<BR>&nbsp;select&nbsp;@msg&nbsp;=&nbsp;'dbcc&nbsp;inputbuffer('&nbsp;+&nbsp;@spidch&nbsp;+&nbsp;')'<BR>&nbsp;execute(@msg)<BR>&nbsp;fetch&nbsp;c1&nbsp;into&nbsp;&nbsp;@spid<BR>&nbsp;&nbsp;&nbsp;end<BR>deallocate&nbsp;c1</P>
<P>drop&nbsp;table&nbsp;#info&nbsp;--&nbsp;we&nbsp;are&nbsp;finished&nbsp;with&nbsp;the&nbsp;sysprocesses&nbsp;capture</P>
<P>/*&nbsp;Update&nbsp;locks&nbsp;table&nbsp;with&nbsp;tablename,&nbsp;objectname,&nbsp;indexname&nbsp;from&nbsp;the&nbsp;appropriate&nbsp;database&nbsp;*/</P>
<P>declare&nbsp;@dbname&nbsp;varchar(30),<BR>&nbsp;@objid&nbsp;int,<BR>&nbsp;@indid&nbsp;int,<BR>&nbsp;@idch&nbsp;varchar(20),<BR>&nbsp;@indch&nbsp;varchar(20),<BR>&nbsp;@objname&nbsp;varchar(30),<BR>&nbsp;@indexname&nbsp;varchar(30),<BR>&nbsp;@stmt&nbsp;varchar(500)</P>
<P>declare&nbsp;c2&nbsp;cursor&nbsp;for&nbsp;select&nbsp;distinct&nbsp;dbname,&nbsp;objid,&nbsp;indid&nbsp;from&nbsp;#locks&nbsp;where&nbsp;typeid&nbsp;between&nbsp;4&nbsp;and&nbsp;9&nbsp;for&nbsp;read&nbsp;only<BR>open&nbsp;c2<BR>fetch&nbsp;c2&nbsp;into&nbsp;&nbsp;@dbname,&nbsp;@objid,&nbsp;@indid<BR>while&nbsp;@@fetch_status&nbsp;&gt;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;select&nbsp;@idch=cast(@objid&nbsp;as&nbsp;varchar(20))<BR>&nbsp;select&nbsp;@indch=cast(@indid&nbsp;as&nbsp;varchar(20))<BR>&nbsp;if&nbsp;@indid&nbsp;&lt;&gt;&nbsp;0<BR>&nbsp;&nbsp;select&nbsp;@stmt&nbsp;=&nbsp;'update&nbsp;#locks&nbsp;set&nbsp;objectname&nbsp;=&nbsp;cast(o.name&nbsp;as&nbsp;char(30)),&nbsp;indname=cast(i.name&nbsp;as&nbsp;char(30))&nbsp;from&nbsp;#locks&nbsp;l,&nbsp;'&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@dbname&nbsp;+&nbsp;'..sysobjects&nbsp;o&nbsp;(nolock),&nbsp;'&nbsp;+&nbsp;@dbname&nbsp;+&nbsp;'..sysindexes&nbsp;i&nbsp;(nolock)&nbsp;where&nbsp;l.dbname&nbsp;=&nbsp;'&nbsp;+&nbsp;''''&nbsp;+&nbsp;@dbname&nbsp;+&nbsp;''''&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;'&nbsp;and&nbsp;l.objid&nbsp;=&nbsp;'&nbsp;+&nbsp;@idch&nbsp;+&nbsp;'&nbsp;and&nbsp;l.indid&nbsp;=&nbsp;'&nbsp;+&nbsp;@indch&nbsp;+&nbsp;'&nbsp;and&nbsp;o.id&nbsp;=&nbsp;'&nbsp;+&nbsp;@idch&nbsp;+&nbsp;'&nbsp;and&nbsp;i.id&nbsp;=&nbsp;'&nbsp;+&nbsp;@idch&nbsp;+&nbsp;'&nbsp;and&nbsp;i.indid&nbsp;=&nbsp;'&nbsp;+&nbsp;@indch<BR>&nbsp;else<BR>&nbsp;&nbsp;select&nbsp;@stmt&nbsp;=&nbsp;'update&nbsp;#locks&nbsp;set&nbsp;objectname&nbsp;=&nbsp;cast(o.name&nbsp;as&nbsp;char(30))&nbsp;from&nbsp;#locks&nbsp;l,&nbsp;'&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@dbname&nbsp;+&nbsp;'..sysobjects&nbsp;o&nbsp;(nolock)&nbsp;where&nbsp;l.dbname&nbsp;=&nbsp;'&nbsp;+&nbsp;''''&nbsp;+&nbsp;@dbname&nbsp;+&nbsp;''''&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;'&nbsp;and&nbsp;l.objid&nbsp;=&nbsp;'&nbsp;+&nbsp;@idch&nbsp;+&nbsp;'&nbsp;and&nbsp;l.indid&nbsp;=&nbsp;'&nbsp;+&nbsp;@indch&nbsp;+&nbsp;'&nbsp;and&nbsp;o.id&nbsp;=&nbsp;'&nbsp;+&nbsp;@idch<BR>&nbsp;execute(@stmt)<BR>&nbsp;fetch&nbsp;c2&nbsp;into&nbsp;&nbsp;@dbname,&nbsp;@objid,&nbsp;@indid<BR>&nbsp;&nbsp;&nbsp;end<BR>deallocate&nbsp;c2</P>
<P>/*&nbsp;Show&nbsp;lock&nbsp;information&nbsp;from&nbsp;syslocks&nbsp;capture&nbsp;*/</P>
<P>print&nbsp;''<BR>print&nbsp;'Locks'<BR>print&nbsp;''</P>
<P>select&nbsp;spid,&nbsp;type,&nbsp;mode,&nbsp;status,&nbsp;[database]=dbname,&nbsp;[index]=indname,&nbsp;[object]=objectname,&nbsp;resource,&nbsp;ownertype,&nbsp;"trans&nbsp;#"=transid,&nbsp;refcnt<BR>from&nbsp;#locks&nbsp;order&nbsp;by&nbsp;spid,&nbsp;dbname,&nbsp;object,&nbsp;indname,&nbsp;resource,&nbsp;type,&nbsp;mode,&nbsp;status</P>
<P>drop&nbsp;table&nbsp;#locks&nbsp;--&nbsp;drop&nbsp;syslockinfo&nbsp;capture<BR>GO</P>
<P>exec&nbsp;sp_activity<BR></P></FONT>