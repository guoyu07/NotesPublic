<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Search&nbsp;SQL&nbsp;Error&nbsp;Log</B><BR>Search&nbsp;SQL&nbsp;Error&nbsp;Log&nbsp;Script
<P></P>
<P></P>
<P><BR>This&nbsp;script&nbsp;creates&nbsp;an&nbsp;sp&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;search&nbsp;the&nbsp;SQL&nbsp;Error&nbsp;Log&nbsp;for&nbsp;a&nbsp;user&nbsp;specified&nbsp;search&nbsp;criteria.&nbsp;This&nbsp;can&nbsp;be&nbsp;very&nbsp;handy&nbsp;when&nbsp;trying&nbsp;to&nbsp;find&nbsp;a&nbsp;particular&nbsp;problem&nbsp;in&nbsp;very&nbsp;large&nbsp;SQL&nbsp;Error&nbsp;Logs.&nbsp;</P>
<P>The&nbsp;procedure&nbsp;</P>
<P>Reads&nbsp;the&nbsp;registry&nbsp;to&nbsp;determine&nbsp;where&nbsp;Your&nbsp;SQL&nbsp;install&nbsp;exists&nbsp;so&nbsp;that&nbsp;you&nbsp;do&nbsp;not&nbsp;have&nbsp;to&nbsp;tell&nbsp;it&nbsp;where&nbsp;your&nbsp;SQL&nbsp;Error&nbsp;Logs&nbsp;reside;&nbsp;<BR>Accept&nbsp;a&nbsp;log&nbsp;number&nbsp;variable&nbsp;for&nbsp;searching&nbsp;offline&nbsp;error&nbsp;logs;&nbsp;<BR>Tells&nbsp;you&nbsp;if&nbsp;it&nbsp;does&nbsp;not&nbsp;find&nbsp;anything&nbsp;in&nbsp;the&nbsp;error&nbsp;log&nbsp;for&nbsp;the&nbsp;search&nbsp;criteria&nbsp;you&nbsp;specified.&nbsp;<BR>The&nbsp;script&nbsp;has&nbsp;been&nbsp;tested&nbsp;on&nbsp;SQL&nbsp;7.0&nbsp;and&nbsp;2000.&nbsp;It&nbsp;should&nbsp;work&nbsp;in&nbsp;SQL&nbsp;6.5&nbsp;if&nbsp;the&nbsp;registry&nbsp;entries&nbsp;are&nbsp;the&nbsp;same,&nbsp;but&nbsp;the&nbsp;script&nbsp;has&nbsp;not&nbsp;been&nbsp;tested&nbsp;on&nbsp;this&nbsp;version&nbsp;of&nbsp;SQL&nbsp;Server.&nbsp;If&nbsp;it&nbsp;does&nbsp;not&nbsp;work&nbsp;on&nbsp;v6.5,&nbsp;either&nbsp;modify&nbsp;the&nbsp;registry&nbsp;call&nbsp;so&nbsp;that&nbsp;it&nbsp;is&nbsp;looking&nbsp;in&nbsp;the&nbsp;right&nbsp;place&nbsp;for&nbsp;the&nbsp;DataRoot&nbsp;Key&nbsp;or&nbsp;hard&nbsp;code&nbsp;the&nbsp;SQL&nbsp;Error&nbsp;Log&nbsp;Path.&nbsp;</P>
<P>It's&nbsp;recommened&nbsp;that&nbsp;this&nbsp;script&nbsp;be&nbsp;put&nbsp;in&nbsp;the&nbsp;Master&nbsp;db&nbsp;because&nbsp;it&nbsp;calls&nbsp;the&nbsp;xp_cmdshell&nbsp;extended&nbsp;stored&nbsp;procedure.&nbsp;</P>
<P>Author:&nbsp;Phillip&nbsp;Snipes&nbsp;<BR>if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;id&nbsp;=<BR>object_id(N'[dbo].[spKM_search_sqlerrorlog]')&nbsp;and&nbsp;OBJECTPROPERTY(id,<BR>N'IsProcedure')&nbsp;=&nbsp;1)<BR>drop&nbsp;procedure&nbsp;[dbo].[spKM_search_sqlerrorlog]<BR>GO</P>
<P>SET&nbsp;QUOTED_IDENTIFIER&nbsp;&nbsp;OFF&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;ANSI_NULLS&nbsp;&nbsp;OFF&nbsp;<BR>GO</P>
<P>CREATE&nbsp;proc&nbsp;&nbsp;dbo.spKM_search_sqlerrorlog&nbsp;</P>
<P>@lookfor&nbsp;varchar(25)=&nbsp;'',&nbsp;@LogNum&nbsp;char(2)=&nbsp;''</P>
<P>&nbsp;&nbsp;AS<BR>/******************************</P>
<P>sql-scripting&nbsp;04/04/2001&nbsp;</P>
<P>Visit&nbsp;www.sql-scripting.com&nbsp;<BR>Edward&nbsp;J&nbsp;Pochinski&nbsp;III&nbsp;</P>
<P>******************************/&nbsp;</P>
<P>/******************************</P>
<P>This&nbsp;script&nbsp;creates&nbsp;an&nbsp;sp&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;search&nbsp;the<BR>SQL&nbsp;Error&nbsp;Log&nbsp;for&nbsp;a&nbsp;user&nbsp;specified&nbsp;search&nbsp;criteria.<BR>This&nbsp;can&nbsp;be&nbsp;very&nbsp;handy&nbsp;when&nbsp;trying&nbsp;to&nbsp;find&nbsp;a&nbsp;particular<BR>problem&nbsp;in&nbsp;very&nbsp;large&nbsp;SQL&nbsp;Error&nbsp;Logs.<BR>I&nbsp;can&nbsp;not&nbsp;take&nbsp;full&nbsp;credit&nbsp;for&nbsp;this&nbsp;idea&nbsp;as<BR>I&nbsp;first&nbsp;found&nbsp;the&nbsp;script&nbsp;on&nbsp;www.sql-scripting.com.<BR>I&nbsp;have&nbsp;since&nbsp;modified&nbsp;&nbsp;it&nbsp;to&nbsp;<BR>1)&nbsp;read&nbsp;the&nbsp;registry&nbsp;to&nbsp;determine&nbsp;<BR>where&nbsp;Your&nbsp;SQL&nbsp;install&nbsp;exists&nbsp;so&nbsp;that&nbsp;you&nbsp;do&nbsp;not&nbsp;have&nbsp;to&nbsp;tell<BR>it&nbsp;where&nbsp;your&nbsp;SQL&nbsp;Error&nbsp;Logs&nbsp;reside;<BR>2)&nbsp;accept&nbsp;a&nbsp;log&nbsp;number&nbsp;variable&nbsp;for&nbsp;searching&nbsp;offline&nbsp;error&nbsp;logs;<BR>3)&nbsp;tell&nbsp;you&nbsp;if&nbsp;it&nbsp;does&nbsp;not&nbsp;find&nbsp;anything&nbsp;in&nbsp;the&nbsp;error&nbsp;log&nbsp;for&nbsp;the&nbsp;search<BR>criteria&nbsp;you&nbsp;specified.</P>
<P>Phillip&nbsp;D.&nbsp;Snipes</P>
<P>*******************************/</P>
<P>DECLARE&nbsp;@SQLLogPath&nbsp;varchar(20)</P>
<P>EXEC&nbsp;master..xp_regread&nbsp;@rootkey='HKEY_LOCAL_MACHINE',&nbsp;<BR>@key='SOFTWARE\Microsoft\MSSQLServer\Setup',&nbsp;@value_name='SQLDataRoot',<BR>@value=@SQLLogPath&nbsp;OUTPUT<BR>&nbsp;</P>
<P>Declare&nbsp;@cmd&nbsp;varchar(65)&nbsp;</P>
<P>/*********************<BR>Print&nbsp;help&nbsp;message&nbsp;if&nbsp;no&nbsp;search&nbsp;criteria&nbsp;specified.<BR>**********************/<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@lookfor&nbsp;=&nbsp;''&nbsp;</P>
<P>Begin&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;Print&nbsp;'#################################################'&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)+'You&nbsp;must&nbsp;pass&nbsp;a&nbsp;string&nbsp;to&nbsp;search&nbsp;for.'&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)+'example:&nbsp;To&nbsp;search&nbsp;current&nbsp;SQL&nbsp;Error&nbsp;Log&nbsp;for<BR>the&nbsp;word&nbsp;kernel'</P>
<P>Print&nbsp;char(13)+'exec&nbsp;spKM_search_sqlerrorlog&nbsp;kernel'&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)+'Optional&nbsp;parameter&nbsp;to&nbsp;pass&nbsp;is&nbsp;the&nbsp;Log<BR>Number.&nbsp;The&nbsp;SQL&nbsp;Server&nbsp;starts&nbsp;a&nbsp;new'&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)+'Error&nbsp;Log&nbsp;each&nbsp;time&nbsp;it&nbsp;is&nbsp;started.&nbsp;To&nbsp;search<BR>a&nbsp;previous&nbsp;SQL&nbsp;Error&nbsp;Log&nbsp;You&nbsp;must&nbsp;specify&nbsp;the&nbsp;Log&nbsp;Number.'&nbsp;</P>
<P>Print&nbsp;char(13)+'If&nbsp;you&nbsp;do&nbsp;not&nbsp;pass&nbsp;a&nbsp;Log&nbsp;Number&nbsp;the<BR>procedure&nbsp;will&nbsp;default&nbsp;to&nbsp;searching&nbsp;the&nbsp;current&nbsp;SQL&nbsp;Error&nbsp;Log.'&nbsp;</P>
<P>Print&nbsp;char(13)+'If&nbsp;you&nbsp;want&nbsp;to&nbsp;search&nbsp;previous&nbsp;Logs,&nbsp;then<BR>specify&nbsp;which&nbsp;Log&nbsp;to&nbsp;search&nbsp;by&nbsp;passing&nbsp;a&nbsp;number.'&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;Print&nbsp;char(13)+'example:&nbsp;To&nbsp;search&nbsp;the&nbsp;most&nbsp;recent&nbsp;previous<BR>SQL&nbsp;Error&nbsp;Log&nbsp;for&nbsp;the&nbsp;word&nbsp;kernel'</P>
<P>Print&nbsp;char(13)+'exec&nbsp;spKM_search_sqlerrorlog&nbsp;kernel,&nbsp;1'&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;Print<BR>char(13)+'#################################################'&nbsp;</P>
<P>&nbsp;&nbsp;Return</P>
<P><BR>End&nbsp;</P>
<P>/********************<BR>Defaults&nbsp;to&nbsp;searching&nbsp;current&nbsp;SQL&nbsp;Error&nbsp;Log&nbsp;if&nbsp;no&nbsp;LogNum&nbsp;specified.<BR>*********************/<BR>If&nbsp;@LogNum&nbsp;=&nbsp;''<BR>Begin<BR>Set&nbsp;NoCount&nbsp;On<BR>&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@cmd&nbsp;=&nbsp;'FINDSTR&nbsp;/I&nbsp;/C:"'+@lookfor+'"&nbsp;'&nbsp;+&nbsp;@SQLLogPath&nbsp;+<BR>'\Log\errorlog'<BR>Create&nbsp;Table&nbsp;#Results&nbsp;(&nbsp;Results&nbsp;varchar(8000))<BR>insert&nbsp;into&nbsp;#Results<BR>Exec&nbsp;xp_cmdshell&nbsp;@cmd<BR>Select&nbsp;*&nbsp;from&nbsp;#Results<BR>IF&nbsp;@@ROWCOUNT&nbsp;=&nbsp;0&nbsp;<BR>BEGIN&nbsp;<BR>Print&nbsp;char(13)+'There&nbsp;are&nbsp;no&nbsp;entries&nbsp;in&nbsp;the<BR>Current&nbsp;SQL&nbsp;Error&nbsp;Log&nbsp;matching&nbsp;the&nbsp;search&nbsp;criteria&nbsp;"'+@lookfor+'".'<BR>End<BR>Drop&nbsp;Table&nbsp;#Results<BR>Set&nbsp;NoCount&nbsp;Off</P>
<P>End<BR>/****************<BR>Print&nbsp;which&nbsp;SQL&nbsp;Error&nbsp;Log&nbsp;file&nbsp;is&nbsp;being&nbsp;searched.<BR>*****************/&nbsp;<BR>If&nbsp;@LogNum&nbsp;&gt;&nbsp;0&nbsp;And&nbsp;@LogNum&nbsp;&lt;&nbsp;7<BR>Begin<BR>If&nbsp;@logNum&nbsp;=&nbsp;1&nbsp;<BR>Begin<BR>Print&nbsp;char(13)+'SQL&nbsp;Error&nbsp;Log&nbsp;Archive&nbsp;#1'<BR>End<BR>If&nbsp;@logNum&nbsp;=&nbsp;2&nbsp;<BR>Begin<BR>Print&nbsp;char(13)+'SQL&nbsp;Error&nbsp;Log&nbsp;Archive&nbsp;#2'<BR>End<BR>If&nbsp;@logNum&nbsp;=&nbsp;3&nbsp;<BR>Begin<BR>Print&nbsp;char(13)+'SQL&nbsp;Error&nbsp;Log&nbsp;Archive&nbsp;#3'<BR>End<BR>If&nbsp;@logNum&nbsp;=&nbsp;4&nbsp;<BR>Begin<BR>Print&nbsp;char(13)+'SQL&nbsp;Error&nbsp;Log&nbsp;Archive&nbsp;#4'<BR>End<BR>If&nbsp;@logNum&nbsp;=&nbsp;5&nbsp;<BR>Begin<BR>Print&nbsp;char(13)+'SQL&nbsp;Error&nbsp;Log&nbsp;Archive&nbsp;#5'<BR>End<BR>If&nbsp;@logNum&nbsp;=&nbsp;6&nbsp;<BR>Begin<BR>Print&nbsp;char(13)+'SQL&nbsp;Error&nbsp;Log&nbsp;Archive&nbsp;#6'<BR>End</P>
<P>Set&nbsp;NoCount&nbsp;On<BR>set&nbsp;@cmd&nbsp;=&nbsp;'FINDSTR&nbsp;/I&nbsp;/C:"'+@lookfor+'"&nbsp;'&nbsp;+&nbsp;@SQLLogPath&nbsp;+<BR>'\Log\errorlog.'&nbsp;+&nbsp;@LogNum&nbsp;<BR>Create&nbsp;Table&nbsp;#Results1&nbsp;(&nbsp;Results&nbsp;varchar(8000))<BR>insert&nbsp;into&nbsp;#Results1<BR>Exec&nbsp;xp_cmdshell&nbsp;@cmd<BR>Select&nbsp;*&nbsp;from&nbsp;#Results1<BR>IF&nbsp;@@ROWCOUNT&nbsp;=&nbsp;0&nbsp;<BR>BEGIN&nbsp;<BR>Print&nbsp;char(13)+'There&nbsp;are&nbsp;no&nbsp;entries&nbsp;in&nbsp;the<BR>SQL&nbsp;Error&nbsp;Log&nbsp;Archive&nbsp;#'+@LogNum+'&nbsp;matching&nbsp;the&nbsp;search&nbsp;criteria<BR>"'+@lookfor+'".'<BR>End<BR>Drop&nbsp;Table&nbsp;#Results1<BR>Set&nbsp;NoCount&nbsp;Off<BR>End</P>
<P>/*************************<BR>Prinnt&nbsp;an&nbsp;error&nbsp;message&nbsp;if&nbsp;the&nbsp;LogNum&nbsp;specified&nbsp;is&nbsp;too&nbsp;high.<BR>**************************/<BR>If&nbsp;@logNum&nbsp;&gt;&nbsp;6&nbsp;<BR>Begin<BR>Print&nbsp;char(13)+'SQL&nbsp;Error&nbsp;Log&nbsp;Number&nbsp;out&nbsp;of<BR>Range.&nbsp;MS&nbsp;SQL&nbsp;Server&nbsp;does&nbsp;not&nbsp;maintain&nbsp;more&nbsp;than&nbsp;6&nbsp;Archived&nbsp;Error&nbsp;Logs.'<BR></P></FONT>