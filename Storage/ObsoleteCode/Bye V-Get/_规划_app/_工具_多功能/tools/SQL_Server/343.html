<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>ExportToExcel</B><BR>Version:&nbsp;SQL&nbsp;Server&nbsp;7.0/2000<BR>Created&nbsp;by:&nbsp;Alexander&nbsp;Chigrik<BR><IMG 
src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.MSSQLCity.com/" 
target=_blank>http://www.MSSQLCity.com/</A>&nbsp;-&nbsp;all&nbsp;about&nbsp;MS&nbsp;SQL<BR>(SQL&nbsp;Server&nbsp;Articles,&nbsp;FAQ,&nbsp;Scripts,&nbsp;Tips&nbsp;and&nbsp;Test&nbsp;Exams).
<P></P>
<P>This&nbsp;stored&nbsp;procedure&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;insert&nbsp;the&nbsp;result&nbsp;set&nbsp;of&nbsp;the<BR>particular&nbsp;select&nbsp;statement&nbsp;into&nbsp;Excel&nbsp;file&nbsp;(c:\ImportToExcel.xls,<BR>by&nbsp;default).<BR>You&nbsp;can&nbsp;pass&nbsp;the&nbsp;server&nbsp;name,&nbsp;user&nbsp;name,&nbsp;user&nbsp;password,&nbsp;the&nbsp;select<BR>statement&nbsp;to&nbsp;execute,&nbsp;and&nbsp;the&nbsp;file&nbsp;name&nbsp;to&nbsp;store&nbsp;the&nbsp;results&nbsp;set,<BR>as&nbsp;in&nbsp;the&nbsp;example&nbsp;below:</P>
<P>EXEC&nbsp;ExportToExcel&nbsp;@server&nbsp;=&nbsp;'.',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@uname&nbsp;=&nbsp;'sa',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@QueryText&nbsp;=&nbsp;'SELECT&nbsp;au_fname&nbsp;FROM&nbsp;pubs..authors',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@filename&nbsp;=&nbsp;'c:\ImportToExcel.xls'</P>
<P>/*<BR>Version:&nbsp;SQL&nbsp;Server&nbsp;7.0/2000<BR>Created&nbsp;by:&nbsp;Alexander&nbsp;Chigrik<BR><IMG 
src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.MSSQLCity.com/" 
target=_blank>http://www.MSSQLCity.com/</A>&nbsp;-&nbsp;all&nbsp;about&nbsp;MS&nbsp;SQL<BR>(SQL&nbsp;Server&nbsp;Articles,&nbsp;FAQ,&nbsp;Scripts,&nbsp;Tips&nbsp;and&nbsp;Test&nbsp;Exams).</P>
<P>This&nbsp;stored&nbsp;procedure&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;insert&nbsp;the&nbsp;result&nbsp;set&nbsp;of&nbsp;the<BR>particular&nbsp;select&nbsp;statement&nbsp;into&nbsp;Excel&nbsp;file&nbsp;(c:\ImportToExcel.xls,<BR>by&nbsp;default).<BR>You&nbsp;can&nbsp;pass&nbsp;the&nbsp;server&nbsp;name,&nbsp;user&nbsp;name,&nbsp;user&nbsp;password,&nbsp;the&nbsp;select<BR>statement&nbsp;to&nbsp;execute,&nbsp;and&nbsp;the&nbsp;file&nbsp;name&nbsp;to&nbsp;store&nbsp;the&nbsp;results&nbsp;set,<BR>as&nbsp;in&nbsp;the&nbsp;example&nbsp;below:</P>
<P>EXEC&nbsp;ExportToExcel&nbsp;@server&nbsp;=&nbsp;'.',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@uname&nbsp;=&nbsp;'sa',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@QueryText&nbsp;=&nbsp;'SELECT&nbsp;au_fname&nbsp;FROM&nbsp;pubs..authors',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@filename&nbsp;=&nbsp;'c:\ImportToExcel.xls'<BR>*/</P>
<P>IF&nbsp;OBJECT_ID('ExportToExcel')&nbsp;IS&nbsp;NOT&nbsp;NULL&nbsp;DROP&nbsp;PROC&nbsp;ExportToExcel<BR>GO</P>
<P>CREATE&nbsp;PROCEDURE&nbsp;ExportToExcel&nbsp;(<BR>&nbsp;&nbsp;@server&nbsp;sysname&nbsp;=&nbsp;null,<BR>&nbsp;&nbsp;@uname&nbsp;sysname&nbsp;=&nbsp;null,<BR>&nbsp;&nbsp;@pwd&nbsp;sysname&nbsp;=&nbsp;null,<BR>&nbsp;&nbsp;@QueryText&nbsp;varchar(200)&nbsp;=&nbsp;null,<BR>&nbsp;&nbsp;@filename&nbsp;varchar(200)&nbsp;=&nbsp;'c:\ImportToExcel.xls'<BR>)<BR>AS<BR>DECLARE&nbsp;@SQLServer&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@QueryResults&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@CurrentResultSet&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@object&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@WorkBooks&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@WorkBook&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Range&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@hr&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Columns&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Rows&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@indColumn&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@indRow&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@off_Column&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@off_Row&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@code_str&nbsp;varchar(100),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@result_str&nbsp;varchar(255)</P>
<P>IF&nbsp;@QueryText&nbsp;IS&nbsp;NULL&nbsp;<BR>&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'Set&nbsp;the&nbsp;query&nbsp;string'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>&nbsp;&nbsp;END</P>
<P>--&nbsp;Sets&nbsp;the&nbsp;server&nbsp;to&nbsp;the&nbsp;local&nbsp;server<BR>IF&nbsp;@server&nbsp;IS&nbsp;NULL&nbsp;SELECT&nbsp;@server&nbsp;=&nbsp;@@servername</P>
<P>--&nbsp;Sets&nbsp;the&nbsp;username&nbsp;to&nbsp;the&nbsp;current&nbsp;user&nbsp;name<BR>IF&nbsp;@uname&nbsp;IS&nbsp;NULL&nbsp;SELECT&nbsp;@uname&nbsp;=&nbsp;SYSTEM_USER</P>
<P>SET&nbsp;NOCOUNT&nbsp;ON</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OACreate&nbsp;'SQLDMO.SQLServer',&nbsp;@SQLServer&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;create&nbsp;SQLDMO.SQLServer'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>--&nbsp;&nbsp;Connect&nbsp;to&nbsp;the&nbsp;SQL&nbsp;Server<BR>IF&nbsp;@pwd&nbsp;IS&nbsp;NULL<BR>&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@SQLServer,&nbsp;'Connect',&nbsp;null,&nbsp;@server,&nbsp;@uname<BR>&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;Connect'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END<BR>&nbsp;&nbsp;END<BR>ELSE<BR>&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@SQLServer,&nbsp;'Connect',&nbsp;null,&nbsp;@server,&nbsp;@uname,&nbsp;@pwd<BR>&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;Connect'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END<BR>&nbsp;&nbsp;END</P>
<P>SELECT&nbsp;@result_str&nbsp;=&nbsp;'ExecuteWithResults("'&nbsp;+&nbsp;@QueryText&nbsp;+&nbsp;'")'<BR>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@SQLServer,&nbsp;@result_str,&nbsp;@QueryResults&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;with&nbsp;method&nbsp;ExecuteWithResults'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@QueryResults,&nbsp;'CurrentResultSet',&nbsp;@CurrentResultSet&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;get&nbsp;CurrentResultSet'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@QueryResults,&nbsp;'Columns',&nbsp;@Columns&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;get&nbsp;Columns'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@QueryResults,&nbsp;'Rows',&nbsp;@Rows&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;get&nbsp;Rows'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OACreate&nbsp;'Excel.Application',&nbsp;@object&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;create&nbsp;Excel.Application'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAGetProperty&nbsp;@object,&nbsp;'WorkBooks',&nbsp;@WorkBooks&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;create&nbsp;WorkBooks'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAGetProperty&nbsp;@WorkBooks,&nbsp;'Add',&nbsp;@WorkBook&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;with&nbsp;method&nbsp;Add'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAGetProperty&nbsp;@object,&nbsp;'Range("A1")',&nbsp;@Range&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;create&nbsp;Range'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>SELECT&nbsp;@indRow&nbsp;=&nbsp;1<BR>SELECT&nbsp;@off_Row&nbsp;=&nbsp;0<BR>SELECT&nbsp;@off_Column&nbsp;=&nbsp;1</P>
<P>WHILE&nbsp;(@indRow&nbsp;&lt;=&nbsp;@Rows)<BR>BEGIN<BR>SELECT&nbsp;@indColumn&nbsp;=&nbsp;1</P>
<P>WHILE&nbsp;(@indColumn&nbsp;&lt;=&nbsp;@Columns)<BR>BEGIN</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@QueryResults,&nbsp;'GetColumnString',&nbsp;@result_str&nbsp;OUT,&nbsp;@indRow,&nbsp;@indColumn<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;get&nbsp;GetColumnString'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OASetProperty&nbsp;@Range,&nbsp;'value',&nbsp;@result_str<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;set&nbsp;value'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAGetProperty&nbsp;@Range,&nbsp;'Offset',&nbsp;@Range&nbsp;OUT,&nbsp;@off_Row,&nbsp;@off_Column<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;get&nbsp;Offset'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>SELECT&nbsp;@indColumn&nbsp;=&nbsp;@indColumn&nbsp;+&nbsp;1</P>
<P>END</P>
<P>SELECT&nbsp;@indRow&nbsp;=&nbsp;@indRow&nbsp;+&nbsp;1<BR>SELECT&nbsp;@code_str&nbsp;=&nbsp;'Range("A'&nbsp;+&nbsp;LTRIM(str(@indRow))&nbsp;+&nbsp;'")'<BR>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAGetProperty&nbsp;@object,&nbsp;@code_str,&nbsp;@Range&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;create&nbsp;Range'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>END</P>
<P>SELECT&nbsp;@result_str&nbsp;=&nbsp;'exec&nbsp;master..xp_cmdshell&nbsp;''del&nbsp;'&nbsp;+&nbsp;@filename&nbsp;+&nbsp;''',&nbsp;no_output'<BR>EXEC(@result_str)<BR>SELECT&nbsp;@result_str&nbsp;=&nbsp;'SaveAs("'&nbsp;+&nbsp;@filename&nbsp;+&nbsp;'")'<BR>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@WorkBook,&nbsp;@result_str<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;with&nbsp;method&nbsp;SaveAs'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@WorkBook,&nbsp;'Close'<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;with&nbsp;method&nbsp;Close'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OADestroy&nbsp;@object<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;destroy&nbsp;Excel.Application'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END</P>
<P>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OADestroy&nbsp;@SQLServer<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;PRINT&nbsp;'error&nbsp;destroy&nbsp;SQLDMO.SQLServer'<BR>&nbsp;&nbsp;&nbsp;&nbsp;RETURN<BR>END<BR>GO</P></FONT>