<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>sp_lock2</B><BR>Version:&nbsp;SQL&nbsp;Server&nbsp;7.0/2000<BR>Created&nbsp;by:&nbsp;Alexander&nbsp;Chigrik<BR><IMG 
src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.MSSQLCity.com/" 
target=_blank>http://www.MSSQLCity.com/</A>&nbsp;-&nbsp;all&nbsp;about&nbsp;MS&nbsp;SQL<BR>(SQL&nbsp;Server&nbsp;Articles,&nbsp;FAQ,&nbsp;Scripts,&nbsp;Tips&nbsp;and&nbsp;Test&nbsp;Exams).
<P></P>
<P>This&nbsp;stored&nbsp;procedure&nbsp;can&nbsp;be&nbsp;used&nbsp;instead&nbsp;of&nbsp;sp_lock&nbsp;system&nbsp;stored&nbsp;procedure<BR>to&nbsp;return&nbsp;more&nbsp;detailed&nbsp;locking&nbsp;view&nbsp;(it&nbsp;can&nbsp;return&nbsp;user&nbsp;name,&nbsp;host&nbsp;name,<BR>database&nbsp;name,&nbsp;object&nbsp;name,&nbsp;index&nbsp;name&nbsp;and&nbsp;object&nbsp;owner).<BR>This&nbsp;is&nbsp;the&nbsp;example&nbsp;to&nbsp;use&nbsp;sp_lock2:</P>
<P>EXEC&nbsp;sp_lock2</P>
<P>/*<BR>Version:&nbsp;SQL&nbsp;Server&nbsp;7.0/2000<BR>Created&nbsp;by:&nbsp;Alexander&nbsp;Chigrik<BR><IMG 
src="http://www.pigtwo.com/forum/pic/url.gif" align=absMiddle border=0><A href="http://www.MSSQLCity.com/" 
target=_blank>http://www.MSSQLCity.com/</A>&nbsp;-&nbsp;all&nbsp;about&nbsp;MS&nbsp;SQL<BR>(SQL&nbsp;Server&nbsp;Articles,&nbsp;FAQ,&nbsp;Scripts,&nbsp;Tips&nbsp;and&nbsp;Test&nbsp;Exams).</P>
<P>This&nbsp;stored&nbsp;procedure&nbsp;can&nbsp;be&nbsp;used&nbsp;instead&nbsp;of&nbsp;sp_lock&nbsp;stored&nbsp;procedure<BR>to&nbsp;return&nbsp;more&nbsp;detailed&nbsp;locking&nbsp;view&nbsp;(it&nbsp;can&nbsp;return&nbsp;user&nbsp;name,&nbsp;host&nbsp;name,<BR>database&nbsp;name,&nbsp;object&nbsp;name,&nbsp;index&nbsp;name&nbsp;and&nbsp;object&nbsp;owner).<BR>This&nbsp;is&nbsp;the&nbsp;example&nbsp;to&nbsp;use&nbsp;sp_lock2:</P>
<P>EXEC&nbsp;sp_lock2<BR>*/</P>
<P>USE&nbsp;MASTER<BR>GO<BR>IF&nbsp;OBJECT_ID('sp_lock2')&nbsp;IS&nbsp;NOT&nbsp;NULL&nbsp;DROP&nbsp;PROC&nbsp;sp_lock2<BR>GO<BR>CREATE&nbsp;PROCEDURE&nbsp;sp_lock2<BR>@spid1&nbsp;int&nbsp;=&nbsp;NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;server&nbsp;process&nbsp;id&nbsp;to&nbsp;check&nbsp;for&nbsp;locks&nbsp;*/<BR>@spid2&nbsp;int&nbsp;=&nbsp;NULL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;other&nbsp;process&nbsp;id&nbsp;to&nbsp;check&nbsp;for&nbsp;locks&nbsp;*/<BR>as</P>
<P>set&nbsp;nocount&nbsp;on<BR>/*<BR>**&nbsp;Show&nbsp;the&nbsp;locks&nbsp;for&nbsp;both&nbsp;parameters.<BR>*/<BR>declare&nbsp;@objid&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;@indid&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;@dbid&nbsp;int,<BR>&nbsp;&nbsp;&nbsp;@string&nbsp;Nvarchar(255)</P>
<P>CREATE&nbsp;TABLE&nbsp;#locktable<BR>&nbsp;&nbsp;&nbsp;(<BR>&nbsp;&nbsp;&nbsp;spid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smallint<BR>&nbsp;&nbsp;&nbsp;,loginname&nbsp;nvarchar(20)<BR>&nbsp;&nbsp;&nbsp;,hostname&nbsp;&nbsp;nvarchar(30)<BR>&nbsp;&nbsp;&nbsp;,dbid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int<BR>&nbsp;&nbsp;&nbsp;,dbname&nbsp;&nbsp;&nbsp;&nbsp;nvarchar(20)<BR>&nbsp;&nbsp;&nbsp;,ObjOwner&nbsp;&nbsp;nvarchar(128)<BR>&nbsp;&nbsp;&nbsp;,objId&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int<BR>&nbsp;&nbsp;&nbsp;,ObjName&nbsp;&nbsp;&nbsp;nvarchar(128)<BR>&nbsp;&nbsp;&nbsp;,IndId&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int<BR>&nbsp;&nbsp;&nbsp;,IndName&nbsp;&nbsp;&nbsp;nvarchar(128)<BR>&nbsp;&nbsp;&nbsp;,Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nvarchar(4)<BR>&nbsp;&nbsp;&nbsp;,Resource&nbsp;&nbsp;nvarchar(16)<BR>&nbsp;&nbsp;&nbsp;,Mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nvarchar(8)<BR>&nbsp;&nbsp;&nbsp;,Status&nbsp;&nbsp;&nbsp;&nbsp;nvarchar(5)<BR>&nbsp;&nbsp;&nbsp;)</P>
<P>if&nbsp;@spid1&nbsp;is&nbsp;not&nbsp;NULL<BR>begin<BR>&nbsp;&nbsp;&nbsp;INSERT&nbsp;#locktable<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,loginname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,hostname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,dbid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,dbname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,ObjOwner<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,objId<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,ObjName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,IndId<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,IndName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,Type<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,Resource<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,Mode<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,Status<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<BR>&nbsp;&nbsp;&nbsp;select&nbsp;convert&nbsp;(smallint,&nbsp;l.req_spid)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,coalesce(substring&nbsp;(s.loginame,&nbsp;1,&nbsp;20),'')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,coalesce(substring&nbsp;(s.hostname,&nbsp;1,&nbsp;30),'')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,l.rsc_dbid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(db_name(l.rsc_dbid),&nbsp;1,&nbsp;20)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,l.rsc_objid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,l.rsc_indid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(v.name,&nbsp;1,&nbsp;4)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(l.rsc_text,&nbsp;1,&nbsp;16)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(u.name,&nbsp;1,&nbsp;8)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(x.name,&nbsp;1,&nbsp;5)<BR>&nbsp;&nbsp;&nbsp;from&nbsp;master.dbo.syslockinfo&nbsp;l,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master.dbo.spt_values&nbsp;v,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master.dbo.spt_values&nbsp;x,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master.dbo.spt_values&nbsp;u,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master.dbo.sysprocesses&nbsp;s<BR>&nbsp;&nbsp;&nbsp;where&nbsp;l.rsc_type&nbsp;=&nbsp;v.number<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;v.type&nbsp;=&nbsp;'LR'<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;l.req_status&nbsp;=&nbsp;x.number<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;x.type&nbsp;=&nbsp;'LS'<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;l.req_mode&nbsp;+&nbsp;1&nbsp;=&nbsp;u.number<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;u.type&nbsp;=&nbsp;'L'<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;req_spid&nbsp;in&nbsp;(@spid1,&nbsp;@spid2)<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;req_spid&nbsp;=&nbsp;s.spid<BR>end<BR>/*<BR>**&nbsp;No&nbsp;parameters,&nbsp;so&nbsp;show&nbsp;all&nbsp;the&nbsp;locks.<BR>*/<BR>else<BR>begin<BR>&nbsp;&nbsp;&nbsp;INSERT&nbsp;#locktable<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,loginname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,hostname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,dbid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,dbname<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,ObjOwner<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,objId<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,ObjName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,IndId<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,IndName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,Type<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,Resource<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,Mode<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,Status<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<BR>&nbsp;&nbsp;&nbsp;select&nbsp;convert&nbsp;(smallint,&nbsp;l.req_spid)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,coalesce(substring&nbsp;(s.loginame,&nbsp;1,&nbsp;20),'')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,coalesce(substring&nbsp;(s.hostname,&nbsp;1,&nbsp;30),'')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,l.rsc_dbid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(db_name(l.rsc_dbid),&nbsp;1,&nbsp;20)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,l.rsc_objid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,l.rsc_indid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,''<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(v.name,&nbsp;1,&nbsp;4)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(l.rsc_text,&nbsp;1,&nbsp;16)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(u.name,&nbsp;1,&nbsp;8)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,substring&nbsp;(x.name,&nbsp;1,&nbsp;5)<BR>&nbsp;&nbsp;&nbsp;from&nbsp;master.dbo.syslockinfo&nbsp;l,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master.dbo.spt_values&nbsp;v,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master.dbo.spt_values&nbsp;x,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master.dbo.spt_values&nbsp;u,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;master.dbo.sysprocesses&nbsp;s<BR>&nbsp;&nbsp;&nbsp;where&nbsp;l.rsc_type&nbsp;=&nbsp;v.number<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;v.type&nbsp;=&nbsp;'LR'<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;l.req_status&nbsp;=&nbsp;x.number<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;x.type&nbsp;=&nbsp;'LS'<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;l.req_mode&nbsp;+&nbsp;1&nbsp;=&nbsp;u.number<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;u.type&nbsp;=&nbsp;'L'<BR>&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;req_spid&nbsp;=&nbsp;s.spid<BR>&nbsp;&nbsp;&nbsp;order&nbsp;by&nbsp;spID<BR>END<BR>DECLARE&nbsp;lock_cursor&nbsp;CURSOR<BR>FOR&nbsp;SELECT&nbsp;dbid,&nbsp;ObjId,&nbsp;IndId&nbsp;FROM&nbsp;#locktable<BR>&nbsp;&nbsp;WHERE&nbsp;Type&nbsp;&lt;&gt;'DB'&nbsp;and&nbsp;Type&nbsp;&lt;&gt;&nbsp;'FIL'</P>
<P>OPEN&nbsp;lock_cursor<BR>FETCH&nbsp;NEXT&nbsp;FROM&nbsp;lock_cursor&nbsp;INTO&nbsp;@dbid,&nbsp;@ObjId,&nbsp;@IndId<BR>WHILE&nbsp;@@FETCH_STATUS&nbsp;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;BEGIN</P>
<P>&nbsp;&nbsp;&nbsp;SELECT&nbsp;@string&nbsp;=<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'USE&nbsp;'&nbsp;+&nbsp;db_name(@dbid)&nbsp;+&nbsp;char(13)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'update&nbsp;#locktable&nbsp;set&nbsp;ObjName&nbsp;=&nbsp;name,&nbsp;ObjOwner&nbsp;=&nbsp;USER_NAME(uid)'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;id&nbsp;=&nbsp;'&nbsp;+&nbsp;convert(varchar(32),@objid)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'&nbsp;and&nbsp;ObjId&nbsp;=&nbsp;'&nbsp;+&nbsp;convert(varchar(32),@objid)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'&nbsp;and&nbsp;dbid&nbsp;=&nbsp;'&nbsp;+&nbsp;convert(varchar(32),@dbId)</P>
<P>&nbsp;&nbsp;&nbsp;EXECUTE&nbsp;(@string)</P>
<P>&nbsp;&nbsp;&nbsp;SELECT&nbsp;@string&nbsp;=<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'USE&nbsp;'&nbsp;+&nbsp;db_name(@dbid)&nbsp;+&nbsp;char(13)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'update&nbsp;#locktable&nbsp;set&nbsp;IndName&nbsp;=&nbsp;i.name&nbsp;from&nbsp;sysindexes&nbsp;i&nbsp;'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'&nbsp;where&nbsp;i.id&nbsp;=&nbsp;'&nbsp;+&nbsp;convert(varchar(32),@objid)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'&nbsp;and&nbsp;i.indid&nbsp;=&nbsp;'&nbsp;+&nbsp;convert(varchar(32),@indid)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'&nbsp;and&nbsp;ObjId&nbsp;=&nbsp;'&nbsp;+&nbsp;convert(varchar(32),@objid)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'&nbsp;and&nbsp;dbid&nbsp;=&nbsp;'&nbsp;+&nbsp;convert(varchar(32),@dbId)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;'&nbsp;and&nbsp;#locktable.indid&nbsp;=&nbsp;'&nbsp;+&nbsp;convert(varchar(32),@indid)</P>
<P>&nbsp;&nbsp;&nbsp;EXECUTE&nbsp;(@string)</P>
<P>&nbsp;&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;lock_cursor&nbsp;INTO&nbsp;@dbid,&nbsp;@ObjId,&nbsp;@IndId<BR>&nbsp;&nbsp;&nbsp;END<BR>CLOSE&nbsp;lock_cursor<BR>DEALLOCATE&nbsp;lock_cursor</P>
<P>SELECT&nbsp;*&nbsp;FROM&nbsp;#locktable<BR>return&nbsp;(0)<BR>--&nbsp;END&nbsp;sp_lock2<BR>GO</P></FONT>