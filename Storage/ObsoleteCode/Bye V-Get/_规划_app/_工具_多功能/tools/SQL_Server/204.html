<meta http-equiv="content-type" content="text/html; charset=gb2312">&nbsp;<FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Creating&nbsp;a&nbsp;Script&nbsp;from&nbsp;a&nbsp;Stored&nbsp;Procedure</B><BR>A&nbsp;simple&nbsp;task,&nbsp;I&nbsp;thought,&nbsp;but&nbsp;it&nbsp;took&nbsp;me&nbsp;to&nbsp;some&nbsp;interesting&nbsp;places.&nbsp;The&nbsp;method&nbsp;is&nbsp;broadly&nbsp;this:
<P></P>
<P>1)&nbsp;Create&nbsp;an&nbsp;instance&nbsp;of&nbsp;SQL-DMO&nbsp;SQL&nbsp;Server,&nbsp;and&nbsp;use&nbsp;the&nbsp;script&nbsp;method&nbsp;to&nbsp;save&nbsp;the&nbsp;create&nbsp;table&nbsp;text&nbsp;in&nbsp;a&nbsp;file.<BR>2)&nbsp;Get&nbsp;the&nbsp;text&nbsp;from&nbsp;the&nbsp;file&nbsp;into&nbsp;a&nbsp;sp&nbsp;variable.<BR>3)&nbsp;Delete&nbsp;the&nbsp;text&nbsp;file.</P>
<P>Here&nbsp;are&nbsp;the&nbsp;details&nbsp;of&nbsp;the&nbsp;method,&nbsp;and&nbsp;a&nbsp;summary&nbsp;which&nbsp;puts&nbsp;it&nbsp;all&nbsp;together:</P>
<P>1)&nbsp;Create&nbsp;an&nbsp;instance&nbsp;of&nbsp;SQL-DMO&nbsp;SQL&nbsp;Server,&nbsp;and&nbsp;use&nbsp;the&nbsp;script&nbsp;method&nbsp;to&nbsp;save&nbsp;the&nbsp;create&nbsp;table&nbsp;text&nbsp;in&nbsp;a&nbsp;file.&nbsp;&nbsp;Here's&nbsp;the&nbsp;usage:</P>
<P>exec&nbsp;run_script&nbsp;'my_server',&nbsp;'my_database',&nbsp;'my_table',&nbsp;74077,&nbsp;'my_path_name'</P>
<P>And&nbsp;here's&nbsp;the&nbsp;sp...</P>
<P>CREATE&nbsp;proc&nbsp;run_script<BR>@server&nbsp;varchar(100),<BR>@database_name&nbsp;varchar(100),<BR>@table_name&nbsp;varchar(100),<BR>@script_id&nbsp;int,<BR>@path_name&nbsp;varchar(200)&nbsp;as</P>
<P>--runs&nbsp;a&nbsp;sql&nbsp;server&nbsp;script&nbsp;and&nbsp;outputs&nbsp;it&nbsp;to&nbsp;a&nbsp;file.</P>
<P>declare&nbsp;@i&nbsp;int<BR>declare&nbsp;@object&nbsp;int<BR>declare&nbsp;@return&nbsp;varchar(200)<BR>declare&nbsp;@q&nbsp;varchar(200)<BR>declare&nbsp;@is_error&nbsp;bit</P>
<P>set&nbsp;@is_error&nbsp;=&nbsp;0</P>
<P>--create&nbsp;sql&nbsp;server&nbsp;object<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OACreate&nbsp;'SQLDMO.SQLServer',&nbsp;@object&nbsp;OUT<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object</P>
<P>--connect&nbsp;to&nbsp;sql&nbsp;server&nbsp;using&nbsp;windows&nbsp;nt&nbsp;and&nbsp;verify&nbsp;the&nbsp;connection&nbsp;EXEC<BR>@i&nbsp;=&nbsp;sp_OASetProperty&nbsp;@object,&nbsp;'LoginSecure',&nbsp;1<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OAMethod&nbsp;@object,&nbsp;'Connect',&nbsp;NULL,&nbsp;@server<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OAMethod&nbsp;@object,&nbsp;'VerifyConnection',&nbsp;@return&nbsp;OUT<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object</P>
<P>--run&nbsp;the&nbsp;script<BR>SET&nbsp;@q&nbsp;=&nbsp;'Databases("'&nbsp;+&nbsp;@database_name&nbsp;+&nbsp;'").Tables("'&nbsp;+&nbsp;@table_name<BR>+<BR>'").Script('&nbsp;+&nbsp;cast(@script_id&nbsp;as&nbsp;varchar(10))&nbsp;+&nbsp;',&nbsp;'&nbsp;+&nbsp;@path_name&nbsp;+<BR>')'<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;begin&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object&nbsp;set&nbsp;@is_error&nbsp;=&nbsp;1<BR>end<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OAMethod&nbsp;@object,&nbsp;@q,&nbsp;@return&nbsp;OUT<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;begin&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object&nbsp;set&nbsp;@is_error&nbsp;=&nbsp;1<BR>end</P>
<P>--destroy&nbsp;sql&nbsp;server&nbsp;object<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OADestroy&nbsp;@object<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object</P>
<P>return&nbsp;@is_error<BR>GO</P>
<P>2)&nbsp;Get&nbsp;the&nbsp;text&nbsp;from&nbsp;the&nbsp;file&nbsp;into&nbsp;a&nbsp;sp&nbsp;variable.&nbsp;My&nbsp;first&nbsp;try&nbsp;was&nbsp;to&nbsp;use&nbsp;the&nbsp;FileSystemObject...</P>
<P>CREATE&nbsp;proc&nbsp;get_from_file&nbsp;@file_output&nbsp;varchar(8000)&nbsp;output,<BR>@path_name<BR>varchar(200)&nbsp;as<BR>--outputs&nbsp;all&nbsp;the&nbsp;text&nbsp;of&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;into&nbsp;a&nbsp;single&nbsp;string.<BR>--Note&nbsp;-&nbsp;255&nbsp;character&nbsp;limitation.</P>
<P>DECLARE&nbsp;@file_output&nbsp;varchar(8000)<BR>DECLARE&nbsp;@fso&nbsp;int<BR>DECLARE&nbsp;@ts&nbsp;int<BR>DECLARE&nbsp;@i&nbsp;int</P>
<P>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OACreate&nbsp;'Scripting.FileSystemObject',&nbsp;@fso&nbsp;OUT<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@fso<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OAMethod&nbsp;@fso,&nbsp;'OpenTextFile',&nbsp;@ts&nbsp;out,&nbsp;@path_name<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@fso<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OAMethod&nbsp;@ts,&nbsp;'ReadAll',&nbsp;@file_output&nbsp;out<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@ts<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OADestroy&nbsp;@ts<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@ts<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OADestroy&nbsp;@fso<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@fso<BR>GO</P>
<P>This,&nbsp;however,&nbsp;has&nbsp;a&nbsp;255&nbsp;character&nbsp;limitation&nbsp;-&nbsp;so&nbsp;it&nbsp;was&nbsp;back&nbsp;to&nbsp;the&nbsp;drawing&nbsp;board.&nbsp;I&nbsp;don't&nbsp;much&nbsp;like&nbsp;it,&nbsp;but&nbsp;I&nbsp;came&nbsp;up&nbsp;with&nbsp;this...</P>
<P>declare&nbsp;@file_output&nbsp;varchar(8000)<BR>exec&nbsp;get_from_file&nbsp;@file_output&nbsp;output,&nbsp;'my_path_name'<BR>select&nbsp;@file_output</P>
<P>And&nbsp;here's&nbsp;the&nbsp;sp&nbsp;(with&nbsp;a&nbsp;simple&nbsp;supporting&nbsp;sp&nbsp;below&nbsp;it)...</P>
<P>CREATE&nbsp;proc&nbsp;get_from_file&nbsp;@file_output&nbsp;varchar(8000)&nbsp;output,<BR>@path_name<BR>varchar(200)&nbsp;as<BR>--outputs&nbsp;all&nbsp;the&nbsp;text&nbsp;of&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;into&nbsp;a&nbsp;single&nbsp;string.</P>
<P>set&nbsp;nocount&nbsp;on</P>
<P>--get_unique_name&nbsp;for&nbsp;temporary&nbsp;table<BR>declare&nbsp;@unique_table_name&nbsp;varchar(100)<BR>exec&nbsp;get_unique_name&nbsp;@unique_table_name&nbsp;output<BR>set&nbsp;@unique_table_name&nbsp;=&nbsp;'##'&nbsp;+&nbsp;@unique_table_name</P>
<P>--create&nbsp;concatenated&nbsp;string&nbsp;and&nbsp;puts&nbsp;it&nbsp;into&nbsp;the&nbsp;table<BR>exec('<BR>create&nbsp;table&nbsp;#t1&nbsp;(c1&nbsp;varchar(8000))<BR>bulk&nbsp;insert&nbsp;#t1&nbsp;from&nbsp;'''&nbsp;+&nbsp;@path_name&nbsp;+&nbsp;'''<BR>declare&nbsp;@s&nbsp;varchar(8000)<BR>set&nbsp;@s&nbsp;=&nbsp;''''<BR>select&nbsp;@s&nbsp;=&nbsp;@s&nbsp;+&nbsp;isnull(c1,&nbsp;'''')&nbsp;+&nbsp;char(13)&nbsp;from&nbsp;#t1<BR>select&nbsp;c1&nbsp;=&nbsp;@s&nbsp;into&nbsp;'&nbsp;+&nbsp;@unique_table_name<BR>)</P>
<P>--output&nbsp;the&nbsp;single&nbsp;value&nbsp;in&nbsp;the&nbsp;table&nbsp;to&nbsp;our&nbsp;output&nbsp;variable<BR>declare&nbsp;@q&nbsp;nvarchar(100)<BR>set&nbsp;@q&nbsp;=&nbsp;'select&nbsp;@p1&nbsp;=&nbsp;c1&nbsp;from&nbsp;'&nbsp;+&nbsp;@unique_table_name<BR>exec&nbsp;sp_executesql&nbsp;@q,&nbsp;N'@P1&nbsp;varchar(8000)&nbsp;output',&nbsp;@file_output<BR>output</P>
<P>--drop&nbsp;our&nbsp;temporary&nbsp;table<BR>exec&nbsp;('drop&nbsp;table&nbsp;'&nbsp;+&nbsp;@unique_table_name)</P>
<P>set&nbsp;nocount&nbsp;off<BR>GO</P>
<P>Supporting&nbsp;sp...</P>
<P>CREATE&nbsp;proc&nbsp;get_unique_name&nbsp;@output&nbsp;varchar(50)&nbsp;output&nbsp;as</P>
<P>--outputs&nbsp;a&nbsp;unique&nbsp;name&nbsp;based&nbsp;on&nbsp;the&nbsp;current&nbsp;user&nbsp;and&nbsp;the&nbsp;precise&nbsp;time&nbsp;the&nbsp;sp&nbsp;is&nbsp;run.<BR>--can&nbsp;be&nbsp;used&nbsp;for&nbsp;table&nbsp;names&nbsp;/&nbsp;file&nbsp;names&nbsp;etc.</P>
<P>select&nbsp;@output&nbsp;=<BR>replace(system_user,&nbsp;'\',&nbsp;'_')&nbsp;+&nbsp;'_'&nbsp;+<BR>cast(datepart(yyyy,&nbsp;getdate())&nbsp;as&nbsp;varchar(4))&nbsp;+&nbsp;'_'&nbsp;+<BR>cast(datepart(mm,&nbsp;getdate())&nbsp;as&nbsp;varchar(2))&nbsp;+&nbsp;'_'&nbsp;+<BR>cast(datepart(dd,&nbsp;getdate())&nbsp;as&nbsp;varchar(2))&nbsp;+&nbsp;'_'&nbsp;+<BR>cast(datepart(hh,&nbsp;getdate())&nbsp;as&nbsp;varchar(2))&nbsp;+&nbsp;'_'&nbsp;+<BR>cast(datepart(mi,&nbsp;getdate())&nbsp;as&nbsp;varchar(2))&nbsp;+&nbsp;'_'&nbsp;+<BR>cast(datepart(ss,&nbsp;getdate())&nbsp;as&nbsp;varchar(2))&nbsp;+&nbsp;'_'&nbsp;+<BR>cast(datepart(ms,&nbsp;getdate())&nbsp;as&nbsp;varchar(3))<BR>GO</P>
<P>3)&nbsp;Delete&nbsp;the&nbsp;text&nbsp;file.&nbsp;This&nbsp;uses&nbsp;a&nbsp;familiar&nbsp;method.&nbsp;This&nbsp;time&nbsp;there&nbsp;are&nbsp;no&nbsp;limitations.&nbsp;Here's&nbsp;the&nbsp;usage...</P>
<P>exec&nbsp;delete_file&nbsp;'my_path_name'</P>
<P>And&nbsp;here's&nbsp;the&nbsp;sp...</P>
<P>CREATE&nbsp;proc&nbsp;delete_file&nbsp;@path_name&nbsp;varchar(200)&nbsp;as<BR>--deletes&nbsp;a&nbsp;file</P>
<P>DECLARE&nbsp;@object&nbsp;int<BR>DECLARE&nbsp;@i&nbsp;int</P>
<P>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OACreate&nbsp;'Scripting.FileSystemObject',&nbsp;@object&nbsp;OUT<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OAMethod&nbsp;@object,&nbsp;'DeleteFile',&nbsp;null,&nbsp;@FileSpec&nbsp;=<BR>@path_name<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object<BR>EXEC&nbsp;@i&nbsp;=&nbsp;sp_OADestroy&nbsp;@object<BR>IF&nbsp;NOT&nbsp;@i&nbsp;=&nbsp;0&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@object<BR>GO</P>
<P>Putting&nbsp;it&nbsp;all&nbsp;together&nbsp;-&nbsp;here's&nbsp;the&nbsp;usage...</P>
<P>declare&nbsp;@object_text&nbsp;varchar(8000)<BR>exec&nbsp;get_create_table_script&nbsp;@object_text&nbsp;output,&nbsp;'my_server',<BR>'my_database',&nbsp;'my_table'<BR>select&nbsp;@object_text</P>
<P>And&nbsp;here's&nbsp;the&nbsp;sp...</P>
<P>CREATE&nbsp;proc&nbsp;get_create_table_script<BR>@create_table_script&nbsp;varchar(8000)&nbsp;output,<BR>@server&nbsp;varchar(100),<BR>@database_name&nbsp;varchar(100),<BR>@table_name&nbsp;varchar(100)&nbsp;as</P>
<P>--outputs&nbsp;a&nbsp;create&nbsp;table&nbsp;script&nbsp;for&nbsp;a&nbsp;sql&nbsp;table.&nbsp;To&nbsp;do&nbsp;this,&nbsp;it&nbsp;runs&nbsp;a&nbsp;script&nbsp;to&nbsp;put&nbsp;it&nbsp;into&nbsp;a&nbsp;file,&nbsp;then&nbsp;gets&nbsp;it&nbsp;from&nbsp;the&nbsp;file&nbsp;and&nbsp;deletes&nbsp;the&nbsp;file</P>
<P>declare&nbsp;@return&nbsp;int</P>
<P>--get&nbsp;path&nbsp;name&nbsp;of&nbsp;temporary&nbsp;sql&nbsp;file<BR>declare&nbsp;@path_name&nbsp;varchar(100)<BR>exec&nbsp;get_unique_name&nbsp;@path_name&nbsp;output<BR>set&nbsp;@path_name&nbsp;=&nbsp;'\\'&nbsp;+&nbsp;@server&nbsp;+&nbsp;'\c$\'&nbsp;+&nbsp;@path_name&nbsp;+&nbsp;'.sql'</P>
<P>--create&nbsp;the&nbsp;'create&nbsp;table'&nbsp;script&nbsp;and&nbsp;put&nbsp;it&nbsp;into&nbsp;sql&nbsp;file<BR>exec&nbsp;@return&nbsp;=&nbsp;run_script&nbsp;@server,&nbsp;@database_name,&nbsp;@table_name,&nbsp;74077,<BR>@path_name</P>
<P>--return&nbsp;if&nbsp;above&nbsp;step&nbsp;errored.<BR>if&nbsp;@return&nbsp;=&nbsp;1&nbsp;return</P>
<P>--get&nbsp;script&nbsp;results&nbsp;from&nbsp;sql&nbsp;file&nbsp;into&nbsp;output&nbsp;variable<BR>exec&nbsp;get_from_file&nbsp;@create_table_script&nbsp;output,&nbsp;@path_name</P>
<P>--delete&nbsp;temporary&nbsp;sql&nbsp;file<BR>exec&nbsp;delete_file&nbsp;@path_name<BR>GO</P>
<P>And&nbsp;there's&nbsp;your&nbsp;final&nbsp;stored&nbsp;procedure&nbsp;which&nbsp;does&nbsp;what&nbsp;we&nbsp;set&nbsp;out&nbsp;to&nbsp;do.</P></FONT>