<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>查找不同时间段间的差异－3－T-SQL系列</B><BR><BR>方法3：使用游标
<P></P>
<P>这是一种时序操作，所以游标的效果会很好。</P>
<P>DECLARE&nbsp;@lastval&nbsp;int,@currdate&nbsp;datetime,<BR>&nbsp;&nbsp;@currval&nbsp;numeric(4,1),@counter&nbsp;int<BR>SELECT&nbsp;@counter=1<BR>DECLARE&nbsp;diffprev&nbsp;CURSOR<BR>FOR&nbsp;SELECT&nbsp;when_taken,temperature&nbsp;FROM&nbsp;measurements<BR>&nbsp;&nbsp;ORDER&nbsp;BY&nbsp;when_taken&nbsp;ASC<BR>OPEN&nbsp;diffprev<BR>FETCH&nbsp;NEXT&nbsp;FROM&nbsp;diffprev&nbsp;INTO&nbsp;@currdate,@currval<BR>WHILE(@@FETCH_STATUS&lt;&gt;-1)<BR>BEGIN<BR>&nbsp;&nbsp;IF(@counter=1)&nbsp;&nbsp;--For&nbsp;first&nbsp;row,just&nbsp;get&nbsp;value&nbsp;and&nbsp;return<BR>&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;WHEN_TAKEN=@currdate,"CURR_value"=@currval,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RANK=@counter,"PREV_value"=NULL,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"DIFF"=NULL<BR>&nbsp;&nbsp;ELSE<BR>&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;WHEN_TAKEN=@currdate,"CURR_value"=@currval,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RANK=@counter,"PREV_value"=@lastval,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"DIFF"=@currval-@lastval<BR>&nbsp;&nbsp;SELECT&nbsp;@lastval=@currval,@counter=@counter+1<BR>&nbsp;&nbsp;FETCH&nbsp;NEXT&nbsp;FROM&nbsp;diffprev&nbsp;INTO&nbsp;@currdate,@currval<BR>END</P>
<P>CLOSE&nbsp;diffprev<BR>DEALLOCATE&nbsp;diffprev<BR>GO</P></FONT>