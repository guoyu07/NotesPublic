<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>MSSQL&nbsp;Stored&nbsp;Procedure&nbsp;PRINT&nbsp;Statements&nbsp;with&nbsp;ADO</B><BR>MS&nbsp;SQL&nbsp;Server&nbsp;7&nbsp;Stored&nbsp;Procedure&nbsp;PRINT&nbsp;Statements&nbsp;with&nbsp;ADO&nbsp;-&nbsp;by&nbsp;Borland&nbsp;Developer&nbsp;Support&nbsp;Staff
<P></P>
<P></P>
<P>Abstract:&nbsp;How&nbsp;to&nbsp;access&nbsp;the&nbsp;message&nbsp;from&nbsp;an&nbsp;MS&nbsp;SQL&nbsp;Server&nbsp;7&nbsp;Stored&nbsp;Procedure<BR>MS&nbsp;SQL&nbsp;Server&nbsp;stored&nbsp;procedures&nbsp;use&nbsp;a&nbsp;number&nbsp;of&nbsp;ways&nbsp;of&nbsp;communicating&nbsp;information&nbsp;back&nbsp;to&nbsp;the&nbsp;user.&nbsp;One&nbsp;of&nbsp;these&nbsp;is&nbsp;the&nbsp;PRINT&nbsp;statement.&nbsp;This&nbsp;statement&nbsp;is&nbsp;typically&nbsp;used&nbsp;for&nbsp;informational&nbsp;type&nbsp;messages.&nbsp;If&nbsp;the&nbsp;intention&nbsp;is&nbsp;to&nbsp;raise&nbsp;an&nbsp;exception&nbsp;in&nbsp;the&nbsp;calling&nbsp;application,&nbsp;it&nbsp;is&nbsp;preferable&nbsp;to&nbsp;use&nbsp;the&nbsp;RAISERROR&nbsp;statement.&nbsp;</P>
<P>Many&nbsp;users&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;PRINT&nbsp;statement,&nbsp;however,&nbsp;and&nbsp;it&nbsp;has&nbsp;not&nbsp;been&nbsp;possible&nbsp;to&nbsp;access&nbsp;informational&nbsp;type&nbsp;messages&nbsp;with&nbsp;the&nbsp;BDE&nbsp;-&nbsp;only&nbsp;RAISERROR&nbsp;was&nbsp;supported,&nbsp;and&nbsp;then&nbsp;only&nbsp;those&nbsp;errors&nbsp;of&nbsp;sufficient&nbsp;severity&nbsp;to&nbsp;raise&nbsp;an&nbsp;exception.&nbsp;</P>
<P>With&nbsp;ADO&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;access&nbsp;PRINT&nbsp;statement&nbsp;messages.&nbsp;ADO&nbsp;considers&nbsp;these&nbsp;messages&nbsp;to&nbsp;be&nbsp;errors&nbsp;of&nbsp;severity&nbsp;0&nbsp;-&nbsp;too&nbsp;low&nbsp;to&nbsp;raise&nbsp;an&nbsp;exception&nbsp;-&nbsp;but&nbsp;nevertheless&nbsp;the&nbsp;messages&nbsp;are&nbsp;written&nbsp;to&nbsp;ADO's&nbsp;errors&nbsp;collection,&nbsp;which,&nbsp;in&nbsp;Delphi,&nbsp;is&nbsp;a&nbsp;property&nbsp;of&nbsp;the&nbsp;TADOConnection&nbsp;component.&nbsp;</P>
<P>Another&nbsp;fact&nbsp;worth&nbsp;pointing&nbsp;out&nbsp;is&nbsp;that&nbsp;Print&nbsp;statement&nbsp;messages&nbsp;are&nbsp;only&nbsp;placed&nbsp;in&nbsp;the&nbsp;Errors&nbsp;collection&nbsp;if&nbsp;the&nbsp;ADO&nbsp;command&nbsp;is&nbsp;executed&nbsp;with&nbsp;the&nbsp;eoExecuteNoRecords&nbsp;Option&nbsp;set&nbsp;to&nbsp;True.&nbsp;</P>
<P>How&nbsp;do&nbsp;we&nbsp;retrieve&nbsp;this&nbsp;message&nbsp;in&nbsp;practice?&nbsp;</P>
<P>Consider&nbsp;the&nbsp;following&nbsp;Stored&nbsp;Procedure:&nbsp;</P>
<P></P>
<P>create&nbsp;PROCEDURE&nbsp;sp_show_test&nbsp;(@param1&nbsp;char(30))&nbsp;as<BR>begin<BR>&nbsp;&nbsp;If&nbsp;(@param1&nbsp;=&nbsp;"Some&nbsp;value")<BR>&nbsp;&nbsp;&nbsp;&nbsp;Select&nbsp;*&nbsp;from&nbsp;dbo.authors<BR>&nbsp;&nbsp;else<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;"Illegal&nbsp;value&nbsp;:&nbsp;"+@param1<BR>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;25<BR>&nbsp;&nbsp;end<BR>end</P>
<P><BR>This&nbsp;will&nbsp;return&nbsp;a&nbsp;result&nbsp;set&nbsp;if&nbsp;the&nbsp;input&nbsp;parameter&nbsp;is&nbsp;set&nbsp;to&nbsp;"Some&nbsp;value",&nbsp;otherwise&nbsp;it&nbsp;will&nbsp;issue&nbsp;the&nbsp;"Illegal&nbsp;value"&nbsp;message&nbsp;and&nbsp;return&nbsp;a&nbsp;user&nbsp;defined&nbsp;return&nbsp;code&nbsp;of&nbsp;25.&nbsp;</P>
<P>How&nbsp;do&nbsp;we&nbsp;deal&nbsp;with&nbsp;this&nbsp;in&nbsp;Delphi?&nbsp;If&nbsp;we&nbsp;just&nbsp;use&nbsp;a&nbsp;TADODataSet&nbsp;component,&nbsp;we&nbsp;risk&nbsp;getting&nbsp;an&nbsp;exception&nbsp;raised&nbsp;when&nbsp;a&nbsp;result&nbsp;set&nbsp;is&nbsp;not&nbsp;returned&nbsp;by&nbsp;the&nbsp;stored&nbsp;procedure.&nbsp;It&nbsp;is&nbsp;therefore&nbsp;better&nbsp;to&nbsp;use&nbsp;a&nbsp;TADOCommand&nbsp;component&nbsp;AND&nbsp;a&nbsp;TADODataSet.&nbsp;The&nbsp;Execute&nbsp;method&nbsp;of&nbsp;a&nbsp;TADOCommand&nbsp;can&nbsp;return&nbsp;an&nbsp;ADO&nbsp;_RecordSet&nbsp;object,&nbsp;which&nbsp;we&nbsp;can&nbsp;assign&nbsp;to&nbsp;the&nbsp;RecordSet&nbsp;property&nbsp;of&nbsp;the&nbsp;TADODataSet.&nbsp;If&nbsp;the&nbsp;stored&nbsp;procedure&nbsp;does&nbsp;not&nbsp;return&nbsp;a&nbsp;result&nbsp;set,&nbsp;the&nbsp;_RecordSet&nbsp;is&nbsp;still&nbsp;returned&nbsp;but&nbsp;in&nbsp;a&nbsp;closed&nbsp;state,&nbsp;which&nbsp;we&nbsp;can&nbsp;test&nbsp;for.&nbsp;</P>
<P>Here&nbsp;is&nbsp;a&nbsp;simple&nbsp;Delphi&nbsp;unit&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;see&nbsp;the&nbsp;Print&nbsp;statement's&nbsp;message.&nbsp;In&nbsp;addition&nbsp;to&nbsp;the&nbsp;three&nbsp;ADO&nbsp;components&nbsp;listed&nbsp;above&nbsp;this&nbsp;code&nbsp;requires&nbsp;a&nbsp;TEdit&nbsp;and&nbsp;TButton,&nbsp;and&nbsp;'ADOInt'&nbsp;should&nbsp;be&nbsp;added&nbsp;to&nbsp;your&nbsp;uses&nbsp;clause:&nbsp;</P>
<P><BR>procedure&nbsp;TForm1.Button1Click(Sender:&nbsp;TObject);<BR>var<BR>&nbsp;&nbsp;MyReturn&nbsp;:&nbsp;Integer;<BR>&nbsp;&nbsp;looper&nbsp;:&nbsp;Integer;<BR>&nbsp;&nbsp;MyRecordSet&nbsp;:&nbsp;_RecordSet;<BR>begin<BR>&nbsp;&nbsp;ADOCommand1.Prepared&nbsp;:=&nbsp;True;<BR>&nbsp;&nbsp;ADOCommand1.Parameters.ParamByName('@param1').value&nbsp;:=&nbsp;Edit1.Text;<BR>&nbsp;&nbsp;MyRecordSet&nbsp;:=&nbsp;ADOCommand1.Execute;<BR>&nbsp;&nbsp;if&nbsp;MyRecordSet.State&nbsp;=&nbsp;adStateOpen&nbsp;then<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;ADODataSet1.Recordset&nbsp;:=&nbsp;MyRecordSet;<BR>&nbsp;&nbsp;&nbsp;&nbsp;ADODataSet1.Open;<BR>&nbsp;&nbsp;end<BR>&nbsp;&nbsp;else<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;ADOCommand1.ExecuteOptions&nbsp;:=&nbsp;[eoExecuteNoRecords];<BR>&nbsp;&nbsp;&nbsp;&nbsp;ADOCommand1.Execute;<BR>&nbsp;&nbsp;&nbsp;&nbsp;MyReturn&nbsp;:=&nbsp;ADOCommand1.Parameters.ParamByName('RETURN_value').value;<BR>&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;looper&nbsp;:=&nbsp;0&nbsp;to&nbsp;ADOConnection1.Errors.Count&nbsp;-&nbsp;1&nbsp;do<BR>&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShowMessage(Format('Stored&nbsp;Procedure&nbsp;%s&nbsp;Failed&nbsp;with&nbsp;Return&nbsp;Code&nbsp;%d&nbsp;and&nbsp;Message&nbsp;"%s"',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ADOCommand1.CommandText,MyReturn,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TrimRight(ADOConnection1.Errors[looper].Description)]));<BR>&nbsp;&nbsp;&nbsp;&nbsp;end;<BR>&nbsp;&nbsp;end;<BR>end;</P>
<P><BR>As&nbsp;mentioned,&nbsp;when&nbsp;we&nbsp;execute&nbsp;the&nbsp;procedure&nbsp;the&nbsp;first&nbsp;time,&nbsp;we&nbsp;are&nbsp;expecting&nbsp;a&nbsp;result&nbsp;set&nbsp;to&nbsp;be&nbsp;returned.&nbsp;This&nbsp;will&nbsp;mean&nbsp;that&nbsp;the&nbsp;Errors&nbsp;collection&nbsp;will&nbsp;not&nbsp;be&nbsp;filled.&nbsp;If&nbsp;the&nbsp;result&nbsp;set&nbsp;has&nbsp;not&nbsp;been&nbsp;returned,&nbsp;we&nbsp;must&nbsp;execute&nbsp;the&nbsp;procedure&nbsp;a&nbsp;second&nbsp;time&nbsp;with&nbsp;the&nbsp;eoExecuteNoRecords&nbsp;option&nbsp;set.&nbsp;&nbsp;</P></FONT>