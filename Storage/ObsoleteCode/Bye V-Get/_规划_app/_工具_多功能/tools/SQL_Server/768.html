<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Create&nbsp;Excel&nbsp;XLS&nbsp;from&nbsp;T-SQL</B><BR>Create&nbsp;Excel&nbsp;XLS&nbsp;from&nbsp;T-SQL<BR>Script&nbsp;Rating&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Total&nbsp;number&nbsp;of&nbsp;votes&nbsp;[30]&nbsp;<BR>By:&nbsp;David&nbsp;A.&nbsp;Long&nbsp;<BR>This&nbsp;is&nbsp;a&nbsp;T-SQL&nbsp;script&nbsp;that&nbsp;uses&nbsp;OLE,&nbsp;ADO,&nbsp;Jet4&nbsp;ISAM,&nbsp;and&nbsp;Linked&nbsp;Server&nbsp;to&nbsp;create&nbsp;and&nbsp;populate&nbsp;an&nbsp;Excel&nbsp;Workbook&nbsp;(XLS)&nbsp;file&nbsp;from&nbsp;T-SQL&nbsp;query.&nbsp;If&nbsp;the&nbsp;Excel&nbsp;Worksheet&nbsp;exists,&nbsp;the&nbsp;query&nbsp;will&nbsp;append&nbsp;to&nbsp;the&nbsp;"table".&nbsp;<BR>The&nbsp;code&nbsp;is&nbsp;designed&nbsp;to&nbsp;be&nbsp;used&nbsp;by&nbsp;SQL&nbsp;Agent&nbsp;and&nbsp;to&nbsp;append&nbsp;to&nbsp;the&nbsp;step&nbsp;output&nbsp;with&nbsp;verbose&nbsp;and&nbsp;minimal&nbsp;detail.&nbsp;<BR>Code&nbsp;is&nbsp;pretty&nbsp;well&nbsp;commented,&nbsp;including&nbsp;some&nbsp;hard&nbsp;won&nbsp;knowledge&nbsp;about&nbsp;Jet4&nbsp;ISAM,&nbsp;OLE,&nbsp;ADO,&nbsp;and&nbsp;usage&nbsp;of&nbsp;the&nbsp;Excel&nbsp;table&nbsp;from&nbsp;T-SQL<BR>--&nbsp;Create&nbsp;XLS&nbsp;script&nbsp;DAL&nbsp;-&nbsp;04/24/2003<BR>--<BR>--&nbsp;Designed&nbsp;for&nbsp;Agent&nbsp;scheduling,&nbsp;turn&nbsp;on&nbsp;"Append&nbsp;output&nbsp;for&nbsp;step&nbsp;history"<BR>--<BR>--&nbsp;Search&nbsp;for&nbsp;%%%&nbsp;to&nbsp;find&nbsp;adjustable&nbsp;constants&nbsp;and&nbsp;other&nbsp;options<BR>--<BR>--&nbsp;Uses&nbsp;OLE&nbsp;for&nbsp;ADO&nbsp;and&nbsp;OLE&nbsp;DB&nbsp;to&nbsp;create&nbsp;the&nbsp;XLS&nbsp;file&nbsp;if&nbsp;it&nbsp;does&nbsp;not&nbsp;exist<BR>--&nbsp;&nbsp;&nbsp;Linked&nbsp;server&nbsp;requires&nbsp;the&nbsp;XLS&nbsp;to&nbsp;exist&nbsp;before&nbsp;creation<BR>--&nbsp;Uses&nbsp;OLE&nbsp;ADO&nbsp;to&nbsp;Create&nbsp;the&nbsp;XLS&nbsp;Worksheet&nbsp;for&nbsp;use&nbsp;as&nbsp;a&nbsp;table&nbsp;by&nbsp;T-SQL<BR>--&nbsp;Uses&nbsp;Linked&nbsp;Server&nbsp;to&nbsp;allow&nbsp;T-SQL&nbsp;access&nbsp;to&nbsp;XLS&nbsp;table<BR>--&nbsp;Uses&nbsp;T-SQL&nbsp;to&nbsp;populate&nbsp;te&nbsp;XLS&nbsp;worksheet,&nbsp;very&nbsp;fast<BR>--<BR>PRINT&nbsp;'Begin&nbsp;CreateXLS&nbsp;script&nbsp;at&nbsp;'+RTRIM(CONVERT(varchar(24),GETDATE(),121))+'&nbsp;'<BR>PRINT&nbsp;''<BR>GO
<P></P>
<P>SET&nbsp;NOCOUNT&nbsp;ON<BR>DECLARE&nbsp;@Conn&nbsp;int&nbsp;--&nbsp;ADO&nbsp;Connection&nbsp;object&nbsp;to&nbsp;create&nbsp;XLS<BR>&nbsp;,&nbsp;@hr&nbsp;int&nbsp;--&nbsp;OLE&nbsp;return&nbsp;value<BR>&nbsp;,&nbsp;@src&nbsp;varchar(255)&nbsp;--&nbsp;OLE&nbsp;Error&nbsp;Source<BR>&nbsp;,&nbsp;@desc&nbsp;varchar(255)&nbsp;--&nbsp;OLE&nbsp;Error&nbsp;Description<BR>&nbsp;,&nbsp;@Path&nbsp;varchar(255)&nbsp;--&nbsp;Drive&nbsp;or&nbsp;UNC&nbsp;path&nbsp;for&nbsp;XLS<BR>&nbsp;,&nbsp;@Connect&nbsp;varchar(255)&nbsp;--&nbsp;OLE&nbsp;DB&nbsp;Connection&nbsp;string&nbsp;for&nbsp;Jet&nbsp;4&nbsp;Excel&nbsp;ISAM<BR>&nbsp;,&nbsp;@WKS_Created&nbsp;bit&nbsp;--&nbsp;Whether&nbsp;the&nbsp;XLS&nbsp;Worksheet&nbsp;exists<BR>&nbsp;,&nbsp;@WKS_Name&nbsp;varchar(128)&nbsp;--&nbsp;Name&nbsp;of&nbsp;the&nbsp;XLS&nbsp;Worksheet&nbsp;(table)<BR>&nbsp;,&nbsp;@ServerName&nbsp;nvarchar(128)&nbsp;--&nbsp;Linked&nbsp;Server&nbsp;name&nbsp;for&nbsp;XLS<BR>&nbsp;,&nbsp;@DDL&nbsp;varchar(8000)&nbsp;--&nbsp;Jet4&nbsp;DDL&nbsp;for&nbsp;the&nbsp;XLS&nbsp;WKS&nbsp;table&nbsp;creation<BR>&nbsp;,&nbsp;@SQL&nbsp;varchar(8000)&nbsp;--&nbsp;INSERT&nbsp;INTO&nbsp;XLS&nbsp;T-SQL<BR>&nbsp;,&nbsp;@Recs&nbsp;int&nbsp;--&nbsp;Number&nbsp;of&nbsp;records&nbsp;added&nbsp;to&nbsp;XLS<BR>&nbsp;,&nbsp;@Log&nbsp;bit&nbsp;--&nbsp;Whether&nbsp;to&nbsp;log&nbsp;process&nbsp;detail</P>
<P>--&nbsp;Init&nbsp;variables<BR>SELECT&nbsp;@Recs&nbsp;=&nbsp;0<BR>&nbsp;--&nbsp;%%%&nbsp;1&nbsp;=&nbsp;Verbose&nbsp;output&nbsp;detail,&nbsp;helps&nbsp;find&nbsp;problems,&nbsp;0&nbsp;=&nbsp;minimal&nbsp;output&nbsp;detail<BR>&nbsp;,&nbsp;@Log&nbsp;=&nbsp;1&nbsp;<BR>--&nbsp;%%%&nbsp;assign&nbsp;the&nbsp;UNC&nbsp;or&nbsp;path&nbsp;and&nbsp;name&nbsp;for&nbsp;the&nbsp;XLS&nbsp;file,&nbsp;requires&nbsp;Read/Write&nbsp;access<BR>--&nbsp;&nbsp;&nbsp;must&nbsp;be&nbsp;accessable&nbsp;from&nbsp;server&nbsp;via&nbsp;SQL&nbsp;Server&nbsp;service&nbsp;account<BR>--&nbsp;&nbsp;&nbsp;&amp;&nbsp;SQL&nbsp;Server&nbsp;Agent&nbsp;service&nbsp;account,&nbsp;if&nbsp;scheduled<BR>SET&nbsp;@Path&nbsp;=&nbsp;'C:\TEMP\Test_'+CONVERT(varchar(10),GETDATE(),112)+'.xls'<BR>--&nbsp;assign&nbsp;the&nbsp;ADO&nbsp;connection&nbsp;string&nbsp;for&nbsp;the&nbsp;XLS&nbsp;creation<BR>SET&nbsp;@Connect&nbsp;=&nbsp;'Provider=Microsoft.Jet.OLEDB.4.0;Data&nbsp;Source='+@Path+';Extended&nbsp;Properties=Excel&nbsp;8.0'<BR>--&nbsp;%%%&nbsp;assign&nbsp;the&nbsp;Linked&nbsp;Server&nbsp;name&nbsp;for&nbsp;the&nbsp;XLS&nbsp;population<BR>SET&nbsp;@ServerName&nbsp;=&nbsp;'EXCEL_TEST'<BR>--&nbsp;%%%&nbsp;Rename&nbsp;Table&nbsp;as&nbsp;required,&nbsp;this&nbsp;will&nbsp;also&nbsp;be&nbsp;the&nbsp;XLS&nbsp;Worksheet&nbsp;name<BR>SET&nbsp;@WKS_Name&nbsp;=&nbsp;'People'<BR>--&nbsp;%%%&nbsp;Table&nbsp;creation&nbsp;DDL,&nbsp;uses&nbsp;Jet4&nbsp;syntax,&nbsp;<BR>--&nbsp;&nbsp;&nbsp;Text&nbsp;data&nbsp;type&nbsp;=&nbsp;varchar(255)&nbsp;when&nbsp;accessed&nbsp;from&nbsp;T-SQL<BR>SET&nbsp;@DDL&nbsp;=&nbsp;'CREATE&nbsp;TABLE&nbsp;'+@WKS_Name+'&nbsp;(SSN&nbsp;Text,&nbsp;Name&nbsp;Text,&nbsp;Phone&nbsp;Text)'<BR>--&nbsp;%%%&nbsp;T-SQL&nbsp;for&nbsp;table&nbsp;population,&nbsp;note&nbsp;the&nbsp;4&nbsp;part&nbsp;naming&nbsp;required&nbsp;by&nbsp;Jet4&nbsp;OLE&nbsp;DB<BR>--&nbsp;&nbsp;&nbsp;INSERT&nbsp;INTO&nbsp;SELECT,&nbsp;INSERT&nbsp;INTO&nbsp;valueS,&nbsp;and&nbsp;EXEC&nbsp;sp&nbsp;types&nbsp;are&nbsp;supported<BR>--&nbsp;&nbsp;&nbsp;Linked&nbsp;Server&nbsp;does&nbsp;not&nbsp;support&nbsp;SELECT&nbsp;INTO&nbsp;types<BR>SET&nbsp;@SQL&nbsp;=&nbsp;'INSERT&nbsp;INTO&nbsp;'+@ServerName+'...'+@WKS_Name+'&nbsp;(SSN,&nbsp;Name,&nbsp;Phone)&nbsp;'<BR>SET&nbsp;@SQL&nbsp;=&nbsp;@SQL+'SELECT&nbsp;au_id&nbsp;AS&nbsp;SSN'<BR>SET&nbsp;@SQL&nbsp;=&nbsp;@SQL+',&nbsp;LTRIM(RTRIM(ISNULL(au_fname,'''')+''&nbsp;''+ISNULL(au_lname,'''')))&nbsp;AS&nbsp;Name'<BR>SET&nbsp;@SQL&nbsp;=&nbsp;@SQL+',&nbsp;phone&nbsp;AS&nbsp;Phone&nbsp;'<BR>SET&nbsp;@SQL&nbsp;=&nbsp;@SQL+'FROM&nbsp;pubs.dbo.authors'</P>
<P>IF&nbsp;@Log&nbsp;=&nbsp;1&nbsp;PRINT&nbsp;'Created&nbsp;OLE&nbsp;ADODB.Connection&nbsp;object'<BR>--&nbsp;Create&nbsp;the&nbsp;Conn&nbsp;object<BR>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OACreate&nbsp;'ADODB.Connection',&nbsp;@Conn&nbsp;OUT<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0&nbsp;--&nbsp;have&nbsp;to&nbsp;use&nbsp;&lt;&gt;&nbsp;as&nbsp;OLE&nbsp;/&nbsp;ADO&nbsp;can&nbsp;return&nbsp;negative&nbsp;error&nbsp;numbers<BR>BEGIN<BR>&nbsp;--&nbsp;Return&nbsp;OLE&nbsp;error<BR>&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@Conn,&nbsp;@src&nbsp;OUT,&nbsp;@desc&nbsp;OUT&nbsp;<BR>&nbsp;SELECT&nbsp;Error=convert(varbinary(4),@hr),&nbsp;Source=@src,&nbsp;Description=@desc<BR>&nbsp;RETURN<BR>END</P>
<P>IF&nbsp;@Log&nbsp;=&nbsp;1&nbsp;PRINT&nbsp;char(9)+'Assigned&nbsp;ConnectionString&nbsp;property'<BR>--&nbsp;Set&nbsp;a&nbsp;the&nbsp;Conn&nbsp;object's&nbsp;ConnectionString&nbsp;property<BR>--&nbsp;&nbsp;&nbsp;Work-around&nbsp;for&nbsp;error&nbsp;using&nbsp;a&nbsp;variable&nbsp;parameter&nbsp;on&nbsp;the&nbsp;Open&nbsp;method<BR>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OASetProperty&nbsp;@Conn,&nbsp;'ConnectionString',&nbsp;@Connect<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;--&nbsp;Return&nbsp;OLE&nbsp;error<BR>&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@Conn,&nbsp;@src&nbsp;OUT,&nbsp;@desc&nbsp;OUT&nbsp;<BR>&nbsp;SELECT&nbsp;Error=convert(varbinary(4),@hr),&nbsp;Source=@src,&nbsp;Description=@desc<BR>&nbsp;RETURN<BR>END</P>
<P>IF&nbsp;@Log&nbsp;=&nbsp;1&nbsp;PRINT&nbsp;char(9)+'Open&nbsp;Connection&nbsp;to&nbsp;XLS,&nbsp;for&nbsp;file&nbsp;Create&nbsp;or&nbsp;Append'<BR>--&nbsp;Call&nbsp;the&nbsp;Open&nbsp;method&nbsp;to&nbsp;create&nbsp;the&nbsp;XLS&nbsp;if&nbsp;it&nbsp;does&nbsp;not&nbsp;exist,&nbsp;can't&nbsp;use&nbsp;parameters<BR>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@Conn,&nbsp;'Open'<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;--&nbsp;Return&nbsp;OLE&nbsp;error<BR>&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@Conn,&nbsp;@src&nbsp;OUT,&nbsp;@desc&nbsp;OUT&nbsp;<BR>&nbsp;SELECT&nbsp;Error=convert(varbinary(4),@hr),&nbsp;Source=@src,&nbsp;Description=@desc<BR>&nbsp;RETURN<BR>END</P>
<P>--&nbsp;%%%&nbsp;This&nbsp;section&nbsp;could&nbsp;be&nbsp;repeated&nbsp;for&nbsp;multiple&nbsp;Worksheets&nbsp;(Tables)<BR>IF&nbsp;@Log&nbsp;=&nbsp;1&nbsp;PRINT&nbsp;char(9)+'Execute&nbsp;DDL&nbsp;to&nbsp;create&nbsp;'''+@WKS_Name+'''&nbsp;worksheet'<BR>--&nbsp;Call&nbsp;the&nbsp;Execute&nbsp;method&nbsp;to&nbsp;Create&nbsp;the&nbsp;work&nbsp;sheet&nbsp;with&nbsp;the&nbsp;@WKS_Name&nbsp;caption,&nbsp;<BR>--&nbsp;&nbsp;&nbsp;which&nbsp;is&nbsp;also&nbsp;used&nbsp;as&nbsp;a&nbsp;Table&nbsp;reference&nbsp;in&nbsp;T-SQL<BR>--&nbsp;Neat&nbsp;way&nbsp;to&nbsp;define&nbsp;column&nbsp;data&nbsp;types&nbsp;in&nbsp;Excel&nbsp;worksheet<BR>--&nbsp;&nbsp;&nbsp;Sometimes&nbsp;converting&nbsp;to&nbsp;text&nbsp;is&nbsp;the&nbsp;only&nbsp;work-around&nbsp;for&nbsp;Excel's&nbsp;General&nbsp;<BR>--&nbsp;&nbsp;&nbsp;Cell&nbsp;formatting,&nbsp;even&nbsp;though&nbsp;the&nbsp;Cell&nbsp;contains&nbsp;Text,&nbsp;Excel&nbsp;tries&nbsp;to&nbsp;format<BR>--&nbsp;&nbsp;&nbsp;it&nbsp;in&nbsp;a&nbsp;"Smart"&nbsp;way,&nbsp;I&nbsp;have&nbsp;even&nbsp;had&nbsp;to&nbsp;use&nbsp;the&nbsp;single&nbsp;quote&nbsp;appended&nbsp;as&nbsp;the<BR>--&nbsp;&nbsp;&nbsp;1st&nbsp;character&nbsp;in&nbsp;T-SQL&nbsp;to&nbsp;force&nbsp;Excel&nbsp;to&nbsp;leave&nbsp;it&nbsp;alone<BR>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OAMethod&nbsp;@Conn,&nbsp;'Execute',&nbsp;NULL,&nbsp;@DDL,&nbsp;NULL,&nbsp;129&nbsp;--&nbsp;adCmdText&nbsp;+&nbsp;adExecuteNoRecords<BR>--&nbsp;0x80040E14&nbsp;for&nbsp;table&nbsp;exists&nbsp;in&nbsp;ADO<BR>IF&nbsp;@hr&nbsp;=&nbsp;0x80040E14&nbsp;<BR>&nbsp;--&nbsp;kludge,&nbsp;skip&nbsp;0x80042732&nbsp;for&nbsp;ADO&nbsp;Optional&nbsp;parameters&nbsp;(NULL)&nbsp;in&nbsp;SQL7<BR>&nbsp;OR&nbsp;@hr&nbsp;=&nbsp;0x80042732<BR>BEGIN<BR>&nbsp;--&nbsp;Trap&nbsp;these&nbsp;OLE&nbsp;Errors<BR>&nbsp;IF&nbsp;@hr&nbsp;=&nbsp;0x80040E14<BR>&nbsp;BEGIN<BR>&nbsp;&nbsp;PRINT&nbsp;char(9)+''''+@WKS_Name+'''&nbsp;Worksheet&nbsp;exists&nbsp;for&nbsp;append'<BR>&nbsp;&nbsp;SET&nbsp;@WKS_Created&nbsp;=&nbsp;0<BR>&nbsp;END<BR>&nbsp;SET&nbsp;@hr&nbsp;=&nbsp;0&nbsp;--&nbsp;ignore&nbsp;these&nbsp;errors<BR>END<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;--&nbsp;Return&nbsp;OLE&nbsp;error<BR>&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@Conn,&nbsp;@src&nbsp;OUT,&nbsp;@desc&nbsp;OUT&nbsp;<BR>&nbsp;SELECT&nbsp;Error=convert(varbinary(4),@hr),&nbsp;Source=@src,&nbsp;Description=@desc<BR>&nbsp;RETURN<BR>END</P>
<P>IF&nbsp;@Log&nbsp;=&nbsp;1&nbsp;PRINT&nbsp;'Destroyed&nbsp;OLE&nbsp;ADODB.Connection&nbsp;object'<BR>--&nbsp;Destroy&nbsp;the&nbsp;Conn&nbsp;object,&nbsp;+++&nbsp;important&nbsp;to&nbsp;not&nbsp;leak&nbsp;memory&nbsp;+++<BR>EXEC&nbsp;@hr&nbsp;=&nbsp;sp_OADestroy&nbsp;@Conn<BR>IF&nbsp;@hr&nbsp;&lt;&gt;&nbsp;0<BR>BEGIN<BR>&nbsp;--&nbsp;Return&nbsp;OLE&nbsp;error<BR>&nbsp;EXEC&nbsp;sp_OAGetErrorInfo&nbsp;@Conn,&nbsp;@src&nbsp;OUT,&nbsp;@desc&nbsp;OUT&nbsp;<BR>&nbsp;SELECT&nbsp;Error=convert(varbinary(4),@hr),&nbsp;Source=@src,&nbsp;Description=@desc<BR>&nbsp;RETURN<BR>END</P>
<P>--&nbsp;Linked&nbsp;Server&nbsp;allows&nbsp;T-SQL&nbsp;to&nbsp;access&nbsp;the&nbsp;XLS&nbsp;worksheet&nbsp;(Table)<BR>--&nbsp;&nbsp;&nbsp;This&nbsp;must&nbsp;be&nbsp;performed&nbsp;after&nbsp;the&nbsp;ADO&nbsp;stuff&nbsp;as&nbsp;the&nbsp;XLS&nbsp;must&nbsp;exist<BR>--&nbsp;&nbsp;&nbsp;and&nbsp;contain&nbsp;the&nbsp;schema&nbsp;for&nbsp;the&nbsp;table,&nbsp;or&nbsp;worksheet<BR>IF&nbsp;NOT&nbsp;EXISTS(SELECT&nbsp;srvname&nbsp;from&nbsp;master.dbo.sysservers&nbsp;where&nbsp;srvname&nbsp;=&nbsp;@ServerName)<BR>BEGIN<BR>&nbsp;IF&nbsp;@Log&nbsp;=&nbsp;1&nbsp;PRINT&nbsp;'Created&nbsp;Linked&nbsp;Server&nbsp;'''+@ServerName+'''&nbsp;and&nbsp;Login'<BR>&nbsp;EXEC&nbsp;sp_addlinkedserver&nbsp;@server&nbsp;=&nbsp;@ServerName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;@srvproduct&nbsp;=&nbsp;'Microsoft&nbsp;Excel&nbsp;Workbook'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;@provider&nbsp;=&nbsp;'Microsoft.Jet.OLEDB.4.0'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;@datasrc&nbsp;=&nbsp;@Path<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;@provstr&nbsp;=&nbsp;'Excel&nbsp;8.0'&nbsp;<BR>&nbsp;--&nbsp;no&nbsp;login&nbsp;name&nbsp;or&nbsp;password&nbsp;are&nbsp;required&nbsp;to&nbsp;connect&nbsp;to&nbsp;the&nbsp;Jet4&nbsp;ISAM&nbsp;linked&nbsp;server<BR>&nbsp;EXEC&nbsp;sp_addlinkedsrvlogin&nbsp;@ServerName,&nbsp;'false'&nbsp;<BR>END</P>
<P>--&nbsp;Have&nbsp;to&nbsp;EXEC&nbsp;the&nbsp;SQL,&nbsp;otherwise&nbsp;the&nbsp;SQL&nbsp;is&nbsp;evaluated&nbsp;<BR>--&nbsp;&nbsp;&nbsp;for&nbsp;the&nbsp;linked&nbsp;server&nbsp;before&nbsp;it&nbsp;exists<BR>EXEC&nbsp;(@SQL)<BR>PRINT&nbsp;char(9)+'Populated&nbsp;'''+@WKS_Name+'''&nbsp;table&nbsp;with&nbsp;'+CONVERT(varchar,@@ROWCOUNT)+'&nbsp;Rows'</P>
<P>--&nbsp;%%%&nbsp;Optional&nbsp;you&nbsp;may&nbsp;leave&nbsp;the&nbsp;Linked&nbsp;Server&nbsp;for&nbsp;other&nbsp;XLS&nbsp;operations<BR>--&nbsp;&nbsp;&nbsp;Remember&nbsp;that&nbsp;the&nbsp;Linked&nbsp;Server&nbsp;will&nbsp;not&nbsp;create&nbsp;the&nbsp;XLS,&nbsp;so&nbsp;remove&nbsp;it<BR>--&nbsp;&nbsp;&nbsp;When&nbsp;you&nbsp;are&nbsp;done&nbsp;with&nbsp;it,&nbsp;especially&nbsp;if&nbsp;you&nbsp;delete&nbsp;or&nbsp;move&nbsp;the&nbsp;file<BR>IF&nbsp;EXISTS(SELECT&nbsp;srvname&nbsp;from&nbsp;master.dbo.sysservers&nbsp;where&nbsp;srvname&nbsp;=&nbsp;@ServerName)<BR>BEGIN<BR>&nbsp;IF&nbsp;@Log&nbsp;=&nbsp;1&nbsp;PRINT&nbsp;'Deleted&nbsp;Linked&nbsp;Server&nbsp;'''+@ServerName+'''&nbsp;and&nbsp;Login'<BR>&nbsp;EXEC&nbsp;sp_dropserver&nbsp;@ServerName,&nbsp;'droplogins'<BR>END<BR>GO</P>
<P>SET&nbsp;NOCOUNT&nbsp;OFF<BR>PRINT&nbsp;''<BR>PRINT&nbsp;'Finished&nbsp;CreateXLS&nbsp;script&nbsp;at&nbsp;'+RTRIM(CONVERT(varchar(24),GETDATE(),121))+'&nbsp;'<BR>GO</P></FONT>