<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>find_foreign_keys</B><BR>find_foreign_keys.sql
<P></P>
<P></P>
<P><BR>In&nbsp;a&nbsp;heavily&nbsp;normalized&nbsp;database,&nbsp;it&nbsp;is&nbsp;often&nbsp;difficult&nbsp;to&nbsp;modify/drop&nbsp;tables&nbsp;when&nbsp;lots&nbsp;of&nbsp;foreign&nbsp;keys&nbsp;exist.&nbsp;This&nbsp;script&nbsp;will&nbsp;list&nbsp;all&nbsp;of&nbsp;the&nbsp;foreign&nbsp;keys&nbsp;in&nbsp;the&nbsp;database&nbsp;that&nbsp;reference&nbsp;a&nbsp;given&nbsp;table&nbsp;name.&nbsp;It&nbsp;will&nbsp;also&nbsp;generate&nbsp;scripts&nbsp;to&nbsp;drop&nbsp;the&nbsp;foreign&nbsp;keys&nbsp;to&nbsp;make&nbsp;dropping&nbsp;the&nbsp;parent&nbsp;table&nbsp;easier.&nbsp;Supply&nbsp;the&nbsp;parent&nbsp;table&nbsp;name&nbsp;in&nbsp;the&nbsp;@table_name&nbsp;parameter,&nbsp;then&nbsp;set&nbsp;the&nbsp;@generate_drop_scripts&nbsp;bit&nbsp;to&nbsp;1&nbsp;if&nbsp;you&nbsp;wish&nbsp;to&nbsp;PRINT&nbsp;the&nbsp;scripts&nbsp;to&nbsp;drop&nbsp;the&nbsp;constraints.&nbsp;</P>
<P>I&nbsp;hope&nbsp;you&nbsp;find&nbsp;this&nbsp;script&nbsp;useful&nbsp;--&nbsp;it&nbsp;has&nbsp;helped&nbsp;me&nbsp;significantly&nbsp;cut&nbsp;down&nbsp;the&nbsp;time&nbsp;required&nbsp;to&nbsp;search&nbsp;the&nbsp;database&nbsp;for&nbsp;dependencies&nbsp;related&nbsp;to&nbsp;foreign&nbsp;key&nbsp;constraints.&nbsp;</P>
<P>Author:&nbsp;Jason&nbsp;Bohanon&nbsp;<BR>SET&nbsp;QUOTED_IDENTIFIER&nbsp;ON&nbsp;<BR>GO<BR>SET&nbsp;ANSI_NULLS&nbsp;ON&nbsp;<BR>GO</P>
<P>/******&nbsp;Object:&nbsp;&nbsp;Stored&nbsp;Procedure&nbsp;dbo.sp_FIND_FOREIGN_KEYS&nbsp;&nbsp;&nbsp;&nbsp;Script&nbsp;Date:&nbsp;10/17/2001&nbsp;3:17:55&nbsp;PM&nbsp;******/<BR>if&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;dbo.sysobjects&nbsp;where&nbsp;id&nbsp;=&nbsp;object_id(N'[dbo].[sp_FIND_FOREIGN_KEYS]')&nbsp;and&nbsp;OBJECTPROPERTY(id,&nbsp;N'IsProcedure')&nbsp;=&nbsp;1)<BR>drop&nbsp;procedure&nbsp;[dbo].[sp_FIND_FOREIGN_KEYS]<BR>GO</P>
<P><BR>CREATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCEDURE&nbsp;sp_FIND_FOREIGN_KEYS<BR>@table_name&nbsp;nvarchar(128),&nbsp;/***Table&nbsp;to&nbsp;check&nbsp;for&nbsp;dependent&nbsp;constraints***/<BR>@generate_drop_scripts&nbsp;bit&nbsp;=&nbsp;0&nbsp;/***SET&nbsp;to&nbsp;1&nbsp;to&nbsp;PRINT&nbsp;scripts***/<BR>AS</P>
<P>/****CREATED&nbsp;BY&nbsp;JASON&nbsp;BOHANON****/<BR>/****QUESTIONS,&nbsp;PLEASE&nbsp;EMAIL&nbsp;bohanon@qwest.net****/</P>
<P>SET&nbsp;NOCOUNT&nbsp;ON<BR>DECLARE&nbsp;@alter_table1&nbsp;nvarchar(4000),<BR>&nbsp;@key_name&nbsp;nvarchar(128),&nbsp;<BR>&nbsp;@child_table&nbsp;nvarchar(128)</P>
<P>SELECT&nbsp;<BR>&nbsp;@table_name&nbsp;as&nbsp;'Referenced&nbsp;Table',&nbsp;<BR>&nbsp;f.name&nbsp;as&nbsp;'Referenced&nbsp;Column',<BR>&nbsp;c.name&nbsp;as&nbsp;'Tables&nbsp;That&nbsp;Reference',&nbsp;<BR>&nbsp;e.name&nbsp;as&nbsp;'Referencing&nbsp;Column',&nbsp;<BR>&nbsp;d.name&nbsp;as&nbsp;'Foreign_Key_Name'<BR>FROM&nbsp;sysobjects&nbsp;a&nbsp;<BR>&nbsp;JOIN&nbsp;sysforeignkeys&nbsp;b<BR>&nbsp;on&nbsp;a.id&nbsp;=&nbsp;b.rkeyid&nbsp;<BR>&nbsp;JOIN&nbsp;sysobjects&nbsp;c<BR>&nbsp;on&nbsp;c.id&nbsp;=&nbsp;b.fkeyid<BR>&nbsp;JOIN&nbsp;sysobjects&nbsp;d<BR>&nbsp;on&nbsp;d.id&nbsp;=&nbsp;b.constid<BR>&nbsp;JOIN&nbsp;syscolumns&nbsp;f<BR>&nbsp;on&nbsp;f.id&nbsp;=&nbsp;a.id<BR>&nbsp;AND&nbsp;b.rkey&nbsp;=&nbsp;f.colid<BR>&nbsp;JOIN&nbsp;syscolumns&nbsp;e<BR>&nbsp;on&nbsp;c.id&nbsp;=&nbsp;e.id&nbsp;<BR>&nbsp;AND&nbsp;b.fkey&nbsp;=&nbsp;e.colid<BR>WHERE&nbsp;a.name&nbsp;=&nbsp;@table_name&nbsp;<BR>ORDER&nbsp;BY&nbsp;c.name</P>
<P>IF&nbsp;@generate_drop_scripts&nbsp;=&nbsp;1<BR>BEGIN&nbsp;/***CREATE&nbsp;CONSTRAINT&nbsp;DROP&nbsp;SCRIPTS***/</P>
<P>CREATE&nbsp;TABLE&nbsp;#tmp_drop_keys<BR>(key_name&nbsp;nvarchar(128),&nbsp;child_table&nbsp;nvarchar(128),&nbsp;used&nbsp;bit)</P>
<P>INSERT&nbsp;INTO&nbsp;#tmp_drop_keys<BR>(key_name,&nbsp;child_table,&nbsp;used)<BR>SELECT&nbsp;d.name&nbsp;,c.name&nbsp;,&nbsp;&nbsp;0<BR>FROM&nbsp;sysobjects&nbsp;a&nbsp;<BR>&nbsp;JOIN&nbsp;sysforeignkeys&nbsp;b<BR>&nbsp;on&nbsp;a.id&nbsp;=&nbsp;b.rkeyid&nbsp;<BR>&nbsp;JOIN&nbsp;sysobjects&nbsp;c<BR>&nbsp;on&nbsp;c.id&nbsp;=&nbsp;b.fkeyid<BR>&nbsp;JOIN&nbsp;sysobjects&nbsp;d<BR>&nbsp;on&nbsp;d.id&nbsp;=&nbsp;b.constid<BR>WHERE&nbsp;a.name&nbsp;=&nbsp;@table_name&nbsp;</P>
<P>WHILE&nbsp;EXISTS&nbsp;(SELECT&nbsp;*&nbsp;FROM&nbsp;#tmp_drop_keys&nbsp;WHERE&nbsp;used&nbsp;=&nbsp;0)<BR>BEGIN</P>
<P>SELECT&nbsp;TOP&nbsp;1&nbsp;@key_name&nbsp;=&nbsp;key_name,&nbsp;@child_table&nbsp;=&nbsp;child_table<BR>FROM&nbsp;#tmp_drop_keys<BR>WHERE&nbsp;used&nbsp;=&nbsp;0</P>
<P>SELECT&nbsp;@alter_table1&nbsp;=&nbsp;'&nbsp;ALTER&nbsp;TABLE&nbsp;'&nbsp;+&nbsp;@child_table&nbsp;+&nbsp;<BR>&nbsp;&nbsp;&nbsp;'&nbsp;DROP&nbsp;CONSTRAINT&nbsp;'&nbsp;+&nbsp;@key_name<BR>PRINT&nbsp;''<BR>PRINT&nbsp;'------ALTERING&nbsp;TABLE&nbsp;'&nbsp;+&nbsp;UPPER(@child_table)&nbsp;+&nbsp;'------'<BR>PRINT&nbsp;@alter_table1<BR>PRINT&nbsp;''</P>
<P>UPDATE&nbsp;#tmp_drop_keys<BR>SET&nbsp;used&nbsp;=&nbsp;1<BR>WHERE&nbsp;key_name&nbsp;=&nbsp;@key_name</P>
<P>END</P>
<P><BR>END&nbsp;/***END&nbsp;CREATE&nbsp;CONSTRAINT&nbsp;DROP&nbsp;SCRIPTS***/</P>
<P></P>
<P></P>
<P>GO</P>
<P>SET&nbsp;QUOTED_IDENTIFIER&nbsp;OFF&nbsp;<BR>GO<BR>SET&nbsp;ANSI_NULLS&nbsp;ON&nbsp;<BR>GO</P></FONT>