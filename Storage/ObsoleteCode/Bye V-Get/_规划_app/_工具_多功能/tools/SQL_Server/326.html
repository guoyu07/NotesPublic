<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>更新索引统计</B><BR><B>分布页面并不是每次一个记录更新时都要进行更新.在大型数据库中,这会导致巨大的性能损失.因此,当用户初始创建一个空表时,分布页面仍是空的.它仅在发生如下情况时才被更新:<BR>1.用户在一个已存在数据表上创建一个索引.<BR>2.用户进行了update&nbsp;satatic语句<BR>从系统管理员角度来看,用户应该创建一个工具来自动地更新分布页面.自动更新应该至少每周一次,如果数据量每天增加10%以上则应每天一次.<BR>因为不可能每天都添加索引,用户需要使用update&nbsp;statistics语句更新分布页面,用以优化SQLserver.</B>
<P></P>
<P><B>UPDATE&nbsp;STATISTICS</B><BR>在指定的表或索引视图中，对一个或多个统计组（集合）有关键值分发的信息进行更新。若要基于列生成统计，请参见&nbsp;CREATE&nbsp;STATISTICS。&nbsp;</P>
<P>语法<BR>UPDATE&nbsp;STATISTICS&nbsp;table&nbsp;|&nbsp;view<BR>&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;(&nbsp;statistics_name&nbsp;[&nbsp;,...n&nbsp;]&nbsp;)<BR>&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;&nbsp;&nbsp;WITH<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;FULLSCAN&nbsp;]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;SAMPLE&nbsp;number&nbsp;{&nbsp;PERCENT&nbsp;|&nbsp;ROWS&nbsp;}&nbsp;]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;RESAMPLE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;[&nbsp;,&nbsp;]&nbsp;[&nbsp;ALL&nbsp;|&nbsp;COLUMNS&nbsp;|&nbsp;INDEX&nbsp;]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;[&nbsp;,&nbsp;]&nbsp;NORECOMPUTE&nbsp;]&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;</P>
<P>参数<BR>table&nbsp;|&nbsp;view</P>
<P>要更新统计的表或索引视图的名称。表名和视图名必须符合标识符的规则。有关更多信息，请参见使用标识符。由于索引名在每个数据库中不唯一，所以必须指定&nbsp;table&nbsp;或&nbsp;view。可选择指定数据库、表或视图所有者。只有在&nbsp;Microsoft?&nbsp;SQL&nbsp;Server?&nbsp;2000&nbsp;企业版中才支持索引视图。</P>
<P>index</P>
<P>要更新统计的索引。索引名必须符合标识符的规则。如果未指定&nbsp;index，则更新指定表或索引视图中的所有索引的分发统计。若要查看索引名和描述的列表，请带表名或视图名执行&nbsp;sp_helpindex。</P>
<P>statistics_name</P>
<P>要更新的统计组（集合）的名称。统计名称必须符合标识符规则。有关生成统计组的更多信息，请参见&nbsp;CREATE&nbsp;STATISTICS。</P>
<P>n</P>
<P>是表示可以指定多个&nbsp;statistic_name&nbsp;组的占位符。</P>
<P>FULLSCAN</P>
<P>指定应读取&nbsp;table&nbsp;或&nbsp;view&nbsp;中的所有行以收集统计。FULLSCAN&nbsp;提供与&nbsp;SAMPLE&nbsp;100&nbsp;PERCENT&nbsp;相同的行为。FULLSCAN&nbsp;不能与&nbsp;SAMPLE&nbsp;选项一起使用。</P>
<P>SAMPLE&nbsp;number&nbsp;{&nbsp;PERCENT&nbsp;|&nbsp;ROWS&nbsp;}</P>
<P>当为较大的表或视图收集统计时，指定要采样的表或索引视图的百分比或行数。number&nbsp;只允许使用整数，无论它是&nbsp;PERCENT&nbsp;还是&nbsp;ROWS。若要对较大的表或视图使用默认采样行为，请将&nbsp;SAMPLE&nbsp;number&nbsp;和&nbsp;PERCENT&nbsp;或&nbsp;ROWS&nbsp;一起使用。Microsoft&nbsp;SQL&nbsp;Server&nbsp;将确保值的采样数不低于某一数目，以保证统计有用。如果&nbsp;PERCENT、ROWS&nbsp;或&nbsp;number&nbsp;选项导致要采样的行数过小，SQL&nbsp;Server&nbsp;则自动根据表或视图中的现有行数改正采样。</P>
<P></P>
<P>说明&nbsp;&nbsp;默认行为是在目标表或索引视图上进行采样扫描。SQL&nbsp;Server&nbsp;自动计算所需的样本大小。</P>
<P><BR>RESAMPLE</P>
<P>指定使用从所有现有统计（包括索引）继承的采样速率来收集统计。如果采样速率导致要采样的行过少，SQL&nbsp;Server&nbsp;则自动根据表或视图中的现有行数改正采样。</P>
<P>ALL&nbsp;|&nbsp;COLUMNS&nbsp;|&nbsp;INDEX</P>
<P>指定&nbsp;UPDATE&nbsp;STATISTICS&nbsp;语句是否影响列统计、索引统计或所有现有统计。如果未指定选项，则&nbsp;UPDATE&nbsp;STATISTICS&nbsp;语句影响所有的统计。每个&nbsp;UPDATE&nbsp;STATISTICS&nbsp;语句只能指定一种类型（ALL、COLUMNS&nbsp;或&nbsp;INDEX）。&nbsp;</P>
<P>NORECOMPUTE</P>
<P>指定过期统计不自动重新计算。统计过期与否取决于在索引列上进行的&nbsp;INSERT、UPDATE&nbsp;和&nbsp;DELETE&nbsp;操作的数量。指定该选项时，将导致&nbsp;SQL&nbsp;Server&nbsp;禁用自动统计重建功能。若要还原自动统计重新计算，请重新执行&nbsp;UPDATE&nbsp;STATISTICS（不要&nbsp;NORECOMPUTE&nbsp;选项），或者执行&nbsp;sp_autostats。</P>
<P></P>
<P>重要&nbsp;&nbsp;禁用自动统计重新计算会导致&nbsp;SQL&nbsp;Server&nbsp;查询优化器对于涉及指定表的查询选择非最佳的策略。</P>
<P><BR>注释<BR>SQL&nbsp;Server&nbsp;保留每个索引中关于键值分发的统计，并且使用这些统计来决定查询处理中使用哪个（或哪些）索引。用户可以通过使用&nbsp;CREATE&nbsp;STATISTICS&nbsp;语句生成基于非索引列的统计。查询优化依赖于分发步骤的准确性：&nbsp;</P>
<P>如果索引中的键值有显著变化，请对此索引重新运行&nbsp;UPDATE&nbsp;STATISTICS。</P>
<P><BR>如果索引列中添加、更改或删除大量数据（即如果键值分发更改），或者用&nbsp;TRUNCATE&nbsp;TABLE&nbsp;语句将表截断然后重新填充，请使用&nbsp;UPDATE&nbsp;STATISTICS。&nbsp;<BR>若要查看统计最近一次更新的时间，请使用&nbsp;STATS_DATE&nbsp;函数。</P>
<P>只有当能够在计算列上创建索引时，才可以在包含这些计算列的表上创建或更新统计。有关在计算列上创建索引的要求和限制的更多信息，请参见&nbsp;CREATE&nbsp;INDEX。</P>
<P>权限<BR>UPDATE&nbsp;STATISTICS&nbsp;权限默认授予表或视图的所有者，并且该权限不可转让。</P>
<P>示例<BR>A.&nbsp;更新单个表的所有统计<BR>本示例更新表&nbsp;authors&nbsp;上的所有索引分发统计。</P>
<P>UPDATE&nbsp;STATISTICS&nbsp;authors</P>
<P>B.&nbsp;仅更新单一索引的统计<BR>本示例仅更新表&nbsp;authors&nbsp;的索引&nbsp;au_id_ind&nbsp;的分发信息。&nbsp;</P>
<P>UPDATE&nbsp;STATISTICS&nbsp;authors&nbsp;au_id_ind</P>
<P>C.&nbsp;使用&nbsp;50%&nbsp;采样更新特定统计组（集合）的统计<BR>本示例首先创建表&nbsp;authors&nbsp;中&nbsp;au_lname&nbsp;列和&nbsp;au_fname&nbsp;列的统计组，然后对其进行更新。</P>
<P>CREATE&nbsp;STATISTICS&nbsp;anames&nbsp;<BR>&nbsp;&nbsp;&nbsp;ON&nbsp;authors&nbsp;(au_lname,&nbsp;au_fname)<BR>&nbsp;&nbsp;&nbsp;WITH&nbsp;SAMPLE&nbsp;50&nbsp;PERCENT<BR>GO<BR>--&nbsp;Time&nbsp;passes.&nbsp;The&nbsp;UPDATE&nbsp;STATISTICS&nbsp;statement&nbsp;is&nbsp;then&nbsp;executed.<BR>UPDATE&nbsp;STATISTICS&nbsp;authors(anames)&nbsp;<BR>&nbsp;&nbsp;&nbsp;WITH&nbsp;SAMPLE&nbsp;50&nbsp;PERCENT<BR>GO</P>
<P>D.&nbsp;使用&nbsp;FULLSCAN&nbsp;和&nbsp;NORECOMPUTE&nbsp;更新特定统计组（集合）的统计<BR>本示例更新表&nbsp;authors&nbsp;中的&nbsp;anames&nbsp;统计组（集合），强制对表&nbsp;authors&nbsp;中的所有行进行完全扫描，并且关闭该统计组（集合）的自动统计更新。</P>
<P>UPDATE&nbsp;STATISTICS&nbsp;authors(anames)<BR>&nbsp;&nbsp;&nbsp;WITH&nbsp;FULLSCAN,&nbsp;NORECOMPUTE</P>
<P><B>sp_updatestats对当前数据库中所有用户定义的表运行&nbsp;UPDATE&nbsp;STATISTICS</B>。</P>
<P>语法<BR>sp_updatestats&nbsp;[[@resample&nbsp;=]&nbsp;''resample'']</P>
<P>返回代码值<BR>0（成功）或&nbsp;1（失败）</P>
<P>参数<BR>[@resample&nbsp;=]&nbsp;''resample''</P>
<P>指定&nbsp;sp_updatestats&nbsp;将使用&nbsp;UPDATE&nbsp;STATISTICS&nbsp;命令的&nbsp;RESAMPLE&nbsp;选项。新统计表将继承旧统计表的采样比率。如果未指定&nbsp;''resample''，则&nbsp;sp_updatestats&nbsp;使用默认采样更新统计表。该参数的数据类型为&nbsp;varchar(8)，默认值为&nbsp;''NO''。</P>
<P>注释<BR>sp_updatestats&nbsp;会显示表示其进度的消息。完成更新之后，该存储过程将报告已为所有的表更新了统计信息。&nbsp;</P>
<P>权限<BR>只有&nbsp;DBO&nbsp;和&nbsp;sysadmin&nbsp;固定服务器角色的成员才能执行该过程。</P>
<P>示例<BR>下例为数据库&nbsp;pubs&nbsp;中的表更新统计信息。</P>
<P>USE&nbsp;pubs<BR>EXEC&nbsp;sp_updatestats&nbsp;</P></FONT>