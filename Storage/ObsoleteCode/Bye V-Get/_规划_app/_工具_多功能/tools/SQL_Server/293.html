<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>Get&nbsp;all&nbsp;Table&nbsp;Sizes</B><BR>Get&nbsp;all&nbsp;Table&nbsp;Sizes
<P></P>
<P></P>
<P><BR>These&nbsp;script&nbsp;creates&nbsp;two&nbsp;procedures&nbsp;(usp_GetTableSizes&nbsp;and&nbsp;sp_SpaceUsed2)&nbsp;in&nbsp;the&nbsp;user&nbsp;database.&nbsp;The&nbsp;first&nbsp;procedure&nbsp;Usp_GetTableSizes&nbsp;reports&nbsp;each&nbsp;user&nbsp;table&nbsp;in&nbsp;the&nbsp;database&nbsp;along&nbsp;with&nbsp;it's&nbsp;data&nbsp;size&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;data&nbsp;rows&nbsp;it&nbsp;has.&nbsp;Usp_GetTableSizes&nbsp;uses&nbsp;the&nbsp;second&nbsp;store&nbsp;procedure&nbsp;sp_spaceused2&nbsp;to&nbsp;collect&nbsp;metadata.&nbsp;Sp_spaceused2&nbsp;is&nbsp;a&nbsp;slightly&nbsp;modified&nbsp;version&nbsp;of&nbsp;the&nbsp;system&nbsp;stored&nbsp;procedure&nbsp;sp_spaceused.&nbsp;It&nbsp;returns&nbsp;tablenames&nbsp;that&nbsp;are&nbsp;longer&nbsp;than&nbsp;20&nbsp;characters.&nbsp;The&nbsp;sp_spaceused&nbsp;system&nbsp;stored&nbsp;procedure&nbsp;currently&nbsp;shows&nbsp;only&nbsp;the&nbsp;first&nbsp;20&nbsp;characters&nbsp;of&nbsp;a&nbsp;table&nbsp;name.&nbsp;</P>
<P>Author:&nbsp;Neil&nbsp;Mederich&nbsp;</P>
<P>--&nbsp;&nbsp;Run&nbsp;this&nbsp;script&nbsp;in&nbsp;your&nbsp;user&nbsp;database<BR>--&nbsp;&nbsp;There&nbsp;are&nbsp;two&nbsp;procedure&nbsp;create&nbsp;statements&nbsp;in&nbsp;this&nbsp;script.&nbsp;The&nbsp;first&nbsp;one&nbsp;reports&nbsp;the&nbsp;size<BR>--&nbsp;&nbsp;of&nbsp;each&nbsp;user&nbsp;table&nbsp;in&nbsp;the&nbsp;current&nbsp;database.&nbsp;The&nbsp;second&nbsp;procedure&nbsp;provides&nbsp;support&nbsp;for<BR>--&nbsp;&nbsp;table&nbsp;names&nbsp;that&nbsp;are&nbsp;longer&nbsp;than&nbsp;20&nbsp;characters&nbsp;(a&nbsp;limitation&nbsp;of&nbsp;system&nbsp;stored&nbsp;procedure&nbsp;sp_spaceused)<BR>--&nbsp;&nbsp;It&nbsp;will&nbsp;support&nbsp;tablenames&nbsp;of&nbsp;50&nbsp;characters&nbsp;or&nbsp;less,&nbsp;which&nbsp;should&nbsp;be&nbsp;sufficient&nbsp;in&nbsp;most&nbsp;cases</P>
<P>if&nbsp;exists(select&nbsp;*&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;id=object_id('usp_gettablesizes')&nbsp;and&nbsp;objectproperty(id,'isprocedure')=1)<BR>&nbsp;&nbsp;drop&nbsp;proc&nbsp;usp_gettablesizes<BR>go</P>
<P>create&nbsp;procedure&nbsp;usp_GetTableSizes&nbsp;@sortby&nbsp;varchar(5)='rows',@updateusage&nbsp;varchar(5)='False'<BR>as<BR>/*&nbsp;<BR>**&nbsp;Date:&nbsp;August&nbsp;17,&nbsp;2000<BR>**&nbsp;Author:&nbsp;Neil&nbsp;Mederich<BR>**&nbsp;Purpose:&nbsp;Report&nbsp;row&nbsp;counts&nbsp;and&nbsp;data&nbsp;size&nbsp;of&nbsp;user&nbsp;tables<BR>**&nbsp;Input&nbsp;Parameter:&nbsp;@sortby&nbsp;=&nbsp;column&nbsp;to&nbsp;sort&nbsp;results&nbsp;by&nbsp;('rows'&nbsp;or&nbsp;'data'&nbsp;or&nbsp;'name')&nbsp;<BR>**&nbsp;Input&nbsp;Parameter:&nbsp;@updateusage&nbsp;=&nbsp;update&nbsp;statistics&nbsp;('true'&nbsp;or&nbsp;'false')&nbsp;<BR>*/<BR>set&nbsp;nocount&nbsp;on</P>
<P>declare&nbsp;@dependency&nbsp;char(1)<BR>if&nbsp;exists(select&nbsp;*&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;id=object_id('sp_spaceused2')&nbsp;and&nbsp;objectproperty(id,'isprocedure')=1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dependency='T'<BR>else<BR>&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@dependency='F'</P>
<P>if&nbsp;@updateusage='True'<BR>&nbsp;&nbsp;Begin&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;DBCC&nbsp;UPDATEUSAGE&nbsp;(0)&nbsp;with&nbsp;NO_INFOMSGS&nbsp;<BR>&nbsp;&nbsp;End</P>
<P>create&nbsp;table&nbsp;#sdtt&nbsp;([name]&nbsp;nvarchar(50),[rows]&nbsp;int,[reserved]&nbsp;varchar(18),<BR>&nbsp;&nbsp;&nbsp;&nbsp;[data]&nbsp;varchar(18),[index_size]&nbsp;varchar(18),[unused]&nbsp;varchar(18))</P>
<P>select&nbsp;convert(varchar(50),a.name)&nbsp;as&nbsp;tablename&nbsp;into&nbsp;#sdt<BR>&nbsp;from&nbsp;sysobjects&nbsp;a&nbsp;<BR>&nbsp;where&nbsp;a.type='u'&nbsp;and&nbsp;objectproperty(a.id,'istable')=1</P>
<P>declare&nbsp;@x&nbsp;varchar(50),&nbsp;@y&nbsp;varchar(255)<BR>declare&nbsp;cOne&nbsp;cursor&nbsp;for&nbsp;select&nbsp;distinct&nbsp;tablename&nbsp;from&nbsp;#sdt&nbsp;order&nbsp;by&nbsp;tablename<BR>open&nbsp;cOne<BR>fetch&nbsp;next&nbsp;from&nbsp;cOne&nbsp;into&nbsp;@x<BR>While&nbsp;@@fetch_status=0<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;@dependency&nbsp;=&nbsp;'T'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@y&nbsp;=&nbsp;'exec&nbsp;sp_spaceused2&nbsp;@objname='&nbsp;+&nbsp;@x<BR>&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@y&nbsp;=&nbsp;'exec&nbsp;sp_spaceused&nbsp;@objname='&nbsp;+&nbsp;@x</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;@y&nbsp;=&nbsp;'insert&nbsp;#sdtt&nbsp;'&nbsp;+&nbsp;@y&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execute(@y)<BR>&nbsp;&nbsp;&nbsp;&nbsp;fetch&nbsp;next&nbsp;from&nbsp;cOne&nbsp;into&nbsp;@x<BR>&nbsp;&nbsp;end<BR>close&nbsp;cOne<BR>deallocate&nbsp;cOne</P>
<P>declare&nbsp;@z&nbsp;varchar(255)<BR>if&nbsp;@sortby='name'<BR>&nbsp;&nbsp;set&nbsp;@z&nbsp;=&nbsp;'select&nbsp;*&nbsp;from&nbsp;#sdtt&nbsp;order&nbsp;by&nbsp;'&nbsp;+&nbsp;@sortby&nbsp;+&nbsp;'&nbsp;asc'<BR>else<BR>&nbsp;&nbsp;set&nbsp;@z&nbsp;=&nbsp;'select&nbsp;*&nbsp;from&nbsp;#sdtt&nbsp;order&nbsp;by&nbsp;'&nbsp;+&nbsp;@sortby&nbsp;+&nbsp;'&nbsp;desc'</P>
<P>exec&nbsp;(@z)</P>
<P>go</P>
<P><BR>if&nbsp;exists(select&nbsp;*&nbsp;from&nbsp;sysobjects&nbsp;where&nbsp;id=object_id('sp_spaceused2')&nbsp;and&nbsp;objectproperty(id,'isprocedure')=1)<BR>&nbsp;&nbsp;drop&nbsp;proc&nbsp;sp_spaceused2<BR>go<BR>CREATE&nbsp;procedure&nbsp;sp_spaceused2<BR>/*<BR>**&nbsp;The&nbsp;Original&nbsp;version&nbsp;(sp_spaceused)&nbsp;truncates&nbsp;table&nbsp;name&nbsp;at&nbsp;20&nbsp;characters.<BR>**&nbsp;Sp_spaceused2&nbsp;is&nbsp;a&nbsp;slightly&nbsp;modified&nbsp;version&nbsp;that&nbsp;allows&nbsp;the&nbsp;usp_GetTableSizes&nbsp;stored&nbsp;procedure&nbsp;to<BR>**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;report&nbsp;on&nbsp;tables&nbsp;that&nbsp;have&nbsp;a&nbsp;name&nbsp;up&nbsp;to&nbsp;50&nbsp;characters&nbsp;in&nbsp;length.<BR>**&nbsp;If&nbsp;all&nbsp;your&nbsp;user&nbsp;table&nbsp;names&nbsp;are&nbsp;20&nbsp;characters&nbsp;or&nbsp;less&nbsp;you&nbsp;can&nbsp;get&nbsp;by&nbsp;without&nbsp;adding&nbsp;this&nbsp;procedure.</P>
<P>*/<BR>@objname&nbsp;nvarchar(776)&nbsp;=&nbsp;null,&nbsp;&nbsp;--&nbsp;The&nbsp;object&nbsp;we&nbsp;want&nbsp;size&nbsp;on.<BR>@updateusage&nbsp;varchar(5)&nbsp;=&nbsp;false&nbsp;&nbsp;--&nbsp;Param.&nbsp;for&nbsp;specifying&nbsp;that<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;usage&nbsp;info.&nbsp;should&nbsp;be&nbsp;updated.<BR>as</P>
<P>declare&nbsp;@id&nbsp;int&nbsp;&nbsp;&nbsp;--&nbsp;The&nbsp;object&nbsp;id&nbsp;of&nbsp;@objname.<BR>declare&nbsp;@type&nbsp;character(2)&nbsp;--&nbsp;The&nbsp;object&nbsp;type.<BR>declare&nbsp;@pages&nbsp;int&nbsp;&nbsp;&nbsp;--&nbsp;Working&nbsp;variable&nbsp;for&nbsp;size&nbsp;calc.<BR>declare&nbsp;@dbname&nbsp;sysname<BR>declare&nbsp;@dbsize&nbsp;dec(15,0)<BR>declare&nbsp;@bytesperpage&nbsp;dec(15,0)<BR>declare&nbsp;@pagesperMB&nbsp;&nbsp;dec(15,0)</P>
<P>/*Create&nbsp;temp&nbsp;tables&nbsp;before&nbsp;any&nbsp;DML&nbsp;to&nbsp;ensure&nbsp;dynamic<BR>**&nbsp;&nbsp;We&nbsp;need&nbsp;to&nbsp;create&nbsp;a&nbsp;temp&nbsp;table&nbsp;to&nbsp;do&nbsp;the&nbsp;calculation.<BR>**&nbsp;&nbsp;reserved:&nbsp;sum(reserved)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)<BR>**&nbsp;&nbsp;data:&nbsp;sum(dpages)&nbsp;where&nbsp;indid&nbsp;&lt;&nbsp;2&nbsp;+&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;=&nbsp;255&nbsp;(text)<BR>**&nbsp;&nbsp;indexp:&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)&nbsp;-&nbsp;data<BR>**&nbsp;&nbsp;unused:&nbsp;sum(reserved)&nbsp;-&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)<BR>*/<BR>create&nbsp;table&nbsp;#spt_space<BR>(<BR>&nbsp;rows&nbsp;&nbsp;int&nbsp;null,<BR>&nbsp;reserved&nbsp;dec(15)&nbsp;null,<BR>&nbsp;data&nbsp;&nbsp;dec(15)&nbsp;null,<BR>&nbsp;indexp&nbsp;&nbsp;dec(15)&nbsp;null,<BR>&nbsp;unused&nbsp;&nbsp;dec(15)&nbsp;null<BR>)</P>
<P>/*<BR>**&nbsp;&nbsp;Check&nbsp;to&nbsp;see&nbsp;if&nbsp;user&nbsp;wants&nbsp;usages&nbsp;updated.<BR>*/</P>
<P>if&nbsp;@updateusage&nbsp;is&nbsp;not&nbsp;null<BR>&nbsp;begin<BR>&nbsp;&nbsp;select&nbsp;@updateusage=lower(@updateusage)</P>
<P>&nbsp;&nbsp;if&nbsp;@updateusage&nbsp;not&nbsp;in&nbsp;('true','false')<BR>&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;raiserror(15143,-1,-1,@updateusage)<BR>&nbsp;&nbsp;&nbsp;&nbsp;return(1)<BR>&nbsp;&nbsp;&nbsp;end<BR>&nbsp;end<BR>/*<BR>**&nbsp;&nbsp;Check&nbsp;to&nbsp;see&nbsp;that&nbsp;the&nbsp;objname&nbsp;is&nbsp;local.<BR>*/<BR>if&nbsp;@objname&nbsp;IS&nbsp;NOT&nbsp;NULL<BR>begin</P>
<P>&nbsp;select&nbsp;@dbname&nbsp;=&nbsp;parsename(@objname,&nbsp;3)</P>
<P>&nbsp;if&nbsp;@dbname&nbsp;is&nbsp;not&nbsp;null&nbsp;and&nbsp;@dbname&nbsp;&lt;&gt;&nbsp;db_name()<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;raiserror(15250,-1,-1)<BR>&nbsp;&nbsp;&nbsp;return&nbsp;(1)<BR>&nbsp;&nbsp;end</P>
<P>&nbsp;if&nbsp;@dbname&nbsp;is&nbsp;null<BR>&nbsp;&nbsp;select&nbsp;@dbname&nbsp;=&nbsp;db_name()</P>
<P>&nbsp;/*<BR>&nbsp;**&nbsp;&nbsp;Try&nbsp;to&nbsp;find&nbsp;the&nbsp;object.<BR>&nbsp;*/<BR>&nbsp;select&nbsp;@id&nbsp;=&nbsp;null<BR>&nbsp;select&nbsp;@id&nbsp;=&nbsp;id,&nbsp;@type&nbsp;=&nbsp;xtype<BR>&nbsp;&nbsp;from&nbsp;sysobjects<BR>&nbsp;&nbsp;&nbsp;where&nbsp;id&nbsp;=&nbsp;object_id(@objname)</P>
<P>&nbsp;/*<BR>&nbsp;**&nbsp;&nbsp;Does&nbsp;the&nbsp;object&nbsp;exist?<BR>&nbsp;*/<BR>&nbsp;if&nbsp;@id&nbsp;is&nbsp;null<BR>&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;raiserror(15009,-1,-1,@objname,@dbname)<BR>&nbsp;&nbsp;&nbsp;return&nbsp;(1)<BR>&nbsp;&nbsp;end</P>
<P><BR>&nbsp;if&nbsp;not&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;@id&nbsp;=&nbsp;id&nbsp;and&nbsp;indid&nbsp;&lt;&nbsp;2)</P>
<P>&nbsp;&nbsp;if&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@type&nbsp;in&nbsp;('P&nbsp;','D&nbsp;','R&nbsp;','TR','C&nbsp;','RF')&nbsp;--data&nbsp;stored&nbsp;in&nbsp;sysprocedures<BR>&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raiserror(15234,-1,-1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;&nbsp;else&nbsp;if&nbsp;@type&nbsp;=&nbsp;'V&nbsp;'&nbsp;--&nbsp;View&nbsp;=&gt;&nbsp;no&nbsp;physical&nbsp;data&nbsp;storage.<BR>&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raiserror(15235,-1,-1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;&nbsp;else&nbsp;if&nbsp;@type&nbsp;in&nbsp;('PK','UQ')&nbsp;--&nbsp;no&nbsp;physical&nbsp;data&nbsp;storage.&nbsp;--?!?!&nbsp;too&nbsp;many&nbsp;similar&nbsp;messages<BR>&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raiserror(15064,-1,-1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;end<BR>&nbsp;&nbsp;else&nbsp;if&nbsp;@type&nbsp;=&nbsp;'F&nbsp;'&nbsp;--&nbsp;FK&nbsp;=&gt;&nbsp;no&nbsp;physical&nbsp;data&nbsp;storage.<BR>&nbsp;&nbsp;&nbsp;&nbsp;begin<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raiserror(15275,-1,-1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;end<BR>end</P>
<P>/*<BR>**&nbsp;&nbsp;Update&nbsp;usages&nbsp;if&nbsp;user&nbsp;specified&nbsp;to&nbsp;do&nbsp;so.<BR>*/</P>
<P>if&nbsp;@updateusage&nbsp;=&nbsp;'true'<BR>&nbsp;begin<BR>&nbsp;&nbsp;if&nbsp;@objname&nbsp;is&nbsp;null<BR>&nbsp;&nbsp;&nbsp;dbcc&nbsp;updateusage(0)&nbsp;with&nbsp;no_infomsgs<BR>&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;dbcc&nbsp;updateusage(0,@objname)&nbsp;with&nbsp;no_infomsgs<BR>&nbsp;&nbsp;print&nbsp;'&nbsp;'<BR>&nbsp;end</P>
<P><BR>set&nbsp;nocount&nbsp;on</P>
<P>/*<BR>**&nbsp;&nbsp;If&nbsp;@id&nbsp;is&nbsp;null,&nbsp;then&nbsp;we&nbsp;want&nbsp;summary&nbsp;data.<BR>*/<BR>/*&nbsp;Space&nbsp;used&nbsp;calculated&nbsp;in&nbsp;the&nbsp;following&nbsp;way<BR>**&nbsp;@dbsize&nbsp;=&nbsp;Pages&nbsp;used<BR>**&nbsp;@bytesperpage&nbsp;=&nbsp;d.low&nbsp;(where&nbsp;d&nbsp;=&nbsp;master.dbo.spt_values)&nbsp;is<BR>**&nbsp;the&nbsp;#&nbsp;of&nbsp;bytes&nbsp;per&nbsp;page&nbsp;when&nbsp;d.type&nbsp;=&nbsp;'E'&nbsp;and<BR>**&nbsp;d.number&nbsp;=&nbsp;1.<BR>**&nbsp;Size&nbsp;=&nbsp;@dbsize&nbsp;*&nbsp;d.low&nbsp;/&nbsp;(1048576&nbsp;(OR&nbsp;1&nbsp;MB))<BR>*/<BR>if&nbsp;@id&nbsp;is&nbsp;null<BR>begin<BR>&nbsp;select&nbsp;@dbsize&nbsp;=&nbsp;sum(convert(dec(15),size))<BR>&nbsp;&nbsp;from&nbsp;dbo.sysfiles</P>
<P>&nbsp;select&nbsp;@bytesperpage&nbsp;=&nbsp;low<BR>&nbsp;&nbsp;from&nbsp;master.dbo.spt_values<BR>&nbsp;&nbsp;where&nbsp;number&nbsp;=&nbsp;1<BR>&nbsp;&nbsp;&nbsp;and&nbsp;type&nbsp;=&nbsp;'E'<BR>&nbsp;select&nbsp;@pagesperMB&nbsp;=&nbsp;1048576&nbsp;/&nbsp;@bytesperpage</P>
<P>&nbsp;select&nbsp;&nbsp;database_name&nbsp;=&nbsp;db_name(),<BR>&nbsp;&nbsp;database_size&nbsp;=<BR>&nbsp;&nbsp;&nbsp;ltrim(str(@dbsize&nbsp;/&nbsp;@pagesperMB,15,2)&nbsp;+&nbsp;'&nbsp;MB'),<BR>&nbsp;&nbsp;'unallocated&nbsp;space'&nbsp;=<BR>&nbsp;&nbsp;&nbsp;ltrim(str((@dbsize&nbsp;-<BR>&nbsp;&nbsp;&nbsp;&nbsp;(select&nbsp;sum(convert(dec(15),reserved))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)<BR>&nbsp;&nbsp;&nbsp;&nbsp;))&nbsp;/&nbsp;@pagesperMB,15,2)+&nbsp;'&nbsp;MB')</P>
<P>&nbsp;print&nbsp;'&nbsp;'<BR>&nbsp;/*<BR>&nbsp;**&nbsp;&nbsp;Now&nbsp;calculate&nbsp;the&nbsp;summary&nbsp;data.<BR>&nbsp;**&nbsp;&nbsp;reserved:&nbsp;sum(reserved)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)<BR>&nbsp;*/<BR>&nbsp;insert&nbsp;into&nbsp;#spt_space&nbsp;(reserved)<BR>&nbsp;&nbsp;select&nbsp;sum(convert(dec(15),reserved))<BR>&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)</P>
<P>&nbsp;/*<BR>&nbsp;**&nbsp;data:&nbsp;sum(dpages)&nbsp;where&nbsp;indid&nbsp;&lt;&nbsp;2<BR>&nbsp;**&nbsp;+&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;=&nbsp;255&nbsp;(text)<BR>&nbsp;*/<BR>&nbsp;select&nbsp;@pages&nbsp;=&nbsp;sum(convert(dec(15),dpages))<BR>&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;&lt;&nbsp;2<BR>&nbsp;select&nbsp;@pages&nbsp;=&nbsp;@pages&nbsp;+&nbsp;isnull(sum(convert(dec(15),used)),&nbsp;0)<BR>&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;=&nbsp;255<BR>&nbsp;update&nbsp;#spt_space<BR>&nbsp;&nbsp;set&nbsp;data&nbsp;=&nbsp;@pages</P>
<P><BR>&nbsp;/*&nbsp;index:&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)&nbsp;-&nbsp;data&nbsp;*/<BR>&nbsp;update&nbsp;#spt_space<BR>&nbsp;&nbsp;set&nbsp;indexp&nbsp;=&nbsp;(select&nbsp;sum(convert(dec(15),used))<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;data</P>
<P>&nbsp;/*&nbsp;unused:&nbsp;sum(reserved)&nbsp;-&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)&nbsp;*/<BR>&nbsp;update&nbsp;#spt_space<BR>&nbsp;&nbsp;set&nbsp;unused&nbsp;=&nbsp;reserved<BR>&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;(select&nbsp;sum(convert(dec(15),used))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255))</P>
<P>&nbsp;select&nbsp;reserved&nbsp;=&nbsp;ltrim(str(reserved&nbsp;*&nbsp;d.low&nbsp;/&nbsp;1024.,15,0)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;'&nbsp;+&nbsp;'KB'),<BR>&nbsp;&nbsp;data&nbsp;=&nbsp;ltrim(str(data&nbsp;*&nbsp;d.low&nbsp;/&nbsp;1024.,15,0)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;'&nbsp;+&nbsp;'KB'),<BR>&nbsp;&nbsp;index_size&nbsp;=&nbsp;ltrim(str(indexp&nbsp;*&nbsp;d.low&nbsp;/&nbsp;1024.,15,0)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;'&nbsp;+&nbsp;'KB'),<BR>&nbsp;&nbsp;unused&nbsp;=&nbsp;ltrim(str(unused&nbsp;*&nbsp;d.low&nbsp;/&nbsp;1024.,15,0)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;'&nbsp;+&nbsp;'KB')<BR>&nbsp;&nbsp;from&nbsp;#spt_space,&nbsp;master.dbo.spt_values&nbsp;d<BR>&nbsp;&nbsp;where&nbsp;d.number&nbsp;=&nbsp;1<BR>&nbsp;&nbsp;&nbsp;and&nbsp;d.type&nbsp;=&nbsp;'E'<BR>end</P>
<P>/*<BR>**&nbsp;&nbsp;We&nbsp;want&nbsp;a&nbsp;particular&nbsp;object.<BR>*/<BR>else<BR>begin<BR>&nbsp;/*<BR>&nbsp;**&nbsp;&nbsp;Now&nbsp;calculate&nbsp;the&nbsp;summary&nbsp;data.<BR>&nbsp;**&nbsp;&nbsp;reserved:&nbsp;sum(reserved)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)<BR>&nbsp;*/<BR>&nbsp;insert&nbsp;into&nbsp;#spt_space&nbsp;(reserved)<BR>&nbsp;&nbsp;select&nbsp;sum(reserved)<BR>&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;id&nbsp;=&nbsp;@id</P>
<P>&nbsp;/*<BR>&nbsp;**&nbsp;data:&nbsp;sum(dpages)&nbsp;where&nbsp;indid&nbsp;&lt;&nbsp;2<BR>&nbsp;**&nbsp;+&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;=&nbsp;255&nbsp;(text)<BR>&nbsp;*/<BR>&nbsp;select&nbsp;@pages&nbsp;=&nbsp;sum(dpages)<BR>&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;&lt;&nbsp;2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;id&nbsp;=&nbsp;@id<BR>&nbsp;select&nbsp;@pages&nbsp;=&nbsp;@pages&nbsp;+&nbsp;isnull(sum(used),&nbsp;0)<BR>&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;=&nbsp;255<BR>&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;id&nbsp;=&nbsp;@id<BR>&nbsp;update&nbsp;#spt_space<BR>&nbsp;&nbsp;set&nbsp;data&nbsp;=&nbsp;@pages</P>
<P><BR>&nbsp;/*&nbsp;index:&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)&nbsp;-&nbsp;data&nbsp;*/<BR>&nbsp;update&nbsp;#spt_space<BR>&nbsp;&nbsp;set&nbsp;indexp&nbsp;=&nbsp;(select&nbsp;sum(used)<BR>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;id&nbsp;=&nbsp;@id)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;data</P>
<P>&nbsp;/*&nbsp;unused:&nbsp;sum(reserved)&nbsp;-&nbsp;sum(used)&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)&nbsp;*/<BR>&nbsp;update&nbsp;#spt_space<BR>&nbsp;&nbsp;set&nbsp;unused&nbsp;=&nbsp;reserved<BR>&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;(select&nbsp;sum(used)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;indid&nbsp;in&nbsp;(0,&nbsp;1,&nbsp;255)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;id&nbsp;=&nbsp;@id)<BR>&nbsp;update&nbsp;#spt_space<BR>&nbsp;&nbsp;set&nbsp;rows&nbsp;=&nbsp;i.rows<BR>&nbsp;&nbsp;&nbsp;from&nbsp;sysindexes&nbsp;i<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;i.indid&nbsp;&lt;&nbsp;2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;i.id&nbsp;=&nbsp;@id</P>
<P>--&nbsp;Line&nbsp;below&nbsp;is&nbsp;the&nbsp;line&nbsp;that&nbsp;was&nbsp;changed&nbsp;to&nbsp;allow&nbsp;table&nbsp;names&nbsp;up&nbsp;to&nbsp;50&nbsp;characters<BR>&nbsp;select&nbsp;name&nbsp;=&nbsp;substring(object_name(@id),&nbsp;1,&nbsp;50),<BR>&nbsp;&nbsp;rows&nbsp;=&nbsp;convert(char(11),&nbsp;rows),<BR>&nbsp;&nbsp;reserved&nbsp;=&nbsp;ltrim(str(reserved&nbsp;*&nbsp;d.low&nbsp;/&nbsp;1024.,15,0)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;'&nbsp;+&nbsp;'KB'),<BR>&nbsp;&nbsp;data&nbsp;=&nbsp;ltrim(str(data&nbsp;*&nbsp;d.low&nbsp;/&nbsp;1024.,15,0)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;'&nbsp;+&nbsp;'KB'),<BR>&nbsp;&nbsp;index_size&nbsp;=&nbsp;ltrim(str(indexp&nbsp;*&nbsp;d.low&nbsp;/&nbsp;1024.,15,0)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;'&nbsp;+&nbsp;'KB'),<BR>&nbsp;&nbsp;unused&nbsp;=&nbsp;ltrim(str(unused&nbsp;*&nbsp;d.low&nbsp;/&nbsp;1024.,15,0)&nbsp;+<BR>&nbsp;&nbsp;&nbsp;&nbsp;'&nbsp;'&nbsp;+&nbsp;'KB')<BR>&nbsp;from&nbsp;#spt_space,&nbsp;master.dbo.spt_values&nbsp;d<BR>&nbsp;&nbsp;where&nbsp;d.number&nbsp;=&nbsp;1<BR>&nbsp;&nbsp;&nbsp;and&nbsp;d.type&nbsp;=&nbsp;'E'<BR>end</P>
<P>return&nbsp;(0)</P></FONT>