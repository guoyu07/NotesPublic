<meta http-equiv="content-type" content="text/html; charset=gb2312">Have&nbsp;you&nbsp;heard&nbsp;about&nbsp;orphan&nbsp;SQL&nbsp;Server&nbsp;users?&nbsp;If&nbsp;not,&nbsp;an&nbsp;orphan&nbsp;user&nbsp;is&nbsp;a&nbsp;user&nbsp;in&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;database&nbsp;that&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;login.&nbsp;Orphan&nbsp;users&nbsp;are&nbsp;created&nbsp;when&nbsp;a&nbsp;database&nbsp;backup&nbsp;from&nbsp;one&nbsp;server&nbsp;is&nbsp;restored&nbsp;on&nbsp;another&nbsp;server.&nbsp;There&nbsp;are&nbsp;a&nbsp;number&nbsp;of&nbsp;articles&nbsp;that&nbsp;have&nbsp;been&nbsp;written,&nbsp;and&nbsp;lots&nbsp;of&nbsp;topics&nbsp;on&nbsp;discussion&nbsp;boards&nbsp;about&nbsp;reconnecting&nbsp;orphan&nbsp;users&nbsp;with&nbsp;logins,&nbsp;but&nbsp;few,&nbsp;if&nbsp;any,&nbsp;regarding&nbsp;removing&nbsp;orphan&nbsp;users.&nbsp;Therefore,&nbsp;this&nbsp;article&nbsp;deals&nbsp;with&nbsp;how&nbsp;to&nbsp;identify&nbsp;which&nbsp;databases&nbsp;have&nbsp;orphan&nbsp;users,&nbsp;and&nbsp;how&nbsp;to&nbsp;remove&nbsp;the&nbsp;identified&nbsp;orphan&nbsp;users.
<P></P>
<P>Just&nbsp;because&nbsp;you&nbsp;are&nbsp;moving&nbsp;a&nbsp;database&nbsp;from&nbsp;one&nbsp;server&nbsp;to&nbsp;another&nbsp;does&nbsp;not&nbsp;mean&nbsp;you&nbsp;also&nbsp;want&nbsp;to&nbsp;move&nbsp;all&nbsp;of&nbsp;the&nbsp;users&nbsp;associated&nbsp;with&nbsp;the&nbsp;database.&nbsp;In&nbsp;some&nbsp;cases,&nbsp;you&nbsp;may&nbsp;not&nbsp;want&nbsp;to&nbsp;move&nbsp;any,&nbsp;and&nbsp;in&nbsp;other&nbsp;cases,&nbsp;you&nbsp;might&nbsp;want&nbsp;to&nbsp;move&nbsp;only&nbsp;a&nbsp;few.&nbsp;For&nbsp;this&nbsp;discussion,&nbsp;let's&nbsp;say&nbsp;you&nbsp;have&nbsp;already&nbsp;identified&nbsp;and&nbsp;reconnected&nbsp;all&nbsp;of&nbsp;the&nbsp;orphan&nbsp;users&nbsp;you&nbsp;plan&nbsp;to&nbsp;keep.&nbsp;For&nbsp;all&nbsp;of&nbsp;the&nbsp;other&nbsp;orphan&nbsp;users&nbsp;you&nbsp;did&nbsp;not&nbsp;reconnect,&nbsp;I&nbsp;will&nbsp;show&nbsp;you&nbsp;how&nbsp;to&nbsp;identify&nbsp;and&nbsp;remove&nbsp;them.</P>
<P>Identifying&nbsp;Orphan&nbsp;Users<BR>SQL&nbsp;Server&nbsp;provides&nbsp;a&nbsp;SP&nbsp;to&nbsp;help&nbsp;you&nbsp;identify&nbsp;orphan&nbsp;users&nbsp;that&nbsp;were&nbsp;originally&nbsp;associated&nbsp;with&nbsp;SQL&nbsp;Server&nbsp;Authenticated&nbsp;logins.&nbsp;The&nbsp;SP&nbsp;is&nbsp;called&nbsp;sp_change_users_login.&nbsp;However,&nbsp;SQL&nbsp;Server&nbsp;does&nbsp;not&nbsp;provide&nbsp;a&nbsp;mechanism&nbsp;to&nbsp;identify&nbsp;orphan&nbsp;users&nbsp;that&nbsp;where&nbsp;originally&nbsp;associated&nbsp;with&nbsp;Windows&nbsp;authenticated&nbsp;users&nbsp;or&nbsp;groups.&nbsp;The&nbsp;key&nbsp;to&nbsp;removing&nbsp;users&nbsp;is&nbsp;being&nbsp;able&nbsp;to&nbsp;identify&nbsp;them.&nbsp;The&nbsp;following&nbsp;code&nbsp;can&nbsp;be&nbsp;run&nbsp;against&nbsp;any&nbsp;database&nbsp;to&nbsp;identify&nbsp;all&nbsp;of&nbsp;the&nbsp;orphan&nbsp;users&nbsp;regardless&nbsp;of&nbsp;whether&nbsp;they&nbsp;are&nbsp;associated&nbsp;with&nbsp;a&nbsp;SQL&nbsp;Server&nbsp;or&nbsp;Windows&nbsp;authenticated&nbsp;user&nbsp;and/or&nbsp;a&nbsp;Windows&nbsp;group.</P>
<P>select&nbsp;u.name&nbsp;from&nbsp;master..syslogins&nbsp;l&nbsp;right&nbsp;join&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;sysusers&nbsp;u&nbsp;on&nbsp;l.sid&nbsp;=&nbsp;u.sid&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;l.sid&nbsp;is&nbsp;null&nbsp;and&nbsp;issqlrole&nbsp;&lt;&gt;&nbsp;1&nbsp;and&nbsp;isapprole&nbsp;&lt;&gt;&nbsp;1&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;(u.name&nbsp;&lt;&gt;&nbsp;'INFORMATION_SCHEMA'&nbsp;and&nbsp;u.name&nbsp;&lt;&gt;&nbsp;'guest'&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;u.name&nbsp;&lt;&gt;&nbsp;'system_function_schema')</P>
<P>Removing&nbsp;Orphan&nbsp;Users<BR>Once&nbsp;you&nbsp;have&nbsp;identified&nbsp;orphan&nbsp;users&nbsp;it&nbsp;is&nbsp;extremely&nbsp;simple&nbsp;to&nbsp;remove&nbsp;them.&nbsp;You&nbsp;remove&nbsp;them&nbsp;by&nbsp;using&nbsp;the&nbsp;sp_revokeuser&nbsp;SP.&nbsp;Here&nbsp;is&nbsp;an&nbsp;example&nbsp;that&nbsp;removes&nbsp;the&nbsp;database&nbsp;users&nbsp;'USERX',&nbsp;from&nbsp;the&nbsp;current&nbsp;database&nbsp;in&nbsp;use.</P>
<P>exec&nbsp;sp_revokelogin&nbsp;'USERX'<BR>It&nbsp;seems&nbsp;fairly&nbsp;simple&nbsp;to&nbsp;do&nbsp;this&nbsp;for&nbsp;a&nbsp;few&nbsp;users&nbsp;and&nbsp;databases.&nbsp;However,&nbsp;if&nbsp;you&nbsp;have&nbsp;a&nbsp;large&nbsp;number&nbsp;of&nbsp;orphan&nbsp;users&nbsp;and&nbsp;databases,&nbsp;I'm&nbsp;sure&nbsp;you&nbsp;would&nbsp;not&nbsp;like&nbsp;to&nbsp;do&nbsp;this&nbsp;by&nbsp;hand.&nbsp;At&nbsp;least,&nbsp;I&nbsp;didn't&nbsp;want&nbsp;to&nbsp;do&nbsp;this&nbsp;manually.&nbsp;Because&nbsp;I&nbsp;like&nbsp;to&nbsp;automate&nbsp;repetitive&nbsp;manual&nbsp;tasks,&nbsp;I&nbsp;developed&nbsp;a&nbsp;stored&nbsp;procedure&nbsp;(SP)&nbsp;named&nbsp;"usp_remove_orphan_users"&nbsp;to&nbsp;accomplish&nbsp;identifying&nbsp;and&nbsp;removing&nbsp;orphan&nbsp;users.&nbsp;The&nbsp;code&nbsp;for&nbsp;this&nbsp;SP&nbsp;can&nbsp;be&nbsp;found&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;this&nbsp;article.&nbsp;</P>
<P>This&nbsp;SP&nbsp;first&nbsp;determines&nbsp;which&nbsp;databases&nbsp;have&nbsp;orphan&nbsp;users.&nbsp;For&nbsp;each&nbsp;database&nbsp;that&nbsp;has&nbsp;orphans,&nbsp;it&nbsp;removes&nbsp;them&nbsp;one&nbsp;at&nbsp;a&nbsp;time.&nbsp;If&nbsp;an&nbsp;orphan&nbsp;user&nbsp;is&nbsp;the&nbsp;database&nbsp;owner&nbsp;then&nbsp;the&nbsp;"sp_changedbowner"&nbsp;SP&nbsp;is&nbsp;used&nbsp;to&nbsp;change&nbsp;the&nbsp;owner&nbsp;to&nbsp;"SA"&nbsp;before&nbsp;the&nbsp;orphan&nbsp;user&nbsp;is&nbsp;removed.&nbsp;The&nbsp;SP&nbsp;does&nbsp;not&nbsp;really&nbsp;remove&nbsp;the&nbsp;users,&nbsp;or&nbsp;change&nbsp;the&nbsp;database&nbsp;owners,&nbsp;but&nbsp;instead&nbsp;it&nbsp;just&nbsp;generates&nbsp;the&nbsp;code&nbsp;to&nbsp;remove&nbsp;the&nbsp;users.&nbsp;This&nbsp;allows&nbsp;you&nbsp;to&nbsp;review&nbsp;the&nbsp;code&nbsp;and&nbsp;determine&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;remove&nbsp;all&nbsp;users,&nbsp;or&nbsp;only&nbsp;a&nbsp;select&nbsp;set&nbsp;of&nbsp;orphan&nbsp;users.</P>
<P>Conclusion<BR>You&nbsp;can&nbsp;leave&nbsp;the&nbsp;orphan&nbsp;database&nbsp;users&nbsp;in&nbsp;a&nbsp;database&nbsp;if&nbsp;you&nbsp;want.&nbsp;Although&nbsp;they&nbsp;are&nbsp;excess&nbsp;baggage,&nbsp;that&nbsp;comes&nbsp;along&nbsp;with&nbsp;a&nbsp;database&nbsp;restore.&nbsp;In&nbsp;addition,&nbsp;they&nbsp;provide&nbsp;a&nbsp;small&nbsp;security&nbsp;risk&nbsp;if&nbsp;some&nbsp;newly&nbsp;defined&nbsp;login&nbsp;is&nbsp;unintentionally&nbsp;associated&nbsp;with&nbsp;an&nbsp;orphan&nbsp;user,&nbsp;allowing&nbsp;the&nbsp;new&nbsp;login&nbsp;to&nbsp;gain&nbsp;unauthorized&nbsp;database&nbsp;access.&nbsp;It&nbsp;is&nbsp;best&nbsp;to&nbsp;remove&nbsp;un-necessary&nbsp;orphan&nbsp;users&nbsp;to&nbsp;provide&nbsp;a&nbsp;clean,&nbsp;uncluttered&nbsp;database&nbsp;environment.&nbsp;This&nbsp;script&nbsp;provides&nbsp;an&nbsp;easy&nbsp;method&nbsp;to&nbsp;identify&nbsp;and&nbsp;remove&nbsp;unneeded&nbsp;orphan&nbsp;users.&nbsp;Therefore,&nbsp;this&nbsp;SP&nbsp;can&nbsp;be&nbsp;a&nbsp;valuable&nbsp;tool,&nbsp;to&nbsp;be&nbsp;used&nbsp;as&nbsp;part&nbsp;of&nbsp;your&nbsp;database&nbsp;restore&nbsp;process,&nbsp;should&nbsp;you&nbsp;desire&nbsp;to&nbsp;remove&nbsp;orphan&nbsp;users.</P>