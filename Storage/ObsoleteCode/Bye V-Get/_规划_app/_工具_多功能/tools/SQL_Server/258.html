<meta http-equiv="content-type" content="text/html; charset=gb2312"><FONT 
style="FONT-SIZE: 9pt; LINE-HEIGHT: 15pt"><B>The&nbsp;SQL&nbsp;Server&nbsp;Black&nbsp;Box</B><BR>Have&nbsp;you&nbsp;ever&nbsp;had&nbsp;the&nbsp;problem&nbsp;where&nbsp;a&nbsp;user&nbsp;ran&nbsp;a&nbsp;query&nbsp;against&nbsp;your&nbsp;SQL&nbsp;Serer&nbsp;and&nbsp;crashed&nbsp;it&nbsp;or&nbsp;made&nbsp;the&nbsp;server&nbsp;unusable&nbsp;since&nbsp;the&nbsp;CPU&nbsp;was&nbsp;spiked&nbsp;at&nbsp;100%?&nbsp;A&nbsp;SQL&nbsp;Server&nbsp;black&nbsp;box&nbsp;is&nbsp;the&nbsp;equivalent&nbsp;of&nbsp;a&nbsp;flight&nbsp;data&nbsp;record.&nbsp;The&nbsp;black&nbsp;box&nbsp;records&nbsp;all&nbsp;queries&nbsp;being&nbsp;passed&nbsp;to&nbsp;your&nbsp;SQL&nbsp;Server&nbsp;and&nbsp;other&nbsp;useful&nbsp;information&nbsp;like&nbsp;errors.&nbsp;You&nbsp;can&nbsp;use&nbsp;this&nbsp;information&nbsp;to&nbsp;determine&nbsp;why&nbsp;your&nbsp;server&nbsp;crashed&nbsp;or&nbsp;what&nbsp;error&nbsp;occured&nbsp;right&nbsp;before&nbsp;your&nbsp;CPU&nbsp;was&nbsp;pegged.&nbsp;<BR>A&nbsp;black&nbsp;box&nbsp;traps&nbsp;the&nbsp;following&nbsp;information:&nbsp;
<P></P>
<P>Errors&nbsp;and&nbsp;warnings&nbsp;(Attention&nbsp;and&nbsp;Exception)&nbsp;<BR>Stored&nbsp;procedure&nbsp;execution&nbsp;(RPC:&nbsp;Starting)&nbsp;<BR>T-SQL&nbsp;execution&nbsp;(SQL:&nbsp;BatchStarting)&nbsp;<BR>For&nbsp;those&nbsp;given&nbsp;events,&nbsp;the&nbsp;following&nbsp;information&nbsp;is&nbsp;trapped:&nbsp;</P>
<P>Query&nbsp;or&nbsp;error&nbsp;that&nbsp;was&nbsp;executed&nbsp;<BR>Date&nbsp;and&nbsp;time&nbsp;executed&nbsp;<BR>The&nbsp;user&nbsp;that&nbsp;executed&nbsp;the&nbsp;query&nbsp;or&nbsp;sproc&nbsp;<BR>Database&nbsp;the&nbsp;event&nbsp;occured&nbsp;in&nbsp;<BR>The&nbsp;server&nbsp;or&nbsp;workstation&nbsp;that&nbsp;sent&nbsp;the&nbsp;query&nbsp;or&nbsp;caused&nbsp;the&nbsp;error&nbsp;<BR>Application&nbsp;name&nbsp;that&nbsp;performed&nbsp;the&nbsp;query&nbsp;<BR>The&nbsp;black&nbsp;box&nbsp;writes&nbsp;to&nbsp;the&nbsp;file&nbsp;in&nbsp;128K&nbsp;chunks.&nbsp;In&nbsp;other&nbsp;words,&nbsp;when&nbsp;you&nbsp;start&nbsp;the&nbsp;black&nbsp;box,&nbsp;it&nbsp;will&nbsp;appear&nbsp;as&nbsp;if&nbsp;the&nbsp;file&nbsp;has&nbsp;0K&nbsp;until&nbsp;it&nbsp;has&nbsp;128K&nbsp;worth&nbsp;of&nbsp;data&nbsp;to&nbsp;write.&nbsp;This&nbsp;architecture&nbsp;makes&nbsp;it&nbsp;a&nbsp;very&nbsp;efficient&nbsp;process&nbsp;and&nbsp;where&nbsp;it&nbsp;uses&nbsp;minimal&nbsp;CPU&nbsp;utilization.&nbsp;Because&nbsp;of&nbsp;that,&nbsp;you&nbsp;can&nbsp;run&nbsp;it&nbsp;for&nbsp;extended&nbsp;periods&nbsp;of&nbsp;time&nbsp;and&nbsp;not&nbsp;worry&nbsp;about&nbsp;it&nbsp;killing&nbsp;your&nbsp;server's&nbsp;performance.&nbsp;If&nbsp;you&nbsp;stop&nbsp;SQL&nbsp;Server,&nbsp;the&nbsp;SQL&nbsp;Server&nbsp;will&nbsp;write&nbsp;whatever&nbsp;data&nbsp;it&nbsp;has&nbsp;in&nbsp;cache&nbsp;to&nbsp;the&nbsp;trace&nbsp;file.&nbsp;<BR>The&nbsp;file&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;the&nbsp;data&nbsp;directory&nbsp;by&nbsp;default&nbsp;(\Program&nbsp;Files\Microsoft&nbsp;SQL&nbsp;Server\MSSQL\data)&nbsp;and&nbsp;is&nbsp;called&nbsp;blackbox.trc.&nbsp;As&nbsp;the&nbsp;file&nbsp;grows&nbsp;to&nbsp;5MB,&nbsp;it&nbsp;rolls&nbsp;over&nbsp;to&nbsp;a&nbsp;new&nbsp;file.&nbsp;A&nbsp;new&nbsp;file&nbsp;will&nbsp;be&nbsp;created&nbsp;also&nbsp;occurs&nbsp;if&nbsp;you&nbsp;start&nbsp;and&nbsp;stop&nbsp;SQL&nbsp;Server,&nbsp;overwriting&nbsp;your&nbsp;old&nbsp;file.&nbsp;Make&nbsp;sure&nbsp;that&nbsp;you&nbsp;occasionally&nbsp;go&nbsp;through&nbsp;and&nbsp;delete&nbsp;the&nbsp;old&nbsp;trace&nbsp;file&nbsp;that&nbsp;may've&nbsp;rolled&nbsp;over.&nbsp;</P>
<P>Now&nbsp;that&nbsp;you&nbsp;know&nbsp;what&nbsp;a&nbsp;black&nbsp;box&nbsp;is,&nbsp;how&nbsp;do&nbsp;you&nbsp;start&nbsp;one?&nbsp;To&nbsp;start&nbsp;one,&nbsp;you&nbsp;have&nbsp;to&nbsp;use&nbsp;the&nbsp;sp_trace_create&nbsp;system&nbsp;stored&nbsp;procedure.&nbsp;You&nbsp;set&nbsp;the&nbsp;trace&nbsp;type&nbsp;to&nbsp;the&nbsp;special&nbsp;server-side&nbsp;trace&nbsp;status&nbsp;of&nbsp;8&nbsp;to&nbsp;make&nbsp;it&nbsp;a&nbsp;black&nbsp;box&nbsp;trace&nbsp;file.&nbsp;The&nbsp;below&nbsp;stored&nbsp;procedure&nbsp;will&nbsp;create&nbsp;a&nbsp;black&nbsp;box&nbsp;stored&nbsp;procedure&nbsp;called&nbsp;startblackbox&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;start&nbsp;the&nbsp;black&nbsp;box&nbsp;on&nbsp;demand.&nbsp;I&nbsp;have&nbsp;optionally&nbsp;used&nbsp;the&nbsp;sp_procoption&nbsp;stored&nbsp;procedure&nbsp;to&nbsp;start&nbsp;the&nbsp;black&nbsp;box&nbsp;when&nbsp;SQL&nbsp;Server&nbsp;starts.&nbsp;</P>
<P>-----------------------------------------------------------------------------------<BR>USE&nbsp;master<BR>GO</P>
<P>CREATE&nbsp;PROC&nbsp;startblackbox<BR>AS</P>
<P>declare&nbsp;@TraceID&nbsp;int</P>
<P>exec&nbsp;sp_trace_create&nbsp;@TraceID&nbsp;output,&nbsp;8<BR>exec&nbsp;sp_trace_setstatus&nbsp;@traceID,&nbsp;1</P>
<P>RETURN<BR>go<BR>--Optional&nbsp;part&nbsp;of&nbsp;syntax&nbsp;to&nbsp;make&nbsp;the&nbsp;black&nbsp;box&nbsp;start&nbsp;on&nbsp;the&nbsp;startup&nbsp;of&nbsp;SQL&nbsp;Server<BR>exec&nbsp;sp_procoption&nbsp;startblackbox,&nbsp;'startup',&nbsp;'on'<BR>go<BR>-----------------------------------------------------------------------------------</P>
<P>Now&nbsp;that&nbsp;you&nbsp;have&nbsp;the&nbsp;stored&nbsp;procedure,&nbsp;give&nbsp;it&nbsp;a&nbsp;shot&nbsp;on&nbsp;a&nbsp;development&nbsp;server!&nbsp;You&nbsp;can&nbsp;use&nbsp;the&nbsp;output&nbsp;in&nbsp;many&nbsp;ways.&nbsp;For&nbsp;example,&nbsp;you&nbsp;can&nbsp;use&nbsp;the&nbsp;output&nbsp;for&nbsp;Index&nbsp;Tuning&nbsp;Wizard&nbsp;input&nbsp;to&nbsp;tune&nbsp;your&nbsp;server.&nbsp;The&nbsp;main&nbsp;reason&nbsp;for&nbsp;this&nbsp;trace&nbsp;is&nbsp;to&nbsp;send&nbsp;to&nbsp;Microsoft&nbsp;product&nbsp;support&nbsp;or&nbsp;for&nbsp;debugging&nbsp;yoursel</P></FONT>