[MQTT](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718013)
# Data Representation
Integer data values are 16 bits in big-endian order: the high order byte precedes the lower order byte. This means that a 16-bit word is presented on the network as Most Significant Byte (MSB), followed by Least Significant Byte (LSB).

# MQTT Control Packet Format
```
+------------------------------------------
|                   |          | 
+-------------------+----------+-----------
|                   | CP  Flags| 
| Fixed header      +----------+  All (2 Bytes)
|                   |  Remaing |   
+-------------------+----------+------------
|                   | PI MSB   |
| Variable header   +----------+  Some (2 Bytes)
|                   | PI LSB   |   
+-------------------+----------+-------------
| Payload           |          |  Some
+-----------------------+--------------------
```

## Fixed Header
```
+--------------------------------------+
| bit  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
| Byte |    Control    |     Flags     |
|   1  |    Packet     |               |
+--------------------------------------+
|   2  |  Remaining Length             |
+--------------------------------------+
```
### Control Packet
1 byte = 4 bit = [0, 2^4 - 1]
```
Bit   7    6   5  4
+---------------------------------------------------------------
|CP|V|P|
+-----------------------------------------------------
| 0| | | Reseved    |         |
| 1| |*| CONNECT    | C2S     |  
| 2| | | CONNACK    | S2C     | Connect ACK
| 3|?|?| PUBLISH    | C2S/S2C |  Publish message
| 4|Y| | PUBACK     | C2S/S2C | Publish ACK
| 5|Y| | PUBREC     | C2S/S2C | Publish Received
| 6|Y| | PUBREL     | C2S/S2C | Publish Release
| 7|Y| | PUBCOMP    | C2S/S2C | Publish Complete
| 8|Y|*| SUBSCRIBE  | C2S     |
| 9|Y|*| SUBACK     | S2C     | Subscribe ACK
|10|Y|*| UNSUBSCRIBE| C2S     |
|11|Y| | UNSUBACK   | S2C     | Unsubscribe ACK
|12| | | PINGREQ    | C2S     | Ping Request
|13| | | PINGRESP   | S2C     | Ping Response
|14| | | DISCONNECT | C2S     | Client is disconnecting
|15| | | Reserved   |         |
+----------------------------------------------------
```
CP      : The value of conrol pakcet bit
V       : Contains packet identifier filed (variable header), [? PUBLISH, if QoS > 0]
P       : Requires payload, [? optional] [* required]
C2S     : Client to Server
S2C     : Server to Client
### Flags
```
+----------------------------------------------------------------------+
|CP|Control Packet   |                    | bit3 | bit2 | bit1 |  bit0  |
+----------------------------------------------------------------------+
|
|           
| 3|  PUBLISH      |  Used in MQTT 3.1.1  | DUP  | QoS  | Qos  | RETAIN |
``` 
CP       : The value of conrol pakcet bit
DUP     : Duplicate delivery of a PUBLISH Control Packet
QoS     : PUBLISH Quality of Service
            0: at most once, [0, 1]
            1: at least once, [1,]
            2: only once, [1]
            3: reserved
RETAIN  : PUBLISH Retain flag

### Remaining Length
Starts at byte 2


## Variable Header
The variable header component of many of the Control Packet types includes a 2 byte Packet Identifier field. These Control Packets are PUBLISH (where QoS > 0), PUBACK, PUBREC, PUBREL, PUBCOMP, SUBSCRIBE, SUBACK, UNSUBSCRIBE, UNSUBACK.

> A PUBACK, PUBREC or PUBREL Packet MUST contain the same Packet Identifier as the PUBLISH Packet that was originally sent
> SUBSCRIBE, UNSUBSCRIBE, and PUBLISH (in cases where QoS > 0) Control Packets MUST contain a non-zero 16-bit Packet Identifier [MQTT-2.3.1-1]. Each time a Client sends a new packet of one of these types it MUST assign it a currently unused Packet Identifier [MQTT-2.3.1-2]. If a Client re-sends a particular Control Packet, then it MUST use the same Packet Identifier in subsequent re-sends of that packet. The Packet Identifier becomes available for reuse after the Client has processed the corresponding acknowledgement packet. In the case of a QoS 1 PUBLISH this is the corresponding PUBACK; in the case of QoS 2 it is PUBCOMP. For SUBSCRIBE or UNSUBSCRIBE it is the corresponding SUBACK or UNSUBACK [MQTT-2.3.1-3]. The same conditions apply to a Server when it sends a PUBLISH with QoS > 0 [MQTT-2.3.1-4].

> The Client and Server assign Packet Identifiers independently of each other. As a result, Client Server pairs can participate in concurrent message exchanges using the same Packet Identifiers.
 
```
[Client]                                                                                  [Server]
   PUBLISH Packet Identifier=0x1234--->
                                                    <--PUBLISH Packet Identifier=0x1234
   PUBACK Packet Identifier=0x1234--->
                                                    <--PUBACK Packet Identifier=0x1234
```

# MQTT Control Packets
## CONNECT - C2S
> After a Network Connection is established by a Client to a Server, the first Packet sent from the Client to the Server MUST be a CONNECT Packet.

> A Client can only send the CONNECT Packet once over a Network Connection. The Server MUST process a second CONNECT Packet sent from a Client as a protocol violation and disconnect the Client 

> The payload contains one or more encoded fields. They specify a unique Client identifier for the Client, a Will topic, Will Message, User Name and Password. All but the Client identifier are optional and their presence is determined based on flags in the variable header.

### CONNECT Packets Fixed Header
```
+--------------------------------------+
| bit  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+----------------------+---------------+
|      | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 |
+--------------------------------------+
|      |                               |
|  ... |      Remaining Length         |
|      |                               |
+--------------------------------------+
```
